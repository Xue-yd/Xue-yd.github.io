<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>Hello World</title>
    <url>/2022/08/13/hello-world/</url>
    <content><![CDATA[<p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p>
<span id="more"></span>
<p>D:\SogouDownload\nodejs\node_global\hexo d</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>
]]></content>
      <categories>
        <category>Hexo</category>
      </categories>
      <tags>
        <tag>Hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>FCA数据库中的原始reads文件之uBAM文件</title>
    <url>/2022/08/15/FCA%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%AD%E7%9A%84%E5%8E%9F%E5%A7%8Breads%E6%96%87%E4%BB%B6%E4%B9%8BuBAM%E6%96%87%E4%BB%B6/</url>
    <content><![CDATA[<p>本文介绍uBAM文件：</p>
<ul>
<li>什么是uBAM文件</li>
<li>uBAM vs fastq</li>
<li>uBAM转换为fastq<span id="more"></span></li>
</ul>
<h2 id="1-什么是uBAM文件？"><a href="#1-什么是uBAM文件？" class="headerlink" title="1.什么是uBAM文件？"></a>1.什么是uBAM文件？</h2><p>uBAM文件，即unmapped or unaligned BAM文件，里面的reads是没有经过比对的，目的是为了储存原始的reads信息。</p>
<h2 id="2-uBAM-vs-fastq"><a href="#2-uBAM-vs-fastq" class="headerlink" title="2.uBAM vs fastq"></a>2.uBAM vs fastq</h2><p>相比于fastq文件来说，uBAM文件储存的信息更加丰富。由于fastq文件的格式原因，很多信息都不能存放在fastq文件中。而BAM文件中只需要加上tag信息即可。以FlyCellAtlas中的原始BAM文件为例:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1	4	*	0	255	*	*	0	91	ATTGGCGACAGAT...CGGAATATATATATATGTATATAT	FFFFFFFFFFFFFFFFFFF...FFFFFFFFFFFFFFFFFF	on:Z:A00428:211:H77T5DSXY:3:1101:1090:1000@2:N:0:GCTCAACC	op:Z:FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF:FFFFFFFFFFFF,FFFFFFFFF:FFFFFF	RX:Z:CATCTATTATAT	QX:Z:FFFFFFFFFF:F	CR:Z:TTGGGTAAGGAGGCAG	CY:Z:#FFFFFFFFFFFFFFF</span><br></pre></td></tr></table></figure>

<p>RX tag即UMI信息，QX tag为UMI测序质量信息，CR tag为cell barcode序列，CY tag为cell barcode的测序质量信息。对于单细胞测序而言，一个uBAM文件即将R1(cell barcode + UMI)和R2(真正的reads)的fastq信息都包含在内。</p>
<h2 id="3-uBAM转换为cellranger需要的fastq"><a href="#3-uBAM转换为cellranger需要的fastq" class="headerlink" title="3.uBAM转换为cellranger需要的fastq"></a>3.uBAM转换为cellranger需要的fastq</h2><p>cellranger处理的fastq文件，有两个reads文件和index文件，index文件不是必需的。R1文件中储存的是cell barcode+UMI序列相关信息，R2文件中储存的是真正的测序序列。对于R2文件来说，直接用samtools fastq即可完成转换。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">samtools  fastq sample1.bam &gt; fastq/sample1-1_S1_L001_R2_001.fastq.gz</span><br></pre></td></tr></table></figure>

<p>对于R1文件而言，就有些复杂，我们可以首先将BAM文件中的UMI、barcode序列信息进行提取，然后再用samtools完成转换。这是一个笨方法，而且耗费资源，速度也比较慢，但是不需要写脚本。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> sample1-1 sample1-2 sample1-3</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">	samtools view <span class="variable">$i</span>.bam | awk <span class="string">&#x27;&#123;print $1&quot;\t&quot;$2&quot;\t&quot;$3&quot;\t&quot;$4&quot;\t&quot;$5&quot;\t&quot;$6&quot;\t&quot;$7&quot;\t&quot;$8&quot;\t&quot;$9&quot;\t&quot;$16$14&quot;\t&quot;$17$15&#125;&#x27;</span> &gt; <span class="variable">$i</span>.tmp;		<span class="comment">#提取序列基本信息和barcode(16列)和UMI(14列)信息，17、15列为相对应的质量信息</span></span><br><span class="line">	sed -i <span class="string">&#x27;1,$s/CR:Z://g&#x27;</span> <span class="variable">$i</span>.tmp;    <span class="comment">#处理文件，去掉tag标签，只保留序列</span></span><br><span class="line">	sed -i <span class="string">&#x27;1,$s/CY:Z://g&#x27;</span> <span class="variable">$i</span>.tmp;</span><br><span class="line">	sed -i <span class="string">&#x27;1,$s/RX:Z://g&#x27;</span> <span class="variable">$i</span>.tmp;</span><br><span class="line">	sed -i <span class="string">&#x27;1,$s/QX:Z://g&#x27;</span> <span class="variable">$i</span>.tmp;</span><br><span class="line">	<span class="built_in">cat</span> header <span class="variable">$i</span>.tmp &gt; <span class="variable">$i</span>.sam;		<span class="comment">#加上头文件</span></span><br><span class="line">	<span class="built_in">rm</span> <span class="variable">$i</span>.tmp;</span><br><span class="line">	samtools view -@ 10 -bS <span class="variable">$i</span>.sam -o <span class="variable">$i</span>.R1.bam;	<span class="comment">#转换为bam文件，节省空间</span></span><br><span class="line">	<span class="built_in">rm</span> <span class="variable">$i</span>.sam;</span><br><span class="line">	samtools fastq <span class="variable">$i</span>.R1.bam &gt; fastq/<span class="variable">$i_S1_L001_R1_001</span>.fastq; <span class="comment">#BAM转换为fastq（reads1）</span></span><br><span class="line">	samtools fastq <span class="variable">$i</span>.bam &gt; fastq/<span class="variable">$i_S1_L001_R2_001</span>.fastq;    <span class="comment">#（reads2）</span></span><br><span class="line">	gzip fastq/<span class="variable">$i</span>.R1_001.fastq;</span><br><span class="line">	gzip fastq/<span class="variable">$i</span>.R2_001.fastq;</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<p>完成转换之后就可以走接下来的cellranger流程啦！</p>
]]></content>
      <categories>
        <category>scRNA-seq</category>
      </categories>
      <tags>
        <tag>scRNA-seq</tag>
        <tag>raw reads</tag>
        <tag>10X genomics</tag>
      </tags>
  </entry>
  <entry>
    <title>scRNA-seq分析之cellranger count</title>
    <url>/2022/08/15/scRNA-seq%E5%88%86%E6%9E%90%E4%B9%8Bcellranger-count/</url>
    <content><![CDATA[<p>本文介绍从fastq文件开始，用cellranger进行定量：</p>
<ul>
<li>用cellranger构建参考基因组<ul>
<li>cellranger mkgtf</li>
<li>cellranger mkref</li>
</ul>
</li>
<li>cellranger count<span id="more"></span></li>
</ul>
<h2 id="1-生成cellranger参考基因组"><a href="#1-生成cellranger参考基因组" class="headerlink" title="1. 生成cellranger参考基因组"></a>1. 生成cellranger参考基因组</h2><p>cellranger官方提供有小鼠和人类的参考基因组，其他物种的需要用mkref自己产生。</p>
<h3 id="1-1-生成用于产生参考基因组的gtf文件"><a href="#1-1-生成用于产生参考基因组的gtf文件" class="headerlink" title="1.1 生成用于产生参考基因组的gtf文件"></a>1.1 生成用于产生参考基因组的gtf文件</h3><p>–attribute参数用于指定gtf文件中的biotype。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">cellranger mkgtf Dmel.gtf Dmel.BDGP6.32.104.filtered.gtf \</span><br><span class="line">--attribute=gene_biotype:protein_coding \</span><br><span class="line">--attribute=gene_biotype:lncRNA \</span><br><span class="line">--attribute=gene_biotype:antisense</span><br></pre></td></tr></table></figure>

<h3 id="1-2-生成参考基因组文件"><a href="#1-2-生成参考基因组文件" class="headerlink" title="1.2 生成参考基因组文件"></a>1.2 生成参考基因组文件</h3><p>接下来根据上一步产生的gtf文件生成参考基因组文件，–genome参数指定接下来产生的参考基因组的文件夹名字，–fasta为下载的参考基因组的序列文件，–gtf为上一步产生的gtf文件。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">cellranger mkref --genome=Dmel.genome \</span><br><span class="line">--fasta=Dme.dna.fa \</span><br><span class="line">--gtf=Dmel.BDGP6.32.104.filtered.gtf</span><br></pre></td></tr></table></figure>

<h2 id="2-cellranger-count定量"><a href="#2-cellranger-count定量" class="headerlink" title="2. cellranger count定量"></a>2. cellranger count定量</h2><p>有了fastq和参考基因组，接下来就可以定量了。<br>–id输出文件夹名字，–transcriptome参考基因组所在的文件夹，–fastqs为fastq序列所在的文件名，–sample用于分析的文件prefix，–localcores线程数，–localmem内存数，加上–nosecondary参数不进行下游聚类分析。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">cellranger count --<span class="built_in">id</span>=run_sample1 \</span><br><span class="line">--fastqs=/storage/XYD/mywork/fastq \</span><br><span class="line">--sample=sample1-44,sample1-48,sample1-49,sample1-56 \</span><br><span class="line">--transcriptome=/storage/XYD/00.reference/01.Dmel/Dmel.genome \</span><br><span class="line">--localcores=12 \</span><br><span class="line">--localmem=128 \</span><br><span class="line">--nosecondary</span><br></pre></td></tr></table></figure>

<p>定量结束之后，产生的文件夹里outs&#x2F;下会有一个网页文件web_summary.html，打开会看到下图的信息。</p>
<p><img src="/pics/2022-0815-cellranger-count-1.jpg" alt="alt 图标"></p>
<p>发现有个warning：Low fraction reads in cells，显示我的数据大概在54％左右，理想情况下应该为70%，官方的解释有两种可能：1.环境RNA水平过高；2.有一部分细胞RNA content很低，若是第二种情况，那么可以在count步骤加上–force-cells参数，设置一下自己预期的细胞数量，从而去掉RNA含量低的细胞。但是我设置了这个参数之后，还是会有这个warning，这可能说明细胞中reads比例低不是第二种情况造成的。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">cellranger count --<span class="built_in">id</span>=run_sample1 \</span><br><span class="line">--fastqs=/storage/XYD/mywork/fastq \</span><br><span class="line">--sample=sample1-44,sample1-48,sample1-49,sample1-56 \</span><br><span class="line">--transcriptome=/storage/XYD/00.reference/01.Dmel/Dmel.genome \</span><br><span class="line">--localcores=12 \</span><br><span class="line">--localmem=128 \</span><br><span class="line">--nosecondary</span><br><span class="line">--force-cells=13000</span><br></pre></td></tr></table></figure>

<p>参考资料：<br>1.<a href="https://kb.10xgenomics.com/hc/en-us/articles/360003919491-How-to-interpret-the-Fraction-Reads-in-Cells-metric-">https://kb.10xgenomics.com/hc/en-us/articles/360003919491-How-to-interpret-the-Fraction-Reads-in-Cells-metric-</a></p>
]]></content>
      <categories>
        <category>scRNA-seq</category>
        <category>10X genomics</category>
      </categories>
      <tags>
        <tag>scRNA-seq</tag>
        <tag>10X genomics</tag>
      </tags>
  </entry>
  <entry>
    <title>Seurat包合并多个sample datasets</title>
    <url>/2022/08/17/Seurat%E5%8C%85%E5%90%88%E5%B9%B6%E5%A4%9A%E4%B8%AAsample-datasets/</url>
    <content><![CDATA[<p>很多情况下，我们需要将多个sample dataset合并在一起，然后进行接下来的分析。Seurat v4官方提供了可以用于整合数据集的函数：FindIntegrationAnchors()和IntegrateData()。</p>
<span id="more"></span>

<h2 id="1-导入数据，设置SeuratObject"><a href="#1-导入数据，设置SeuratObject" class="headerlink" title="1.导入数据，设置SeuratObject"></a>1.导入数据，设置SeuratObject</h2><p>首先读入数据，然后创建SeuratObject对象。</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">library<span class="punctuation">(</span>Seurat<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">data1 <span class="operator">&lt;-</span> Read10X<span class="punctuation">(</span>data.dir <span class="operator">=</span> <span class="string">&quot;D:/000 MyWork/000 MyProject/000 scVariants/sample1&quot;</span><span class="punctuation">,</span></span><br><span class="line">	gene.column <span class="operator">=</span> <span class="number">1</span><span class="punctuation">)</span></span><br><span class="line">data2 <span class="operator">&lt;-</span> Read10X<span class="punctuation">(</span>data.dir <span class="operator">=</span> <span class="string">&quot;D:/000 MyWork/000 MyProject/000 scVariants/sample2&quot;</span><span class="punctuation">,</span></span><br><span class="line">	gene.column <span class="operator">=</span> <span class="number">1</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">data1 <span class="operator">&lt;-</span> CreateSeuratObject<span class="punctuation">(</span>counts <span class="operator">=</span> data1<span class="punctuation">,</span>project <span class="operator">=</span> <span class="string">&quot;sample1&quot;</span><span class="punctuation">,</span></span><br><span class="line">	min.cells <span class="operator">=</span> <span class="number">3</span><span class="punctuation">,</span>min.features <span class="operator">=</span> <span class="number">200</span><span class="punctuation">,</span></span><br><span class="line">	assay <span class="operator">=</span> <span class="string">&quot;RNA&quot;</span><span class="punctuation">)</span></span><br><span class="line">data2 <span class="operator">&lt;-</span> CreateSeuratObject<span class="punctuation">(</span>counts <span class="operator">=</span> data2<span class="punctuation">,</span>project <span class="operator">=</span> <span class="string">&quot;sample2&quot;</span><span class="punctuation">,</span></span><br><span class="line">	min.cells <span class="operator">=</span> <span class="number">3</span><span class="punctuation">,</span>min.features <span class="operator">=</span> <span class="number">200</span><span class="punctuation">,</span></span><br><span class="line">	assay <span class="operator">=</span> <span class="string">&quot;RNA&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<p>接下来分别对两个数据各自进行Normalize（每个都要各自进行normalize），并鉴定variable features,最后选择两个datasets中repeatedly variable features进行integration。</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">data.list <span class="operator">&lt;-</span> <span class="built_in">c</span><span class="punctuation">(</span>data1<span class="punctuation">,</span>data2<span class="punctuation">)</span></span><br><span class="line">data.list <span class="operator">&lt;-</span> lapply<span class="punctuation">(</span>X <span class="operator">=</span> data.list<span class="punctuation">,</span> FUN <span class="operator">=</span> <span class="keyword">function</span><span class="punctuation">(</span>x<span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">	x <span class="operator">&lt;-</span> NormalizeData<span class="punctuation">(</span>x<span class="punctuation">)</span></span><br><span class="line">	x <span class="operator">&lt;-</span> FindVariableFeatures<span class="punctuation">(</span>x<span class="punctuation">,</span> selection.method <span class="operator">=</span> <span class="string">&quot;vst&quot;</span><span class="punctuation">,</span> nfeatures <span class="operator">=</span> <span class="number">2000</span><span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">features <span class="operator">&lt;-</span> SelectIntegrationFeatures<span class="punctuation">(</span>object.list <span class="operator">=</span> data.list<span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<h2 id="2-进行整合"><a href="#2-进行整合" class="headerlink" title="2.进行整合"></a>2.进行整合</h2><p>然后，使用FindIntegrationAnchors()函数确定Anchor，这个函数以SeuratObject函数作为输入，然后再利用IntegrateData()函数进行整合。</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">data.anchors <span class="operator">&lt;-</span> FindIntegrationAnchors<span class="punctuation">(</span>object.list <span class="operator">=</span> data.list<span class="punctuation">,</span></span><br><span class="line">anchor.features <span class="operator">=</span> features<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">data.combined <span class="operator">&lt;-</span> IntegrateData<span class="punctuation">(</span>anchorset <span class="operator">=</span> data.anchors<span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<p>这样整合之后的数据只包括了前面鉴定到的features信息，后续的scale等等分析都仅基于这些features，默认是2000个，因此数据会小很多。</p>
<h2 id="3-整合后的分析"><a href="#3-整合后的分析" class="headerlink" title="3.整合后的分析"></a>3.整合后的分析</h2><p>接下来就可以进行后续的分析了。</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">DefaultAssay<span class="punctuation">(</span>data.combined<span class="punctuation">)</span> <span class="operator">&lt;-</span> <span class="string">&quot;integrated&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Run the standard workflow for visualization and clustering</span></span><br><span class="line">data.combined <span class="operator">&lt;-</span> ScaleData<span class="punctuation">(</span>data.combined<span class="punctuation">,</span> verbose <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">)</span></span><br><span class="line">data.combined <span class="operator">&lt;-</span> RunPCA<span class="punctuation">(</span>data.combined<span class="punctuation">,</span> npcs <span class="operator">=</span> <span class="number">30</span><span class="punctuation">,</span> verbose <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">)</span></span><br><span class="line">data.combined <span class="operator">&lt;-</span> FindNeighbors<span class="punctuation">(</span>data.combined<span class="punctuation">,</span> reduction <span class="operator">=</span> <span class="string">&quot;pca&quot;</span><span class="punctuation">,</span> dims <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span><span class="number">20</span><span class="punctuation">)</span></span><br><span class="line">data.combined <span class="operator">&lt;-</span> FindClusters<span class="punctuation">(</span>data.combined<span class="punctuation">,</span> resolution <span class="operator">=</span> <span class="number">0.5</span><span class="punctuation">)</span></span><br><span class="line">data.combined <span class="operator">&lt;-</span> RunUMAP<span class="punctuation">(</span>data.combined<span class="punctuation">,</span> reduction <span class="operator">=</span> <span class="string">&quot;pca&quot;</span><span class="punctuation">,</span> dims <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span><span class="number">20</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Visualization</span></span><br><span class="line">p1 <span class="operator">&lt;-</span> DimPlot<span class="punctuation">(</span>data.combined<span class="punctuation">,</span> reduction <span class="operator">=</span> <span class="string">&quot;umap&quot;</span><span class="punctuation">)</span></span><br><span class="line">p2 <span class="operator">&lt;-</span> DimPlot<span class="punctuation">(</span>data.combined<span class="punctuation">,</span> reduction <span class="operator">=</span> <span class="string">&quot;umap&quot;</span><span class="punctuation">,</span> label <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">,</span> repel <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">)</span></span><br><span class="line">p1</span><br><span class="line">p2</span><br></pre></td></tr></table></figure>

<p>这种整合方法对于较大的数据集，比较消耗内存和时间，了解到还有另外一种整合方法：Harmony，之后再说。</p>
<p>参考：<a href="https://satijalab.org/seurat/articles/integration_introduction.html">https://satijalab.org/seurat/articles/integration_introduction.html</a></p>
]]></content>
      <categories>
        <category>R</category>
        <category>Seurat</category>
      </categories>
      <tags>
        <tag>scRNA-seq</tag>
        <tag>Seurat</tag>
      </tags>
  </entry>
  <entry>
    <title>RNA-seq分析(1)之数据质控</title>
    <url>/2022/08/14/RNA-seq%E5%88%86%E6%9E%90%E4%B9%8B%E6%95%B0%E6%8D%AE%E8%B4%A8%E6%8E%A7/</url>
    <content><![CDATA[<p>本文介绍RNA-seq上游分析之数据质控：</p>
<ul>
<li>fastqc质控<ul>
<li>去除接头序列</li>
<li>reads trim</li>
</ul>
</li>
<li>去除rRNA序列<ul>
<li>rRNA index</li>
<li>反向mapping<span id="more"></span></li>
</ul>
</li>
</ul>
<h2 id="1-fastq文件质控"><a href="#1-fastq文件质控" class="headerlink" title="1.fastq文件质控"></a>1.fastq文件质控</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">fastq -f fastq -t 10 -o ./ ./myfastq_r1.fq.gz ./myfastq_r2.fq.gz</span><br></pre></td></tr></table></figure>

<p>之后会产生质控报告和zip文件，查看报告，可以看到base quality、GC content等信息。质控报告每个版块的具体的意义参考(<a href="https://zhuanlan.zhihu.com/p/20731723">https://zhuanlan.zhihu.com/p/20731723</a> )。</p>
<h2 id="2-去除接头序列"><a href="#2-去除接头序列" class="headerlink" title="2.去除接头序列"></a>2.去除接头序列</h2><p>RNA-seq建库测序时，会在样品末端加上接头序列，在后续的步骤中需要去除。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Usage:</span><br><span class="line">    cutadapt -a ADAPTER [options] [-o output.fastq] input.fastq</span><br><span class="line"></span><br><span class="line">For paired-end reads:</span><br><span class="line">    cutadapt -a ADAPT1 -A ADAPT2 [options] -o out1.fastq -p out2.fastq in1.fastq                            in2.fastq</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>去除接头序列，这里我用cutadapt，对于双端测序来说，需要去掉read1和read2两个序列，参数-a和-A分别是read1和read2序列的3’端序列。-e即error rate,-n为2即最多每条read最多去掉两个adapter，-m为20去掉adapter之后若reads长度小于20，则去掉这条reads，–pair-filter这个参数对于双端测序而言，read1和read2都有可能检测到接头。如果选择any，则只要两个中其中一个检测到接头，read1和read2均舍弃；如果选择both，则必须两个都检测到接头，read1和read2才舍弃，-j线程数，-q [5’CUTOFF,]3’CUTOFF参数，quality cutoff，去掉5’端、3’端碱基质量低于该值。双端测序需要提供两个值。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">cutadapt -a AGATCGGAAGAGCACACGTCTGAACTCCAGTCAC -A AGATCGGAAGAGCGTCGTGTAGGGAAAGAGTGT</span><br><span class="line">\ -e 0.1 -O 5 -n 2 -m 20 --pair-filter both -q 20,20 -j 10</span><br><span class="line">\ -o 01.clean/CS-1.clean.r1.fq.gz -p 01.clean/CS-1.clean.r2.fq.gz</span><br><span class="line">\ 00.rawdata/CS-1-LEG8830_L2_1.fq.gz 00.rawdata/CS-1-LEG8830_L2_2.fq.gz</span><br></pre></td></tr></table></figure>

<h2 id="3-去除测序刚开始时不稳定的reads"><a href="#3-去除测序刚开始时不稳定的reads" class="headerlink" title="3.去除测序刚开始时不稳定的reads"></a>3.去除测序刚开始时不稳定的reads</h2><p>测序仪进行测序时，刚开始10bp左右的reads测序不稳定，可以进行适当修剪。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">cutadapt -u 10 -o trimmed.fastq input_reads.fastq</span><br></pre></td></tr></table></figure>

<h2 id="4-去除rRNA序列"><a href="#4-去除rRNA序列" class="headerlink" title="4.去除rRNA序列"></a>4.去除rRNA序列</h2><p>有时候质控得到的结果中GC含量为双峰，这可能是一些RNA过表达引起的GC偏好，需要去除一些rRNA序列或是其他我们并不关心的序列，但是也并不必过于担忧，RNA-seq中本身就有一些表达量高的序列，所以质控报告中只要一些如碱基质量等的关键因素满足要求，后续只是进行差异表达等的分析，不去除也是可以的。<br>首先，我们需要在NCBI数据库中下载rRNA序列的fasta文件，然后用Hisat2进行比对，保留没有比对上的序列即可,过程如下：</p>
<h3 id="4-1-构建索引"><a href="#4-1-构建索引" class="headerlink" title="4.1 构建索引"></a>4.1 构建索引</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">hisat2-build -p 10 rRNA.fasta ./rRNA/rRNA</span><br></pre></td></tr></table></figure>

<h3 id="4-2-输出没有比对上的序列"><a href="#4-2-输出没有比对上的序列" class="headerlink" title="4.2 输出没有比对上的序列"></a>4.2 输出没有比对上的序列</h3><p>–un-conc-gz参数输出没有比对上的序列。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> CS-1 CS-2 PS-1 PS-2</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">	hisat2 -x 03.<span class="built_in">rm</span>/rRNA/rRNA \</span><br><span class="line">	-1 01.clean/<span class="variable">$i</span>.r1.clean.fq.gz \</span><br><span class="line">	-2 01.clean/<span class="variable">$i</span>.r2.clean.fq.gz \</span><br><span class="line">	--un-conc-gz 03.<span class="built_in">rm</span>/<span class="variable">$&#123;i&#125;</span>_rmr_%.fq.gz -p 10 -S 03.<span class="built_in">rm</span>/<span class="variable">$&#123;i&#125;</span>.rRNA.sam</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>
<p>这一步进行完之后便会发现fastq文件小了许多，这便是去除成功了。然后便可以继续接下来的分析了。</p>
<p>参考资料：<br>1.<a href="https://zhuanlan.zhihu.com/p/20731723">https://zhuanlan.zhihu.com/p/20731723</a><br>2.<a href="https://mp.weixin.qq.com/s/jVTmp4VJQxB6Lwxh1QmNkA">https://mp.weixin.qq.com/s/jVTmp4VJQxB6Lwxh1QmNkA</a></p>
]]></content>
      <categories>
        <category>RNA-seq</category>
      </categories>
      <tags>
        <tag>RNA-seq</tag>
      </tags>
  </entry>
  <entry>
    <title>RNA-seq分析(2)之Hisat2+FeatureCounts</title>
    <url>/2022/08/17/RNA-seq%E5%88%86%E6%9E%90%E4%B9%8BHisat2+FeatureCounts/</url>
    <content><![CDATA[<p>本文介绍RNA-seq流程：</p>
<ul>
<li>Hisat2 mapping</li>
<li>FeatureCounts 定量<span id="more"></span></li>
</ul>
<h2 id="1-Hisat2-mapping"><a href="#1-Hisat2-mapping" class="headerlink" title="1.Hisat2 mapping"></a>1.Hisat2 mapping</h2><p>Hisat2 mapping,-x即参考基因组所在的文件夹位置，-1、-2分别为read1和read2的fastq文件，然后将比对产生的sam文件转为bam并进行排序。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> CS-1 CS-2 PS-1 PS-2</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">	hisat2 -x ~/00.reference/index/Dro.mel/genome</span><br><span class="line">	\ -1 03.<span class="built_in">cut</span>/<span class="variable">$i</span>.r1.trimmed.fq.gz</span><br><span class="line">	\ -2 03.<span class="built_in">cut</span>/<span class="variable">$i</span>.r2.trimmed.fq.gz</span><br><span class="line">	\ -p 12 -S 05.mapping/<span class="variable">$i</span>.sam</span><br><span class="line">	samtools view -S -b 05.mapping/<span class="variable">$i</span>.sam -o 05.mapping/<span class="variable">$i</span>.bam</span><br><span class="line">	samtools <span class="built_in">sort</span> -l 9 05.mapping/<span class="variable">$i</span>.bam -o 05.mapping/<span class="variable">$i</span>.sorted.bam</span><br><span class="line">	<span class="built_in">rm</span> 05.mapping/<span class="variable">$i</span>.sam 05.mapping/<span class="variable">$i</span>.bam</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<h2 id="2-FeatureCounts定量"><a href="#2-FeatureCounts定量" class="headerlink" title="2.FeatureCounts定量"></a>2.FeatureCounts定量</h2><p>-T线程数，-p双端测序，-g根据gene_id进行，设置feature-type，-t指定的必须是gtf中有的feature，同时read只有落到这些feature上才会被统计到，默认是“exon”，-g参数需要提供一个id identifier 来将feature水平的统计汇总为meta-feature水平的统计(即对一个基因来说，统计map到这个基因的exon上的reads数，以此来进行定量)，默认为gene_id，-a参考基因组gtf文件名。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> CS-1 CS-2 PS-1 PS-2</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">	featureCounts -p -T 10 -t exon -g gene_id -a ~/00.reference/01.Dmel/Dmel.gtf</span><br><span class="line">	\ -o 06.counts/<span class="variable">$i</span>.count.txt 05.mapping/<span class="variable">$i</span>.sorted.bam</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>RNA-seq</category>
      </categories>
      <tags>
        <tag>RNA-seq</tag>
      </tags>
  </entry>
  <entry>
    <title>Seurat数据结构</title>
    <url>/2022/08/24/Seurat%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/</url>
    <content><![CDATA[<ul>
<li>SeuratObject数据结构<ul>
<li>Assays</li>
<li>meta.data</li>
<li>active.assay</li>
<li>active.ident</li>
<li>reduction</li>
</ul>
</li>
<li>提取数据<ul>
<li>提取基因ID和细胞ID</li>
<li>提取细胞坐标信息</li>
<li>提取表达矩阵</li>
<li>提取平均表达量</li>
<li>聚类细胞数目与比例统计</li>
<li>修改聚类后的idents</li>
<li>提取部分Seurat对象<span id="more"></span></li>
</ul>
</li>
</ul>
<h2 id="1-SeuratObject数据结构"><a href="#1-SeuratObject数据结构" class="headerlink" title="1. SeuratObject数据结构"></a>1. SeuratObject数据结构</h2><p>首先，先来了解一下SeuratObject的数据结构和格式。<br><img src="/pics/2022-0824-Seurat%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84.png" alt="alt 图标"></p>
<p>图片来源：<a href="https://www.jianshu.com/p/13142bf51e81">https://www.jianshu.com/p/13142bf51e81</a></p>
<h3 id="1-1-Assays"><a href="#1-1-Assays" class="headerlink" title="1.1 Assays"></a>1.1 Assays</h3><p>默认情况下Seurat对象的Assay是”RNA”,在后续的数据处理过程中，会产生新的。例如，integration之后、SCTransform之后等过程处理之后，都会产生新的Assay，存放的是经过处理之后产生的矩阵。修改默认的Assay可以通过DefaultAssay函数，也可通过 @active.assay查看默认的assay。</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">pbmc<span class="operator">@</span>active.assay</span><br><span class="line">DefaultAssay<span class="punctuation">(</span>pbmc<span class="punctuation">)</span> <span class="operator">&lt;-</span> <span class="string">&quot;RNA&quot;</span></span><br></pre></td></tr></table></figure>
<p>在assay数据中，counts是原始数据，data是normalize（归一化）之后的数据，scale.data是scale（标准化）之后的数据。var.features是高变的features，默认是2000个。调用方法：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">pbmc<span class="operator">@</span>assays<span class="operator">$</span>RNA<span class="operator">@</span>counts</span><br><span class="line">pbmc<span class="punctuation">[[</span><span class="string">&quot;RNA&quot;</span><span class="punctuation">]</span><span class="punctuation">]</span><span class="operator">@</span>counts</span><br></pre></td></tr></table></figure>

<h3 id="1-2-meta-data"><a href="#1-2-meta-data" class="headerlink" title="1.2 meta.data"></a>1.2 meta.data</h3><p>meta.data数据中储存的是细胞的相关信息，主要包括：orig.ident,nCount_RNA,nFeature_RNA,percent.mito,RNA_snn_res.0.4,seurat_clusters等。orig.ident是细胞的来源信息，例如我的是3个样本合并之后的dataset，那么这个里面就是sample1、sample2、sample3，nCount_RNA是每个细胞中RNA数量，nFeature_RNA同理，percent.mito每个细胞中的线粒体基因占比信息，seurat_clusters是细胞聚类之后被归为哪一类。调用方法：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">pbmc<span class="operator">$</span>orig.ident</span><br><span class="line">pbmc<span class="punctuation">[[</span><span class="string">&quot;orig.ident&quot;</span><span class="punctuation">]</span><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>

<h3 id="1-3-active-assay"><a href="#1-3-active-assay" class="headerlink" title="1.3 active.assay"></a>1.3 active.assay</h3><p>查看当前的默认assay。调用方式：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">pbmc<span class="operator">@</span>active.assays</span><br></pre></td></tr></table></figure>

<h3 id="1-4-active-ident"><a href="#1-4-active-ident" class="headerlink" title="1.4 active.ident"></a>1.4 active.ident</h3><p>查看使用的分群方式。调用方式：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">pbmc<span class="operator">@</span>active.ident</span><br></pre></td></tr></table></figure>

<h3 id="1-5-reduction"><a href="#1-5-reduction" class="headerlink" title="1.5 reduction"></a>1.5 reduction</h3><p>储存降维之后每个细胞的坐标信息，3种方法分别在：pca、tsne、umap。坐标信息在cell.embeddings中；每个基因对pca成分的贡献度在feature.loadings中。assay.used指这个降维使用的assay。调用方法：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">head<span class="punctuation">(</span>pbmc<span class="operator">@</span>reduction<span class="operator">$</span>umap<span class="operator">@</span>cell.embeddings<span class="punctuation">)</span></span><br><span class="line">head<span class="punctuation">(</span>pbmc<span class="operator">@</span>reduction<span class="operator">$</span>umap<span class="operator">@</span>feature.loadings<span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<h2 id="2-提取数据"><a href="#2-提取数据" class="headerlink" title="2. 提取数据"></a>2. 提取数据</h2><h3 id="2-1-提取基因ID与细胞ID"><a href="#2-1-提取基因ID与细胞ID" class="headerlink" title="2.1 提取基因ID与细胞ID"></a>2.1 提取基因ID与细胞ID</h3><figure class="highlight r"><table><tr><td class="code"><pre><span class="line">rownames<span class="punctuation">(</span>pbmc<span class="punctuation">)</span> <span class="comment">#提取基因ID</span></span><br><span class="line">colnames<span class="punctuation">(</span>pbmc<span class="punctuation">)</span> <span class="comment">#提取细胞ID</span></span><br><span class="line">Cells<span class="punctuation">(</span>pbmc<span class="punctuation">)</span>    <span class="comment">#提取细胞ID</span></span><br><span class="line"></span><br><span class="line">WhichCells<span class="punctuation">(</span>pbmc<span class="punctuation">,</span>ident<span class="operator">=</span><span class="built_in">c</span><span class="punctuation">(</span><span class="number">1</span><span class="punctuation">,</span><span class="number">2</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="comment">#按照idents提取细胞ID</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 按照idents提取细胞ID，加上invert表示反向提取，除1,2之外的细胞</span></span><br><span class="line">WhichCells<span class="punctuation">(</span>pbmc<span class="punctuation">,</span>ident<span class="operator">=</span><span class="built_in">c</span><span class="punctuation">(</span><span class="number">1</span><span class="punctuation">,</span><span class="number">2</span><span class="punctuation">)</span><span class="punctuation">,</span>invert<span class="operator">=</span><span class="literal">TRUE</span><span class="punctuation">)</span> </span><br><span class="line"></span><br><span class="line"><span class="comment"># 按照gene1的表达量提取细胞ID，slot指定counts即原始数据</span></span><br><span class="line">WhichCells<span class="punctuation">(</span>pbmc<span class="punctuation">,</span><span class="built_in">expression</span><span class="operator">=</span>gene1<span class="operator">&gt;</span><span class="number">1</span><span class="punctuation">,</span>slot<span class="operator">=</span><span class="string">&quot;counts&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<h3 id="2-2-提取细胞坐标信息"><a href="#2-2-提取细胞坐标信息" class="headerlink" title="2.2 提取细胞坐标信息"></a>2.2 提取细胞坐标信息</h3><figure class="highlight r"><table><tr><td class="code"><pre><span class="line">Embeddings<span class="punctuation">(</span>pbmc<span class="punctuation">,</span>reduction<span class="operator">=</span><span class="string">&quot;umap&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<h3 id="2-3-提取表达矩阵"><a href="#2-3-提取表达矩阵" class="headerlink" title="2.3 提取表达矩阵"></a>2.3 提取表达矩阵</h3><figure class="highlight r"><table><tr><td class="code"><pre><span class="line"><span class="comment">#提取所有细胞的表达矩阵</span></span><br><span class="line">raw <span class="operator">&lt;-</span> as.matrix<span class="punctuation">(</span>GetAssayData<span class="punctuation">(</span>pbmc<span class="punctuation">,</span>slot<span class="operator">=</span><span class="string">&quot;counts&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">raw <span class="operator">&lt;-</span> as.matrix<span class="punctuation">(</span>pbmc<span class="operator">@</span>assays<span class="operator">$</span>RNA<span class="operator">@</span>counts<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#提取idents为5的细胞表达矩阵</span></span><br><span class="line">raw5 <span class="operator">&lt;-</span> as.matrix<span class="punctuation">(</span>GetAssayData<span class="punctuation">(</span>pbmc<span class="punctuation">,</span>slot<span class="operator">=</span><span class="string">&quot;counts&quot;</span><span class="punctuation">)</span><span class="punctuation">[</span><span class="punctuation">,</span>WhichCells<span class="punctuation">(</span>pbmc<span class="punctuation">,</span>ident<span class="operator">=</span><span class="string">&quot;5&quot;</span><span class="punctuation">)</span><span class="punctuation">]</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<h3 id="2-4-提取平均表达量"><a href="#2-4-提取平均表达量" class="headerlink" title="2.4 提取平均表达量"></a>2.4 提取平均表达量</h3><figure class="highlight r"><table><tr><td class="code"><pre><span class="line">cluster.averages <span class="operator">&lt;-</span> AverageExpression<span class="punctuation">(</span>pbmc<span class="punctuation">)</span></span><br><span class="line">write.table<span class="punctuation">(</span>cluster.averages<span class="punctuation">[[</span><span class="string">&quot;RNA&quot;</span><span class="punctuation">]</span><span class="punctuation">]</span><span class="punctuation">[</span><span class="punctuation">,</span><span class="number">1</span><span class="operator">:</span><span class="number">15</span><span class="punctuation">]</span><span class="punctuation">,</span><span class="string">&quot;cluster.averages.txt&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<h3 id="2-5-聚类细胞数目与比例统计"><a href="#2-5-聚类细胞数目与比例统计" class="headerlink" title="2.5 聚类细胞数目与比例统计"></a>2.5 聚类细胞数目与比例统计</h3><figure class="highlight r"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看每个cluster的细胞数目</span></span><br><span class="line">table<span class="punctuation">(</span>Idents<span class="punctuation">(</span>pbmc<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">table<span class="punctuation">(</span>pbmc<span class="operator">$</span>RNA_snn_res.0.4<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#统计每个样本的细胞数目</span></span><br><span class="line">table<span class="punctuation">(</span>pbmc<span class="operator">$</span>orig.ident<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#将cluster和样本来源一起统计</span></span><br><span class="line">table<span class="punctuation">(</span>Idents<span class="punctuation">(</span>pbmc<span class="punctuation">)</span><span class="punctuation">,</span>pbmc<span class="operator">$</span>orig.ident<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看每个cluster细胞数目占总细胞的比例</span></span><br><span class="line">prop.table<span class="punctuation">(</span>table<span class="punctuation">(</span>Idents<span class="punctuation">(</span>pbmc<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">prop.table<span class="punctuation">(</span>table<span class="punctuation">(</span>pbmc<span class="operator">$</span>RNA_snn_res.0.4<span class="punctuation">)</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<h3 id="2-6-修改聚类后的idents"><a href="#2-6-修改聚类后的idents" class="headerlink" title="2.6 修改聚类后的idents"></a>2.6 修改聚类后的idents</h3><figure class="highlight r"><table><tr><td class="code"><pre><span class="line">pbmc <span class="operator">&lt;-</span> RenameIdents<span class="punctuation">(</span>pbmc<span class="punctuation">,</span>`<span class="number">0</span>`=&quot;B cells&quot;,`1`=&quot;NK cells&quot;)</span><br></pre></td></tr></table></figure>

<h3 id="2-7-提取部分Seurat对象"><a href="#2-7-提取部分Seurat对象" class="headerlink" title="2.7 提取部分Seurat对象"></a>2.7 提取部分Seurat对象</h3><figure class="highlight r"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 按照细胞ID提取</span></span><br><span class="line">subset<span class="punctuation">(</span>pbmc<span class="punctuation">,</span>cells<span class="operator">=</span>cells<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 按照cluster提取</span></span><br><span class="line">subset<span class="punctuation">(</span>pbmc<span class="punctuation">,</span>ident<span class="operator">=</span><span class="built_in">c</span><span class="punctuation">(</span><span class="number">1</span><span class="punctuation">,</span><span class="number">2</span><span class="punctuation">,</span><span class="number">3</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">subset<span class="punctuation">(</span>pbmc<span class="punctuation">,</span>ident<span class="operator">=</span><span class="built_in">c</span><span class="punctuation">(</span><span class="number">1</span><span class="punctuation">,</span><span class="number">2</span><span class="punctuation">,</span><span class="number">3</span><span class="punctuation">)</span><span class="punctuation">,</span>invert<span class="operator">=</span><span class="literal">TRUE</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<p>参考<br>1.<a href="https://www.jianshu.com/p/13142bf51e81">https://www.jianshu.com/p/13142bf51e81</a><br>2.<a href="https://www.jianshu.com/p/1db7c28249d4">https://www.jianshu.com/p/1db7c28249d4</a></p>
]]></content>
      <categories>
        <category>R</category>
        <category>Seurat</category>
      </categories>
      <tags>
        <tag>scRNA-seq</tag>
        <tag>Seurat</tag>
      </tags>
  </entry>
  <entry>
    <title>GATK/bcftools变异检测</title>
    <url>/2022/08/27/GATK-bcftools%E5%8F%98%E5%BC%82%E6%A3%80%E6%B5%8B/</url>
    <content><![CDATA[<p>本文总结利用RNA-seq数据进行snp calling的流程。</p>
<span id="more"></span>

<h2 id="1-构建参考基因组index"><a href="#1-构建参考基因组index" class="headerlink" title="1. 构建参考基因组index"></a>1. 构建参考基因组index</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">bwa index Dmel.dna.fa</span><br><span class="line">samtools faidx Dmel.dna.fa</span><br><span class="line">picard CreateSequenceDictionary -R ~/00.reference/01.Dmel/Dmel.dna.fa -O Dmel.dna.dict</span><br></pre></td></tr></table></figure>

<h2 id="2-bam文件预处理"><a href="#2-bam文件预处理" class="headerlink" title="2. bam文件预处理"></a>2. bam文件预处理</h2><p>对bam文件进行排序。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">samtools merge -@ 10 -l 9 merged.bam sample1.bam sample2.bam sample3.bam</span><br><span class="line">samtools <span class="built_in">sort</span> -@ 10 -l 9 merged.bam -o merged.sort.bam</span><br></pre></td></tr></table></figure>

<h2 id="3-去重复mark-duplicates"><a href="#3-去重复mark-duplicates" class="headerlink" title="3. 去重复mark duplicates"></a>3. 去重复mark duplicates</h2><p>去除掉建库、测序过程中偏好性导致的一些”假阳性”地增高的reads。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">picard MarkDuplicates -I merged.sort.bam</span><br><span class="line">\ -M merged_mark_metrics.txt</span><br><span class="line">\ --REMOVE_DUPLICATES 1</span><br><span class="line">\ -O merged.sort.removed.bam</span><br></pre></td></tr></table></figure>

<h2 id="4-1-GATK-snp-calling"><a href="#4-1-GATK-snp-calling" class="headerlink" title="4-1. GATK snp calling"></a>4-1. GATK snp calling</h2><h3 id="1-SplitNCigarReads"><a href="#1-SplitNCigarReads" class="headerlink" title="1. SplitNCigarReads"></a>1. SplitNCigarReads</h3><p>这一步是针对RNA-seq数据call snp特有的步骤。mRNA转录本主要是由DNA的外显子exon的可变剪切，不包括intron部分。因此，在RNA-seq数据call snp时，如果直接比对到基因组上，若比对到intron的N区域，就会有假阳性的snp，为了减少假阳性，需要将reads进行切割，跨越intron区域。若为n个intron的read片段，则切割为n+1个子read片段。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">gatk SplitNCigarReads -R ~/00.reference/01.Dmel/Dmel.dna.fa</span><br><span class="line">\ -I merged.sort.removed.bam </span><br><span class="line">\ -O merged.sort.removed.splited.bam</span><br></pre></td></tr></table></figure>

<h3 id="2-GATK-snp-calling"><a href="#2-GATK-snp-calling" class="headerlink" title="2. GATK snp calling"></a>2. GATK snp calling</h3><p>HaplotypeCaller进行变异检测，之后，只保留SNP位点,并对SNP进行过滤：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">gatk HaplotypeCaller -R ~/00.reference/01.Dmel/Dmel.dna.fa</span><br><span class="line">\ --ploidy 2 -I 03.bam/merged.sort.removed.bam</span><br><span class="line">\ -O 04.call_snp/all.merged.vcf.gz</span><br><span class="line"></span><br><span class="line">gatk SelectVariants -R ~/00.reference/01.Dmel/Dmel.dna.fa</span><br><span class="line">\ -O 04.call_snp/all.merged.snp.vcf</span><br><span class="line">\ --variant 04.call_snp/all.merged.vcf.gz</span><br><span class="line">\ --select-type-to-include SNP</span><br><span class="line"></span><br><span class="line">gatk VariantFiltration -R ~/00.reference/01.Dmel/Dmel.dna.fa</span><br><span class="line">\ -V 04.call_snp/all.merged.snp.vcf.gz</span><br><span class="line">\ --cluster-size 4 --cluster-window-size 10</span><br><span class="line">\ --mask-name aroundIndel --mask 04.call_snp/all.merged.indel.vcf.gz -mask-extension 3</span><br><span class="line">\ --filter-name <span class="string">&quot;lowMQRankSum&quot;</span> --filter-expression <span class="string">&quot;MQRankSum &lt; 12.5&quot;</span></span><br><span class="line">\ --filter-name <span class="string">&quot;highFS&quot;</span> --filter-expression <span class="string">&quot;FS &gt; 60.0&quot;</span></span><br><span class="line">\ --filter-name <span class="string">&quot;lowReadPosRankSum&quot;</span> --filter-expression <span class="string">&quot;ReadPosRankSum &lt; -8.0&quot;</span></span><br><span class="line">\ --filter-name <span class="string">&quot;lowMQ&quot;</span> --filter-expression <span class="string">&quot;MQ &lt; 40.0&quot;</span></span><br><span class="line">\ --filter-name <span class="string">&quot;lowQD&quot;</span> --filter-expression <span class="string">&quot;QD &lt; 2.0&quot;</span></span><br><span class="line">\ --genotype-filter-name <span class="string">&quot;lowDP&quot;</span> --genotype-filter-expression <span class="string">&quot;DP &lt; 8.0&quot;</span></span><br><span class="line">\ -O 05.filter_snp/all.merged.filered.snp.vcf.gz</span><br></pre></td></tr></table></figure>

<h2 id="4-2-bcftools-snp-calling"><a href="#4-2-bcftools-snp-calling" class="headerlink" title="4-2. bcftools snp calling"></a>4-2. bcftools snp calling</h2><p>去重复之后，也可利用bcftools进行snp calling,并进行过滤。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">bcftools mpileup -Ou -f ~/00.reference/01.Dmel/Dmel.dna.fa 03.bam/merged.sort.removed.bam | bcftools call -<span class="built_in">mv</span> -o all.merged.vcf.gz</span><br><span class="line">bcftools filter all.merged.vcf.gz -e <span class="string">&#x27;QUAL&lt;30&#x27;</span> --SnpGap 5 -Oz -o all.filtered.merged.vcf.gz;</span><br><span class="line">bcftools filter all.filtered.merged.vcf.gz -e <span class="string">&#x27;DP&lt;10&#x27;</span> -Oz -o all.filtered2.merged.vcf.gz;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>SNP calling</category>
      </categories>
      <tags>
        <tag>SNP calling</tag>
      </tags>
  </entry>
  <entry>
    <title>从FCA数据库中的loom文件中选择想要的cell构建SeuratObject</title>
    <url>/2022/08/30/%E4%BB%8EFCA%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%AD%E7%9A%84loom-h5ad-file%E4%B8%AD%E9%80%89%E6%8B%A9%E7%89%B9%E5%AE%9Acell%E6%9E%84%E5%BB%BASeuratObject/</url>
    <content><![CDATA[<p>从FCA数据库中下载的原始.loom文件,选择自己选择想要的cells转换为Seurat对象。</p>
<span id="more"></span>

<p>将.loom文件格式数据转换为SeuratObject，需要SeuratDisk包。</p>
<h2 id="1-SeuratDisk包安装"><a href="#1-SeuratDisk包安装" class="headerlink" title="1. SeuratDisk包安装"></a>1. SeuratDisk包安装</h2><p>SeuratDisk包只能通过github安装，因此，需要下载devtools，然后再用devtools通过github安装。</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">install.packages<span class="punctuation">(</span><span class="string">&quot;devtools&quot;</span><span class="punctuation">)</span></span><br><span class="line">devtools<span class="operator">::</span>install_github<span class="punctuation">(</span><span class="string">&quot;mojaveazure/SeuratDisk&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<h2 id="2-loom文件格式"><a href="#2-loom文件格式" class="headerlink" title="2. .loom文件格式"></a>2. .loom文件格式</h2><p>loom文件格式是HDF5文件的文件结构，可以有效地储存大型单细胞数据集。可以使用<a href="https://www.hdfgroup.org/downloads/hdfview/">HDFview</a>来查看其数据格式。<br>打开之后，数据格式如下：<br><img src="/pics/2022-0830-loom.jfif" alt="alt 图标"><br>&#x2F;matrix中储存基因*细胞矩阵，&#x2F;attrs中储存数据的一些相关信息，如数据创建日期，&#x2F;col_attrs中储存矩阵列（细胞）的信息，如CellID、ClusterID、Embeddings信息等，&#x2F;row_attrs中储存矩阵行（基因）的信息，如基因ID、细胞marker等。&#x2F;layers中储存另外的基因*矩阵，例如scale.data。</p>
<h2 id="3-将loom转换为Seurat"><a href="#3-将loom转换为Seurat" class="headerlink" title="3. 将loom转换为Seurat"></a>3. 将loom转换为Seurat</h2><p>由于Seurat::as.Seurat()所识别的loom文件和FCA数据库中的loom文件格式不太一样，因此不能直接转换，只能自己构建。<br>导入loom文件，并读取基因*细胞矩阵，这样读取的矩阵是raw counts，可以直接根据矩阵的属性访问。</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line"><span class="operator">&gt;</span> library<span class="punctuation">(</span>Seurat<span class="punctuation">)</span></span><br><span class="line"><span class="operator">&gt;</span> library<span class="punctuation">(</span>SeuratDisk<span class="punctuation">)</span></span><br><span class="line"><span class="operator">&gt;</span> ds <span class="operator">&lt;-</span> Connect<span class="punctuation">(</span><span class="string">&quot;r_fca_biohub_body_10x.loom&quot;</span><span class="punctuation">,</span>mode <span class="operator">=</span> <span class="string">&quot;r&quot;</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment"># 读取全部矩阵</span></span><br><span class="line"><span class="operator">&gt;</span> fca_body_mat <span class="operator">&lt;-</span> ds<span class="punctuation">[[</span><span class="string">&quot;/matrix&quot;</span><span class="punctuation">]</span><span class="punctuation">]</span><span class="punctuation">[</span><span class="punctuation">,</span><span class="punctuation">]</span></span><br><span class="line"><span class="comment"># 访问矩阵第一行第一列元素</span></span><br><span class="line"><span class="operator">&gt;</span> ds<span class="punctuation">[[</span><span class="string">&quot;/matrix&quot;</span><span class="punctuation">]</span><span class="punctuation">]</span><span class="punctuation">[</span><span class="number">1</span><span class="punctuation">,</span><span class="number">1</span><span class="punctuation">]</span></span><br><span class="line">	<span class="number">0</span></span><br><span class="line"><span class="comment"># 读取矩阵的维度</span></span><br><span class="line"><span class="operator">&gt;</span> ds<span class="punctuation">[[</span><span class="string">&quot;/matrix&quot;</span><span class="punctuation">]</span><span class="punctuation">]</span><span class="operator">$</span>dims</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>读取loom文件中储存的细胞ID和基因ID信息，分别为矩阵的列名和行名。</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">fca_body_cellid <span class="operator">&lt;-</span> ds<span class="punctuation">[[</span><span class="string">&quot;/col_attrs/CellID&quot;</span><span class="punctuation">]</span><span class="punctuation">]</span><span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">fca_body_geneid <span class="operator">&lt;-</span> ds<span class="punctuation">[[</span><span class="string">&quot;/row_attrs/Gene&quot;</span><span class="punctuation">]</span><span class="punctuation">]</span><span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">colnames<span class="punctuation">(</span>fca_body_mat<span class="punctuation">)</span> <span class="operator">&lt;-</span> fca_body_geneid</span><br><span class="line">rownames<span class="punctuation">(</span>fca_body_mat<span class="punctuation">)</span> <span class="operator">&lt;-</span> fca_body_cellid</span><br></pre></td></tr></table></figure>

<p>将自己所需要的细胞ID存储于一个文件中并进行读取。</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">mycell <span class="operator">&lt;-</span> read.table<span class="punctuation">(</span>file <span class="operator">=</span> <span class="string">&quot;attrs_myline.txt&quot;</span><span class="punctuation">,</span>header <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">,</span></span><br><span class="line">sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">)</span></span><br><span class="line">mycell <span class="operator">&lt;-</span> mycell<span class="operator">$</span>CellID</span><br><span class="line">mycell <span class="operator">&lt;-</span> as.array<span class="punctuation">(</span>mycell<span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p>提取自己所需要的细胞的矩阵。</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">fca_my_mat <span class="operator">&lt;-</span> fca_body_mat<span class="punctuation">[</span>rownames<span class="punctuation">(</span>fca_body_mat<span class="punctuation">)</span> <span class="operator">%in%</span> mycell<span class="punctuation">,</span><span class="punctuation">]</span></span><br><span class="line">rm<span class="punctuation">(</span>fca_body_mat<span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p>将矩阵转换为稀疏矩阵(节省空间)并进行转置。</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">fca_my_mat <span class="operator">&lt;-</span> Matrix<span class="operator">::</span>Matrix<span class="punctuation">(</span>fca_my_mat<span class="punctuation">,</span> sparse<span class="operator">=</span><span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line">fca_my_mat <span class="operator">&lt;-</span> Matrix<span class="operator">::</span>t<span class="punctuation">(</span>fca_my_mat<span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<p>提取所需要的meta信息。</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">attrs <span class="operator">&lt;-</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&#x27;CellID&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;ClusterID&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;n_counts&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;n_genes&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;percent_mito&#x27;</span><span class="punctuation">,</span><span class="string">&#x27;sex&#x27;</span><span class="punctuation">,</span></span><br><span class="line"><span class="string">&#x27;annotation&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;annotation_broad&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;S_annotation_broad_extrapolated&#x27;</span><span class="punctuation">)</span></span><br><span class="line">attrs_df <span class="operator">&lt;-</span> map_dfc<span class="punctuation">(</span>attrs<span class="punctuation">,</span> <span class="operator">~</span> ds<span class="punctuation">[[</span>paste0<span class="punctuation">(</span><span class="string">&quot;col_attrs/&quot;</span><span class="punctuation">,</span> .<span class="punctuation">)</span><span class="punctuation">]</span><span class="punctuation">]</span><span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span> as.data.frame<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line">colnames<span class="punctuation">(</span>attrs_df<span class="punctuation">)</span> <span class="operator">&lt;-</span> attrs</span><br><span class="line">rownames<span class="punctuation">(</span>attrs_df<span class="punctuation">)</span> <span class="operator">&lt;-</span> fca_body_cellid</span><br><span class="line"></span><br><span class="line">attrs_df <span class="operator">&lt;-</span> attrs_df<span class="punctuation">[</span>rownames<span class="punctuation">(</span>attrs_df<span class="punctuation">)</span> <span class="operator">%in%</span> mycell<span class="punctuation">,</span><span class="punctuation">]</span></span><br><span class="line">write.table<span class="punctuation">(</span>attrs_df<span class="punctuation">,</span><span class="string">&quot;attrs.txt&quot;</span><span class="punctuation">,</span>sep<span class="operator">=</span><span class="string">&quot;\t&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<p>如果我们不想要数据库已经注释好的信息，想要自己的注释，例如合并某些cluster，怎么办呢？<br>我们可以在输出的attrs.txt中加上一列my_annotation，然后就可以啦。</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">attrs <span class="operator">&lt;-</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&#x27;CellID&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;ClusterID&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;n_counts&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;n_genes&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;percent_mito&#x27;</span><span class="punctuation">,</span><span class="string">&#x27;sex&#x27;</span><span class="punctuation">,</span></span><br><span class="line"><span class="string">&#x27;annotation&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;my_annotation&#x27;</span><span class="punctuation">,</span><span class="string">&#x27;annotation_broad&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;S_annotation_broad_extrapolated&#x27;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">attrs_df <span class="operator">&lt;-</span> read.table<span class="punctuation">(</span>file <span class="operator">=</span> <span class="string">&quot;attrs_my.txt&quot;</span><span class="punctuation">,</span>sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span>header <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line">colnames<span class="punctuation">(</span>attrs_df<span class="punctuation">)</span> <span class="operator">&lt;-</span> attrs</span><br><span class="line">rownames<span class="punctuation">(</span>attrs_df<span class="punctuation">)</span> <span class="operator">&lt;-</span> attrs_df<span class="operator">$</span>CellID</span><br><span class="line"></span><br><span class="line">fca_my_seurat <span class="operator">&lt;-</span> CreateSeuratObject<span class="punctuation">(</span>counts <span class="operator">=</span> fca_my_mat<span class="punctuation">,</span></span><br><span class="line">	meta.data <span class="operator">=</span> attrs_df<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">fca_my_seurat<span class="operator">@</span>active.ident <span class="operator">&lt;-</span> as.factor<span class="punctuation">(</span>fca_my_seurat<span class="operator">$</span>my_annotation<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">saveRDS<span class="punctuation">(</span>fca_my_seurat<span class="punctuation">,</span>file <span class="operator">=</span> <span class="string">&quot;fca_my_seurat.rds&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<p>这样构建出的SeuratObject就有了自己想要的细胞的表达矩阵以及meta信息，可以进行接下来的分析了。</p>
]]></content>
      <categories>
        <category>R</category>
        <category>Seurat</category>
      </categories>
      <tags>
        <tag>scRNA-seq</tag>
        <tag>Seurat</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux常用命令总结-sed、awk、grep、cut</title>
    <url>/2022/08/30/Linux%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4%E6%80%BB%E7%BB%93-sed%E3%80%81awk%E3%80%81grep%E3%80%81cut/</url>
    <content><![CDATA[<p>记性不好，这里总结一些自己常用的命令，会持续更新，以后用到的会再添加上：</p>
<ul>
<li>sed</li>
<li>awk</li>
<li>grep</li>
<li>cut<span id="more"></span></li>
</ul>
<h2 id="1-sed"><a href="#1-sed" class="headerlink" title="1.sed"></a>1.sed</h2><h3 id="1-1-sed替换"><a href="#1-1-sed替换" class="headerlink" title="1.1 sed替换"></a>1.1 sed替换</h3><p>直接替换file.txt文件中指定的内容，g:全局替换</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sed -i <span class="string">&#x27;1,$s/abc/123/g&#x27;</span> file.txt</span><br></pre></td></tr></table></figure>
<p>不修改文件中的内容，替换后直接输出到屏幕</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sed <span class="string">&#x27;1,$s/abc/123/g&#x27;</span> file.txt</span><br></pre></td></tr></table></figure>
<p>批量替换当前目录下以file开头的文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sed <span class="string">&#x27;1,$s/abc/123/g&#x27;</span> file*</span><br></pre></td></tr></table></figure>

<h3 id="1-2-sed查看"><a href="#1-2-sed查看" class="headerlink" title="1.2 sed查看"></a>1.2 sed查看</h3><p>打印出2-5行，并不改变文件中内容:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sed -n <span class="string">&#x27;2,5p&#x27;</span> file.txt</span><br></pre></td></tr></table></figure>
<h3 id="1-3-sed删除"><a href="#1-3-sed删除" class="headerlink" title="1.3 sed删除"></a>1.3 sed删除</h3><p>删除第2行、2-5行、2至最后：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sed <span class="string">&#x27;2d&#x27;</span> file.txt</span><br><span class="line">sed <span class="string">&#x27;2,5d&#x27;</span> file.txt</span><br><span class="line">sed <span class="string">&#x27;2,$d&#x27;</span> file.txt</span><br></pre></td></tr></table></figure>
<h3 id="1-4-sed添加"><a href="#1-4-sed添加" class="headerlink" title="1.4 sed添加"></a>1.4 sed添加</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sed <span class="string">&#x27;2a add line&#x27;</span> file.txt <span class="comment"># 在第2行后添加&quot;add line&quot;</span></span><br><span class="line">sed <span class="string">&#x27;2i insert line&#x27;</span> file.txt <span class="comment"># 在第2行前添加&quot;insert line&quot;</span></span><br><span class="line">sed <span class="string">&#x27;2a add line1 \</span></span><br><span class="line"><span class="string">add line2&#x27;</span> file.txt <span class="comment"># 在第二行后添加两行用反斜线</span></span><br></pre></td></tr></table></figure>

<h3 id="1-5-sed查找"><a href="#1-5-sed查找" class="headerlink" title="1.5 sed查找"></a>1.5 sed查找</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sed -n <span class="string">&#x27;/ooo/p&#x27;</span> file.txt <span class="comment"># 查找含有关键字ooo的行</span></span><br><span class="line">sed -n <span class="string">&#x27;/ooo/d&#x27;</span> file.txt <span class="comment"># 查找并删除该行</span></span><br><span class="line">sed -n <span class="string">&#x27;/ooo/&#123;s/ooo/kkk/;p;q&#125;&#x27;</span> <span class="comment"># 查找有ooo的行,替换为kkk，并输出，q:退出</span></span><br></pre></td></tr></table></figure>

<h3 id="1-5-sed多点编辑"><a href="#1-5-sed多点编辑" class="headerlink" title="1.5 sed多点编辑"></a>1.5 sed多点编辑</h3><p>删除第二行，并将ooo替换为kkk。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sed -e <span class="string">&#x27;2d&#x27;</span> -e <span class="string">&#x27;s/ooo/kkk/&#x27;</span></span><br></pre></td></tr></table></figure>

<h2 id="2-awk"><a href="#2-awk" class="headerlink" title="2.awk"></a>2.awk</h2><h3 id="2-1-awk基本用法"><a href="#2-1-awk基本用法" class="headerlink" title="2.1 awk基本用法"></a>2.1 awk基本用法</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">awk <span class="string">&#x27;&#123;print $1,$2&#125;&#x27;</span> file.txt</span><br><span class="line">awk -F, <span class="string">&#x27;&#123;pritn $1,$2&#125;&#x27;</span> file.txt <span class="comment"># -F,按逗号分割</span></span><br><span class="line">awk -f try.awk file.txt <span class="comment"># -f后加awk脚本</span></span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th align="center">内置变量</th>
<th align="center">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="center">$n</td>
<td align="center">当前记录的第n个字段，字段间由FS分隔</td>
</tr>
<tr>
<td align="center">$0</td>
<td align="center">完整的输入记录</td>
</tr>
<tr>
<td align="center">FS</td>
<td align="center">字段分隔符(默认是任何空格)</td>
</tr>
<tr>
<td align="center">IGNORECASE</td>
<td align="center">如果为真，则进行忽略大小写的匹配</td>
</tr>
<tr>
<td align="center">NF</td>
<td align="center">一条记录的字段的数目</td>
</tr>
<tr>
<td align="center">NR</td>
<td align="center">已经读出的记录数，就是行号，从1开始</td>
</tr>
<tr>
<td align="center">OFS</td>
<td align="center">输出字段分隔符，默认值与输入字段分隔符一致。</td>
</tr>
<tr>
<td align="center">ORS</td>
<td align="center">输出记录分隔符(默认值是一个换行符)</td>
</tr>
<tr>
<td align="center">RS</td>
<td align="center">记录分隔符(默认是一个换行符)</td>
</tr>
</tbody></table>
<h3 id="2-2-awk运算符"><a href="#2-2-awk运算符" class="headerlink" title="2.2 awk运算符"></a>2.2 awk运算符</h3><table>
<thead>
<tr>
<th align="center">运算符</th>
<th align="center">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="center">&#x3D;;+&#x3D;,-&#x3D;,*&#x3D;,&#x2F;&#x3D;;%&#x3D;;**&#x3D;;^&#x3D;</td>
<td align="center">赋值运算符</td>
</tr>
<tr>
<td align="center">||;&amp;&amp;</td>
<td align="center">逻辑或、与</td>
</tr>
<tr>
<td align="center">~;!~</td>
<td align="center">正则表达式匹配与不匹配</td>
</tr>
<tr>
<td align="center">&lt;;&lt;&#x3D;;&gt;;&gt;&#x3D;;!&#x3D;;&#x3D;&#x3D;</td>
<td align="center">关系运算符</td>
</tr>
</tbody></table>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">awk <span class="string">&#x27;$1==2 &#123;print $1,$3&#125;&#x27;</span> log.txt</span><br><span class="line">awk <span class="string">&#x27;$1&gt;2 &amp;&amp; $2==&quot;aaa&quot; &#123;print $1,$2,$3&#125;&#x27;</span> log.txt</span><br></pre></td></tr></table></figure>

<h3 id="2-3-awk正则匹配"><a href="#2-3-awk正则匹配" class="headerlink" title="2.3 awk正则匹配"></a>2.3 awk正则匹配</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">awk <span class="string">&#x27;$2 ~ /th/ &#123;print $2,$4&#125;&#x27;</span> log.txt</span><br><span class="line">awk <span class="string">&#x27;/re/ &#x27;</span> log.txt</span><br><span class="line">awk <span class="string">&#x27;BEGIN&#123;IGNORECASE=1&#125; /this/&#x27;</span> log.txt  <span class="comment"># 忽略大小写</span></span><br><span class="line">awk <span class="string">&#x27;$2 !~ /th/ &#123;print $2,$4&#125;&#x27;</span> log.txt </span><br><span class="line">awk <span class="string">&#x27;!/th/ &#123;print $2,$4&#125;&#x27;</span> log.txt</span><br></pre></td></tr></table></figure>

<h3 id="2-2-awk-if条件语句"><a href="#2-2-awk-if条件语句" class="headerlink" title="2.2 awk if条件语句"></a>2.2 awk if条件语句</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">awk <span class="string">&#x27;BEGIN &#123;</span></span><br><span class="line"><span class="string">a=20;</span></span><br><span class="line"><span class="string">if (a==10)</span></span><br><span class="line"><span class="string">  print &quot;a = 10&quot;;</span></span><br><span class="line"><span class="string">else</span></span><br><span class="line"><span class="string">  print &quot;a = 20&quot;;</span></span><br><span class="line"><span class="string">&#125;&#x27;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">awk -F, <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">	if($2~/sa59.*/)</span></span><br><span class="line"><span class="string">		print &quot;s1_&quot;$1; </span></span><br><span class="line"><span class="string">	else if($2~/sa60.*/)</span></span><br><span class="line"><span class="string">		print &quot;s2_&quot;$1; </span></span><br><span class="line"><span class="string">	else print &quot;s3_&quot;$1&#125;&#x27;</span> </span><br></pre></td></tr></table></figure>
<h2 id="3-grep"><a href="#3-grep" class="headerlink" title="3.grep"></a>3.grep</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">grep -v <span class="string">&quot;aaa&quot;</span> <span class="comment"># -v 反向匹配</span></span><br><span class="line"><span class="comment"># -F Interpret PATTERN as a list of fixed strings, separated by newlines, any of which is to be matched. 将样式视为固定字符串的列表。</span></span><br><span class="line"><span class="comment"># -f后面加文件，文件中每一行为一个pattern</span></span><br><span class="line"><span class="built_in">cat</span> test.txt | grep -F -f file.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># -i 忽略字符大小写</span></span><br><span class="line">grep -i <span class="string">&quot;aaa&quot;</span> <span class="built_in">test</span></span><br></pre></td></tr></table></figure>

<h2 id="4-cut"><a href="#4-cut" class="headerlink" title="4.cut"></a>4.cut</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cut</span> -b 2 file.txt   <span class="comment"># 以字节为单位分隔</span></span><br><span class="line"><span class="built_in">cut</span> -c 2- file.txt  <span class="comment"># 以字符为单位分隔，提取第二到最后一个字符</span></span><br><span class="line"><span class="built_in">cut</span> -c 2,4 file.txt <span class="comment"># 以字符为单位分隔，提取第2、4个字符</span></span><br><span class="line"><span class="built_in">cut</span> -c 2-7 file.txt <span class="comment"># 以字符为单位分隔，提取第2至7个字符</span></span><br><span class="line"><span class="built_in">cut</span> -d <span class="string">&quot;,&quot;</span> -f 2 file.txt <span class="comment">#以逗号为分隔符，提取第二个字段</span></span><br><span class="line"><span class="built_in">cut</span> -d <span class="string">&quot;,&quot;</span> -f 2- file.txt</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>linux</tag>
      </tags>
  </entry>
  <entry>
    <title>scRNA-seq分析之Seurat流程</title>
    <url>/2022/09/08/scRNA-seq%E5%88%86%E6%9E%90%E4%B9%8BSeurat%E6%B5%81%E7%A8%8B/</url>
    <content><![CDATA[<p>本文介绍Seurat进行单细胞聚类的流程。</p>
<span id="more"></span>

<h3 id="1-创建对象"><a href="#1-创建对象" class="headerlink" title="1. 创建对象"></a>1. 创建对象</h3><p>首先需要读取数据，并创建Seurat对象，同时过滤掉在少于3个细胞中表达的基因以及检测到的feature少于200的细胞。</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">mydata <span class="operator">&lt;-</span> Read10X<span class="punctuation">(</span>data.dir <span class="operator">=</span> <span class="string">&quot;D:/000 MyWork/000 MyProject/000 scVariants/sample1&quot;</span><span class="punctuation">,</span></span><br><span class="line">                 gene.column <span class="operator">=</span> <span class="number">1</span><span class="punctuation">)</span></span><br><span class="line">mydata <span class="operator">&lt;-</span> CreateSeuratObject<span class="punctuation">(</span>counts <span class="operator">=</span> mydata<span class="punctuation">,</span>project <span class="operator">=</span> <span class="string">&quot;sample1&quot;</span><span class="punctuation">,</span></span><br><span class="line">                            min.cells <span class="operator">=</span> <span class="number">3</span><span class="punctuation">,</span>min.features <span class="operator">=</span> <span class="number">200</span><span class="punctuation">,</span></span><br><span class="line">                            assay <span class="operator">=</span> <span class="string">&quot;RNA&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<h3 id="2-数据质控"><a href="#2-数据质控" class="headerlink" title="2. 数据质控"></a>2. 数据质控</h3><p>常用的质控指标包括：</p>
<ul>
<li>每个细胞的唯一基因数目 feature number<ul>
<li>低质量或空液泡往往只能检测到少量基因</li>
<li>双液泡（doublet）或多液泡（multiplets）会具有异常多的基因数目</li>
</ul>
</li>
<li>每个细胞的总counts数（相当于每个细胞的测序深度）<ul>
<li>线粒体基因占比</li>
<li>低质量或死细胞会具有异常高的线粒体基因表达</li>
</ul>
</li>
</ul>
<p>这里计算线粒体基因的表达比例，并且查看feature number、count number、线粒体基因占比的小提琴图。</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">mydata<span class="punctuation">[[</span><span class="string">&quot;percent.mt&quot;</span><span class="punctuation">]</span><span class="punctuation">]</span> <span class="operator">&lt;-</span> PercentageFeatureSet<span class="punctuation">(</span>mydata<span class="punctuation">,</span>pattern <span class="operator">=</span> <span class="string">&quot;^mt:&quot;</span><span class="punctuation">)</span></span><br><span class="line">VlnPlot<span class="punctuation">(</span>object <span class="operator">=</span> mydata<span class="punctuation">,</span> </span><br><span class="line">        features <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;nFeature_RNA&quot;</span><span class="punctuation">,</span> <span class="string">&quot;nCount_RNA&quot;</span><span class="punctuation">,</span> <span class="string">&quot;percent.mt&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span> </span><br><span class="line">        ncol <span class="operator">=</span> <span class="number">3</span><span class="punctuation">)</span></span><br><span class="line">VlnPlot<span class="punctuation">(</span>object <span class="operator">=</span> mydata<span class="punctuation">,</span></span><br><span class="line">        features <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;nFeature_RNA&quot;</span><span class="punctuation">,</span> <span class="string">&quot;nCount_RNA&quot;</span><span class="punctuation">,</span> <span class="string">&quot;percent.mt&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">        idents <span class="operator">=</span> <span class="literal">NULL</span><span class="punctuation">,</span>assay <span class="operator">=</span> <span class="literal">NULL</span><span class="punctuation">,</span>pt.size <span class="operator">=</span> <span class="number">0</span><span class="punctuation">,</span>ncol <span class="operator">=</span> <span class="number">3</span><span class="punctuation">)</span></span><br><span class="line">mydata <span class="operator">&lt;-</span> subset<span class="punctuation">(</span>mydata<span class="punctuation">,</span> subset <span class="operator">=</span> nFeature_RNA <span class="operator">&gt;</span> <span class="number">500</span></span><br><span class="line">                <span class="operator">&amp;</span> nFeature_RNA <span class="operator">&lt;</span> <span class="number">5000</span> <span class="operator">&amp;</span> percent.mt <span class="operator">&lt;</span> <span class="number">5</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p>根据小提琴图的情况来决定过滤的标准，有个更好的质控方法是根据质控指标的分位数进行过滤，例如过滤掉 nFeature_RNA 上四分位数和下四分位数的细胞。但是有时候也会感觉标准略微严格，如果我想尽可能多地保留细胞，那也可以只过滤掉一些离群值。</p>
<h3 id="3-normalization"><a href="#3-normalization" class="headerlink" title="3. normalization"></a>3. normalization</h3><p>质控之后，进行counts的normalization，默认使用 “LogNormalize” 的方法，即将每个基因的counts除以细胞总的counts数，乘上10,000，再进行对数转换。这种转换的目的？</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">mydata <span class="operator">&lt;-</span> NormalizeData<span class="punctuation">(</span>mydata<span class="punctuation">,</span>scale.factor <span class="operator">=</span> <span class="number">10000</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>Seurat提供了另外的normalization方法，通过 normalization.method 指定， 包括：</p>
<ul>
<li>“CLR”: centered log ratio transformation</li>
<li>“RC”: equals to “LogNormalize” without log-transformation</li>
</ul>
</blockquote>
<h3 id="4-特征选择"><a href="#4-特征选择" class="headerlink" title="4. 特征选择"></a>4. 特征选择</h3><p>鉴定高变基因（代表了细胞之间主要的生物学差异）进行后续分析，默认选择前2000个。</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">mydata <span class="operator">&lt;-</span> FindVariableFeatures<span class="punctuation">(</span>mydata<span class="punctuation">,</span> </span><br><span class="line">                                selection.method <span class="operator">=</span> <span class="string">&quot;vst&quot;</span><span class="punctuation">,</span> nfeatures <span class="operator">=</span> <span class="number">2000</span><span class="punctuation">)</span></span><br><span class="line">top10 <span class="operator">&lt;-</span> head<span class="punctuation">(</span>VariableFeatures<span class="punctuation">(</span>mydata<span class="punctuation">)</span><span class="punctuation">,</span> <span class="number">10</span><span class="punctuation">)</span></span><br><span class="line">plot1 <span class="operator">&lt;-</span> VariableFeaturePlot<span class="punctuation">(</span>mydata<span class="punctuation">)</span></span><br><span class="line">plot2 <span class="operator">&lt;-</span> LabelPoints<span class="punctuation">(</span>plot <span class="operator">=</span> plot1<span class="punctuation">,</span> points <span class="operator">=</span> top10<span class="punctuation">,</span> repel <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">,</span></span><br><span class="line">                     xnudge <span class="operator">=</span> <span class="number">0</span><span class="punctuation">,</span>ynudge <span class="operator">=</span> <span class="number">0</span><span class="punctuation">)</span></span><br><span class="line">plot1</span><br><span class="line">plot2</span><br></pre></td></tr></table></figure>

<h3 id="5-数据缩放"><a href="#5-数据缩放" class="headerlink" title="5. 数据缩放"></a>5. 数据缩放</h3><p>对数据进行缩放scaling，目的是使数据的均值为0，方差为1。</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">all.genes <span class="operator">&lt;-</span> rownames<span class="punctuation">(</span>mydata<span class="punctuation">)</span></span><br><span class="line">mydata<span class="punctuation">[[</span><span class="string">&quot;percent.mt&quot;</span><span class="punctuation">]</span><span class="punctuation">]</span> <span class="operator">&lt;-</span> PercentageFeatureSet<span class="punctuation">(</span>mydata<span class="punctuation">,</span></span><br><span class="line">                                               pattern <span class="operator">=</span> <span class="string">&quot;^mt:&quot;</span><span class="punctuation">,</span>assay<span class="operator">=</span><span class="string">&quot;RNA&quot;</span><span class="punctuation">)</span></span><br><span class="line">mydata <span class="operator">&lt;-</span> ScaleData<span class="punctuation">(</span>mydata<span class="punctuation">,</span> features <span class="operator">=</span> all.genes<span class="punctuation">,</span>vars.to.regress <span class="operator">=</span> <span class="string">&quot;percent.mt&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>Seurat v4.0版本中新的标准化方法SCTransform，这个函数可以替代三个函数normalization、Scale、FindVariableFeatures的功能。</p>
</blockquote>
<h3 id="6-线性降维"><a href="#6-线性降维" class="headerlink" title="6. 线性降维"></a>6. 线性降维</h3><p>只用2000个高变基因进行PCA线性降维，根据ElbowPlot函数的拐点确定后续用于分析的PCA主成分数。</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">mydata <span class="operator">&lt;-</span> RunPCA<span class="punctuation">(</span>mydata<span class="punctuation">,</span> npcs <span class="operator">=</span> <span class="number">20</span><span class="punctuation">,</span> verbose <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">)</span></span><br><span class="line">DimPlot<span class="punctuation">(</span>mydata<span class="punctuation">,</span> reduction <span class="operator">=</span> <span class="string">&quot;pca&quot;</span><span class="punctuation">)</span></span><br><span class="line">DimHeatmap<span class="punctuation">(</span>mydata<span class="punctuation">,</span> dims <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span><span class="number">20</span><span class="punctuation">,</span> cells <span class="operator">=</span> <span class="number">500</span><span class="punctuation">,</span> balanced <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">)</span></span><br><span class="line">mydata <span class="operator">&lt;-</span> JackStraw<span class="punctuation">(</span>mydata<span class="punctuation">,</span> num.replicate <span class="operator">=</span> <span class="number">100</span><span class="punctuation">)</span></span><br><span class="line">mydata <span class="operator">&lt;-</span> ScoreJackStraw<span class="punctuation">(</span>mydata<span class="punctuation">,</span> dims <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span><span class="number">20</span><span class="punctuation">)</span></span><br><span class="line">JackStrawPlot<span class="punctuation">(</span>mydata<span class="punctuation">,</span> dims <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span><span class="number">20</span><span class="punctuation">)</span></span><br><span class="line">ElbowPlot<span class="punctuation">(</span>mydata<span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<h3 id="7-细胞聚类"><a href="#7-细胞聚类" class="headerlink" title="7. 细胞聚类"></a>7. 细胞聚类</h3><figure class="highlight r"><table><tr><td class="code"><pre><span class="line">mydata <span class="operator">&lt;-</span> FindNeighbors<span class="punctuation">(</span>mydata<span class="punctuation">,</span> reduction <span class="operator">=</span> <span class="string">&quot;pca&quot;</span><span class="punctuation">,</span> dims <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span><span class="number">20</span><span class="punctuation">)</span></span><br><span class="line">mydata <span class="operator">&lt;-</span> FindClusters<span class="punctuation">(</span>mydata<span class="punctuation">,</span> resolution <span class="operator">=</span> <span class="number">0.4</span><span class="punctuation">)</span></span><br><span class="line">mydata <span class="operator">&lt;-</span> RunUMAP<span class="punctuation">(</span>mydata<span class="punctuation">,</span> reduction <span class="operator">=</span> <span class="string">&quot;pca&quot;</span><span class="punctuation">,</span> dims <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span><span class="number">20</span><span class="punctuation">)</span></span><br><span class="line">mydata <span class="operator">&lt;-</span> RunTSNE<span class="punctuation">(</span>mydata<span class="punctuation">,</span>reduction <span class="operator">=</span> <span class="string">&quot;pca&quot;</span><span class="punctuation">,</span>dims <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span><span class="number">20</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<h3 id="8-UMAP-x2F-tSNE降维"><a href="#8-UMAP-x2F-tSNE降维" class="headerlink" title="8. UMAP&#x2F;tSNE降维"></a>8. UMAP&#x2F;tSNE降维</h3><figure class="highlight r"><table><tr><td class="code"><pre><span class="line">p1 <span class="operator">&lt;-</span> DimPlot<span class="punctuation">(</span>mydata<span class="punctuation">,</span> reduction <span class="operator">=</span> <span class="string">&quot;umap&quot;</span><span class="punctuation">)</span></span><br><span class="line">p2 <span class="operator">&lt;-</span> DimPlot<span class="punctuation">(</span>mydata<span class="punctuation">,</span> reduction <span class="operator">=</span> <span class="string">&quot;umap&quot;</span><span class="punctuation">,</span> label <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">,</span> repel <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">)</span></span><br><span class="line">p1<span class="operator">+</span>p2</span><br><span class="line"></span><br><span class="line">p3 <span class="operator">&lt;-</span> DimPlot<span class="punctuation">(</span>mydata<span class="punctuation">,</span> reduction <span class="operator">=</span> <span class="string">&quot;tsne&quot;</span><span class="punctuation">)</span></span><br><span class="line">p4 <span class="operator">&lt;-</span> DimPlot<span class="punctuation">(</span>mydata<span class="punctuation">,</span> reduction <span class="operator">=</span> <span class="string">&quot;tsne&quot;</span><span class="punctuation">,</span> label <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">,</span> repel <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">)</span></span><br><span class="line">p3<span class="operator">+</span>p4</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="9-鉴定细胞类群的marker"><a href="#9-鉴定细胞类群的marker" class="headerlink" title="9. 鉴定细胞类群的marker"></a>9. 鉴定细胞类群的marker</h3><p>FindMarkers返回指定指定cluster之间的marker。<br>FindAllMarkers 可以一次寻找所有clusters的markers，但只返回上调的markers。<br>VlnPlot绘制表达情况的小提琴图；FeaturePlot绘制表达情况的细胞降维图。</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line"><span class="comment"># find all markers distinguishing cluster 5 from clusters 0 and 3</span></span><br><span class="line">cluster5.markers <span class="operator">&lt;-</span> FindMarkers<span class="punctuation">(</span>mydata<span class="punctuation">,</span> ident.1 <span class="operator">=</span> <span class="number">5</span><span class="punctuation">,</span> ident.2 <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">0</span><span class="punctuation">,</span> <span class="number">3</span><span class="punctuation">)</span><span class="punctuation">,</span> min.pct <span class="operator">=</span> <span class="number">0.25</span><span class="punctuation">)</span></span><br><span class="line">head<span class="punctuation">(</span>cluster5.markers<span class="punctuation">,</span> n <span class="operator">=</span> <span class="number">5</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># find markers for every cluster compared to all remaining cells, report only the positive ones</span></span><br><span class="line">mydata.markers <span class="operator">&lt;-</span> FindAllMarkers<span class="punctuation">(</span>mydata<span class="punctuation">,</span> only.pos <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">,</span> min.pct <span class="operator">=</span> <span class="number">0.25</span><span class="punctuation">,</span> logfc.threshold <span class="operator">=</span> <span class="number">0.25</span></span><br><span class="line">mydata.markers <span class="operator">%&gt;%</span></span><br><span class="line">    group_by<span class="punctuation">(</span>cluster<span class="punctuation">)</span> <span class="operator">%&gt;%</span></span><br><span class="line">    slice_max<span class="punctuation">(</span>n <span class="operator">=</span> <span class="number">2</span><span class="punctuation">,</span> order_by <span class="operator">=</span> avg_log2FC<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">VlnPlot<span class="punctuation">(</span>mydata<span class="punctuation">,</span> features <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;MS4A1&quot;</span><span class="punctuation">,</span> <span class="string">&quot;CD79A&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">FeaturePlot<span class="punctuation">(</span>mydata<span class="punctuation">,</span> features <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;MS4A1&quot;</span><span class="punctuation">,</span> <span class="string">&quot;CD79A&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<h3 id="10-细胞注释"><a href="#10-细胞注释" class="headerlink" title="10. 细胞注释"></a>10. 细胞注释</h3><p>进行细胞注释，重命名cluster ID为细胞类型。</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">new.cluster.ids <span class="operator">&lt;-</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;Naive CD4 T&quot;</span><span class="punctuation">,</span> <span class="string">&quot;CD14+ Mono&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Memory CD4 T&quot;</span><span class="punctuation">,</span> <span class="string">&quot;B&quot;</span><span class="punctuation">,</span> <span class="string">&quot;CD8 T&quot;</span><span class="punctuation">,</span> <span class="string">&quot;FCGR3A+ Mono&quot;</span><span class="punctuation">,</span><span class="string">&quot;NK&quot;</span><span class="punctuation">,</span> <span class="string">&quot;DC&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Platelet&quot;</span><span class="punctuation">)</span></span><br><span class="line"><span class="built_in">names</span><span class="punctuation">(</span>new.cluster.ids<span class="punctuation">)</span> <span class="operator">&lt;-</span> levels<span class="punctuation">(</span>mydata<span class="punctuation">)</span></span><br><span class="line">mydata <span class="operator">&lt;-</span> RenameIdents<span class="punctuation">(</span>mydata<span class="punctuation">,</span> new.cluster.ids<span class="punctuation">)</span></span><br><span class="line">DimPlot<span class="punctuation">(</span>mydata<span class="punctuation">,</span> reduction <span class="operator">=</span> <span class="string">&quot;umap&quot;</span><span class="punctuation">,</span> label <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">,</span> pt.size <span class="operator">=</span> <span class="number">0.5</span><span class="punctuation">)</span> <span class="operator">+</span> NoLegend<span class="punctuation">(</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>R</category>
        <category>Seurat</category>
      </categories>
      <tags>
        <tag>scRNA-seq</tag>
        <tag>Seurat</tag>
      </tags>
  </entry>
  <entry>
    <title>三代hifi测序之基因组组装</title>
    <url>/2022/09/08/%E4%B8%89%E4%BB%A3hifi%E6%B5%8B%E5%BA%8F%E4%B9%8B%E5%9F%BA%E5%9B%A0%E7%BB%84%E7%BB%84%E8%A3%85/</url>
    <content><![CDATA[<p>本文介绍三代hifi基因组测序的组装。</p>
<span id="more"></span>

<h2 id="1-HiFi测序"><a href="#1-HiFi测序" class="headerlink" title="1.HiFi测序"></a>1.HiFi测序</h2><p>HiFi reads（High fidelity reads）是Sequel II三代测序平台推出的兼顾长读长和高准确度的测序序列，2019年由PacBio公司推出，一般采用CCS（Circular Consensus Sequencing）模式测序，HiFi测序能够产出既有较长读长（10-20kb）又具有高序列精度的测序结果（约99.9%）。</p>
<p>环化共有序列CCS的测序方式：构建一个环形的DNA文库，在这种测序模式下，酶读长一般大于插入片段(即被测序片段)长度，因此酶会绕着模板进行滚环测序，插入片段会被多次测序。单次测序中造成的随机测序错误，可以通过算法整合和自我纠错校正来去除，最终得到高准确度的HiFi reads。<br><img src="/pics/2022-0908-hifi.png" alt="alt 图标"></p>
<p>适用于HiFi测序组装的软件有Flye、HiCanu(是Canu软件专门针对HiFi reads优化版本)、hifiasm(速度快、专注解析单倍型)。</p>
<h2 id="2-HiFi测序下机数据"><a href="#2-HiFi测序下机数据" class="headerlink" title="2.HiFi测序下机数据"></a>2.HiFi测序下机数据</h2><p>Sequal平台的下机数据主要有三种：bam文件、bam.pbi文件、xml文件。</p>
<h3 id="2-1-BAM文件"><a href="#2-1-BAM文件" class="headerlink" title="2.1 BAM文件"></a>2.1 BAM文件</h3><p>Pacbio下机数据中的BAM文件是没有比对过的，用于储存序列。<br>第一列：reads信息<br>    {movieName}&#x2F;{holeNumber}&#x2F;{qStart}_{qEnd}<br>    (对于CCS：{movieName}&#x2F;{holeNumber}&#x2F;ccs)<br>    MovieName 是cell的名字，holeNumer是ZMW孔的编号，qStart和qEnd是subreads相对于ZMW reads的位置。<br>第二列 (sum of flags)：比对信息，均为4 代表没有比对上，也表明了bam文件只储存了序列信息，而没有比对信息。<br>第三列 (RNAM)：参考序列，值为*，代表无参考序列<br>第四列 (position) : 比对上的第一个碱基位置 0<br>第五列 (Mapping quality) : 比对质量分数 255<br>第六列 (CIGAR值) : 比对的具体情况<br>第七列 (MRNM, ) : mate 对应的染色体<br>第八列 (mate position) : mate对应的位置 0<br>第九列 (ISIZE, Inferred fragment size) : 推断的插入片段大小 0<br>第十列 (Sequence) : 序列信息 具体的ATCG<br>第十一列 (ASCII码) : 碱基质量分数 ASCII+33<br>第十二列 : 可选区域记录Reads的总体属性包括信号长度，信号强度等信息。</p>
<h3 id="2-2-bam-pbi"><a href="#2-2-bam-pbi" class="headerlink" title="2.2 bam.pbi"></a>2.2 bam.pbi</h3><p>BAM文件的索引文件。</p>
<h2 id="3-hifi-reads组装"><a href="#3-hifi-reads组装" class="headerlink" title="3.hifi reads组装"></a>3.hifi reads组装</h2><h3 id="3-1-flye组装"><a href="#3-1-flye组装" class="headerlink" title="3.1 flye组装"></a>3.1 flye组装</h3><p>用flye进行组装，输入是测序的fasta或fastq文件，所以需要将下机bam文件转换为fasta文件。bam2fastx软件可以实现转换，也可使用samtools转换。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># bam to fasta</span></span><br><span class="line">conda install bam2fastx</span><br><span class="line">bam2fasta -o out.hifi.fa in.subreads.bam</span><br></pre></td></tr></table></figure>
<p>完成转换之后，可以用flye进行组装。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># assembly</span></span><br><span class="line">conda install flye</span><br><span class="line"><span class="comment"># 对pacbio其他数据(Pacbio CLR)用--pabio-raw选项，hifi数据用--pacbio-hifi选项，针对nanopore用--nano-raw选项</span></span><br><span class="line">flye --pacbio-hifi out.hifi.fa --threads 6 --out-dir out</span><br><span class="line"><span class="comment"># some useful option ：</span></span><br><span class="line"><span class="comment"># --genome-size 指定基因组大小</span></span><br><span class="line"><span class="comment"># --hifi-error 指定错误率</span></span><br></pre></td></tr></table></figure>
<p>组装结果，输出文件：<br>assembly.fasta:最终组装结果<br>assembly_graph.gfa&#x2F;assembly_graph.gv:<br>assembly_info.txt:</p>
<h3 id="3-2-hifiasm组装"><a href="#3-2-hifiasm组装" class="headerlink" title="3.2.hifiasm组装"></a>3.2.hifiasm组装</h3><p>hifiasm擅长组装单倍型，其组装有三种模式：只有hifi reads、Hifi reads+ Hi-C、hifi reads＋双亲二代测序的Trio-binning。</p>
<p>hifiasm安装</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#install</span></span><br><span class="line">conda install -c bioconda hifiasm</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/chhylp123/hifiasm</span><br><span class="line"><span class="built_in">cd</span> hifiasm &amp;&amp; make</span><br></pre></td></tr></table></figure>
<p>hifiasm组装，输出为assembly.fa</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 只有hifi reads</span></span><br><span class="line">hifiasm --primary -o out -t 10 out.hifi.fa &gt; assembly.log</span><br><span class="line"><span class="comment"># --primary：no need for genotyping,不需要分型</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># hifi reads+ Hi-C</span></span><br><span class="line">hifiasm -o out.asm -t 10 -h1 read1.fq.gz -h2 read2.fq.gz hifi.reads.fq.gz</span><br></pre></td></tr></table></figure>

<h3 id="4-quast评估"><a href="#4-quast评估" class="headerlink" title="4. quast评估"></a>4. quast评估</h3><p>完成基因组组装之后，要用quast评估组装结果，quast主要是计算contigs数量、总长度、N50、N90、L50、GC rate等等，可以根据参考基因组进行评估，也可以不依据参考基因组进行评估。软件使用：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#install</span></span><br><span class="line">wget -c https://github.com/ablab/quast/releases/download/quast_5.1.0rc1/quast-5.1.0rc1.tar.gz</span><br><span class="line">tar -zxvf quast-5.1.0rc1.tar.gz</span><br><span class="line"></span><br><span class="line">python quast.py assembly.fasta -t 8 -r reference.fa -o quast-r</span><br></pre></td></tr></table></figure>

<p>评估指标：<br>1.contig size<br>    No. of contigs: 组装中的 contigs 总个数。<br>    Largest contig: 最长 contig 的长度。<br>    Total length: assembly 中的碱基总数。<br>    Nx (where 0&lt;&#x3D;x&lt;&#x3D;100): 最长长度的 contigs 占组装碱基的百分比。<br>    NGx, Genome Nx: 相等或更长的重叠群产生参考基因组长度的 x% 的重叠群长度，而不是组装结果长度的 x%。</p>
<p>2.基因组相关统计<br>    Genome fraction (%) : 基因组中被组装结果覆盖到的碱基数 除以 参考序列的总长度得到的比值；位于重复区域的contig可能会比对到多个位置，因此会被重复计算。<br>    Duplication ratio：组装结果中可比对到基因组的碱基数 与 基因组中被覆盖到的碱基数的比值；如果组装的结果中重复序列较多，多个contig覆盖同一个基因组区域的话，这个值会大于1。这种情况可能是由于过多的估计了重复序列的拷贝数。<br>    Largest alignment：将组装结果同基因组进行比对，得到的最大的连续的比对的长度；这个值一般会同largest contig相同，但是如果larget contig有些missassembled，或者部分未比对上去的话，会相对小一些。<br>    Total aligned length：组装结果中可比对到基因组的碱基数，由于存在未比对和部分未比对，这个数字一般会小于组装的结果的总长度（total length)。</p>
<p>3.组装错误等，这些只能根据已知参考基因组进行评估。<br>    No. of misassemblies: 组装错误的数量。<br>    No. of misassembled contigs: 包含错误组装断点的 contigs 数量。<br>    Misassembled contigs length: 在所有 contig 中包含一个或多个错配的碱基总数。<br>    No. of unaligned contigs: 与参考序列没有对齐的 contigs 数量。<br>    No. of ambiguously mapped contigs: 在参考基因组的多个位置具有相同质量的高得分参考比对的 contigs 数量。<br>    除了以上汇总统计数据之外，Quast 还生成包含每个 contig 详细信息的报告，包括 contig 是否未对齐、不明群映射、错误组装或正确。</p>
<p>4.未比对上的。<br>    fully unaligned contigs：没有比对上参考基因组的contig数<br>    Fully unaligned length：没有比对上参考基因组的contig总长度<br>    partially unaligned contigs：部分没有比对上基因组的contig数，长度大于参数值（500bp）<br>    Partially unaligned length：部分没有比对上基因组的contig中总的没有比对上的碱基数</p>
<p>5.错配的<br>    mismatches ：所有比对上的碱基中，mismatch的个数<br>    indels ：所有比对上的碱基中，indel的个数<br>    Indels length ：indel的总长度<br>    mismatches per 100 kbp：每100kbp中，mismatch的个数<br>    indels per 100 kbp : 每100kbp中，indel的个数<br>    indels (&lt;&#x3D; 5 bp) : 长度小于5的indel个数<br>    indels (&gt; 5 bp) : 长度大于5bp的indel个数<br>    N’s ：N碱基的个数<br>    N’s per 100 kbp：每100kbp中N碱基的个数</p>
<h3 id="5-进行polish"><a href="#5-进行polish" class="headerlink" title="5.进行polish"></a>5.进行polish</h3><p>三代测序读长长，但是也有较高的错误率，组装完成后可以用pilon进行polish，可以用二代测序(pilon)或三代数据(gcpp或racon)再次纠错。这里，介绍gcpp，gcpp封装在pb-assembly中，可以通过conda安装pb-assembly,也可以直接安装gcpp。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># use NGS pair end data or hifi reads to polish, here, we use hifi reads to polish hifi-assembly</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># environment</span></span><br><span class="line">conda create -n pb-polish</span><br><span class="line">conda activate pb-polish</span><br><span class="line">conda install -c bioconda pilon</span><br><span class="line">conda install -c bioconda pbmm2</span><br><span class="line">conda install -c bioconda pbgcpp</span><br><span class="line"><span class="comment"># input: assembly.fa hifi.subreads.bam</span></span><br><span class="line"><span class="comment"># output: assembly-polished.fa</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># interation 2~3 times迭代2至3次。</span></span><br><span class="line">samtools faidx assembly.fa</span><br><span class="line">samtools index pacbio.subreads.bam</span><br><span class="line">pbmm2 align --preset HIFI pacbio.subreads.bam assembly.fasta | samtools <span class="built_in">sort</span> -@ 16 &gt; map.pacbio.bam</span><br><span class="line">pbindex map.pacbio.bam</span><br><span class="line">gcpp -j 16 -r assembly.fasta -o variants.vcf -o consensus</span><br><span class="line"></span><br><span class="line"><span class="comment">#gcpp -j 16 -r assembly.fasta -o variants.vcf -o polished.1.fasta DN.map2flye.bam</span></span><br></pre></td></tr></table></figure>

<h3 id="6-busco评估基因组组装完整性"><a href="#6-busco评估基因组组装完整性" class="headerlink" title="6.busco评估基因组组装完整性"></a>6.busco评估基因组组装完整性</h3><p>conda install -c bioconda busco<br>待更新</p>
]]></content>
      <categories>
        <category>基因组</category>
      </categories>
      <tags>
        <tag>基因组</tag>
      </tags>
  </entry>
  <entry>
    <title>python学习之1</title>
    <url>/2022/09/13/python%E5%AD%A6%E4%B9%A0%E4%B9%8B1/</url>
    <content><![CDATA[<p>这个category记录了自己重新学习python的过程(Python 3),这篇是一些基础过程。</p>
<span id="more"></span>

<h2 id="1-Python数据类型"><a href="#1-Python数据类型" class="headerlink" title="1.Python数据类型"></a>1.Python数据类型</h2><p>python有6个数据类型：不可变数据：数字、字符串、元组；可变数据：列表、集合、字典。type()函数可以查看变量的类型。类型转换函数：int()、float()、str()、tuple()、list()、set()、frozenset()等等。</p>
<h3 id="1-1-python推导式"><a href="#1-1-python推导式" class="headerlink" title="1.1 python推导式"></a>1.1 python推导式</h3><h4 id="1-列表推导式："><a href="#1-列表推导式：" class="headerlink" title="(1).列表推导式："></a>(1).列表推导式：</h4><p>[表达式 for 变量 in 列表]<br>[out_exp_res for out_exp in input_list]<br>或者<br>[表达式 for 变量 in 列表 if 条件]<br>[out_exp_res for out_exp in input_list if condition]</p>
<p>例如：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>names = [<span class="string">&#x27;Bob&#x27;</span>,<span class="string">&#x27;Tom&#x27;</span>,<span class="string">&#x27;alice&#x27;</span>,<span class="string">&#x27;Jerry&#x27;</span>,<span class="string">&#x27;Wendy&#x27;</span>,<span class="string">&#x27;Smith&#x27;</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>new_names = [name.upper()<span class="keyword">for</span> name <span class="keyword">in</span> names <span class="keyword">if</span> <span class="built_in">len</span>(name)&gt;<span class="number">3</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">print</span>(new_names)</span><br><span class="line">[<span class="string">&#x27;ALICE&#x27;</span>, <span class="string">&#x27;JERRY&#x27;</span>, <span class="string">&#x27;WENDY&#x27;</span>, <span class="string">&#x27;SMITH&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>multiples = [i <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">30</span>) <span class="keyword">if</span> i % <span class="number">3</span> == <span class="number">0</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">print</span>(multiples)</span><br><span class="line">[<span class="number">0</span>, <span class="number">3</span>, <span class="number">6</span>, <span class="number">9</span>, <span class="number">12</span>, <span class="number">15</span>, <span class="number">18</span>, <span class="number">21</span>, <span class="number">24</span>, <span class="number">27</span>]</span><br></pre></td></tr></table></figure>

<h4 id="2-字典推导式"><a href="#2-字典推导式" class="headerlink" title="(2).字典推导式"></a>(2).字典推导式</h4><p>{ key_expr: value_expr for value in collection }<br>或<br>{ key_expr: value_expr for value in collection if condition }</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">listdemo = [<span class="string">&#x27;Google&#x27;</span>,<span class="string">&#x27;Runoob&#x27;</span>, <span class="string">&#x27;Taobao&#x27;</span>]</span><br><span class="line"><span class="comment"># 将列表中各字符串值为键，各字符串的长度为值，组成键值对</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>newdict = &#123;key:<span class="built_in">len</span>(key) <span class="keyword">for</span> key <span class="keyword">in</span> listdemo&#125;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>newdict</span><br><span class="line">&#123;<span class="string">&#x27;Google&#x27;</span>: <span class="number">6</span>, <span class="string">&#x27;Runoob&#x27;</span>: <span class="number">6</span>, <span class="string">&#x27;Taobao&#x27;</span>: <span class="number">6</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>dic = &#123;x: x**<span class="number">2</span> <span class="keyword">for</span> x <span class="keyword">in</span> (<span class="number">2</span>, <span class="number">4</span>, <span class="number">6</span>)&#125;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>dic</span><br><span class="line">&#123;<span class="number">2</span>: <span class="number">4</span>, <span class="number">4</span>: <span class="number">16</span>, <span class="number">6</span>: <span class="number">36</span>&#125;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">type</span>(dic)</span><br><span class="line">&lt;<span class="keyword">class</span> <span class="string">&#x27;dict&#x27;</span>&gt;</span><br></pre></td></tr></table></figure>
<p>集合推导式、元组推导式也类似。</p>
<p>python注释：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#单行注释</span></span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">多行</span></span><br><span class="line"><span class="string">注释</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">多行</span></span><br><span class="line"><span class="string">注释</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="2-一些有用的函数"><a href="#2-一些有用的函数" class="headerlink" title="2. 一些有用的函数"></a>2. 一些有用的函数</h3><h4 id="2-1-随机数函数"><a href="#2-1-随机数函数" class="headerlink" title="2.1 随机数函数"></a>2.1 随机数函数</h4><p><code>choice(seq)</code><br>从序列的元素中随机挑选一个元素，比如random.choice(range(10))，从0到9中随机挑选一个整数。<br><code>randrange ([start,] stop [,step])</code><br>从指定范围内，按指定基数递增的集合中获取一个随机数，基数默认值为 1<br><code>random()</code><br>随机生成下一个实数，它在[0,1)范围内。<br><code>seed([x])</code>改变随机数生成器的种子seed。如果你不了解其原理，你不必特别去设定seed，Python会帮你选择seed。<br><code>shuffle(lst)</code><br>将序列的所有元素随机排序<br><code>uniform(x, y)</code><br>随机生成下一个实数，它在[x,y]范围内。</p>
<h4 id="2-2-字符串函数"><a href="#2-2-字符串函数" class="headerlink" title="2.2 字符串函数"></a>2.2 字符串函数</h4><p><code>join(seq)</code><br>    以指定字符串作为分隔符，将 seq 中所有的元素(的字符串表示)合并为一个新的字符串。<br><code>len(string)</code>	<br>    返回字符串长度<br><code>lower()</code><br>    转换字符串中所有大写字符为小写。<br><code>lstrip()</code><br>    截掉字符串左边的空格或指定字符。<br><code>split(str=&quot;&quot;, num=string.count(str))</code><br>    以 str 为分隔符截取字符串，如果 num 有指定值，则仅截取 num+1 个子字符串<br><code>upper()</code><br>    转换字符串中的小写字母为大写<br><code>find(str, beg=0, end=len(string))</code><br>    检测 str 是否包含在字符串中，如果指定范围 beg 和 end ，则检查是否包含在指定范围内，如果包含返回开始的索引值，否则返回-1<br><code>count(str, beg= 0,end=len(string))</code><br>    返回 str 在 string 里面出现的次数，如果 beg 或者 end 指定则返回指定范围内 str 出现的次数</p>
<h3 id="3-索引"><a href="#3-索引" class="headerlink" title="3. 索引"></a>3. 索引</h3><p>python索引：从前到后的索引从0开始，从后往前的索引：最后一项是-1。切片时是[2:5]即取索引为2到4的值，相当于前闭后开区间。</p>
]]></content>
      <categories>
        <category>Python</category>
      </categories>
      <tags>
        <tag>Python</tag>
      </tags>
  </entry>
  <entry>
    <title>医学统计基础学习笔记1</title>
    <url>/2022/09/14/%E5%8C%BB%E5%AD%A6%E7%BB%9F%E8%AE%A1%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B01/</url>
    <content><![CDATA[<p>医学统计方法基础。</p>
<span id="more"></span>

<h3 id="1-统计学概念"><a href="#1-统计学概念" class="headerlink" title="1 统计学概念"></a>1 统计学概念</h3><p>样本之间的变异（variation）使得实验或观察的结果具有不确定性，统计学的目的就是采用统计学方法，发现不确定现象背后隐藏的规律。</p>
<h4 id="1-1-数据类型"><a href="#1-1-数据类型" class="headerlink" title="1.1 数据类型"></a>1.1 数据类型</h4><p>定性&#x2F;分类数据：又分为有序数据（如肿瘤分级、I级、II级等）和无序数据（如血型、性别）；<br>    分类数据的分层大于2时，为多分类数据。<br>定量&#x2F;计量数据：连续型数据（如身高、体重）和不连续型数据（如疾病复发次数）。</p>
<h4 id="1-2-总体与样本"><a href="#1-2-总体与样本" class="headerlink" title="1.2 总体与样本"></a>1.2 总体与样本</h4><p>总体：研究对象全体；<br>样本：样本要有随机性，并且具有总体的特征。<br>从总体到样本：sampling；取样中的问题：取多少？采样部位（均匀的或不均匀的，这与样本分布有关）？如何保证抽样的随机性？<br>从样本到总体：inference。推断不是百分百正确的，是有误差在的，怎样使误差最小？</p>
<h4 id="1-3-参数与统计量"><a href="#1-3-参数与统计量" class="headerlink" title="1.3 参数与统计量"></a>1.3 参数与统计量</h4><p>参数：总体的统计指标，如均值、标准差，固定的常数；<br>统计量：样本的统计指标，如样本均值、样本标准差，是在参数附近随机波动的随机变量。</p>
<p>一些常用的统计量：</p>
<blockquote>
<p>方差：变异度分析<br>标准差：变量分布的离散程度，结合均数描述正态分布特征<br>标准误：样本统计量的标准差（描述抽样误差的大小）<br>极差：<br>四分位数间距：与中位数一起描述数据的集中和离散程度<br>变异系数：标准差&#x2F;均值，代表数据沿着平均值波动的幅度比例，值越大意味着波动性越大，且该种波动性是以平均值作为标准。</p>
</blockquote>
<h4 id="1-4-统计推断"><a href="#1-4-统计推断" class="headerlink" title="1.4 统计推断"></a>1.4 统计推断</h4><p><strong>参数估计</strong>：用样本指标(即统计量)估计总体指标(称为参数)<br>    点估计：直接估计，没有考虑抽样误差的情况<br>    区间估计：以一定的可信度下（置信区间：1-α），同时考虑抽样误差，来估计总体</p>
<p><strong>假设检验</strong>：假设检验是先对总体参数提出一个假设值，然后利用样本信息判断这一假设是否成立。<br>    一种叫原假设，也叫零假设，用H0表示。原假设一般是统计者想要拒绝的假设。原假设的设置一般为：等于&#x3D;、大于等于&gt;&#x3D;、小于等于&lt;&#x3D;。另外一种叫备择假设，用H1表示。备则假设是统计者想要接受的假设。备择假设的设置一般为：不等于、大于&gt;、小于&lt;。</p>
<p><strong>抽样误差</strong>：样本统计量与总体参数之间的差异（由于个体差异导致的）。<br><strong>标准误</strong>：均数的标准误&#x2F;率的标准误<br><strong>标准误与标准差</strong></p>
<blockquote>
<p>例如我们要调查地区A中10岁男孩的身高。如果全部都统计下来，直接测是最准确的数据。但是成本高，不现实。因此需要进行采样，一次测量100个男孩的身高，求这一次的均值M1与标准差S1，如果采样10次，每次都取100人，我们会得到10个均值，分别记为M1，M2，M3…M10，对这10个均值再求一个均值M以及标准差S，其中这个标准差S就是标准误(standard error)，即均值的标准误差(standard error of mean)。<br>第一，标准差是对一次抽样的原始数据进行计算的，而标准误则是对多次抽样的样本统计量进行计算的（这个统计量可以是均值，可以是率）；第二，标准差只是一个描述性指标，只是描述原始数据的波动情况，而标准误是跟统计推断有关的指标，大多数的统计量计算都需要用到标准误。</p>
</blockquote>
<p><strong>置信区间</strong>：按照预先给定的概率1-α，确定一个包含未知总体参数的范围，这一范围为参数的置信区间。<br>    95%置信区间：从样本中作随机抽样，作100次，每个样本可算得一个置信区间，这100个可信区间中，平均有95个置信区间包含μ（估计正确），5个不包含μ（估计错误）。<br><strong>p值的含义</strong>：p值并不代表差异显著性的大小，而是说明两组之间的差异具有统计学意义。同时，p值越小，实验结果重现性越好。<br>注：有统计学差异，不代表就具有生物学意义。</p>
<p><strong>一型错误α：假阳性错误，弃真错误</strong><br>    I类错误，也称为假阳性错误，就是说实际上总体并无差异，原假设H0是成立的，但是通过假设检验P≤α，在设定α的检验水准下，拒绝了H0，认为有差异，出现了假阳性的现象。<br><strong>二型错误β：假阴性错误，纳伪错误</strong><br>    II类错误，也称为假阴性错误，就是说实际上原假设H0不成立，但是通过假设检验P＞α，在设定α的检验水准下，不拒绝H0，得出了阴性的结论，此时犯II类错误的概率为β。</p>
<table>
<thead>
<tr>
<th align="center">基于样本的决定</th>
<th align="center">H0为真</th>
<th align="center">H0为假</th>
</tr>
</thead>
<tbody><tr>
<td align="center">接受H1</td>
<td align="center">I类错误</td>
<td align="center">正确</td>
</tr>
<tr>
<td align="center">接受H0</td>
<td align="center">正确</td>
<td align="center">II类错误</td>
</tr>
</tbody></table>
<p><strong>检验效能</strong>：1-β，即1-第二类错误的概率，表示在一定的检验水准下，当H1为真时，意味着H0为假，假设检验能够拒绝H0的概率。</p>
<h3 id="2-假设检验方法的选择"><a href="#2-假设检验方法的选择" class="headerlink" title="2 假设检验方法的选择"></a>2 假设检验方法的选择</h3><p><strong>1）、单组资料的分析</strong><br>如果数据呈正态分布，则采用单样本t检验(One-Sample Test)；如果数据呈非正态分布，可以采用相应的非参数统计方法Wilcoxon符号等级检验(Wilcoxon Signed-Rank Test)。 </p>
<p><strong>2）、两组资料的分析</strong><br>首先，需要判别数据为定量数据还是分类数据。如果是定量数据，数据的分布特征呈正态，则选择两样本t检验(Two-Sample Test)；如果定量数据呈非正态分布，则选择Wilcoxon等级和检验(Wileoxon Rank Sum Test)。对于分类数据，卡方检验(Chi-Square Test)被广泛运用。但值得注意的是，如果行列表中有1&#x2F;5以上的格子理论频数小于5，或有一个格子理论频数小于1，卡方检验将导致分析的偏性。此时，可以采用 Fishe‘s 精确概率法(Fishe’s Exact Test)计算P值。</p>
<p> <strong>3）、三组或以上资料的分析</strong><br>与两组资料分析类似，如果数据为定量资料呈正态分布，则采用单因素方差分析 (One way ANOVA)；如果定量数据，呈非正态分布，则选择Kruskal一Wallis检验 (Kruskal一Wallis Test)。对于分类数据，多分类无序数据采用卡方检验(Chi-Square Test)或Fish‘s精确概率法；多分类有序数据可采用Cochran-Mantel-Haenszel 检验(Cochran-Mantel -Haenszel Test)。</p>
<p><strong>4）、 等效性检验</strong><br>等效性检验中无效假设H0指治疗间有差异（至少为Δ），Δ为临床无差异之和，拒绝H0意味着治疗之间差异没有显著意义。在双单侧检验（TOST）中，σ值是A药和B药的理论差异，Δ为无差异之和。在差异性检验中，无效假设H0居中，备择假设H1在左侧或右侧；在等效性检验中，备则假设H1居中，H0滑向两侧，那么研究者需设两个H0，即H01（σ≤Δ）和H02 （σ≥Δ），然后进行2次非劣效性检验（Δ－σ和σ－Δ）。在等效性检验中，通常只检验均值或率比。部分研究者倾向于找到σ的可信区间（CI），如果CI不能括入Δ，研究者有证据拒绝H0，并得出等效性结论。 </p>
<p><strong>5）、把握度分析</strong><br>把握度分析可在设计试验阶段进行, 来阐明各试验设计参数之间的互变关系, 尤其是在不同的显著性水平下,研究者进行样本量与把握度关系间的分析，对设计试验时选择合适的样本量大小具有极为重要的作用。 </p>
<p><strong>6）、多因素方差分析（Multi-way ANOVA）</strong><br>t检验是对一个变量的1或2个均值进行检验；方差分析又称F检验，单因素方差分析是对1个变量的≥3个均值进行检验；多因素方差分析是对2个或2个以上变量的多个均值进行检验。</p>
<p><strong>7）、相关性分析(Researeh Question Sabout Relationships among Variables)</strong><br>许多临床研究涉及对一组研究对象2个连续性变量的相互关系的研究。如用2个不同的指标测定心功能，拟评价这2个指标是否一致，这就需要涉及相关(Correlation)和一致性(Agreement)的评价。当数据为正态分布时，Pearson相关系数(Pearson‘s relation Coefficient)可以评价2个指标的相关性。当数据分布非正态，相应的非参数统计量为Spearman’s 等级相关系数(Spearman‘s Rank Correlation Coeffielent)以及Kendall’s Tau-b等级相关系数(Kendall‘s Tau-b Rank Correlation Coeffielent)，两者类似，但更多的统计学家推荐使用后者。 对一致性的评价，定量数据可以采用Concordance相关系数(Concordance Correlation Coeffieient)，分类数据采用 Kappa分析 (Cohen‘s Kappa statistic)。 值得注意的是，相关性与一致性的区别。如在临床研究中，希望评价一个新的方法是否等同于原来的方法，需要使用一致性分析。</p>
<p><strong>8）、多因素分析(StatlstiealMethodSfo:MultipleVariables)</strong><br>临床研究的对象常常为病人，与有严格实验条件控制的动物实验不同，除了研究的因素外，常需要控制许多混杂因素或协变量，统计分析需要采用多因素模型对协变量进行校正。统计分析软件和程序的使用为多因素分析提供了可能。根据反应变量的类型，可以采用多元线形回归(Muiriple LinearRegression)、协方差分析(ANOVA，Analysis of Covariance)、Logistic回归(Logistic Regression)、判别分析、聚类分析等。</p>
<p><strong>9）、重复测量数据的分析(Methods for Analyzing Repeated Measures Data)</strong><br>定量数据可以采用重复测量方差分析(Repeated-Measures ANOVA)以及混合效应模型(MixeD-effects linear Model)。对于分类数据，可以广义估算方程(Generalized Estimated Evluation，GEE)拟合Logistic模型。</p>
<p><strong>10）、生存分析(Analyzing Researeh Questions about Survival)</strong><br>分析一段时间后生存、死亡或其它事件发生情况需要采用生存分析，例如，研究者想了解心脏移植后病人生存天数是否与不同的手术方式有关。生存分析的目的通常是为了描述研究人群的事件发生时间(生存时间、suvival time)的分布特征，比较不同组的生存时间或研究生存时间是否与研究变量有关。单因素生存分析可以采用Log-Rank检验(Log-Rank Test)；多因素可以考虑选择比例风险模型(Cox Proportional Hazards Model)。需要注意的是，在临床研究中经常包含重复测量数据，如病人从心脏移植至死亡发生期间，重复测量了多次心功能值，对于这种资料，可以采用SAS PHREG中，重复测量资料的cox模型的运用。</p>
<p>一些其他重要的：<br>一般情况下，大于两倍标准差（μ+2δ&#x2F;μ-2δ），可以判断是奇异值。<br>一旦定下统计规则，就不能更改。<br>先把简单问题复杂化（选择统计方法），再把复杂问题简单化（描述统计结果）。<br>variation。<br>检验效能 power&#x3D;1-β，β：二型错误；<br>样本量和检验效能的关系。样本量很大时，做卡方检验，卡方值很大，没有意义?</p>
]]></content>
      <categories>
        <category>统计</category>
      </categories>
      <tags>
        <tag>统计</tag>
      </tags>
  </entry>
  <entry>
    <title>RNA-seq分析(3)之DESeq2差异分析</title>
    <url>/2022/09/17/RNA-seq%E5%88%86%E6%9E%90%E4%B9%8BDESeq2%E5%B7%AE%E5%BC%82%E5%88%86%E6%9E%90/</url>
    <content><![CDATA[<p>利用DESeq2包进行差异表达分析。</p>
<span id="more"></span>

<h3 id="1-读入数据并构建DESeq2对象"><a href="#1-读入数据并构建DESeq2对象" class="headerlink" title="1. 读入数据并构建DESeq2对象"></a>1. 读入数据并构建DESeq2对象</h3><p>DESeq2差异分析是使用原始counts数据进行分析的，首先要创建DESeq2包能够处理的对象，创建该对象需要三个数据集：<br>    countData基因计数矩阵:行为基因，列为每个样本。<br>    colData样本信息数据：分别哪个样本是control、哪个是treatment。<br>    group_list：分组信息。<br>    这三个数据中的样本id要一致，否则会报错。<br>数据结构如图所示：<br><img src="/pics/2022-09-17-DESeq2.png" alt="alt 图标"></p>
<p>读入数据及预处理：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">library<span class="punctuation">(</span>DESeq2<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>dplyr<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>ggplot2<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>ggrepel<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 读入数据</span></span><br><span class="line">count <span class="operator">&lt;-</span> read.table<span class="punctuation">(</span>file <span class="operator">=</span> <span class="string">&quot;counts.txt&quot;</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment"># 命名行和列的名字:行名为第一列</span></span><br><span class="line">rownames<span class="punctuation">(</span>count<span class="punctuation">)</span> <span class="operator">&lt;-</span> count<span class="operator">$</span>V1</span><br><span class="line">count <span class="operator">&lt;-</span> count<span class="punctuation">[</span><span class="punctuation">,</span><span class="number">2</span><span class="operator">:</span><span class="number">5</span><span class="punctuation">]</span></span><br><span class="line">count <span class="operator">&lt;-</span> count<span class="punctuation">[</span>rowSums<span class="punctuation">(</span>count<span class="punctuation">)</span><span class="operator">&gt;</span><span class="number">0</span><span class="punctuation">,</span><span class="punctuation">]</span></span><br><span class="line">colnames<span class="punctuation">(</span>count<span class="punctuation">)</span> <span class="operator">&lt;-</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;CS-1&quot;</span><span class="punctuation">,</span><span class="string">&quot;CS-2&quot;</span><span class="punctuation">,</span><span class="string">&quot;PS-1&quot;</span><span class="punctuation">,</span><span class="string">&quot;PS-2&quot;</span><span class="punctuation">)</span></span><br><span class="line">count <span class="operator">&lt;-</span> count<span class="punctuation">[</span><span class="operator">-</span><span class="number">1</span><span class="punctuation">,</span><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>
<p>三个dataframe：<br>    ColData:样本和分组的对应信息,即colData；<br>    grouplist:分组信息；<br>    countData:rawcounts,即count。</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">group_list <span class="operator">&lt;-</span> <span class="built_in">rep</span><span class="punctuation">(</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;CS&quot;</span><span class="punctuation">,</span><span class="string">&quot;PS&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span>each <span class="operator">=</span><span class="number">2</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">colData <span class="operator">&lt;-</span> data.frame<span class="punctuation">(</span>sample <span class="operator">=</span> colnames<span class="punctuation">(</span>count<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">                      group_list <span class="operator">=</span> group_list <span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<p>有了这三个矩阵信息，就可以进行接下来DESeq2对象的构建了。</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">dds <span class="operator">&lt;-</span> DESeqDataSetFromMatrix<span class="punctuation">(</span>countData <span class="operator">=</span> count<span class="punctuation">,</span>colData <span class="operator">=</span> colData<span class="punctuation">,</span></span><br><span class="line">                              design <span class="operator">=</span> group_list<span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<h3 id="2-差异分析"><a href="#2-差异分析" class="headerlink" title="2. 差异分析"></a>2. 差异分析</h3><p>接下来可以进行差异分析,并提取差异分析的结果。</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">dds2 <span class="operator">&lt;-</span> DESeq<span class="punctuation">(</span>dds<span class="punctuation">)</span></span><br><span class="line"><span class="comment"># 提取差异分析结果</span></span><br><span class="line">res <span class="operator">&lt;-</span> results<span class="punctuation">(</span>dds2<span class="punctuation">,</span>contrast<span class="operator">=</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;group_list&quot;</span><span class="punctuation">,</span><span class="string">&quot;CS&quot;</span><span class="punctuation">,</span><span class="string">&quot;PS&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p>这里需要注意contrast参数，两个组的先后顺序如果不同分析出来的差异。原文是这样写的：</p>
<blockquote>
<p>The results table when printed will provide the information about the comparison, e.g. “log2 fold change (MAP): condition treated vs untreated”, meaning that the estimates are of log2(treated &#x2F; untreated), as would be returned by contrast&#x3D;c(“condition”,”treated”,”untreated”).</p>
</blockquote>
<p>所以两个组的顺序应该是对照在后面，实验组在前面，否则得到的上下调基因会刚好相反。</p>
<p>res中包含的列：base means across samples, log2 fold changes, standard errors, test statistics, p-values and adjusted p-values。<br>由于我的gene id用的是果蝇flybase数据库中的id，所以我希望在得到的结果中添加上gene symbol信息用于火山图部分基因的标记，添加entrez id以便后续的kegg分析。</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">res<span class="operator">$</span>symbol <span class="operator">&lt;-</span> mapIds<span class="punctuation">(</span>org.Dm.eg.db<span class="punctuation">,</span> </span><br><span class="line">                     keys<span class="operator">=</span>row.names<span class="punctuation">(</span>res<span class="punctuation">)</span><span class="punctuation">,</span> </span><br><span class="line">                     column<span class="operator">=</span><span class="string">&quot;SYMBOL&quot;</span><span class="punctuation">,</span> </span><br><span class="line">                     keytype<span class="operator">=</span><span class="string">&quot;ENSEMBL&quot;</span><span class="punctuation">,</span></span><br><span class="line">                     multiVals<span class="operator">=</span><span class="string">&quot;first&quot;</span><span class="punctuation">)</span></span><br><span class="line">res<span class="operator">$</span>entrez <span class="operator">&lt;-</span> mapIds<span class="punctuation">(</span>org.Dm.eg.db<span class="punctuation">,</span> </span><br><span class="line">                     keys<span class="operator">=</span>row.names<span class="punctuation">(</span>res<span class="punctuation">)</span><span class="punctuation">,</span> </span><br><span class="line">                     column<span class="operator">=</span><span class="string">&quot;ENTREZID&quot;</span><span class="punctuation">,</span> </span><br><span class="line">                     keytype<span class="operator">=</span><span class="string">&quot;ENSEMBL&quot;</span><span class="punctuation">,</span></span><br><span class="line">                     multiVals<span class="operator">=</span><span class="string">&quot;first&quot;</span><span class="punctuation">)</span></span><br><span class="line">res<span class="operator">$</span>name <span class="operator">=</span>   mapIds<span class="punctuation">(</span>org.Dm.eg.db<span class="punctuation">,</span></span><br><span class="line">                    keys<span class="operator">=</span>row.names<span class="punctuation">(</span>res<span class="punctuation">)</span><span class="punctuation">,</span> </span><br><span class="line">                    column<span class="operator">=</span><span class="string">&quot;GENENAME&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    keytype<span class="operator">=</span><span class="string">&quot;ENSEMBL&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    multiVals<span class="operator">=</span><span class="string">&quot;first&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<figure class="highlight r"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 按照pvalue大小排序</span></span><br><span class="line">res_ordered <span class="operator">&lt;-</span> res<span class="punctuation">[</span>order<span class="punctuation">(</span>res<span class="operator">$</span>pvalue<span class="punctuation">)</span><span class="punctuation">,</span><span class="punctuation">]</span></span><br><span class="line"></span><br><span class="line">DEG <span class="operator">&lt;-</span> as.data.frame<span class="punctuation">(</span>res_ordered<span class="punctuation">)</span></span><br><span class="line"><span class="comment"># 去除NA值：na.omit()去除含有NA值的整行数据</span></span><br><span class="line">DEG <span class="operator">&lt;-</span> na.omit<span class="punctuation">(</span>DEG<span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<h3 id="3-根据差异表达倍数确定上下调的基因"><a href="#3-根据差异表达倍数确定上下调的基因" class="headerlink" title="3. 根据差异表达倍数确定上下调的基因"></a>3. 根据差异表达倍数确定上下调的基因</h3><p>确定上下调表达的基因，可以选择静态阈值或者动态阈值。静态阈值比如：p&lt;0.05,logFC&gt;2。动态阈值根据数据整体的情况确定一个阈值。</p>
<p>如果采用动态阈值，则计算动态阈值的代码如下：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 动态阈值计算：差异倍数绝对值的均值±两倍标准差</span></span><br><span class="line">logFC_t <span class="operator">&lt;-</span> with<span class="punctuation">(</span>DEG<span class="punctuation">,</span>mean<span class="punctuation">(</span><span class="built_in">abs</span><span class="punctuation">(</span>log2FoldChange<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span> <span class="number">2</span><span class="operator">*</span>sd<span class="punctuation">(</span><span class="built_in">abs</span><span class="punctuation">(</span>log2FoldChange<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">logFC_t <span class="operator">&lt;-</span> <span class="built_in">round</span><span class="punctuation">(</span>logFC_t<span class="punctuation">,</span> <span class="number">2</span><span class="punctuation">)</span> <span class="comment">#取前两位小数</span></span><br></pre></td></tr></table></figure>

<p>这里以采用静态阈值2为例进行分析并绘制火山图，也可以采用padj确定上下调基因。</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">DEG<span class="operator">$</span>change <span class="operator">=</span> as.factor<span class="punctuation">(</span>ifelse<span class="punctuation">(</span>DEG<span class="operator">$</span>pvalue <span class="operator">&lt;</span> <span class="number">0.05</span> <span class="operator">&amp;</span> <span class="built_in">abs</span><span class="punctuation">(</span>DEG<span class="operator">$</span>log2FoldChange<span class="punctuation">)</span> <span class="operator">&gt;</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">                              ifelse<span class="punctuation">(</span>DEG<span class="operator">$</span>log2FoldChange <span class="operator">&gt;</span> <span class="number">2</span> <span class="punctuation">,</span><span class="string">&#x27;UP&#x27;</span><span class="punctuation">,</span><span class="string">&#x27;DOWN&#x27;</span><span class="punctuation">)</span><span class="punctuation">,</span><span class="string">&#x27;STABLE&#x27;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">table<span class="punctuation">(</span>DEG<span class="operator">$</span>change<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">DEG<span class="operator">$</span>label <span class="operator">&lt;-</span> ifelse<span class="punctuation">(</span>DEG<span class="operator">$</span>pvalue <span class="operator">&lt;</span> <span class="number">0.00000001</span> <span class="operator">&amp;</span> <span class="built_in">abs</span><span class="punctuation">(</span>DEG<span class="operator">$</span>log2FoldChange<span class="punctuation">)</span> <span class="operator">&gt;=</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">                    DEG<span class="operator">$</span>symbol<span class="punctuation">,</span><span class="string">&quot;&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">ggplot<span class="punctuation">(</span>DEG<span class="punctuation">,</span> aes<span class="punctuation">(</span>x<span class="operator">=</span>log2FoldChange<span class="punctuation">,</span> y<span class="operator">=</span><span class="operator">-</span>log10<span class="punctuation">(</span>pvalue<span class="punctuation">)</span><span class="punctuation">,</span>color<span class="operator">=</span>change<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span> </span><br><span class="line">  geom_point<span class="punctuation">(</span>alpha<span class="operator">=</span><span class="number">0.4</span><span class="punctuation">,</span> size<span class="operator">=</span><span class="number">2</span><span class="punctuation">)</span> <span class="operator">+</span> </span><br><span class="line">  theme_classic<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">+</span> </span><br><span class="line">  xlab<span class="punctuation">(</span><span class="string">&quot;log2 fold change&quot;</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  ylab<span class="punctuation">(</span><span class="string">&quot;-log10 pvalue&quot;</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  theme<span class="punctuation">(</span>plot.title <span class="operator">=</span> element_text<span class="punctuation">(</span>size<span class="operator">=</span><span class="number">15</span><span class="punctuation">,</span>hjust <span class="operator">=</span> <span class="number">0.5</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span> </span><br><span class="line">  scale_colour_manual<span class="punctuation">(</span>values <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&#x27;blue&#x27;</span><span class="punctuation">,</span><span class="string">&#x27;black&#x27;</span><span class="punctuation">,</span><span class="string">&#x27;red&#x27;</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  geom_hline<span class="punctuation">(</span>yintercept <span class="operator">=</span> <span class="operator">-</span>log10<span class="punctuation">(</span><span class="number">0.05</span><span class="punctuation">)</span><span class="punctuation">,</span> lty <span class="operator">=</span> <span class="number">2</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  geom_vline<span class="punctuation">(</span>xintercept <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="operator">-</span><span class="number">2</span><span class="punctuation">,</span> <span class="number">2</span><span class="punctuation">)</span><span class="punctuation">,</span> lty <span class="operator">=</span> <span class="number">2</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  geom_label_repel<span class="punctuation">(</span>data <span class="operator">=</span> DEG<span class="punctuation">,</span> aes<span class="punctuation">(</span>label <span class="operator">=</span> label<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">                   size <span class="operator">=</span> <span class="number">3</span><span class="punctuation">,</span>box.padding <span class="operator">=</span> unit<span class="punctuation">(</span><span class="number">0.5</span><span class="punctuation">,</span> <span class="string">&quot;lines&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">                   point.padding <span class="operator">=</span> unit<span class="punctuation">(</span><span class="number">0.8</span><span class="punctuation">,</span> <span class="string">&quot;lines&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">                   segment.color <span class="operator">=</span> <span class="string">&quot;black&quot;</span><span class="punctuation">,</span></span><br><span class="line">                   show.legend <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">,</span> max.overlaps <span class="operator">=</span> <span class="number">10000</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<p>到这里，差异分析就完成啦！</p>
<p>参考链接：</p>
<ol>
<li><a href="https://www.jianshu.com/p/694b40961fc7">https://www.jianshu.com/p/694b40961fc7</a></li>
<li><a href="https://mp.weixin.qq.com/s?__biz=MzUzMTEwODk0Ng==&amp;mid=2247497831&amp;idx=1&amp;sn=5fc90f8b4a3d0955566a869bed164cee&amp;chksm=fa453d5acd32b44c05eb25fbecda756d82b9aa052149995b437d58088582aaf44e8287907c63&amp;scene=178&amp;cur_album_id=1749887454125293572#rd">https://mp.weixin.qq.com/s?__biz=MzUzMTEwODk0Ng==&amp;mid=2247497831&amp;idx=1&amp;sn=5fc90f8b4a3d0955566a869bed164cee&amp;chksm=fa453d5acd32b44c05eb25fbecda756d82b9aa052149995b437d58088582aaf44e8287907c63&amp;scene=178&amp;cur_album_id=1749887454125293572#rd</a></li>
</ol>
]]></content>
      <categories>
        <category>RNA-seq</category>
      </categories>
      <tags>
        <tag>RNA-seq</tag>
      </tags>
  </entry>
  <entry>
    <title>RNA-seq分析(4)之KEGG富集分析</title>
    <url>/2022/09/18/RNA-seq%E5%88%86%E6%9E%90%E4%B9%8BKEGG%E5%AF%8C%E9%9B%86%E5%88%86%E6%9E%90/</url>
    <content><![CDATA[<p>接上一篇<a href="http://xueyd.top/2022/09/17/RNA-seq%E5%88%86%E6%9E%90%E4%B9%8BDESeq2%E5%B7%AE%E5%BC%82%E5%88%86%E6%9E%90/#more">DESeq2包差异分析</a>，使用clusterProfiler包进行KEGG富集分析。</p>
<span id="more"></span>

<h3 id="1-提取基因集ID"><a href="#1-提取基因集ID" class="headerlink" title="1. 提取基因集ID"></a>1. 提取基因集ID</h3><p>得到差异分析中基因上下调的结果之后，就可以进行KEGG分析了，KEGG分析只需要一串基因id就可以了,因此首先先提取上下调基因集，这里我们使用entrez id进行基因富集。</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">library<span class="punctuation">(</span>clusterProfiler<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>ggplot2<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>ggrepel<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span><span class="string">&quot;AnnotationDbi&quot;</span><span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span><span class="string">&quot;org.Dm.eg.db&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">gene_up <span class="operator">&lt;-</span> DEG<span class="punctuation">[</span>DEG<span class="operator">$</span>change <span class="operator">==</span> <span class="string">&quot;UP&quot;</span><span class="punctuation">,</span><span class="string">&quot;entrez&quot;</span><span class="punctuation">]</span></span><br><span class="line">gene_down <span class="operator">&lt;-</span> DEG<span class="punctuation">[</span>DEG<span class="operator">$</span>change <span class="operator">==</span> <span class="string">&quot;DOWN&quot;</span><span class="punctuation">,</span><span class="string">&quot;entrez&quot;</span><span class="punctuation">]</span></span><br><span class="line">gene_diff <span class="operator">&lt;-</span> <span class="built_in">c</span><span class="punctuation">(</span>gene_up<span class="punctuation">,</span>gene_down<span class="punctuation">)</span></span><br><span class="line">gene_all <span class="operator">&lt;-</span> <span class="built_in">as.character</span><span class="punctuation">(</span>DEG<span class="punctuation">[</span><span class="punctuation">,</span><span class="string">&quot;entrez&quot;</span><span class="punctuation">]</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<h3 id="2-KEGG富集"><a href="#2-KEGG富集" class="headerlink" title="2. KEGG富集"></a>2. KEGG富集</h3><p>接下来进行KEGG富集，enrichKEGG函数的keytype参数有4个选项：”kegg”、’ncbi-geneid’、’ncib-proteinid’、’uniprot’。</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">kk.up <span class="operator">&lt;-</span> enrichKEGG<span class="punctuation">(</span>gene          <span class="operator">=</span>  gene_up<span class="punctuation">,</span></span><br><span class="line">                    organism      <span class="operator">=</span>  <span class="string">&quot;dme&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    keyType <span class="operator">=</span> <span class="string">&quot;ncbi-geneid&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    universe      <span class="operator">=</span>  gene_all<span class="punctuation">,</span></span><br><span class="line">                    pvalueCutoff  <span class="operator">=</span>  <span class="number">0.8</span><span class="punctuation">,</span></span><br><span class="line">                    qvalueCutoff  <span class="operator">=</span>  <span class="number">0.8</span><span class="punctuation">)</span></span><br><span class="line">kk.down <span class="operator">&lt;-</span> enrichKEGG<span class="punctuation">(</span>gene          <span class="operator">=</span>  gene_down<span class="punctuation">,</span></span><br><span class="line">                      organism      <span class="operator">=</span>  <span class="string">&quot;dme&quot;</span><span class="punctuation">,</span></span><br><span class="line">                      keyType <span class="operator">=</span> <span class="string">&quot;ncbi-geneid&quot;</span><span class="punctuation">,</span></span><br><span class="line">                      universe      <span class="operator">=</span>  gene_all<span class="punctuation">,</span></span><br><span class="line">                      pvalueCutoff  <span class="operator">=</span>  <span class="number">0.8</span><span class="punctuation">,</span></span><br><span class="line">                      qvalueCutoff  <span class="operator">=</span>  <span class="number">0.8</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<p>提取KEGG分析的结果，将上调和下调的基因富集结果整合在一起。</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">kegg_down_dt <span class="operator">&lt;-</span> as.data.frame<span class="punctuation">(</span>kk.down<span class="punctuation">)</span></span><br><span class="line">kegg_up_dt <span class="operator">&lt;-</span> as.data.frame<span class="punctuation">(</span>kk.up<span class="punctuation">)</span></span><br><span class="line">down_kegg <span class="operator">&lt;-</span> kegg_down_dt<span class="punctuation">[</span>kegg_down_dt<span class="operator">$</span>pvalue <span class="operator">&lt;</span> <span class="number">0.05</span><span class="punctuation">,</span><span class="punctuation">]</span></span><br><span class="line">down_kegg<span class="operator">$</span>group <span class="operator">=</span> <span class="operator">-</span><span class="number">1</span></span><br><span class="line">up_kegg <span class="operator">&lt;-</span> kegg_up_dt<span class="punctuation">[</span>kegg_up_dt<span class="operator">$</span>pvalue <span class="operator">&lt;</span> <span class="number">0.05</span><span class="punctuation">,</span><span class="punctuation">]</span></span><br><span class="line">up_kegg<span class="operator">$</span>group <span class="operator">=</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line">dat <span class="operator">&lt;-</span> rbind<span class="punctuation">(</span>up_kegg<span class="punctuation">,</span> down_kegg<span class="punctuation">)</span></span><br><span class="line">dat<span class="operator">$</span>pvalue <span class="operator">&lt;-</span> <span class="operator">-</span>log10<span class="punctuation">(</span>dat<span class="operator">$</span>pvalue<span class="punctuation">)</span></span><br><span class="line">dat<span class="operator">$</span>pvalue <span class="operator">&lt;-</span> dat<span class="operator">$</span>pvalue <span class="operator">*</span> dat<span class="operator">$</span>group</span><br><span class="line"></span><br><span class="line">dat <span class="operator">&lt;-</span> dat<span class="punctuation">[</span>order<span class="punctuation">(</span>dat<span class="operator">$</span>pvalue<span class="punctuation">,</span> decreasing <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">)</span><span class="punctuation">,</span><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>

<p>绘图。</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">ggplot<span class="punctuation">(</span>dat<span class="punctuation">,</span> aes<span class="punctuation">(</span>x <span class="operator">=</span> reorder<span class="punctuation">(</span>Description<span class="punctuation">,</span> order<span class="punctuation">(</span>pvalue<span class="punctuation">,</span> decreasing<span class="operator">=</span><span class="built_in">F</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">,</span> </span><br><span class="line">                y <span class="operator">=</span> pvalue<span class="punctuation">,</span> fill <span class="operator">=</span> group<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span> </span><br><span class="line">  geom_bar<span class="punctuation">(</span>stat <span class="operator">=</span> <span class="string">&quot;identity&quot;</span><span class="punctuation">)</span> <span class="operator">+</span> </span><br><span class="line">  scale_fill_gradient<span class="punctuation">(</span>low <span class="operator">=</span> <span class="string">&quot;blue&quot;</span><span class="punctuation">,</span> high <span class="operator">=</span> <span class="string">&quot;red&quot;</span><span class="punctuation">,</span> guide <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">)</span> <span class="operator">+</span> </span><br><span class="line">  scale_x_discrete<span class="punctuation">(</span>name <span class="operator">=</span> <span class="string">&quot;Pathway names&quot;</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  scale_y_continuous<span class="punctuation">(</span>name <span class="operator">=</span> <span class="string">&quot;log10P-value&quot;</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  coord_flip<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">+</span> theme_bw<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">+</span> theme<span class="punctuation">(</span>plot.title <span class="operator">=</span> element_text<span class="punctuation">(</span>hjust <span class="operator">=</span> <span class="number">0.5</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  ggtitle<span class="punctuation">(</span><span class="string">&quot;Pathway Enrichment&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>RNA-seq</category>
      </categories>
      <tags>
        <tag>RNA-seq</tag>
      </tags>
  </entry>
  <entry>
    <title>RNA-seq分析(5)之GO富集分析</title>
    <url>/2022/09/19/RNA-seq%E5%88%86%E6%9E%90-5-%E4%B9%8BGO%E5%AF%8C%E9%9B%86%E5%88%86%E6%9E%90/</url>
    <content><![CDATA[<p>接上一篇<a href="http://xueyd.top/2022/09/18/RNA-seq%E5%88%86%E6%9E%90%E4%B9%8BKEGG%E5%AF%8C%E9%9B%86%E5%88%86%E6%9E%90/#more">KEGG富集分析</a>，使用clusterProfiler包进行GO通路富集分析。</p>
<span id="more"></span>

<h3 id="1-上调基因通路富集"><a href="#1-上调基因通路富集" class="headerlink" title="1. 上调基因通路富集"></a>1. 上调基因通路富集</h3><p>enrichGO进行上调基因的通路富集，并提取富集结果。</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">ego_up <span class="operator">&lt;-</span> enrichGO<span class="punctuation">(</span>gene          <span class="operator">=</span> gene_up<span class="punctuation">,</span></span><br><span class="line">                OrgDb         <span class="operator">=</span> org.Dm.eg.db<span class="punctuation">,</span></span><br><span class="line">                keytype <span class="operator">=</span> <span class="string">&quot;ENTREZID&quot;</span><span class="punctuation">,</span></span><br><span class="line">                ont           <span class="operator">=</span> <span class="string">&quot;ALL&quot;</span> <span class="punctuation">,</span></span><br><span class="line">                universe      <span class="operator">=</span> gene_all<span class="punctuation">,</span></span><br><span class="line">                pAdjustMethod <span class="operator">=</span> <span class="string">&quot;BH&quot;</span><span class="punctuation">,</span></span><br><span class="line">                pvalueCutoff  <span class="operator">=</span> <span class="number">0.99</span><span class="punctuation">,</span></span><br><span class="line">                qvalueCutoff  <span class="operator">=</span> <span class="number">0.99</span><span class="punctuation">,</span></span><br><span class="line">                readable      <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">head<span class="punctuation">(</span>ego_up<span class="punctuation">[</span><span class="punctuation">,</span><span class="number">1</span><span class="operator">:</span><span class="number">6</span><span class="punctuation">]</span><span class="punctuation">)</span></span><br><span class="line">ego_up_result <span class="operator">&lt;-</span> ego_up<span class="operator">@</span>result<span class="punctuation">[</span>order<span class="punctuation">(</span>ego_up<span class="operator">@</span>result<span class="operator">$</span>pvalue<span class="punctuation">)</span><span class="punctuation">,</span><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>

<p>选择前10个BP、CC、MF合并到一个dataset中并绘图。</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">ego_up_sig <span class="operator">&lt;-</span> rbind<span class="punctuation">(</span>head<span class="punctuation">(</span>subset<span class="punctuation">(</span>ego_up_result<span class="punctuation">,</span> ONTOLOGY <span class="operator">==</span> <span class="string">&quot;BP&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span> <span class="number">10</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">                    head<span class="punctuation">(</span>subset<span class="punctuation">(</span>ego_up_result<span class="punctuation">,</span> ONTOLOGY <span class="operator">==</span> <span class="string">&quot;CC&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span> <span class="number">10</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">                    head<span class="punctuation">(</span>subset<span class="punctuation">(</span>ego_up_result<span class="punctuation">,</span> ONTOLOGY <span class="operator">==</span> <span class="string">&quot;MF&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span> <span class="number">10</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">ego_up_sig<span class="operator">$</span>pvalue <span class="operator">&lt;-</span> <span class="operator">-</span>log10<span class="punctuation">(</span>ego_up_sig<span class="operator">$</span>pvalue<span class="punctuation">)</span></span><br><span class="line">ego_up_sig<span class="operator">$</span>Description <span class="operator">&lt;-</span> factor<span class="punctuation">(</span>ego_up_sig<span class="operator">$</span>Description<span class="punctuation">,</span></span><br><span class="line">  levels <span class="operator">=</span> <span class="built_in">as.character</span><span class="punctuation">(</span>rev<span class="punctuation">(</span>ego_up_sig<span class="operator">$</span>Description<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># GO富集分析柱状图，柱子颜色根据BP、CC、MF区分</span></span><br><span class="line">ggplot<span class="punctuation">(</span>ego_up_sig<span class="punctuation">,</span> aes<span class="punctuation">(</span>x <span class="operator">=</span> Description<span class="punctuation">,</span> y <span class="operator">=</span> pvalue<span class="punctuation">,</span> fill <span class="operator">=</span> ONTOLOGY<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  geom_col<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  coord_flip<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  theme_classic<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  facet_grid<span class="punctuation">(</span>ONTOLOGY<span class="operator">~</span>.<span class="punctuation">,</span> scales <span class="operator">=</span> <span class="string">&quot;free&quot;</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  xlab<span class="punctuation">(</span><span class="string">&quot;Up regulated&quot;</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  ylab<span class="punctuation">(</span><span class="string">&quot;-log10 pvalue&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># GO富集分析柱状图，柱子颜色变化依据p.adjust值</span></span><br><span class="line">ggplot<span class="punctuation">(</span>ego_up_sig<span class="punctuation">,</span></span><br><span class="line">  aes<span class="punctuation">(</span>x <span class="operator">=</span> Description<span class="punctuation">,</span> y <span class="operator">=</span> pvalue<span class="punctuation">,</span> fill <span class="operator">=</span> p.adjust<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  scale_fill_gradient<span class="punctuation">(</span>low <span class="operator">=</span> <span class="string">&quot;red&quot;</span><span class="punctuation">,</span>high <span class="operator">=</span> <span class="string">&quot;blue&quot;</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">  geom_col<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  coord_flip<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  theme_classic<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  facet_grid<span class="punctuation">(</span>ONTOLOGY<span class="operator">~</span>.<span class="punctuation">,</span> scales <span class="operator">=</span> <span class="string">&quot;free&quot;</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  xlab<span class="punctuation">(</span><span class="string">&quot;Down regulated&quot;</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">  ylab<span class="punctuation">(</span><span class="string">&quot;-log10 pvalue&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># GO富集分析气泡图</span></span><br><span class="line">ggplot<span class="punctuation">(</span>ego_up_sig<span class="punctuation">,</span></span><br><span class="line">  aes<span class="punctuation">(</span>x <span class="operator">=</span> GeneRatio<span class="punctuation">,</span> y <span class="operator">=</span> Description<span class="punctuation">,</span> color <span class="operator">=</span>p.adjust<span class="punctuation">,</span> size <span class="operator">=</span> Count<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  geom_point<span class="punctuation">(</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">  scale_size<span class="punctuation">(</span><span class="built_in">range</span> <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">2</span><span class="punctuation">,</span><span class="number">8</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">  scale_color_gradient<span class="punctuation">(</span>low <span class="operator">=</span> <span class="string">&quot;red&quot;</span><span class="punctuation">,</span>high <span class="operator">=</span> <span class="string">&quot;blue&quot;</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">  theme_classic<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  facet_grid<span class="punctuation">(</span>ONTOLOGY<span class="operator">~</span>.<span class="punctuation">,</span> scales <span class="operator">=</span> <span class="string">&quot;free&quot;</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  xlab<span class="punctuation">(</span><span class="string">&quot;Gene ratio&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<h3 id="2-下调基因通路富集"><a href="#2-下调基因通路富集" class="headerlink" title="2. 下调基因通路富集"></a>2. 下调基因通路富集</h3><p>下调基因同理。</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">ego_down <span class="operator">&lt;-</span> enrichGO<span class="punctuation">(</span>gene          <span class="operator">=</span> gene_down<span class="punctuation">,</span></span><br><span class="line">                   OrgDb         <span class="operator">=</span> org.Dm.eg.db<span class="punctuation">,</span></span><br><span class="line">                   ont           <span class="operator">=</span> <span class="string">&quot;ALL&quot;</span> <span class="punctuation">,</span></span><br><span class="line">                   universe      <span class="operator">=</span> gene_all<span class="punctuation">,</span></span><br><span class="line">                   pAdjustMethod <span class="operator">=</span> <span class="string">&quot;BH&quot;</span><span class="punctuation">,</span></span><br><span class="line">                   pvalueCutoff  <span class="operator">=</span> <span class="number">0.99</span><span class="punctuation">,</span></span><br><span class="line">                   qvalueCutoff  <span class="operator">=</span> <span class="number">0.99</span><span class="punctuation">,</span></span><br><span class="line">                   readable      <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">head<span class="punctuation">(</span>ego_down<span class="punctuation">[</span><span class="punctuation">,</span><span class="number">1</span><span class="operator">:</span><span class="number">6</span><span class="punctuation">]</span><span class="punctuation">)</span></span><br><span class="line">ego_down_result <span class="operator">&lt;-</span> ego_down<span class="operator">@</span>result<span class="punctuation">[</span>order<span class="punctuation">(</span>ego_down<span class="operator">@</span>result<span class="operator">$</span>pvalue<span class="punctuation">)</span><span class="punctuation">,</span><span class="punctuation">]</span></span><br><span class="line">ego_down_sig <span class="operator">&lt;-</span> rbind<span class="punctuation">(</span>head<span class="punctuation">(</span>subset<span class="punctuation">(</span>ego_down_result<span class="punctuation">,</span> ONTOLOGY <span class="operator">==</span> <span class="string">&quot;BP&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span> <span class="number">10</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">                    head<span class="punctuation">(</span>subset<span class="punctuation">(</span>ego_down_result<span class="punctuation">,</span> ONTOLOGY <span class="operator">==</span> <span class="string">&quot;CC&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span> <span class="number">10</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">                    head<span class="punctuation">(</span>subset<span class="punctuation">(</span>ego_down_result<span class="punctuation">,</span> ONTOLOGY <span class="operator">==</span> <span class="string">&quot;MF&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span> <span class="number">10</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">ego_down_sig<span class="operator">$</span>pvalue <span class="operator">&lt;-</span> <span class="operator">-</span>log10<span class="punctuation">(</span>ego_down_sig<span class="operator">$</span>pvalue<span class="punctuation">)</span></span><br><span class="line">ego_down_sig<span class="operator">$</span>Description <span class="operator">&lt;-</span> factor<span class="punctuation">(</span>ego_down_sig<span class="operator">$</span>Description<span class="punctuation">,</span> </span><br><span class="line">  levels <span class="operator">=</span> <span class="built_in">as.character</span><span class="punctuation">(</span>rev<span class="punctuation">(</span>ego_down_sig<span class="operator">$</span>Description<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">ggplot<span class="punctuation">(</span>ego_down_sig<span class="punctuation">,</span> aes<span class="punctuation">(</span>x <span class="operator">=</span> Description<span class="punctuation">,</span> y <span class="operator">=</span> pvalue<span class="punctuation">,</span> fill <span class="operator">=</span> ONTOLOGY<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  geom_col<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  coord_flip<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  theme_classic<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  facet_grid<span class="punctuation">(</span>ONTOLOGY<span class="operator">~</span>.<span class="punctuation">,</span> scales <span class="operator">=</span> <span class="string">&quot;free&quot;</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  xlab<span class="punctuation">(</span><span class="string">&quot;Down regulated&quot;</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  ylab<span class="punctuation">(</span><span class="string">&quot;-log10 pvalue&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># GO富集分析柱状图，柱子颜色变化依据p.adjust值</span></span><br><span class="line">ggplot<span class="punctuation">(</span>ego_down_sig<span class="punctuation">,</span></span><br><span class="line">  aes<span class="punctuation">(</span>x <span class="operator">=</span> Description<span class="punctuation">,</span> y <span class="operator">=</span> pvalue<span class="punctuation">,</span> fill <span class="operator">=</span> p.adjust<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  scale_fill_gradient<span class="punctuation">(</span>low <span class="operator">=</span> <span class="string">&quot;red&quot;</span><span class="punctuation">,</span>high <span class="operator">=</span> <span class="string">&quot;blue&quot;</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">  geom_col<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  coord_flip<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  theme_classic<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  facet_grid<span class="punctuation">(</span>ONTOLOGY<span class="operator">~</span>.<span class="punctuation">,</span> scales <span class="operator">=</span> <span class="string">&quot;free&quot;</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  xlab<span class="punctuation">(</span><span class="string">&quot;Down regulated&quot;</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">  ylab<span class="punctuation">(</span><span class="string">&quot;-log10 pvalue&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># GO富集分析气泡图</span></span><br><span class="line">ggplot<span class="punctuation">(</span>ego_down_sig<span class="punctuation">,</span></span><br><span class="line">  aes<span class="punctuation">(</span>x <span class="operator">=</span> GeneRatio<span class="punctuation">,</span> y <span class="operator">=</span> Description<span class="punctuation">,</span> color <span class="operator">=</span>p.adjust<span class="punctuation">,</span> size <span class="operator">=</span> Count<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  geom_point<span class="punctuation">(</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">  scale_size<span class="punctuation">(</span><span class="built_in">range</span> <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">2</span><span class="punctuation">,</span><span class="number">8</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">  scale_color_gradient<span class="punctuation">(</span>low <span class="operator">=</span> <span class="string">&quot;red&quot;</span><span class="punctuation">,</span>high <span class="operator">=</span> <span class="string">&quot;blue&quot;</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">  theme_classic<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  facet_grid<span class="punctuation">(</span>ONTOLOGY<span class="operator">~</span>.<span class="punctuation">,</span> scales <span class="operator">=</span> <span class="string">&quot;free&quot;</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  xlab<span class="punctuation">(</span><span class="string">&quot;Gene ratio&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>RNA-seq</category>
      </categories>
      <tags>
        <tag>RNA-seq</tag>
      </tags>
  </entry>
  <entry>
    <title>ggplot2包的geom_col()和geom_bar()</title>
    <url>/2022/09/19/ggplot2%E5%8C%85%E7%9A%84geom-col-%E5%92%8Cgeom-bar/</url>
    <content><![CDATA[<p>ggplot2包的geom_col()和geom_bar()绘制柱状图时的区别。</p>
<span id="more"></span>

<h3 id="1-geom-col"><a href="#1-geom-col" class="headerlink" title="1. geom_col()"></a>1. geom_col()</h3><p>geom_col绘制柱状图时需要给ggplot映射x值（x值一般是因子型的变量），也需要映射y值。如： </p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">ggplot<span class="punctuation">(</span>data<span class="punctuation">,</span> aes<span class="punctuation">(</span>x <span class="operator">=</span> x<span class="punctuation">,</span> y <span class="operator">=</span> y<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span> </span><br><span class="line">	geom_col<span class="punctuation">(</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<h3 id="2-geom-bar"><a href="#2-geom-bar" class="headerlink" title="2. geom_bar()"></a>2. geom_bar()</h3><p>针对计数的柱状图，即count, 是只给ggplot映射x值（x也一般是因子）。自动计算x的每个因子所拥有的数据点的个数，将这个个数给与y轴。如： </p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">ggplot<span class="punctuation">(</span>data<span class="punctuation">,</span> aes<span class="punctuation">(</span>x <span class="operator">=</span> x<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">	geom_bar<span class="punctuation">(</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p>总结：区别在于给ggplot是否映射y值。</p>
]]></content>
      <categories>
        <category>R</category>
        <category>ggplot2</category>
      </categories>
      <tags>
        <tag>R</tag>
        <tag>ggplot2</tag>
      </tags>
  </entry>
  <entry>
    <title>python习题练习1</title>
    <url>/2022/09/19/python%E4%B9%A0%E9%A2%98%E7%BB%83%E4%B9%A01/</url>
    <content><![CDATA[<p>生物信息学Python习题来自<a href="https://rosalind.info/problems/list-view/">ROSALIND</a>。</p>
<span id="more"></span>

<h4 id="1-Counting-DNA-Nucleotides"><a href="#1-Counting-DNA-Nucleotides" class="headerlink" title="1. Counting DNA Nucleotides"></a>1. Counting DNA Nucleotides</h4><p>给定一个DNA序列s&#x3D;’AGCTTTTCATTCTGACTGCAACGGGCAATATGTCTCTGTGTGGATTAAAAAAAGAGTGTCTGATAGCAGC’，计算这一序列s中四个碱基A、T、C、G的碱基数。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">s1 =<span class="string">&#x27;AGCTTTTCATTCTGACTGCAACGGGCAATATGTCTCTGTGTGGATTAAAAAAAGAGTGTCTGATAGCAGC&#x27;</span></span><br><span class="line"></span><br><span class="line">A = s1.count(<span class="string">&#x27;A&#x27;</span>,<span class="number">0</span>,<span class="built_in">len</span>(s1))</span><br><span class="line">T = s1.count(<span class="string">&#x27;T&#x27;</span>,<span class="number">0</span>,<span class="built_in">len</span>(s1))</span><br><span class="line">C = s1.count(<span class="string">&#x27;C&#x27;</span>,<span class="number">0</span>,<span class="built_in">len</span>(s1))</span><br><span class="line">G = s1.count(<span class="string">&#x27;G&#x27;</span>,<span class="number">0</span>,<span class="built_in">len</span>(s1))</span><br><span class="line"></span><br><span class="line"><span class="built_in">list</span> = [A,T,C,G]</span><br><span class="line"><span class="keyword">for</span> l <span class="keyword">in</span> <span class="built_in">list</span>:</span><br><span class="line">    <span class="built_in">print</span>(l,end=<span class="string">&#x27; &#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>封装在函数中。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">count</span>(<span class="params">string,substring</span>):</span><br><span class="line">	num = string.count(substring,<span class="number">0</span>,<span class="built_in">len</span>(s1))</span><br><span class="line">	<span class="keyword">return</span> num</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(count(s1,<span class="string">&#x27;A&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span>(count(s1,<span class="string">&#x27;T&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span>(count(s1,<span class="string">&#x27;C&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span>(count(s1,<span class="string">&#x27;G&#x27;</span>))</span><br></pre></td></tr></table></figure>

<h4 id="2-Transcribing-DNA-into-RNA"><a href="#2-Transcribing-DNA-into-RNA" class="headerlink" title="2. Transcribing DNA into RNA"></a>2. Transcribing DNA into RNA</h4><p>给定一个编码链的DNA序列s1&#x3D;’GATGGAACTTGACTACGTAAATT’，将其转换为RNA序列，即T替换为U。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">s1 = <span class="string">&#x27;GATGGAACTTGACTACGTAAATT&#x27;</span></span><br><span class="line">s2 = s1.replace(<span class="string">&#x27;T&#x27;</span>, <span class="string">&#x27;U&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(s2)</span><br><span class="line"></span><br><span class="line"><span class="comment">#封装到函数中</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">DNA2RNA</span>(<span class="params">DNAstring</span>):</span><br><span class="line">    RNAstring = DNAstring.replace(<span class="string">&#x27;T&#x27;</span>,<span class="string">&#x27;U&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> RNAstring</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(DNA2RNA(s1))</span><br></pre></td></tr></table></figure>

<h4 id="3-Complementing-a-strand-of-DNA"><a href="#3-Complementing-a-strand-of-DNA" class="headerlink" title="3. Complementing a strand of DNA"></a>3. Complementing a strand of DNA</h4><p>给定一个DNA序列s1&#x3D;’AAAACCCGGT’，得到其反向互补序列。<br>第一种方法：用字典。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">s1 = <span class="string">&#x27;AAAACCCGGT&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">DNA_Reverse</span>(<span class="params">DNAstring</span>):</span><br><span class="line">    <span class="keyword">return</span> DNAstring[::-<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">DNA_Complement</span>(<span class="params">DNAstring</span>):</span><br><span class="line">    my_dict = &#123;<span class="string">&#x27;A&#x27;</span>:<span class="string">&#x27;T&#x27;</span>,</span><br><span class="line">               <span class="string">&#x27;T&#x27;</span>:<span class="string">&#x27;A&#x27;</span>,</span><br><span class="line">               <span class="string">&#x27;C&#x27;</span>:<span class="string">&#x27;G&#x27;</span>,</span><br><span class="line">               <span class="string">&#x27;G&#x27;</span>:<span class="string">&#x27;C&#x27;</span>,</span><br><span class="line">               <span class="string">&#x27;a&#x27;</span>:<span class="string">&#x27;t&#x27;</span>,</span><br><span class="line">               <span class="string">&#x27;t&#x27;</span>:<span class="string">&#x27;a&#x27;</span>,</span><br><span class="line">               <span class="string">&#x27;c&#x27;</span>:<span class="string">&#x27;g&#x27;</span>,</span><br><span class="line">               <span class="string">&#x27;g&#x27;</span>:<span class="string">&#x27;c&#x27;</span>&#125;</span><br><span class="line">    DNAstring_list = <span class="built_in">list</span>(DNAstring)</span><br><span class="line">    DNA_com_list = [my_dict[base] <span class="keyword">for</span> base <span class="keyword">in</span> DNAstring_list]</span><br><span class="line">    DNA_com = <span class="string">&#x27;&#x27;</span>.join(DNA_com_list)</span><br><span class="line">    <span class="keyword">return</span> DNA_com</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ReverseCom</span>(<span class="params">DNAstring</span>):</span><br><span class="line">    rev = DNA_Reverse(DNAstring)</span><br><span class="line">    rev_com = DNA_Complement(rev)</span><br><span class="line">    <span class="keyword">return</span> rev_com</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(ReverseCom(s1))</span><br></pre></td></tr></table></figure>
<p>第二种方法：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">s1 = <span class="string">&#x27;AAAACCCGGT&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">DNA_Reverse</span>(<span class="params">DNAstring</span>):</span><br><span class="line">    <span class="keyword">return</span> DNAstring[::-<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">DNA_Complement2</span>(<span class="params">DNAstring</span>):</span><br><span class="line">    DNAstring = DNAstring.upper()</span><br><span class="line">    DNAstring = DNAstring.replace(<span class="string">&#x27;A&#x27;</span>,<span class="string">&#x27;t&#x27;</span>)</span><br><span class="line">    DNAstring = DNAstring.replace(<span class="string">&#x27;T&#x27;</span>,<span class="string">&#x27;A&#x27;</span>)</span><br><span class="line">    DNAstring = DNAstring.replace(<span class="string">&#x27;C&#x27;</span>,<span class="string">&#x27;g&#x27;</span>)</span><br><span class="line">    DNAstring = DNAstring.replace(<span class="string">&#x27;G&#x27;</span>,<span class="string">&#x27;C&#x27;</span>)</span><br><span class="line">    DNAstring = DNAstring.upper()</span><br><span class="line">    <span class="keyword">return</span> DNAstring</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ReverseCom2</span>(<span class="params">DNAstring</span>):</span><br><span class="line">    rev = DNA_Reverse(DNAstring)</span><br><span class="line">    rev_com = DNA_Complement2(rev)</span><br><span class="line">    <span class="keyword">return</span> rev_com</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(ReverseCom2(s1))</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Python</category>
      </categories>
      <tags>
        <tag>Python</tag>
      </tags>
  </entry>
  <entry>
    <title>Ribo-seq上游分析</title>
    <url>/2022/10/23/Ribo-seq%E5%88%86%E6%9E%901/</url>
    <content><![CDATA[<p>本文介绍了Ribo-seq的技术原理和上游的数据处理。</p>
<ul>
<li>技术原理</li>
<li>数据质控</li>
<li>比对<span id="more"></span></li>
</ul>
<h2 id="1-Ribo-seq技术原理"><a href="#1-Ribo-seq技术原理" class="headerlink" title="1. Ribo-seq技术原理"></a>1. Ribo-seq技术原理</h2><p>Ribo-seq建库测序的原理主要是通过对细胞使用翻译抑制剂CHX，使正在翻译的核糖体固定在mRNA序列或者起始位点上。裂解细胞后在细胞裂解液中加入RNase，正在翻译的mRNA片段由于核糖体的保护而保留下来，消化不受核糖体保护的mRNA，分离单一核糖体并提取纯化核糖体上未被消化的短片段mRNA，进行建库测序和相应的数据分析。Ribo-seq测序得到的片段大小在28-32nt左右。<br><img src="/pics/2022-10-23-Ribo-seq.png" alt="alt 图标"></p>
<h2 id="2-Ribo-seq数据质控"><a href="#2-Ribo-seq数据质控" class="headerlink" title="2. Ribo-seq数据质控"></a>2. Ribo-seq数据质控</h2><p>Ribo-seq的下机数据处理部分和RNA-seq的基本流程是一样的，但是Ribo-seq多了去除rRNA这一步，RNA-seq一般情况下是不需要去除rRNA，但是Ribo-seq测序的结果中会有很大含量的rRNA，如果不去除，会对后续的结果造成很大影响，必须要去除。</p>
<h3 id="2-1-去接头"><a href="#2-1-去接头" class="headerlink" title="2.1 去接头"></a>2.1 去接头</h3><p>trim_galore软件封装了fastqc和cutadapt，可以进行质控也可以去接头，如果不知道接头序列，也可以不指定序列，软件可以检测接头序列（但是我试了一下自动检测没有成功，检测不到）。<br>参数解释：<br>-j：线程数。<br>–quality&#x2F;-q：设定Phred quality score阈值，默认为20。<br>–phred33：：选择-phred33或者-phred64，表示测序平台使用的Phred quality score。<br>–adapter&#x2F;-a：输入adapter序列。也可以不输入，Trim Galore!会自动寻找可能性最高的平台对应的adapter。自动搜选的平台三个，也直接显式输入这三种平台，即–illumina、–nextera和–small_rna。<br>–stringency：设定可以忍受的前后adapter重叠的碱基数，默认为1（非常苛刻）。可以适度放宽，因为后一个adapter几乎不可能被测序仪读到。<br>–length：设定输出reads长度阈值，小于设定值会被抛弃。<br>–paired：对于双端测序结果，一对reads中，如果有一个被剔除，那么另一个会被同样抛弃，而不管是否达到标准。<br>–gzip和–dont_gzip：清洗后的数据gzip压缩或者不压缩。<br>–fastqc：trim之后，自动进行fastqc质控。</p>
<p>单端测序：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> `<span class="built_in">cat</span> acc_list.txt`</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">	trim_galore -j 4 -q 20 --phred33 --stringency 3 -a TCGTATGCCGTCTTCTGCTTG --length 15 -e 0.1 01.fastq/<span class="variable">$i</span>.fastq.gz --gzip -o 02.clean<span class="string">&quot;</span></span><br><span class="line"><span class="string">done</span></span><br></pre></td></tr></table></figure>

<p>双端测序：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> `<span class="built_in">cat</span> acc_list.txt`</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">	trim_galore -j 4 -q 20 --phred33 --stringency 3 -a TCGTATGCCGTCTTCTGCTTG --length 15 -e 0.1 --pairded 01.fastq/<span class="variable">$&#123;i&#125;</span>_1.fastq.gz 01.fastq/<span class="variable">$&#123;i&#125;</span>_2.fastq.gz --gzip -o 02.clean<span class="string">&quot;</span></span><br><span class="line"><span class="string">done</span></span><br></pre></td></tr></table></figure>

<h3 id="2-2-去除rRNA和tRNA"><a href="#2-2-去除rRNA和tRNA" class="headerlink" title="2.2 去除rRNA和tRNA"></a>2.2 去除rRNA和tRNA</h3><p>核糖体保护的片段很短，因此在提取过程中会有许多其他序列的污染，rRNA和tRNA是细胞中占比很大的部分，因此拿到测序数据后需要将数据比对到rRNA&#x2F;tRNA上去除这些无用的数据。在比对的时候，我们可以不用选择很严格的标准，我们的目的是为了尽可能多的去除rRNA，因此我们可以使用bowtie2的局部比对，只要一部分片段比对上，我们就认为是rRNA或tRNA，从而将其去除。<br>首先，建立索引：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">bowtie2-build 02.remove_rRNA_tRNA/rRNA.fasta 02.remove_rRNA_tRNA/rRNA-index/rRNA</span><br><span class="line">bowtie2-build 02.remove_rRNA_tRNA/tRNA.fasta 02.remove_rRNA_tRNA/tRNA-index/tRNA</span><br></pre></td></tr></table></figure>
<p>然后进行比对:<br>参数解释：<br>–local：用局部比对<br>–end-to-end：全局比对<br>-x:索引文件所在位置的名字前缀<br>-p：线程数<br>-U：单端测序<br>–un：单端测序比对不上的片段输出<br>-S：比对情况输出sam<br>–un-conc：双端测序中比对不上的片段</p>
<p>单端测序比对命令：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> `<span class="built_in">cat</span> acc_list.txt`</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">	bowtie2 --<span class="built_in">local</span> -x 02.remove_rRNA_tRNA/rRNA-index/rRNA -p 10 -U 02.clean/<span class="variable">$&#123;i&#125;</span>_trimmed.fq --un 02.remove_rRNA_tRNA/fastq_removed_rRNA/<span class="variable">$&#123;i&#125;</span>.fq  -S 02.remove_rRNA_tRNA/rRNA-sam/<span class="variable">$&#123;i&#125;</span>.rRNA.sam</span><br><span class="line">	bowtie2 --<span class="built_in">local</span> -x 02.remove_rRNA_tRNA/tRNA-index/tRNA -p 10 -U 02.remove_rRNA_tRNA/fastq_removed_rRNA/<span class="variable">$&#123;i&#125;</span>.fq --un 02.remove_rRNA_tRNA/fastq_removed_tRNA/<span class="variable">$&#123;i&#125;</span>.fq -S 02.remove_rRNA_tRNA/tRNA-sam/<span class="variable">$&#123;i&#125;</span>.tRNA.sam</span><br><span class="line"></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<p>双端测序比对命令：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> `<span class="built_in">cat</span> acc_list.txt`</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">	bowtie2 --<span class="built_in">local</span> -x 02.remove_rRNA_tRNA/rRNA-index/rRNA -p 10 -1 02.remove_rRNA_tRNA/fastq_removed_rRNA/<span class="variable">$&#123;i&#125;</span>_rmr_1.fq -2 02.remove_rRNA_tRNA/fastq_removed_rRNA/<span class="variable">$&#123;i&#125;</span>_rmr_2.fq --un-conc 02.remove_rRNA_tRNA/fastq_removed_rRNA/<span class="variable">$&#123;i&#125;</span>_rmr_%.fq  -S 02.remove_rRNA_tRNA/rRNA-sam/<span class="variable">$&#123;i&#125;</span>.rRNA.sam</span><br><span class="line">	bowtie2 --<span class="built_in">local</span> -x 02.remove_rRNA_tRNA/tRNA-index/tRNA -p 10 -1 02.remove_rRNA_tRNA/fastq_removed_rRNA/<span class="variable">$&#123;i&#125;</span>_rmr_1.fq -2 02.remove_rRNA_tRNA/fastq_removed_rRNA/<span class="variable">$&#123;i&#125;</span>_rmr_2.fq --un-conc 02.remove_rRNA_tRNA/fastq_removed_tRNA/<span class="variable">$&#123;i&#125;</span>_rmr_%.fq -S 02.remove_rRNA_tRNA/tRNA-sam/<span class="variable">$&#123;i&#125;</span>.tRNA.sam</span><br><span class="line"></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>
<h2 id="3-Ribo-seq比对"><a href="#3-Ribo-seq比对" class="headerlink" title="3 Ribo-seq比对"></a>3 Ribo-seq比对</h2><p>去除rRNA、tRNA之后，就可以进行比对了。由于Ribo-seq测序得到的是正在翻译的片段，就表明这些序列是具有编码能力的mRNA，因此，比对到全基因组上一般是不准确的，所以一般要比对到转录本序列，一般选择CDS最长的转录本序列进行比对。</p>
<h3 id="3-1-比对"><a href="#3-1-比对" class="headerlink" title="3.1 比对"></a>3.1 比对</h3><p>由于Ribo-seq测序得到的序列比较短，因此我们可以选择bowtie进行比对。<br><strong>参数解释：</strong><br>-v模式参数：-v V其中V为整数。-v V代表全长错配不能超过Ｖ个，可以是0-3。这时，不考虑是否高保真区，也不考虑Phred quality值。<br><strong>–best与–strata</strong><br>–best参数代表报告文件中，每个短序列的匹配结果将按匹配质量由高到低排序。–strata参数必须与–best参数一起使用，其作用是只报告质量最高的那部分。所谓质量高低，其实就是指错配的碱基数，如果指定了-l L参数，那就是在高保真区内的错配数，否则就是全序列的错配数。如果你还指定了 -M X的话，那就会在质量最高的当中，随机选择X个来报告。也就是说，当我们指定了-M 1 –best –strata的话，那就只报告1个最好的。<br>-m：指定同一个序列允许最多比对到基因组上几次。</p>
<p>这里用的参数：最多允许两次错配，一个序列只能在基因组上比对一次。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">bowtie-build 05.transcript_index/longest_cds_trans.fa 05.transcript_index/longest_trans</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> `<span class="built_in">cat</span> acc_list.txt`</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">        </span><br><span class="line">        bowtie -p 10 05.transcript_index/longest_trans 03.removed_fastq/<span class="variable">$i</span>.fq -v 2 -m 1 -a --best --strata --al 06.mapping/mapped_fastq/<span class="variable">$i</span>.mapped.fq -S 06.mapping/<span class="variable">$i</span>.sam</span><br><span class="line">        samtools view 06.mapping/<span class="variable">$i</span>.sam -bS -o 06.mapping/<span class="variable">$i</span>.bam</span><br><span class="line">        samtools <span class="built_in">sort</span> -l 9 06.mapping/<span class="variable">$i</span>.bam -o 06.mapping/<span class="variable">$i</span>.sorted.bam</span><br><span class="line">        <span class="built_in">rm</span> 06.mapping/<span class="variable">$i</span>.bam 06.mapping/<span class="variable">$i</span>.sam</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<h3 id="3-2-定量"><a href="#3-2-定量" class="headerlink" title="3.2 定量"></a>3.2 定量</h3><p>htseq-count进行定量，bam文件中包含了比对上的reads和没有比对上的reads, 只有比对上的reads 会用来计数，htseq-count默认会根据mapping的质量值对BAM文件进行过滤，默认值为10, 意味着只有mapping quality &gt; 10的reads才会用来计数，当然可以通过-a参数来修改这个阈值。</p>
<p>。<br>参数解释：<br>-f：输入文件格式，<br>-s：链特异性<br>-i：设置feature ID是由gtf&#x2F;gff文件第9列那个标签决定的；若gtf&#x2F;gff文件多行具有相同的feature ID，则它们来自同一个feature，程序会计算这些features的表达量之和赋给相应的feature ID。<br>-t：程序会对该指定的feature（gtf&#x2F;gff文件第三列）进行表达量计算，而gtf&#x2F;gff文件中其它的feature都会被忽略，一般为exon&#x2F;CDS。<br>-m：设置表达量计算模式。该参数的值可以有union, intersection-strict and intersection-nonempty。这三种模式的选择请见上面对这3种模式的示意图。从图中可知，对于原核生物，推荐使用intersection-strict模式；对于真核生物，推荐使用union模式。<br><img src="/pics/2022-10-23-htseq.png" alt="alt 图标"></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> `<span class="built_in">cat</span> acc_list.txt`</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">        htseq-count -f bam -s no -i gene_id -t CDS -m union 06.mapping/<span class="variable">$i</span>.sorted.bam 04.extract_transcript/Drosophila_melanogaster.BDGP6.32.107.gtf &gt; 07.count/<span class="variable">$i</span>.read_count.HTSeq.txt</span><br><span class="line">        grep __ ~/*.read_count.HTSeq.txt &gt; ~/*.read_count.HTSeq.txt.summary</span><br><span class="line">        sed -i <span class="string">&#x27;/^__/d&#x27;</span> ~/*.read_count.HTSeq.txt</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Ribo-seq</category>
      </categories>
      <tags>
        <tag>Ribo-seq</tag>
      </tags>
  </entry>
  <entry>
    <title>医学统计学习笔记2</title>
    <url>/2022/09/21/%E5%8C%BB%E5%AD%A6%E7%BB%9F%E8%AE%A1%E7%AC%94%E8%AE%B02/</url>
    <content><![CDATA[<p>临床实验设计与分析</p>
<span id="more"></span>

<h3 id="1-临床试验概述"><a href="#1-临床试验概述" class="headerlink" title="1. 临床试验概述"></a>1. 临床试验概述</h3><p>研究设计的就基本原则：随机、对照、重复（临床试验结果的可重复性）、均衡（控制其他混杂因素的偏倚或非处理因素的影响，如性别、年龄等）<br>统计设计：无偏性（减少非必要的偏倚）、最小变异性（各种因素对变异的贡献程度：把非观察效应去掉，留下处理效应）</p>
<h3 id="2-单因素方差分析"><a href="#2-单因素方差分析" class="headerlink" title="2. 单因素方差分析"></a>2. 单因素方差分析</h3><h4 id="2-1-概念"><a href="#2-1-概念" class="headerlink" title="2.1 概念"></a>2.1 概念</h4><p>方差分析（analysis of variance,ANNOVA）&#x2F;F检验&#x2F;变异数分析：比较不同组别的均数是否有统计学的差异，必须符合正态分布</p>
<blockquote>
<p>注：单因素方差分析：要探讨的只有一个因素，不代表数据只有一处理个因素</p>
</blockquote>
<h4 id="2-2-计算"><a href="#2-2-计算" class="headerlink" title="2.2 计算"></a>2.2 计算</h4><p>总变异 &#x3D; 组间变异 + 组内变异（误差）<br>观察值效应 &#x3D; 总平均效应 + 处理效应 + 随机误差效应</p>
<p>总变异：离均差平方和<br>组间变异：每一组平均值到总平均值的变异。包括处理因素的变异以及随机误差<br>组内变异：每个值到组内平均值的变异。</p>
<p>变异的分解：均方MS&#x3D;离均差平方和&#x2F;自由度<br>总自由度 &#x3D; 组间自由度+组内自由度</p>
<p>F&#x3D;MS组间&#x2F;MS组内，F越大，表示组间差异贡献越大</p>
<h4 id="2-3-应用条件"><a href="#2-3-应用条件" class="headerlink" title="2.3 应用条件"></a>2.3 应用条件</h4><p><strong>方差分析应用条件：</strong><br>独立性：相互独立的随机样本，若不独立，某些因素可能在两个组别之间有一些共有的效应<br>正态性：符合正态分布<br>方差齐性：两个组别的离散程度变异程度是一样的，否则比较均值没有意义</p>
<p>检验方差齐性方法：</p>
<ul>
<li>bartlett检验</li>
<li>levene检验 ：用于对多总体方差进行齐性检验时，所分析的资料可以不具有正态性。</li>
</ul>
<blockquote>
<p>如果方差不齐，可以采用数据变换：</p>
</blockquote>
<ul>
<li>平方根反正弦变换</li>
<li>平方根变换（服从泊松分布）</li>
<li>对数变换（服从对数正态分布：抗体滴度、传染病潜伏期）</li>
</ul>
<h4 id="2-4-完全随机设计资料的方差分析"><a href="#2-4-完全随机设计资料的方差分析" class="headerlink" title="2.4 完全随机设计资料的方差分析"></a>2.4 完全随机设计资料的方差分析</h4><p>研究中只安排一个研究因素，同质的受试对象随机分配到各个处理组中。</p>
<ul>
<li>随机分组</li>
<li>随机安排处理因素</li>
</ul>
<p>满足独立性、正态性、方差齐性的，采用单因素方差分析one-way ANNOVA；<br>对两组情况也可以采用成对t检验；<br>对于非正态或&#x2F;和方差不齐数据，可先进性变量变换，然后采用单向分类方差分析或采用Kruskal-Wills H检验。</p>
<h4 id="2-5-多个样本均数间的多重比较"><a href="#2-5-多个样本均数间的多重比较" class="headerlink" title="2.5 多个样本均数间的多重比较"></a>2.5 多个样本均数间的多重比较</h4><p><strong>多重比较</strong><br>H0:μ1&#x3D;μ2&#x3D;μ3<br>H1:μ1、μ2、μ3不全相等<br>如果方差分析结果拒绝H0，接受H1，则三个数不全相等，比较哪两个总体均数不等，要进行多个样本间两两比较，即多重比较。</p>
<blockquote>
<p>两两t检验（做三组）在统计学上是不妥的，统计学结论都是概率性的，有犯错误的可能。<br>若进行6次t检验来检验4组数据平均值是否相同，每次犯I类错误的概率是α，则进行6次比较，犯I类错误概率为1-(1-α)^6，概率将上升。</p>
</blockquote>
<p><strong>多重比较方法</strong></p>
<ul>
<li>LSD-t检验</li>
<li>Dunnett-t检验</li>
<li>SNK检验&#x2F;q检验</li>
</ul>
<h3 id="3-多因素方差分析"><a href="#3-多因素方差分析" class="headerlink" title="3. 多因素方差分析"></a>3. 多因素方差分析</h3><p>处理因素不止一个。<br>**析因分析:**不止包含两个因素单独的处理效应，还包括交互作用（一阶交互作用AB、BC、AC、二阶交互作用ABC）</p>
<ul>
<li>单独效应:A因素固定时，B因素两个水平取值的差异；如图<br><img src="/pics/2022-09-22-%E5%8D%95%E7%8B%AC%E6%95%88%E5%BA%94.jpg" alt="alt 图标">：</li>
<li>主效应：不管A的水平，探讨B的效应，某一个因素各水平之间的差别；如图<br><img src="/pics/2022-09-22-%E4%B8%BB%E6%95%88%E5%BA%94.jpg" alt="alt 图标"></li>
<li>交互作用：不平行&#x2F;交叉，可能有交互作用；如图<br><img src="/pics/2022-09-22-%E4%BA%A4%E4%BA%92%E4%BD%9C%E7%94%A81.jpg" alt="alt 图标"><br><img src="/pics/2022-09-22-%E4%BA%A4%E4%BA%92%E4%BD%9C%E7%94%A82.jpg" alt="alt 图标"></li>
</ul>
<p>总变异SS总 &#x3D; SS处理 + SS误差 &#x3D; SSA + SSB + SSAB + SS误差<br>自由度V总 &#x3D; V处理 + V误差 &#x3D; VA + VB + VAB + V误差</p>
<p><strong>嵌套设计</strong><br>各因素按隶属关系系统分组，各因素水平没有交叉。A、B因素分别为一级、二级处理因素，例如一级实验因素为饲料的种类，二级实验因素为饲料的喂养量。计算方法如图：<br><img src="/pics/2022-09-22-%E5%B5%8C%E5%A5%97%E8%AE%BE%E8%AE%A1.jpg" alt="alt 图标"></p>
<p>还有正交设计、裂区设计等。<br><img src="/pics/2022-09-22-%E8%A3%82%E5%8C%BA-%E5%B5%8C%E5%A5%97.jpg" alt="alt 图标"></p>
<h3 id="4-协方差分析ANCOVA"><a href="#4-协方差分析ANCOVA" class="headerlink" title="4. 协方差分析ANCOVA"></a>4. 协方差分析ANCOVA</h3><h4 id="4-1-协方差分析"><a href="#4-1-协方差分析" class="headerlink" title="4.1 协方差分析"></a>4.1 协方差分析</h4><p><strong>协方差分析</strong>是将线性回归和方差分析结合起来。<br><strong>协变量co-variant：</strong><br>除处理因素外，与结局有关对观察指标有影响的变量，如性别、年龄、病情严重程度等。<br>例如观察降压药物对血压的影响时，患者的初始血压水平也对血压有影响，但患者血压的初始水平难以控制、但又会对结果造成影响，这样来说初始水平就是一个协变量。</p>
<blockquote>
<p>协变量在组间分布不均衡，可能导致分析结果的偏倚。<br>使协变量组间均衡的方法：<br>    随机分组；按协变量取值进行分层随机化(如40岁的人各个组都放几个)；<br>    在纳入标准中限定个体协变量取值，使所有受试者具有相同的协变量值。<br>    注：即使组间均衡，若个体协变量差异较大，也会影响实验结果。</p>
</blockquote>
<p>协变量分析、多重回归分析、分层分析</p>
<h4 id="4-2-协方差分析的应用条件"><a href="#4-2-协方差分析的应用条件" class="headerlink" title="4.2 协方差分析的应用条件"></a>4.2 协方差分析的应用条件</h4><ul>
<li>方差分析的三个条件<ul>
<li>独立性、正态分布、方差齐性</li>
</ul>
</li>
<li>平行性：存在应变量对协变量的线性回归关系且斜率相同。</li>
<li>协变量的要求<ul>
<li>连续变量</li>
<li>影响观察结局，但不能影响处理因素；</li>
<li>取值应在研究前被观察，或研究中观察，但不受处理的影响。</li>
</ul>
</li>
</ul>
<h4 id="4-2-协方差分析模型"><a href="#4-2-协方差分析模型" class="headerlink" title="4.2 协方差分析模型"></a>4.2 协方差分析模型</h4><p>例如，研究体重正常或超重对胆固醇含量的影响：<br>    自变量：正常&#x2F;超重，二分类变量<br>    协变量:年龄，难以控制的定量因素<br>    应变量：胆固醇含量<br>应变量与协变量的关系：胆固醇含量与年龄的关系，如果与体重正常&#x2F;超重有关，则不满足条件，不能做协方差分析。<br>    协变量年龄与应变量的关系，在两组之间是一样的（斜率相同）。</p>
<p><strong>分析模型</strong><br><img src="/pics/2022-09-22-%E5%8D%8F%E6%96%B9%E5%B7%AE1.jpg" alt="alt 图标"><br>因此要研究体重正常者和超重者的血清胆固醇是否不同，即检验𝛽1是否为0。<br>协方差分析所需要进行的检验包含两步：<br>    ①对不同组别中应变量对协变量的回归系数是否相同进行检验，即平行性检验；<br>    ②若满足平行性假定，则进一步检验两组间应变量总体均数是否存在差异。</p>
<p>假设检验：<br>    1.先检验应变量和协变量的关系 在自变量两个不同组之间是一样的（斜率一样）<br>    2. 应变量和自变量的关系：两样本组总体均值差异检验</p>
<p>Fisher<br>karl pearson<br>student</p>
]]></content>
      <categories>
        <category>统计</category>
      </categories>
      <tags>
        <tag>统计</tag>
      </tags>
  </entry>
  <entry>
    <title>Pandas包学习(1)之Series/DataFrame数据结构</title>
    <url>/2022/11/19/Pandas%E5%8C%85%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B01/</url>
    <content><![CDATA[<p>Pandas 是一个开源的第三方 Python 库，从 Numpy 和 Matplotlib 的基础上构建而来。Pandas 这个名字来源于面板数据（Panel Data）与数据分析（data analysis）这两个名词的组合，Pandas可以提供一个简单、高效、带有默认标签（也可以自定义标签）的 DataFrame 对象。本文总结了Pandas学习笔记。</p>
<span id="more"></span>

<h3 id="1-Pandas内置数据结构"><a href="#1-Pandas内置数据结构" class="headerlink" title="1. Pandas内置数据结构"></a>1. Pandas内置数据结构</h3><p>Pandas内置的数据结构有两种，Series和DataFrame，分别是一维数据结构和二维数据结构。</p>
<table>
<thead>
<tr>
<th align="center">内置变量</th>
<th align="center">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="center">Series(一维)</td>
<td align="center">该结构类似一维数组，能够存储各种数据类型，比如字符数、整数、浮点数、Python 对象等，Series 用 name 和 index 属性来描述数据值。Series 是一维数据结构，因此其维数不可以改变。</td>
</tr>
<tr>
<td align="center">DataFramse(二维)</td>
<td align="center">DataFrame 是一种二维表格型数据的结构，既有行索引，也有列索引。行索引是 index，列索引是 columns。在创建该结构时，可以指定相应的索引值。</td>
</tr>
</tbody></table>
<p>二者结构如图所示：<br><strong>Series</strong><br><img src="/pics/2022-11-19-Series.png" alt="alt图标"><br><a href="http://c.biancheng.net/pandas/series.html">图片来源</a><br><strong>DataFrame</strong><br><img src="/pics/2022-11-19-DataFrame.png" alt="alt图标"><br><a href="http://c.biancheng.net/pandas/dataframe.html">图片来源</a></p>
<h3 id="2-创建Series对象"><a href="#2-创建Series对象" class="headerlink" title="2 创建Series对象"></a>2 创建Series对象</h3><h4 id="2-1-Series-函数创建Series对象"><a href="#2-1-Series-函数创建Series对象" class="headerlink" title="2.1 Series()函数创建Series对象"></a>2.1 Series()函数创建Series对象</h4><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&gt; <span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line">&gt; a = pd.Series(data,index,dtype,copy)</span><br><span class="line"><span class="comment"># data是标量时，必须提供索引值</span></span><br><span class="line">&gt; a = pd.Series(<span class="number">9</span>,index = [<span class="number">0</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>])</span><br><span class="line">&gt; a</span><br><span class="line"><span class="number">0</span> 	<span class="number">9</span></span><br><span class="line"><span class="number">1</span> 	<span class="number">9</span></span><br><span class="line"><span class="number">2</span> 	<span class="number">9</span></span><br><span class="line"><span class="number">3</span> 	<span class="number">9</span></span><br><span class="line">dtype:int64</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th align="center">参数</th>
<th align="center">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="center">data</td>
<td align="center">输入的数据，可以是列表、常量、ndarray 数组等。</td>
</tr>
<tr>
<td align="center">index</td>
<td align="center">索引值必须是惟一的，如果没有传递索引，则默认为 np.arrange(n)。</td>
</tr>
<tr>
<td align="center">dtype</td>
<td align="center">dtype表示数据类型，如果没有提供，则会自动判断得出。</td>
</tr>
<tr>
<td align="center">copy</td>
<td align="center">表示对 data 进行拷贝，默认为 False。</td>
</tr>
</tbody></table>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&gt; a = pd.Series([<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">8</span>])</span><br><span class="line">&gt; a</span><br><span class="line"><span class="number">0</span> 	<span class="number">5</span></span><br><span class="line"><span class="number">1</span> 	<span class="number">6</span></span><br><span class="line"><span class="number">2</span> 	<span class="number">7</span></span><br><span class="line"><span class="number">3</span> 	<span class="number">8</span></span><br><span class="line">dtype: int64</span><br><span class="line"><span class="comment"># dtype：数据类型</span></span><br></pre></td></tr></table></figure>

<h4 id="2-2-获取数据和索引"><a href="#2-2-获取数据和索引" class="headerlink" title="2.2 获取数据和索引"></a>2.2 获取数据和索引</h4><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&gt; a.index</span><br><span class="line">RangeIndex(start=<span class="number">0</span>, stop=<span class="number">4</span>, step=<span class="number">1</span>)</span><br><span class="line"><span class="comment">#索引从0开始</span></span><br><span class="line">&gt; a.values</span><br><span class="line">array([<span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>], dtype=int64)</span><br></pre></td></tr></table></figure>

<h4 id="2-3-修改索引"><a href="#2-3-修改索引" class="headerlink" title="2.3 修改索引"></a>2.3 修改索引</h4><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&gt; a = pd.Series(a.values,index=[<span class="number">10</span>,<span class="number">11</span>,<span class="number">12</span>,<span class="number">13</span>])</span><br><span class="line">&gt; a</span><br><span class="line"><span class="number">10</span>    <span class="number">5</span></span><br><span class="line"><span class="number">11</span>    <span class="number">6</span></span><br><span class="line"><span class="number">12</span>    <span class="number">7</span></span><br><span class="line"><span class="number">13</span>    <span class="number">8</span></span><br><span class="line">dtype: int64</span><br></pre></td></tr></table></figure>
<p>Series还可以使用显示索引。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&gt; a = pd.Series(a.values,index=[<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;b&#x27;</span>,<span class="string">&#x27;c&#x27;</span>,<span class="string">&#x27;d&#x27;</span>])</span><br><span class="line">&gt; a</span><br><span class="line">a    <span class="number">5</span></span><br><span class="line">b    <span class="number">6</span></span><br><span class="line">c    <span class="number">7</span></span><br><span class="line">d    <span class="number">8</span></span><br><span class="line">dtype: int64</span><br><span class="line">&gt; a[<span class="string">&#x27;c&#x27;</span>]</span><br><span class="line"><span class="number">7</span></span><br></pre></td></tr></table></figure>

<h4 id="2-4-使用dict创建Series对象"><a href="#2-4-使用dict创建Series对象" class="headerlink" title="2.4 使用dict创建Series对象"></a>2.4 使用dict创建Series对象</h4><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&gt; <span class="built_in">dict</span> = &#123;<span class="string">&#x27;a&#x27;</span>:<span class="number">1</span>,<span class="string">&#x27;b&#x27;</span>:<span class="number">2</span>,<span class="string">&#x27;c&#x27;</span>:<span class="number">3</span>,<span class="string">&#x27;d&#x27;</span>:<span class="number">4</span>&#125;</span><br><span class="line">&gt; b = pd.Series(<span class="built_in">dict</span>)</span><br><span class="line">&gt; b</span><br><span class="line">a    <span class="number">1</span></span><br><span class="line">b    <span class="number">2</span></span><br><span class="line">c    <span class="number">3</span></span><br><span class="line">d    <span class="number">4</span></span><br><span class="line">dtype: int64</span><br></pre></td></tr></table></figure>

<h4 id="2-5-访问元素"><a href="#2-5-访问元素" class="headerlink" title="2.5 访问元素"></a>2.5 访问元素</h4><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 位置索引</span></span><br><span class="line">&gt; b[<span class="number">0</span>]</span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="comment"># 索引标签</span></span><br><span class="line">&gt; b[<span class="string">&#x27;a&#x27;</span>]</span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="comment"># 切片</span></span><br><span class="line">&gt; b[-<span class="number">2</span>:]</span><br><span class="line">c    <span class="number">3</span></span><br><span class="line">d    <span class="number">4</span></span><br><span class="line">dtype: int64</span><br></pre></td></tr></table></figure>

<h4 id="2-6-Series常用属性"><a href="#2-6-Series常用属性" class="headerlink" title="2.6 Series常用属性"></a>2.6 Series常用属性</h4><p>常用属性如下：</p>
<table>
<thead>
<tr>
<th align="center">名称</th>
<th align="center">属性</th>
</tr>
</thead>
<tbody><tr>
<td align="center">axes</td>
<td align="center">以列表的形式返回所有行索引标签。</td>
</tr>
<tr>
<td align="center">dtype</td>
<td align="center">返回对象的数据类型。</td>
</tr>
<tr>
<td align="center">empty</td>
<td align="center">返回一个空的 Series 对象。</td>
</tr>
<tr>
<td align="center">ndim</td>
<td align="center">返回输入数据的维数。</td>
</tr>
<tr>
<td align="center">size</td>
<td align="center">返回输入数据的元素数量。</td>
</tr>
<tr>
<td align="center">values</td>
<td align="center">以 ndarray 的形式返回 Series 对象。</td>
</tr>
<tr>
<td align="center">index</td>
<td align="center">返回一个RangeIndex对象，用来描述索引的取值范围。</td>
</tr>
</tbody></table>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&gt; b.axes</span><br><span class="line">[Index([<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;d&#x27;</span>], dtype=<span class="string">&#x27;object&#x27;</span>)]</span><br><span class="line">&gt; b.dtype</span><br><span class="line">dtype(<span class="string">&#x27;int64&#x27;</span>)</span><br><span class="line">&gt; b.empty</span><br><span class="line">FALSE</span><br><span class="line">&gt; b.ndim</span><br><span class="line"><span class="number">1</span></span><br><span class="line">&gt; b.size</span><br><span class="line"><span class="number">4</span></span><br><span class="line">&gt; b.values</span><br><span class="line">array([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>], dtype=int64)</span><br><span class="line">&gt; b.index</span><br><span class="line">Index([<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;d&#x27;</span>], dtype=<span class="string">&#x27;object&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="3-创建DataFrame对象"><a href="#3-创建DataFrame对象" class="headerlink" title="3 创建DataFrame对象"></a>3 创建DataFrame对象</h3><h4 id="3-1-DataFrame-函数创建DataFrame对象"><a href="#3-1-DataFrame-函数创建DataFrame对象" class="headerlink" title="3.1 DataFrame()函数创建DataFrame对象"></a>3.1 DataFrame()函数创建DataFrame对象</h4><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">aa = pd.DataFrame(data,index,columns,dtype,copy)</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th align="center">参数</th>
<th align="center">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="center">data</td>
<td align="center">输入的数据，可以是 ndarray，series，list，dict，标量以及一个 DataFrame。</td>
</tr>
<tr>
<td align="center">index</td>
<td align="center">行标签，如果没有传递 index 值，则默认行标签是 np.arange(n)，n 代表 data 的元素个数。</td>
</tr>
<tr>
<td align="center">columns</td>
<td align="center">列标签，如果没有传递 columns 值，则默认列标签是 np.arange(n)。</td>
</tr>
<tr>
<td align="center">dtype</td>
<td align="center">dtype表示每一列的数据类型。</td>
</tr>
<tr>
<td align="center">copy</td>
<td align="center">默认为 False，表示复制数据 data。</td>
</tr>
</tbody></table>
<ol>
<li>单一列表创建<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&gt; data = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>]</span><br><span class="line">&gt; aa = pd.DataFrame(data)</span><br><span class="line">&gt; aa</span><br><span class="line">   <span class="number">0</span></span><br><span class="line"><span class="number">0</span>  <span class="number">1</span></span><br><span class="line"><span class="number">1</span>  <span class="number">2</span></span><br><span class="line"><span class="number">2</span>  <span class="number">3</span></span><br><span class="line"><span class="number">3</span>  <span class="number">4</span></span><br><span class="line"><span class="number">4</span>  <span class="number">5</span></span><br></pre></td></tr></table></figure></li>
<li>嵌套列表创建<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&gt; data = [[<span class="string">&#x27;a&#x27;</span>,<span class="number">1</span>],[<span class="string">&#x27;b&#x27;</span>,<span class="number">2</span>],[<span class="string">&#x27;c&#x27;</span>,<span class="number">3</span>],[<span class="string">&#x27;d&#x27;</span>,<span class="number">4</span>]]</span><br><span class="line">&gt; bb = pd.DataFrame(data)</span><br><span class="line">&gt; bb</span><br><span class="line">   <span class="number">0</span>  <span class="number">1</span></span><br><span class="line"><span class="number">0</span>  a  <span class="number">1</span></span><br><span class="line"><span class="number">1</span>  b  <span class="number">2</span></span><br><span class="line"><span class="number">2</span>  c  <span class="number">3</span></span><br><span class="line"><span class="number">3</span>  d  <span class="number">4</span></span><br><span class="line"><span class="comment">## 添加列名</span></span><br><span class="line">&gt; bb = bb.DataFrame(data,columns=[<span class="string">&#x27;char&#x27;</span>,<span class="string">&#x27;num&#x27;</span>])</span><br><span class="line">&gt; bb</span><br><span class="line">  char  num</span><br><span class="line"><span class="number">0</span>    a    <span class="number">1</span></span><br><span class="line"><span class="number">1</span>    b    <span class="number">2</span></span><br><span class="line"><span class="number">2</span>    c    <span class="number">3</span></span><br><span class="line"><span class="number">3</span>    d    <span class="number">4</span></span><br></pre></td></tr></table></figure></li>
<li>字典嵌套列表创建<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&gt; data = &#123;<span class="string">&#x27;char&#x27;</span>:[<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;b&#x27;</span>,<span class="string">&#x27;c&#x27;</span>,<span class="string">&#x27;d&#x27;</span>],<span class="string">&#x27;num&#x27;</span>:[<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>]&#125;</span><br><span class="line">&gt; bb = pd.DataFrame(data)</span><br><span class="line">  char  num</span><br><span class="line"><span class="number">0</span>    a    <span class="number">1</span></span><br><span class="line"><span class="number">1</span>    b    <span class="number">2</span></span><br><span class="line"><span class="number">2</span>    c    <span class="number">3</span></span><br><span class="line"><span class="number">3</span>    d    <span class="number">4</span></span><br><span class="line"><span class="comment">## 添加行名</span></span><br><span class="line">&gt; bb = pd.DataFrame(data,index=[<span class="string">&#x27;row1&#x27;</span>,<span class="string">&#x27;row2&#x27;</span>,<span class="string">&#x27;row3&#x27;</span>,<span class="string">&#x27;row4&#x27;</span>])</span><br><span class="line">&gt; bb</span><br><span class="line">     char  num</span><br><span class="line">row1    a    <span class="number">1</span></span><br><span class="line">row2    b    <span class="number">2</span></span><br><span class="line">row3    c    <span class="number">3</span></span><br><span class="line">row4    d    <span class="number">4</span></span><br></pre></td></tr></table></figure></li>
<li>列表嵌套字典创建<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&gt; data = [&#123;<span class="string">&#x27;a&#x27;</span>:<span class="number">1</span>,<span class="string">&#x27;b&#x27;</span>:<span class="number">2</span>&#125;,&#123;<span class="string">&#x27;a&#x27;</span>:<span class="number">5</span>,<span class="string">&#x27;b&#x27;</span>:<span class="number">3</span>,<span class="string">&#x27;c&#x27;</span>:<span class="number">2</span>&#125;]</span><br><span class="line">&gt; cc = pd.DataFrame(data)</span><br><span class="line">&gt; cc</span><br><span class="line">   a  b    c</span><br><span class="line"><span class="number">0</span>  <span class="number">1</span>  <span class="number">2</span>  NaN</span><br><span class="line"><span class="number">1</span>  <span class="number">5</span>  <span class="number">3</span>  <span class="number">2.0</span></span><br><span class="line">&gt; cc = pd.DataFrame(data,index=[<span class="string">&#x27;row1&#x27;</span>,<span class="string">&#x27;row2&#x27;</span>])</span><br><span class="line">&gt; cc</span><br><span class="line">      a  b    c</span><br><span class="line">row1  <span class="number">1</span>  <span class="number">2</span>  NaN</span><br><span class="line">row2  <span class="number">5</span>  <span class="number">3</span>  <span class="number">2.0</span></span><br><span class="line">&gt; cc = pd.DataFrame(data,index=[<span class="string">&#x27;row1&#x27;</span>,<span class="string">&#x27;row2&#x27;</span>],columns=[<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;b&#x27;</span>,<span class="string">&#x27;c&#x27;</span>])</span><br><span class="line">&gt; cc</span><br><span class="line">      a  b    c</span><br><span class="line">row1  <span class="number">1</span>  <span class="number">2</span>  NaN</span><br><span class="line">row2  <span class="number">5</span>  <span class="number">3</span>  <span class="number">2.0</span></span><br><span class="line">&gt; cc = pd.DataFrame(data,index=[<span class="string">&#x27;row1&#x27;</span>,<span class="string">&#x27;row2&#x27;</span>],columns=[<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;b&#x27;</span>])</span><br><span class="line">&gt; cc</span><br><span class="line">      a  b</span><br><span class="line">row1  <span class="number">1</span>  <span class="number">2</span></span><br><span class="line">row2  <span class="number">5</span>  <span class="number">3</span></span><br><span class="line"><span class="comment">## columns要和字典的key对应，否则为NaN</span></span><br><span class="line">&gt; cc = pd.DataFrame(data,index=[<span class="string">&#x27;row1&#x27;</span>,<span class="string">&#x27;row2&#x27;</span>],columns=[<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;b2&#x27;</span>])</span><br><span class="line">&gt; cc</span><br><span class="line">      a  b2</span><br><span class="line">row1  <span class="number">1</span> NaN</span><br><span class="line">row2  <span class="number">5</span> NaN</span><br></pre></td></tr></table></figure></li>
<li>Series创建DataFrame对象<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&gt; data = &#123;<span class="string">&#x27;col1&#x27;</span>:pd.Series([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>],index=[<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;b&#x27;</span>,<span class="string">&#x27;c&#x27;</span>]),</span><br><span class="line">		  <span class="string">&#x27;col2&#x27;</span>:pd.Series([<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>],index=[<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;b&#x27;</span>,<span class="string">&#x27;c&#x27;</span>,<span class="string">&#x27;d&#x27;</span>])&#125;</span><br><span class="line">&gt; dd = pd.DataFrame(data)</span><br><span class="line">&gt; dd</span><br><span class="line">   col1  col2</span><br><span class="line">a   <span class="number">1.0</span>     <span class="number">4</span></span><br><span class="line">b   <span class="number">2.0</span>     <span class="number">5</span></span><br><span class="line">c   <span class="number">3.0</span>     <span class="number">6</span></span><br><span class="line">d   NaN     <span class="number">7</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="3-2-列索引"><a href="#3-2-列索引" class="headerlink" title="3.2 列索引"></a>3.2 列索引</h4><ol>
<li><p>列索引访问数据列</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&gt; dd[<span class="string">&#x27;col1&#x27;</span>]</span><br><span class="line">a    <span class="number">1.0</span></span><br><span class="line">b    <span class="number">2.0</span></span><br><span class="line">c    <span class="number">3.0</span></span><br><span class="line">d    NaN</span><br><span class="line">Name: col1, dtype: float64</span><br></pre></td></tr></table></figure>
</li>
<li><p>列索引添加数据列</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">## (1) df[&#x27;name&#x27;]=value</span></span><br><span class="line">&gt; dd[<span class="string">&#x27;col3&#x27;</span>]=pd.Series([<span class="number">8</span>,<span class="number">9</span>,<span class="number">10</span>],index=[<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;c&#x27;</span>,<span class="string">&#x27;d&#x27;</span>])</span><br><span class="line">&gt; dd</span><br><span class="line">   col1  col2  col3</span><br><span class="line">a   <span class="number">1.0</span>     <span class="number">4</span>   <span class="number">8.0</span></span><br><span class="line">b   <span class="number">2.0</span>     <span class="number">5</span>   NaN</span><br><span class="line">c   <span class="number">3.0</span>     <span class="number">6</span>   <span class="number">9.0</span></span><br><span class="line">d   NaN     <span class="number">7</span>  <span class="number">10.0</span></span><br><span class="line"></span><br><span class="line">&gt; dd[<span class="string">&#x27;col4&#x27;</span>] = dd[<span class="string">&#x27;col1&#x27;</span>]+dd[<span class="string">&#x27;col3&#x27;</span>]</span><br><span class="line">&gt; dd</span><br><span class="line">   col1  col2  col3  col4</span><br><span class="line">a   <span class="number">1.0</span>     <span class="number">4</span>   <span class="number">8.0</span>   <span class="number">9.0</span></span><br><span class="line">b   <span class="number">2.0</span>     <span class="number">5</span>   NaN   NaN</span><br><span class="line">c   <span class="number">3.0</span>     <span class="number">6</span>   <span class="number">9.0</span>  <span class="number">12.0</span></span><br><span class="line">d   NaN     <span class="number">7</span>  <span class="number">10.0</span>   NaN</span><br><span class="line"></span><br><span class="line"><span class="comment">## (2) df.insert</span></span><br><span class="line">&gt; dd.insert(<span class="number">2</span>,column=<span class="string">&#x27;insert&#x27;</span>,value=[<span class="number">60</span>,<span class="number">70</span>,<span class="number">80</span>,<span class="number">90</span>])</span><br><span class="line">&gt; dd</span><br><span class="line">   col1  insert  col2  col3  col4</span><br><span class="line">a   <span class="number">1.0</span>      <span class="number">60</span>     <span class="number">4</span>   <span class="number">8.0</span>   <span class="number">9.0</span></span><br><span class="line">b   <span class="number">2.0</span>      <span class="number">70</span>     <span class="number">5</span>   NaN   NaN</span><br><span class="line">c   <span class="number">3.0</span>      <span class="number">80</span>     <span class="number">6</span>   <span class="number">9.0</span>  <span class="number">12.0</span></span><br><span class="line">d   NaN      <span class="number">90</span>     <span class="number">7</span>  <span class="number">10.0</span>   NaN</span><br></pre></td></tr></table></figure>
</li>
<li><p>列索引删除数据列: del 和pop()</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&gt; <span class="keyword">del</span> dd[<span class="string">&#x27;insert&#x27;</span>]</span><br><span class="line">&gt; dd</span><br><span class="line">   col1  col2  col3  col4</span><br><span class="line">a   <span class="number">1.0</span>     <span class="number">4</span>   <span class="number">8.0</span>   <span class="number">9.0</span></span><br><span class="line">b   <span class="number">2.0</span>     <span class="number">5</span>   NaN   NaN</span><br><span class="line">c   <span class="number">3.0</span>     <span class="number">6</span>   <span class="number">9.0</span>  <span class="number">12.0</span></span><br><span class="line">d   NaN     <span class="number">7</span>  <span class="number">10.0</span>   NaN</span><br><span class="line"></span><br><span class="line">&gt; dd.pop(<span class="string">&#x27;insert&#x27;</span>)</span><br><span class="line">a     <span class="number">9.0</span></span><br><span class="line">b     NaN</span><br><span class="line">c    <span class="number">12.0</span></span><br><span class="line">d     NaN</span><br><span class="line">Name: col4, dtype: float64</span><br><span class="line">&gt; dd</span><br><span class="line">   col1  col2  col3</span><br><span class="line">a   <span class="number">1.0</span>     <span class="number">4</span>   <span class="number">8.0</span></span><br><span class="line">b   <span class="number">2.0</span>     <span class="number">5</span>   NaN</span><br><span class="line">c   <span class="number">3.0</span>     <span class="number">6</span>   <span class="number">9.0</span></span><br><span class="line">d   NaN     <span class="number">7</span>  <span class="number">10.0</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="3-4-行索引"><a href="#3-4-行索引" class="headerlink" title="3.4 行索引"></a>3.4 行索引</h4><ol>
<li><p>标签索引选取<br>将行标签传递给loc函数，来选取数据。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&gt; dd.loc[<span class="string">&#x27;b&#x27;</span>]</span><br><span class="line">col1    <span class="number">2.0</span></span><br><span class="line">col2    <span class="number">5.0</span></span><br><span class="line">col3    NaN</span><br><span class="line">Name: b, dtype: float64</span><br></pre></td></tr></table></figure>
</li>
<li><p>整数索引选取<br>将数据行所在的索引值传递给iloc函数。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&gt; dd.iloc[<span class="number">1</span>]	<span class="comment"># 行索引</span></span><br><span class="line">col1    <span class="number">2.0</span></span><br><span class="line">col2    <span class="number">5.0</span></span><br><span class="line">col3    NaN</span><br><span class="line">Name: b, dtype: float64</span><br><span class="line">&gt; dd.iloc[<span class="number">1</span>,<span class="number">0</span>] <span class="comment"># 行索引，列索引</span></span><br><span class="line"><span class="number">2.0</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>切片选取多行</p>
</li>
</ol>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&gt; dd[<span class="number">1</span>:]</span><br><span class="line">   col1  col2  col3</span><br><span class="line">b   <span class="number">2.0</span>     <span class="number">5</span>   NaN</span><br><span class="line">c   <span class="number">3.0</span>     <span class="number">6</span>   <span class="number">9.0</span></span><br><span class="line">d   NaN     <span class="number">7</span>  <span class="number">10.0</span></span><br></pre></td></tr></table></figure>

<ol start="4">
<li>添加数据行</li>
</ol>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&gt; ee = pd.DataFrame([[<span class="number">1</span>,<span class="number">2</span>],[<span class="number">3</span>,<span class="number">4</span>]],columns=[<span class="string">&#x27;col1&#x27;</span>,<span class="string">&#x27;col2&#x27;</span>])</span><br><span class="line">&gt; ee</span><br><span class="line">   col1  col2</span><br><span class="line"><span class="number">0</span>     <span class="number">1</span>     <span class="number">2</span></span><br><span class="line"><span class="number">1</span>     <span class="number">3</span>     <span class="number">4</span></span><br><span class="line">&gt; dd = dd.append(ee)</span><br><span class="line">&gt; dd</span><br><span class="line">   col1  col2  col3</span><br><span class="line">a   <span class="number">1.0</span>     <span class="number">4</span>   <span class="number">8.0</span></span><br><span class="line">b   <span class="number">2.0</span>     <span class="number">5</span>   NaN</span><br><span class="line">c   <span class="number">3.0</span>     <span class="number">6</span>   <span class="number">9.0</span></span><br><span class="line">d   NaN     <span class="number">7</span>  <span class="number">10.0</span></span><br><span class="line"><span class="number">0</span>   <span class="number">1.0</span>     <span class="number">2</span>   NaN</span><br><span class="line"><span class="number">1</span>   <span class="number">3.0</span>     <span class="number">4</span>   NaN</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>删除数据行</li>
</ol>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&gt; dd = dd.drop(<span class="number">0</span>) <span class="comment">#并不直接改变dd，而是返回删除行之后的dataframe</span></span><br><span class="line">&gt; dd</span><br><span class="line">   col1  col2  col3</span><br><span class="line">a   <span class="number">1.0</span>     <span class="number">4</span>   <span class="number">8.0</span></span><br><span class="line">b   <span class="number">2.0</span>     <span class="number">5</span>   NaN</span><br><span class="line">c   <span class="number">3.0</span>     <span class="number">6</span>   <span class="number">9.0</span></span><br><span class="line">d   NaN     <span class="number">7</span>  <span class="number">10.0</span></span><br><span class="line"><span class="number">1</span>   <span class="number">3.0</span>     <span class="number">4</span>   NaN</span><br><span class="line"><span class="comment"># 注：如果行索引标签有重复值，会被一起删除</span></span><br></pre></td></tr></table></figure>

<h4 id="3-5-DataFrame属性"><a href="#3-5-DataFrame属性" class="headerlink" title="3.5 DataFrame属性"></a>3.5 DataFrame属性</h4><p>常用的属性(≠函数)如下：</p>
<table>
<thead>
<tr>
<th align="center">名称</th>
<th align="center">属性&amp;方法描述</th>
</tr>
</thead>
<tbody><tr>
<td align="center">T</td>
<td align="center">行和列转置。</td>
</tr>
<tr>
<td align="center">axes</td>
<td align="center">返回一个仅以行轴标签和列轴标签为成员的列表。</td>
</tr>
<tr>
<td align="center">dtypes</td>
<td align="center">返回每列数据的数据类型。</td>
</tr>
<tr>
<td align="center">empty</td>
<td align="center">DataFrame中没有数据或者任意坐标轴的长度为0，则返回True。</td>
</tr>
<tr>
<td align="center">ndim</td>
<td align="center">轴的数量，也指数组的维数。</td>
</tr>
<tr>
<td align="center">shape</td>
<td align="center">返回一个元组，表示了 DataFrame 维度。</td>
</tr>
<tr>
<td align="center">size</td>
<td align="center">DataFrame中的元素数量。</td>
</tr>
<tr>
<td align="center">values</td>
<td align="center">使用 numpy 数组表示 DataFrame 中的元素值。</td>
</tr>
<tr>
<td align="center">head()</td>
<td align="center">返回前 n 行数据。</td>
</tr>
<tr>
<td align="center">tail()</td>
<td align="center">返回后 n 行数据。</td>
</tr>
<tr>
<td align="center">vshift()</td>
<td align="center">将行或列移动指定的步幅长度</td>
</tr>
</tbody></table>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&gt; dd.T</span><br><span class="line">        a    b    c     d    <span class="number">0</span>    <span class="number">1</span></span><br><span class="line">col1  <span class="number">1.0</span>  <span class="number">2.0</span>  <span class="number">3.0</span>   NaN  <span class="number">1.0</span>  <span class="number">3.0</span></span><br><span class="line">col2  <span class="number">4.0</span>  <span class="number">5.0</span>  <span class="number">6.0</span>   <span class="number">7.0</span>  <span class="number">2.0</span>  <span class="number">4.0</span></span><br><span class="line">col3  <span class="number">8.0</span>  NaN  <span class="number">9.0</span>  <span class="number">10.0</span>  NaN  NaN</span><br><span class="line"></span><br><span class="line"><span class="comment"># 返回一个行标签、列标签组成的列表</span></span><br><span class="line">&gt; dd.axes</span><br><span class="line">[Index([<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;d&#x27;</span>, <span class="number">0</span>, <span class="number">1</span>], dtype=<span class="string">&#x27;object&#x27;</span>), Index([<span class="string">&#x27;col1&#x27;</span>, <span class="string">&#x27;col2&#x27;</span>, <span class="string">&#x27;col3&#x27;</span>], dtype=<span class="string">&#x27;object&#x27;</span>)]</span><br><span class="line"></span><br><span class="line">&gt; dd.axes[<span class="number">0</span>]</span><br><span class="line">Index([<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;d&#x27;</span>, <span class="number">0</span>, <span class="number">1</span>], dtype=<span class="string">&#x27;object&#x27;</span>)</span><br><span class="line"></span><br><span class="line">&gt; dd.axes[<span class="number">1</span>]</span><br><span class="line">Index([<span class="string">&#x27;col1&#x27;</span>, <span class="string">&#x27;col2&#x27;</span>, <span class="string">&#x27;col3&#x27;</span>], dtype=<span class="string">&#x27;object&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 返回每列的数据类型</span></span><br><span class="line">&gt; dd.dtypes</span><br><span class="line">col1    float64</span><br><span class="line">col2      int64</span><br><span class="line">col3    float64</span><br><span class="line">dtype: <span class="built_in">object</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 返回布尔值，判断是否为空</span></span><br><span class="line">&gt;	dd.empty</span><br><span class="line"><span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 返回对象的维数,DataFrame是二维数据结构</span></span><br><span class="line">&gt; dd.ndim</span><br><span class="line"><span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 返回DataFrame维度的元组(a,b)，a是行数，b是列数</span></span><br><span class="line">&gt; dd.shape</span><br><span class="line">(<span class="number">6</span>,<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 返回元素数量 行×列</span></span><br><span class="line">&gt; dd.size</span><br><span class="line"><span class="number">18</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 以ndarray数组形式返回DataFrame中的数据</span></span><br><span class="line">&gt; dd.values</span><br><span class="line">array([[ <span class="number">1.</span>,  <span class="number">4.</span>,  <span class="number">8.</span>],</span><br><span class="line">       [ <span class="number">2.</span>,  <span class="number">5.</span>, nan],</span><br><span class="line">       [ <span class="number">3.</span>,  <span class="number">6.</span>,  <span class="number">9.</span>],</span><br><span class="line">       [nan,  <span class="number">7.</span>, <span class="number">10.</span>],</span><br><span class="line">       [ <span class="number">1.</span>,  <span class="number">2.</span>, nan],</span><br><span class="line">       [ <span class="number">3.</span>,  <span class="number">4.</span>, nan]])</span><br><span class="line">&gt; dd.values[<span class="number">0</span>]</span><br><span class="line">array([<span class="number">1.</span>, <span class="number">4.</span>, <span class="number">8.</span>])</span><br><span class="line">&gt; dd.values[<span class="number">0</span>][<span class="number">0</span>]</span><br><span class="line"><span class="number">1.0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看数据的前n行或后n行数据,默认为5行</span></span><br><span class="line">&gt; dd.head()</span><br><span class="line">   col1  col2  col3</span><br><span class="line">a   <span class="number">1.0</span>     <span class="number">4</span>   <span class="number">8.0</span></span><br><span class="line">b   <span class="number">2.0</span>     <span class="number">5</span>   NaN</span><br><span class="line">c   <span class="number">3.0</span>     <span class="number">6</span>   <span class="number">9.0</span></span><br><span class="line">d   NaN     <span class="number">7</span>  <span class="number">10.0</span></span><br><span class="line"><span class="number">0</span>   <span class="number">1.0</span>     <span class="number">2</span>   NaN</span><br><span class="line"></span><br><span class="line">&gt; dd.head(<span class="number">2</span>)</span><br><span class="line">   col1  col2  col3</span><br><span class="line">a   <span class="number">1.0</span>     <span class="number">4</span>   <span class="number">8.0</span></span><br><span class="line">b   <span class="number">2.0</span>     <span class="number">5</span>   NaN</span><br><span class="line"></span><br><span class="line">&gt; dd.tail(<span class="number">2</span>)</span><br><span class="line">   col1  col2  col3</span><br><span class="line"><span class="number">0</span>   <span class="number">1.0</span>     <span class="number">2</span>   NaN</span><br><span class="line"><span class="number">1</span>   <span class="number">3.0</span>     <span class="number">4</span>   NaN</span><br><span class="line"></span><br><span class="line"><span class="comment"># 移动某一行/列</span></span><br><span class="line">ex:</span><br><span class="line">&gt; DataFrame.shift(periods=<span class="number">1</span>, freq=<span class="literal">None</span>, axis=<span class="number">0</span>)  </span><br><span class="line"></span><br><span class="line"><span class="comment"># periods，int，表示移动幅度，可正可负</span></span><br><span class="line"><span class="comment"># axis=0/&quot;index&quot;表示上下移动</span></span><br><span class="line">&gt; dd</span><br><span class="line">   col1  col2  col3</span><br><span class="line">a   <span class="number">1.0</span>     <span class="number">4</span>   <span class="number">8.0</span></span><br><span class="line">b   <span class="number">2.0</span>     <span class="number">5</span>   NaN</span><br><span class="line">c   <span class="number">3.0</span>     <span class="number">6</span>   <span class="number">9.0</span></span><br><span class="line">d   NaN     <span class="number">7</span>  <span class="number">10.0</span></span><br><span class="line"><span class="number">0</span>   <span class="number">1.0</span>     <span class="number">2</span>   NaN</span><br><span class="line"><span class="number">1</span>   <span class="number">3.0</span>     <span class="number">4</span>   NaN</span><br><span class="line"></span><br><span class="line">&gt; dd.shift(periods=<span class="number">2</span>,axis=<span class="number">0</span>)</span><br><span class="line">   col1  col2  col3</span><br><span class="line">a   NaN   NaN   NaN</span><br><span class="line">b   NaN   NaN   NaN</span><br><span class="line">c   <span class="number">1.0</span>   <span class="number">4.0</span>   <span class="number">8.0</span></span><br><span class="line">d   <span class="number">2.0</span>   <span class="number">5.0</span>   NaN</span><br><span class="line"><span class="number">0</span>   <span class="number">3.0</span>   <span class="number">6.0</span>   <span class="number">9.0</span></span><br><span class="line"><span class="number">1</span>   NaN   <span class="number">7.0</span>  <span class="number">10.0</span></span><br><span class="line">&gt; dd.shift(periods=-<span class="number">2</span>,axis=<span class="number">0</span>)</span><br><span class="line">   col1  col2  col3</span><br><span class="line">a   <span class="number">3.0</span>   <span class="number">6.0</span>   <span class="number">9.0</span></span><br><span class="line">b   NaN   <span class="number">7.0</span>  <span class="number">10.0</span></span><br><span class="line">c   <span class="number">1.0</span>   <span class="number">2.0</span>   NaN</span><br><span class="line">d   <span class="number">3.0</span>   <span class="number">4.0</span>   NaN</span><br><span class="line"><span class="number">0</span>   NaN   NaN   NaN</span><br><span class="line"><span class="number">1</span>   NaN   NaN   NaN</span><br><span class="line"></span><br><span class="line"><span class="comment"># axis=1/&quot;columns&quot;表示左右移动</span></span><br><span class="line">&gt; dd.shift(periods=<span class="number">2</span>,axis=<span class="number">1</span>)</span><br><span class="line">   col1  col2  col3</span><br><span class="line">a   NaN   NaN   <span class="number">1.0</span></span><br><span class="line">b   NaN   NaN   <span class="number">2.0</span></span><br><span class="line">c   NaN   NaN   <span class="number">3.0</span></span><br><span class="line">d   NaN   NaN   NaN</span><br><span class="line"><span class="number">0</span>   NaN   NaN   <span class="number">1.0</span></span><br><span class="line"><span class="number">1</span>   NaN   NaN   <span class="number">3.0</span></span><br><span class="line">&gt; dd.shift(periods=-<span class="number">2</span>,axis=<span class="number">1</span>)</span><br><span class="line">   col1  col2  col3</span><br><span class="line">a   <span class="number">8.0</span>   NaN   NaN</span><br><span class="line">b   NaN   NaN   NaN</span><br><span class="line">c   <span class="number">9.0</span>   NaN   NaN</span><br><span class="line">d  <span class="number">10.0</span>   NaN   NaN</span><br><span class="line"><span class="number">0</span>   NaN   NaN   NaN</span><br><span class="line"><span class="number">1</span>   NaN   NaN   NaN</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Python</category>
      </categories>
      <tags>
        <tag>Python</tag>
      </tags>
  </entry>
  <entry>
    <title>Shell中同时遍历两个变量</title>
    <url>/2022/11/22/Shell%E4%B8%AD%E5%90%8C%E6%97%B6%E9%81%8D%E5%8E%86%E4%B8%A4%E4%B8%AA%E5%8F%98%E9%87%8F/</url>
    <content><![CDATA[<p>在bash脚本中同时遍历两个变量。</p>
<span id="more"></span>

<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&gt; <span class="built_in">cat</span> file1.txt</span><br><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">&gt; <span class="built_in">cat</span> file2.txt</span><br><span class="line">a </span><br><span class="line">b</span><br><span class="line">c</span><br><span class="line">d</span><br></pre></td></tr></table></figure>
<p>脚本内容：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/bash</span></span><br><span class="line"></span><br><span class="line">num=(`<span class="built_in">cat</span> file1.txt`)</span><br><span class="line"><span class="comment">#等价于定义数组 num=(1 2 3 4) </span></span><br><span class="line">char=(`<span class="built_in">cat</span> file2.txt`)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> ((i=0;i&lt;4;i++))</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">	<span class="comment">#调用数组的第i个变量</span></span><br><span class="line">	<span class="built_in">echo</span> <span class="variable">$&#123;num[$i]&#125;</span> <span class="variable">$&#123;char[$i]&#125;</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>
<p>结果：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">1 a </span><br><span class="line">2 b</span><br><span class="line">3 c</span><br><span class="line">4 d</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>linux</tag>
      </tags>
  </entry>
  <entry>
    <title>R中从命令行传入参数CommandArgs()用法</title>
    <url>/2022/11/22/R%E4%B8%AD%E4%BB%8E%E5%91%BD%E4%BB%A4%E8%A1%8C%E4%BC%A0%E5%85%A5%E5%8F%82%E6%95%B0CommandArgv-%E7%94%A8%E6%B3%95/</url>
    <content><![CDATA[<p>commandArgs()是R自带的参数传递函数，本文总结其用法。</p>
<span id="more"></span>

<p>与perl的@ARGV和python的 sys.argv 类似，将来自于命令行的参数存入向量&#x2F;数组中。</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line"><span class="operator">&gt;</span> args <span class="operator">&lt;-</span> commandArgs<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line"><span class="operator">&gt;</span> print<span class="punctuation">(</span>args<span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<p>命令行如下：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">Rscript test.R arg1 arg2</span><br></pre></td></tr></table></figure>

<p>输出如下：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span> <span class="string">&quot;C:....&quot;</span>	<span class="comment"># R所在路径</span></span><br><span class="line"><span class="punctuation">[</span><span class="number">2</span><span class="punctuation">]</span> <span class="string">&quot;--slave&quot;</span>	<span class="comment"># Rscript参数</span></span><br><span class="line"><span class="punctuation">[</span><span class="number">3</span><span class="punctuation">]</span> <span class="string">&quot;--no-restore&quot;</span>	<span class="comment"># Rscript参数</span></span><br><span class="line"><span class="punctuation">[</span><span class="number">4</span><span class="punctuation">]</span> <span class="string">&quot;--file=test.R&quot;</span>	<span class="comment"># 脚本路径</span></span><br><span class="line"><span class="punctuation">[</span><span class="number">5</span><span class="punctuation">]</span> <span class="string">&quot;--args&quot;</span>	<span class="comment"># 脚本参数</span></span><br><span class="line"><span class="punctuation">[</span><span class="number">6</span><span class="punctuation">]</span> <span class="string">&quot;arg1&quot;</span>	<span class="comment">#参数1</span></span><br><span class="line"><span class="punctuation">[</span><span class="number">7</span><span class="punctuation">]</span> <span class="string">&quot;args2&quot;</span>	<span class="comment">#参数2</span></span><br></pre></td></tr></table></figure>
<p>即R输入的参数并不像python、perl一样是从第一个开始的。</p>
<p>如下命令可以让其从1开始：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line"><span class="operator">&gt;</span> args <span class="operator">&lt;-</span> commandArgs<span class="punctuation">(</span>trailingOnly<span class="operator">=</span><span class="literal">TRUE</span><span class="punctuation">)</span></span><br><span class="line"><span class="operator">&gt;</span> print<span class="punctuation">(</span>args<span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span>	<span class="string">&quot;args1&quot;</span></span><br><span class="line"><span class="punctuation">[</span><span class="number">2</span><span class="punctuation">]</span>	<span class="string">&quot;args2&quot;</span></span><br></pre></td></tr></table></figure>

<p>读入文件：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line"><span class="operator">&gt;</span> args <span class="operator">&lt;-</span> commandArgs<span class="punctuation">(</span>trailingOnly<span class="operator">=</span><span class="literal">TRUE</span><span class="punctuation">)</span></span><br><span class="line"><span class="operator">&gt;</span> file1 <span class="operator">&lt;-</span> read.csv<span class="punctuation">(</span>argv<span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span><span class="punctuation">,</span>header <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<p>命令行：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">Rscript test.R file1.csv</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>R</category>
      </categories>
      <tags>
        <tag>R</tag>
      </tags>
  </entry>
  <entry>
    <title>R中选择数据框的列</title>
    <url>/2022/11/22/R%E4%B8%AD%E9%80%89%E6%8B%A9%E6%95%B0%E6%8D%AE%E6%A1%86%E7%9A%84%E5%88%97/</url>
    <content><![CDATA[<p>本文介绍利用tidyverse包的select()函数和sqldf包的sqldf()选择数据框的列。</p>
<span id="more"></span>

<h4 id="1-tidyverse包select"><a href="#1-tidyverse包select" class="headerlink" title="1. tidyverse包select()"></a>1. tidyverse包select()</h4><ol>
<li><p>选择列</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line"><span class="comment">#按位置选择</span></span><br><span class="line"><span class="operator">&gt;</span> data <span class="operator">&lt;-</span> mydata <span class="operator">%&gt;%</span> select<span class="punctuation">(</span><span class="number">1</span><span class="operator">:</span><span class="number">3</span><span class="punctuation">)</span></span><br><span class="line"><span class="operator">&gt;</span> data <span class="operator">&lt;-</span> mydata <span class="operator">%&gt;%</span> select<span class="punctuation">(</span><span class="number">1</span><span class="punctuation">,</span><span class="number">3</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#按名字选择</span></span><br><span class="line"><span class="operator">&gt;</span> data <span class="operator">&lt;-</span> mydata <span class="operator">%&gt;%</span> select<span class="punctuation">(</span><span class="string">&#x27;col1&#x27;</span><span class="punctuation">,</span><span class="string">&#x27;col2&#x27;</span><span class="punctuation">)</span></span><br><span class="line"><span class="operator">&gt;</span> data <span class="operator">&lt;-</span> mydata <span class="operator">%&gt;%</span> select<span class="punctuation">(</span><span class="string">&#x27;col1&#x27;</span><span class="punctuation">,</span><span class="string">&#x27;col3&#x27;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#名字以col开头的列</span></span><br><span class="line"><span class="operator">&gt;</span> data <span class="operator">&lt;-</span> mydata <span class="operator">%&gt;%</span> select<span class="punctuation">(</span>starts_with<span class="punctuation">(</span><span class="string">&quot;col&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">#名字以col结尾的列</span></span><br><span class="line"><span class="operator">&gt;</span> data <span class="operator">&lt;-</span> mydata <span class="operator">%&gt;%</span> select<span class="punctuation">(</span>ends_with<span class="punctuation">(</span><span class="string">&quot;col&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">#名字包含有col的列</span></span><br><span class="line"><span class="operator">&gt;</span> data <span class="operator">&lt;-</span> mydata <span class="operator">%&gt;%</span> select<span class="punctuation">(</span>contains<span class="punctuation">(</span><span class="string">&quot;col&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">#名字包含正则表达式的列</span></span><br><span class="line"><span class="operator">&gt;</span> data <span class="operator">&lt;-</span> mydata <span class="operator">%&gt;%</span> select<span class="punctuation">(</span>matches<span class="punctuation">(</span><span class="string">&quot;.t.&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">#选择字符向量中提供变量的所有列</span></span><br><span class="line"><span class="operator">&gt;</span> data <span class="operator">&lt;-</span> mydata <span class="operator">%&gt;%</span> select<span class="punctuation">(</span>one_of<span class="punctuation">(</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;col1&quot;</span><span class="punctuation">,</span><span class="string">&quot;col2&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#选择数值型的列</span></span><br><span class="line"><span class="operator">&gt;</span> data <span class="operator">&lt;-</span> mydata <span class="operator">%&gt;%</span> select<span class="punctuation">(</span><span class="built_in">is.numeric</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>删除列</p>
</li>
</ol>
<p>名称前加上减号-</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line"><span class="comment">#根据位置删除</span></span><br><span class="line"><span class="operator">&gt;</span> data <span class="operator">&lt;-</span> mydata <span class="operator">%&gt;%</span> select<span class="punctuation">(</span><span class="operator">-</span><span class="punctuation">(</span><span class="number">1</span><span class="operator">:</span><span class="number">3</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="operator">&gt;</span> data <span class="operator">&lt;-</span> mydata <span class="operator">%&gt;%</span> select<span class="punctuation">(</span><span class="operator">-</span><span class="number">1</span><span class="punctuation">,</span><span class="operator">-</span><span class="number">3</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="operator">&gt;</span> data <span class="operator">&lt;-</span> mydata <span class="operator">%&gt;%</span> select<span class="punctuation">(</span><span class="operator">-</span><span class="number">1</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#根据名字删除</span></span><br><span class="line"><span class="operator">&gt;</span> data <span class="operator">&lt;-</span> mydata <span class="operator">%&gt;%</span> select<span class="punctuation">(</span><span class="operator">-</span><span class="string">&quot;col1&quot;</span><span class="punctuation">,</span><span class="operator">-</span><span class="string">&quot;col2&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="operator">&gt;</span> data <span class="operator">&lt;-</span> mydata <span class="operator">%&gt;%</span> select<span class="punctuation">(</span><span class="operator">-</span><span class="punctuation">(</span><span class="string">&quot;col1&quot;</span><span class="operator">:</span><span class="string">&quot;col2&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="operator">&gt;</span> data <span class="operator">&lt;-</span> mydata <span class="operator">%&gt;%</span> select<span class="punctuation">(</span><span class="operator">-</span>starts_with<span class="punctuation">(</span><span class="string">&quot;col&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<h4 id="2-sqldf包"><a href="#2-sqldf包" class="headerlink" title="2. sqldf包"></a>2. sqldf包</h4><ol>
<li>选择列<br>sqldf包可以在R中对dataframe格式使用sql语句，和mysql中的select语句是一致的。<figure class="highlight r"><table><tr><td class="code"><pre><span class="line"><span class="operator">&gt;</span> data <span class="operator">&lt;-</span> sqldf<span class="punctuation">(</span><span class="string">&#x27;select col1,col2 from mydata&#x27;</span><span class="punctuation">)</span></span><br><span class="line"><span class="operator">&gt;</span> data <span class="operator">&lt;-</span> sqldf<span class="punctuation">(</span><span class="string">&#x27;select col1,col2 from mydata where col1==&quot;11&quot;&#x27;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure></li>
</ol>
]]></content>
      <categories>
        <category>R</category>
      </categories>
      <tags>
        <tag>R</tag>
      </tags>
  </entry>
  <entry>
    <title>基因表达时序聚类分析Mfuzz包</title>
    <url>/2022/11/23/%E5%9F%BA%E5%9B%A0%E8%A1%A8%E8%BE%BE%E6%97%B6%E5%BA%8F%E8%81%9A%E7%B1%BB%E5%88%86%E6%9E%90Mfuzz%E5%8C%85/</url>
    <content><![CDATA[<p>Mfuzz能够识别表达谱潜在的时间序列模式，并将具有相似表达模式的基因进行聚类。<br>本文介绍Mfuzz包的使用。</p>
<span id="more"></span>

<h4 id="1-安装"><a href="#1-安装" class="headerlink" title="1. 安装"></a>1. 安装</h4><figure class="highlight r"><table><tr><td class="code"><pre><span class="line"><span class="operator">&gt;</span> BiocManager<span class="operator">::</span>install<span class="punctuation">(</span><span class="string">&quot;Mfuzz&quot;</span><span class="punctuation">)</span></span><br><span class="line"><span class="operator">&gt;</span> library<span class="punctuation">(</span>Mfuzz<span class="punctuation">)</span></span><br><span class="line"><span class="comment">#载入数据，行为基因，列为样本</span></span><br><span class="line"><span class="operator">&gt;</span> data <span class="operator">&lt;-</span> read.csv<span class="punctuation">(</span>file	<span class="operator">=</span> <span class="string">&quot;data.csv&quot;</span><span class="punctuation">,</span>header <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<h4 id="2-Mfuzz使用"><a href="#2-Mfuzz使用" class="headerlink" title="2.Mfuzz使用"></a>2.Mfuzz使用</h4><p>构建对象，并对表达矩阵进行标准化，进行聚类分析。</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 构建对象</span></span><br><span class="line"><span class="operator">&gt;</span> dat <span class="operator">&lt;-</span> new<span class="punctuation">(</span><span class="string">&#x27;ExpressionSet&#x27;</span><span class="punctuation">,</span>exprs <span class="operator">=</span> data<span class="punctuation">)</span></span><br><span class="line"><span class="comment"># 处理NA,如果缺失值的比例超过thres，则会被过滤掉</span></span><br><span class="line"><span class="operator">&gt;</span> dat <span class="operator">&lt;-</span> filter.NA<span class="punctuation">(</span>dat<span class="punctuation">,</span>thres<span class="operator">=</span><span class="number">0.1</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment"># 将缺失值替换，可选：mean、median等</span></span><br><span class="line"><span class="operator">&gt;</span> dat <span class="operator">&lt;-</span> fill.NA<span class="punctuation">(</span>dat<span class="punctuation">,</span>mode <span class="operator">=</span> mean<span class="punctuation">)</span></span><br><span class="line"><span class="comment"># 标准化</span></span><br><span class="line"><span class="operator">&gt;</span> dat <span class="operator">&lt;-</span> standardise<span class="punctuation">(</span>dat<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 评估最佳的m值</span></span><br><span class="line"><span class="operator">&gt;</span> m <span class="operator">&lt;-</span> mestimate<span class="punctuation">(</span>dat<span class="punctuation">)</span></span><br><span class="line"><span class="comment"># mfuzz聚类，聚类的个数c需要自己定义</span></span><br><span class="line"><span class="operator">&gt;</span> cl <span class="operator">&lt;-</span> mfuzz<span class="punctuation">(</span>dat<span class="punctuation">,</span><span class="built_in">c</span><span class="operator">=</span><span class="number">8</span><span class="punctuation">,</span>m<span class="operator">=</span>m<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># time.labels参数设置时间轴label</span></span><br><span class="line"><span class="operator">&gt;</span> mfuzz.plot<span class="punctuation">(</span>dat<span class="punctuation">,</span>cl<span class="operator">=</span>cl<span class="punctuation">,</span>mfrow<span class="operator">=</span><span class="built_in">c</span><span class="punctuation">(</span><span class="number">4</span><span class="punctuation">,</span><span class="number">2</span><span class="punctuation">)</span><span class="punctuation">,</span>time.labels<span class="operator">=</span>seq<span class="punctuation">(</span><span class="number">0</span><span class="punctuation">,</span><span class="number">160</span><span class="punctuation">,</span><span class="number">10</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<h4 id="3-获取各个cluster中的基因"><a href="#3-获取各个cluster中的基因" class="headerlink" title="3. 获取各个cluster中的基因"></a>3. 获取各个cluster中的基因</h4><figure class="highlight r"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 每个cluster的基因数目</span></span><br><span class="line"><span class="operator">&gt;</span> cl<span class="operator">$</span>size</span><br><span class="line"><span class="comment"># 每个基因所属的cluster</span></span><br><span class="line"><span class="operator">&gt;</span> head<span class="punctuation">(</span>cl<span class="operator">$</span>cluster<span class="punctuation">)</span></span><br><span class="line"><span class="operator">&gt;</span> head<span class="punctuation">(</span>cl<span class="operator">$</span>membership<span class="punctuation">)</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>R</category>
      </categories>
      <tags>
        <tag>R</tag>
      </tags>
  </entry>
  <entry>
    <title>R语言数据处理中的0值和NA值</title>
    <url>/2022/11/23/R%E8%AF%AD%E8%A8%80%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86%E4%B8%AD%E7%9A%840%E5%80%BC/</url>
    <content><![CDATA[<p>R语言处理数据中的0值和NA值。</p>
<span id="more"></span>

<h4 id="1-去除每个值都是0的行"><a href="#1-去除每个值都是0的行" class="headerlink" title="1. 去除每个值都是0的行"></a>1. 去除每个值都是0的行</h4><figure class="highlight r"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 读入数据</span></span><br><span class="line"><span class="operator">&gt;</span> data <span class="operator">&lt;-</span> read.csv<span class="punctuation">(</span>file<span class="operator">=</span> <span class="string">&quot;data.csv&quot;</span><span class="punctuation">,</span>header<span class="operator">=</span><span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 去除整个数据中每行都是0值的行</span></span><br><span class="line"><span class="operator">&gt;</span> data1 <span class="operator">&lt;-</span> data<span class="punctuation">[</span>which<span class="punctuation">(</span>rowSums<span class="punctuation">(</span>data<span class="punctuation">)</span><span class="operator">&gt;</span><span class="number">0</span><span class="punctuation">)</span><span class="punctuation">,</span><span class="punctuation">]</span></span><br><span class="line"><span class="comment"># 去除数据框3至7列中都是0值的行</span></span><br><span class="line"><span class="operator">&gt;</span> data1 <span class="operator">&lt;-</span> data<span class="punctuation">[</span>which<span class="punctuation">(</span>rowSums<span class="punctuation">(</span>data<span class="punctuation">[</span><span class="number">3</span><span class="operator">:</span><span class="number">7</span><span class="punctuation">]</span><span class="punctuation">)</span><span class="operator">&gt;</span><span class="number">0</span><span class="punctuation">)</span><span class="punctuation">,</span><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>

<h4 id="2-去除存在值为0的行"><a href="#2-去除存在值为0的行" class="headerlink" title="2. 去除存在值为0的行"></a>2. 去除存在值为0的行</h4><figure class="highlight r"><table><tr><td class="code"><pre><span class="line"><span class="operator">&gt;</span> data2 <span class="operator">&lt;-</span> data<span class="punctuation">[</span>which<span class="punctuation">(</span>rowSums<span class="punctuation">(</span>data<span class="operator">==</span><span class="number">0</span><span class="punctuation">)</span><span class="operator">==</span><span class="number">0</span><span class="punctuation">)</span><span class="punctuation">,</span><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>

<h4 id="3-将0值替换为其他值"><a href="#3-将0值替换为其他值" class="headerlink" title="3. 将0值替换为其他值"></a>3. 将0值替换为其他值</h4><figure class="highlight r"><table><tr><td class="code"><pre><span class="line"><span class="operator">&gt;</span> data<span class="punctuation">[</span>data<span class="operator">==</span><span class="number">0</span><span class="punctuation">]</span> <span class="operator">&lt;-</span> <span class="literal">NA</span></span><br></pre></td></tr></table></figure>

<h4 id="4-去除含有NA的行"><a href="#4-去除含有NA的行" class="headerlink" title="4. 去除含有NA的行"></a>4. 去除含有NA的行</h4> <figure class="highlight r"><table><tr><td class="code"><pre><span class="line"><span class="operator">&gt;</span> data3 <span class="operator">&lt;-</span> na.omit<span class="punctuation">(</span>data<span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<h4 id="5-将NA值替换为0"><a href="#5-将NA值替换为0" class="headerlink" title="5. 将NA值替换为0"></a>5. 将NA值替换为0</h4><figure class="highlight r"><table><tr><td class="code"><pre><span class="line"><span class="operator">&gt;</span> data<span class="punctuation">[</span><span class="built_in">is.na</span><span class="punctuation">(</span>data<span class="punctuation">)</span><span class="punctuation">]</span> <span class="operator">&lt;-</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>

<h4 id="6-drop-na"><a href="#6-drop-na" class="headerlink" title="6. drop_na()"></a>6. drop_na()</h4><p>去掉含有NA值的行：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">df <span class="operator">%&gt;%</span> drop_na<span class="punctuation">(</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<p>去除某一列有缺失值的行：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">df <span class="operator">%&gt;%</span> drop_na<span class="punctuation">(</span>col1<span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<h4 id="7-replace-na"><a href="#7-replace-na" class="headerlink" title="7. replace_na()"></a>7. replace_na()</h4><p>将score列中的NA值改为0：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">df <span class="operator">%&gt;%</span> mutate<span class="punctuation">(</span>score<span class="operator">=</span>replace_na<span class="punctuation">(</span>score<span class="punctuation">,</span><span class="number">0</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<p>将score列中的NA值改为均值：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">df <span class="operator">%&gt;%</span> mutate<span class="punctuation">(</span>score<span class="operator">=</span>replace_na<span class="punctuation">(</span>score<span class="punctuation">,</span>mean<span class="punctuation">(</span>score<span class="punctuation">,</span>na.rm<span class="operator">=</span><span class="literal">TRUE</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>R</category>
      </categories>
      <tags>
        <tag>R</tag>
      </tags>
  </entry>
  <entry>
    <title>MeRIP-seq数据分析之peak calling</title>
    <url>/2022/11/28/MeRIp-seq%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%E4%B9%8Bpeak-calling/</url>
    <content><![CDATA[<p>m6A-seq上游的数据处理流程和Ribo-seq差不多，包括去接头、数据质控、比对。比对之前也有文献会对m6A-seq数据去rRNA、tRNA，根据需求处理即可，这里不再总结，直接从得到比对的结果之后开始。</p>
<span id="more"></span>

<h4 id="1-提取高质量比对结果"><a href="#1-提取高质量比对结果" class="headerlink" title="1. 提取高质量比对结果"></a>1. 提取高质量比对结果</h4><p>得到比对的结果out.sam之后，要提取比对质量高的reads进行peak calling。<br>-f 2:提取完全mapping上的序列；<br>-F 256：过滤掉比对到多个位置上的序列；<br>-q 30：提取比对的质量值在30以上的序列。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">samtools view -@ 10 -bS out.sam -f 2 -F 256 -q 30 -o out.highQ.bam</span><br><span class="line">samtools <span class="built_in">sort</span> -@ 10 -l 9 out.highQ.bam -o out.highQ.sorted.bam</span><br></pre></td></tr></table></figure>

<h4 id="2-MACS2进行peak-calling"><a href="#2-MACS2进行peak-calling" class="headerlink" title="2. MACS2进行peak calling"></a>2. MACS2进行peak calling</h4><p>MACS2是为ChIP-seq设计的，已经被广泛使用。主要参数：<br>-t：处理组样本bam文件，即IP样本；<br>-c：对照组样本bam文件，即input样本；<br>-B：save extended fragment pileup, and local lambda tracks (two files) at every bp into a bedGraph file；<br>–SPMR：this option is recommended for displaying normalized pileup tracks across many datasets,可以在样本间进行比较peaks，需要-B参数；<br>–keep-dup：保留重复的tag；<br>-n：输出的文件前缀；<br>–outdir：输出文件路径；<br>-f：文件格式，这里为BAM；<br>-g：基因组大小，可以是数字或物种，如：hs、mm、ce、dm；<br>–nomodel：不建立shifting model；<br>–extsize：与nomodel一起使用，从5’-&gt;3’延伸fragment到指定长度；<br>-q：qvalue;<br>–fe-cutoff：fold enrichment。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">macs2 callpeak -t treatment.highQ.sorted.bam -c control.highQ.sorted.bam -B --SPMR --keep-dup all -n outname --outdir out_peak -f BAM -g mm --nomodel --extsize 150 -q 0.05 --fe-cutoff 2</span><br></pre></td></tr></table></figure>

<h4 id="3-peak-calling结果文件"><a href="#3-peak-calling结果文件" class="headerlink" title="3. peak calling结果文件"></a>3. peak calling结果文件</h4><ol>
<li><p>__control_lambda.bdg&#x2F;__treat_pileup.bdg<br>Input和IP样本的bedgraph格式数据，可以载入IGV可视化。</p>
</li>
<li><p>__peak.narrowPeak<br>每一列信息如下：<br>chrom	start	end	peak_name	peak_length	+&#x2F;-strand	Foldchange	-log10pvalue	-log10qvalue	peak_start位置距离summit的距离</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">chr1    3682490 3682640 MII-m6A-1_peak_50       212     .       6.90033 24.1656 21.2778 127</span><br><span class="line">chr1    3683230 3684604 MII-m6A-1_peak_51       9634    .       19.4958 967.498 963.478 454</span><br><span class="line">chr1    3741597 3741747 MII-m6A-1_peak_52       122     .       7.52285 15.0429 12.2639 48</span><br></pre></td></tr></table></figure>
</li>
<li><p>__peak.xls<br>xls格式的peak数据。abs_summit为顶峰的位置，pileup为顶峰的值。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">chr     start   end     length  abs_summit      pileup  -log10(pvalue)  fold_enrichment -log10(qvalue)  name</span><br><span class="line">chr1	3682491 3682640 150     3682618 43.89   24.1656 6.90033 21.2778 MII-m6A-1_peak_50</span><br><span class="line">chr1    3683231 3684604 1374    3683685 1090.77 967.498 19.4958 963.478 MII-m6A-1_peak_51</span><br><span class="line">chr1    3741598 3741747 150     3741646 21.94   15.0429 7.52285 12.2639 MII-m6A-1_peak_52</span><br></pre></td></tr></table></figure>
</li>
<li><p>__summits.bed<br>每个peak顶峰的位置，最后一列为-log10qvalue。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">chr1    3682617 3682618 MII-m6A-1_peak_50       21.2778</span><br><span class="line">chr1    3683684 3683685 MII-m6A-1_peak_51       963.478</span><br><span class="line">chr1    3741645 3741646 MII-m6A-1_peak_52       12.2639</span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="4-生物学重复replicates样本的peaks取交集"><a href="#4-生物学重复replicates样本的peaks取交集" class="headerlink" title="4. 生物学重复replicates样本的peaks取交集"></a>4. 生物学重复replicates样本的peaks取交集</h4><p>取交集用bedtools intersect,取至少有50%区域overlsap的peak。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">bedtools intersect -a rep1_peaks.narrowPeak -b rep2_peaks.narrowPeak -f 0.5 -F 0.5 -e &gt; overlap.peak</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>m6A-seq</category>
      </categories>
      <tags>
        <tag>MeRIP-seq</tag>
      </tags>
  </entry>
  <entry>
    <title>Pandas包学习(2)之数据统计函数</title>
    <url>/2022/11/25/Pandas%E5%8C%85%E5%AD%A6%E4%B9%A0-2-%E4%B9%8B%E6%95%B0%E6%8D%AE%E7%BB%9F%E8%AE%A1%E5%87%BD%E6%95%B0/</url>
    <content><![CDATA[<p>本文总结Pandas中常用的统计学函数。</p>
<span id="more"></span>

<h4 id="1-常用函数"><a href="#1-常用函数" class="headerlink" title="1. 常用函数"></a>1. 常用函数</h4><p>常用的统计学函数如下：</p>
<table>
<thead>
<tr>
<th align="center">函数名称</th>
<th align="center">描述说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center">count()</td>
<td align="center">统计某个非空值的数量。</td>
</tr>
<tr>
<td align="center">sum()</td>
<td align="center">求和</td>
</tr>
<tr>
<td align="center">mean()</td>
<td align="center">求均值</td>
</tr>
<tr>
<td align="center">median()</td>
<td align="center">求中位数</td>
</tr>
<tr>
<td align="center">mode()</td>
<td align="center">求众数</td>
</tr>
<tr>
<td align="center">std()</td>
<td align="center">求标准差</td>
</tr>
<tr>
<td align="center">min()</td>
<td align="center">求最小值</td>
</tr>
<tr>
<td align="center">max()</td>
<td align="center">求最大值</td>
</tr>
<tr>
<td align="center">abs()</td>
<td align="center">求绝对值</td>
</tr>
<tr>
<td align="center">prod()</td>
<td align="center">求所有数值的乘积。</td>
</tr>
<tr>
<td align="center">cumsum()</td>
<td align="center">计算累计和，axis&#x3D;0，按照行累加；axis&#x3D;1，按照列累加。</td>
</tr>
<tr>
<td align="center">cumprod()</td>
<td align="center">计算累计积，axis&#x3D;0，按照行累积；axis&#x3D;1，按照列累积。</td>
</tr>
<tr>
<td align="center">corr()</td>
<td align="center">计算数列或变量之间的相关系数，取值-1到1，值越大表示关联性越强。</td>
</tr>
</tbody></table>
<p>在 DataFrame 中，使用聚合类方法时需要指定轴(axis)参数。<br>行：默认使用 axis&#x3D;0 或者使用 “index”；<br>列：默认使用 axis&#x3D;1 或者使用 “columns”。<br>如图所示：<br><img src="/pics/2022-11-30-pandas%E6%B1%82%E5%92%8C.jpg" alt="alt图标"></p>
<h4 id="2-sum求和"><a href="#2-sum求和" class="headerlink" title="2. sum求和"></a>2. sum求和</h4><p>创建DataFrame对象。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&gt; data = &#123;<span class="string">&#x27;col1&#x27;</span>:pd.Series([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>],index=[<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;b&#x27;</span>,<span class="string">&#x27;c&#x27;</span>]),</span><br><span class="line">		  <span class="string">&#x27;col2&#x27;</span>:pd.Series([<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>],index=[<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;b&#x27;</span>,<span class="string">&#x27;c&#x27;</span>,<span class="string">&#x27;d&#x27;</span>])&#125;</span><br><span class="line">&gt; data = &#123;<span class="string">&#x27;name&#x27;</span>:pd.Series([<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;b&#x27;</span>,<span class="string">&#x27;c&#x27;</span>,<span class="string">&#x27;d&#x27;</span>]),</span><br><span class="line">		  <span class="string">&#x27;age&#x27;</span>:pd.Series([<span class="number">14</span>,<span class="number">15</span>,<span class="number">13</span>,<span class="number">17</span>]),</span><br><span class="line">		  <span class="string">&#x27;score&#x27;</span>:pd.Series([<span class="number">89</span>,<span class="number">78</span>,<span class="number">99</span>,<span class="number">100</span>])&#125;</span><br><span class="line">&gt; dd = pd.DataFrame(data)</span><br><span class="line">&gt; dd</span><br><span class="line">  name  age  score</span><br><span class="line"><span class="number">0</span>    a   <span class="number">14</span>     <span class="number">89</span></span><br><span class="line"><span class="number">1</span>    b   <span class="number">15</span>     <span class="number">78</span></span><br><span class="line"><span class="number">2</span>    c   <span class="number">13</span>     <span class="number">99</span></span><br><span class="line"><span class="number">3</span>    d   <span class="number">17</span>    <span class="number">100</span></span><br></pre></td></tr></table></figure>
<p>默认情况下，sum()函数使用axis&#x3D;0，按垂直方向进行计算。<br>对于字符串数据，不会得到异常，将字符串进行连接。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&gt; dd.<span class="built_in">sum</span>()</span><br><span class="line">name     abcd</span><br><span class="line">age        <span class="number">59</span></span><br><span class="line">score     <span class="number">366</span></span><br><span class="line">dtype: <span class="built_in">object</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 按垂直方向计算</span></span><br><span class="line">&gt; dd.<span class="built_in">sum</span>(axis=<span class="number">0</span>)</span><br><span class="line">name     abcd</span><br><span class="line">age        <span class="number">59</span></span><br><span class="line">score     <span class="number">366</span></span><br><span class="line">dtype: <span class="built_in">object</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 按水平方向计算</span></span><br><span class="line">&gt; dd.<span class="built_in">sum</span>(axis=<span class="number">1</span>)</span><br><span class="line"><span class="number">0</span>    <span class="number">103</span></span><br><span class="line"><span class="number">1</span>     <span class="number">93</span></span><br><span class="line"><span class="number">2</span>    <span class="number">112</span></span><br><span class="line"><span class="number">3</span>    <span class="number">117</span></span><br><span class="line">dtype: int64</span><br></pre></td></tr></table></figure>

<h4 id="3-mean-求均值"><a href="#3-mean-求均值" class="headerlink" title="3. mean()求均值"></a>3. mean()求均值</h4><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&gt; dd.mean()</span><br><span class="line">age      <span class="number">14.75</span></span><br><span class="line">score    <span class="number">91.50</span></span><br><span class="line">dtype: float64</span><br><span class="line">&gt; dd.mean(axis=<span class="number">0</span>)</span><br><span class="line">age      <span class="number">14.75</span></span><br><span class="line">score    <span class="number">91.50</span></span><br><span class="line">dtype: float64</span><br><span class="line">&gt; dd.mean(axis=<span class="number">1</span>)</span><br><span class="line"><span class="number">0</span>    <span class="number">51.5</span></span><br><span class="line"><span class="number">1</span>    <span class="number">46.5</span></span><br><span class="line"><span class="number">2</span>    <span class="number">56.0</span></span><br><span class="line"><span class="number">3</span>    <span class="number">58.5</span></span><br><span class="line">dtype: float64</span><br></pre></td></tr></table></figure>

<h4 id="4-std-求标准差"><a href="#4-std-求标准差" class="headerlink" title="4. std()求标准差"></a>4. std()求标准差</h4><p>标准差：反应数据的离散程度。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&gt; dd.std()</span><br><span class="line">age       <span class="number">1.707825</span></span><br><span class="line">score    <span class="number">10.279429</span></span><br><span class="line">dtype: float64</span><br><span class="line"></span><br><span class="line">&gt; dd.std(axis=<span class="number">0</span>)</span><br><span class="line">age       <span class="number">1.707825</span></span><br><span class="line">score    <span class="number">10.279429</span></span><br><span class="line">dtype: float64</span><br></pre></td></tr></table></figure>

<h4 id="5-数据汇总描述"><a href="#5-数据汇总描述" class="headerlink" title="5. 数据汇总描述"></a>5. 数据汇总描述</h4><p>describe()函数输出：均值、标准差、四分位值IQR等一系列信息。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&gt; dd.describe()</span><br><span class="line">             age       score</span><br><span class="line">count   <span class="number">4.000000</span>    <span class="number">4.000000</span></span><br><span class="line">mean   <span class="number">14.750000</span>   <span class="number">91.500000</span></span><br><span class="line">std     <span class="number">1.707825</span>   <span class="number">10.279429</span></span><br><span class="line"><span class="built_in">min</span>    <span class="number">13.000000</span>   <span class="number">78.000000</span></span><br><span class="line"><span class="number">25</span>%    <span class="number">13.750000</span>   <span class="number">86.250000</span></span><br><span class="line"><span class="number">50</span>%    <span class="number">14.500000</span>   <span class="number">94.000000</span></span><br><span class="line"><span class="number">75</span>%    <span class="number">15.500000</span>   <span class="number">99.250000</span></span><br><span class="line"><span class="built_in">max</span>    <span class="number">17.000000</span>  <span class="number">100.000000</span></span><br></pre></td></tr></table></figure>

<p>include能够筛选字符列或者数字列的摘要信息。include 相关参数值说明如下：<br>object： 表示对字符列进行统计信息描述；<br>number：表示对数字列进行统计信息描述；<br>all：汇总所有列的统计信息。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&gt; dd.describe(include=[<span class="string">&#x27;object&#x27;</span>])</span><br><span class="line">       name</span><br><span class="line">count     <span class="number">4</span></span><br><span class="line">unique    <span class="number">4</span></span><br><span class="line">top       d</span><br><span class="line">freq      <span class="number">1</span></span><br><span class="line">&gt; dd.describe(include=<span class="string">&#x27;all&#x27;</span>)</span><br><span class="line">       name        age       score</span><br><span class="line">count     <span class="number">4</span>   <span class="number">4.000000</span>    <span class="number">4.000000</span></span><br><span class="line">unique    <span class="number">4</span>        NaN         NaN</span><br><span class="line">top       d        NaN         NaN</span><br><span class="line">freq      <span class="number">1</span>        NaN         NaN</span><br><span class="line">mean    NaN  <span class="number">14.750000</span>   <span class="number">91.500000</span></span><br><span class="line">std     NaN   <span class="number">1.707825</span>   <span class="number">10.279429</span></span><br><span class="line"><span class="built_in">min</span>     NaN  <span class="number">13.000000</span>   <span class="number">78.000000</span></span><br><span class="line"><span class="number">25</span>%     NaN  <span class="number">13.750000</span>   <span class="number">86.250000</span></span><br><span class="line"><span class="number">50</span>%     NaN  <span class="number">14.500000</span>   <span class="number">94.000000</span></span><br><span class="line"><span class="number">75</span>%     NaN  <span class="number">15.500000</span>   <span class="number">99.250000</span></span><br><span class="line"><span class="built_in">max</span>     NaN  <span class="number">17.000000</span>  <span class="number">100.000000</span></span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Python</category>
      </categories>
      <tags>
        <tag>Python</tag>
      </tags>
  </entry>
  <entry>
    <title>exomePeak2包进行m6A peak calling</title>
    <url>/2022/12/16/exomePeak2%E5%8C%85%E8%BF%9B%E8%A1%8Cm6A-peak-calling/</url>
    <content><![CDATA[<p>本来使用的是MACS2进行peak calling，但是后来发现有专门针对m6A开发的call peaks的R包，而且相比较于MACS2，exomePeak2还能够直接输出peak的count数等等信息，从而后续可以用部分结果进行差异peak分析，所以就采用这个包啦。由于bam文件比较大，所以文章最后会写成需要传参的脚本，这里就用R自带的传参函数。</p>
<span id="more"></span>

<h4 id="1-构建参考基因组的Txdb对象"><a href="#1-构建参考基因组的Txdb对象" class="headerlink" title="1. 构建参考基因组的Txdb对象"></a>1. 构建参考基因组的Txdb对象</h4><p>这一步需要用到GenomicsFeatures包，可以直接从gtf文件构建，也可以直接从数据库构建,需要指明物种和版本。</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">library<span class="punctuation">(</span>GenomicFeatures<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>exomePeak2<span class="punctuation">)</span></span><br><span class="line"><span class="comment">#根据已有的gtf文件构建</span></span><br><span class="line">txdb <span class="operator">&lt;-</span> makeTxDbFromGFF<span class="punctuation">(</span>file <span class="operator">=</span> <span class="string">&quot;gencode.vM31.primary_assembly.annotation.gtf&quot;</span><span class="punctuation">,</span>format <span class="operator">=</span> <span class="string">&quot;gtf&quot;</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment"># 从数据库构建</span></span><br><span class="line">txdb <span class="operator">&lt;-</span> makeTxDbFromEnsembl<span class="punctuation">(</span>organism <span class="operator">=</span> <span class="string">&quot;Mus musculus&quot;</span><span class="punctuation">,</span>release <span class="operator">=</span> <span class="number">104</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<h4 id="2-exomePeak2进行peak-calling"><a href="#2-exomePeak2进行peak-calling" class="headerlink" title="2. exomePeak2进行peak calling"></a>2. exomePeak2进行peak calling</h4><figure class="highlight r"><table><tr><td class="code"><pre><span class="line">ip_bam <span class="operator">&lt;-</span> <span class="string">&quot;ip.bam&quot;</span></span><br><span class="line">input_bam <span class="operator">&lt;-</span> <span class="string">&quot;input.bam&quot;</span></span><br><span class="line">exomePeak2<span class="punctuation">(</span>bam_ip <span class="operator">=</span> ip_bam<span class="punctuation">,</span></span><br><span class="line">             bam_input <span class="operator">=</span> input_bam<span class="punctuation">,</span></span><br><span class="line">             paired_end <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">,</span></span><br><span class="line">             txdb <span class="operator">=</span> txdb<span class="punctuation">,</span></span><br><span class="line">             p_cutoff <span class="operator">=</span> <span class="number">1e-5</span><span class="punctuation">,</span></span><br><span class="line">             log2FC_cutoff <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">             save_dir <span class="operator">=</span> <span class="string">&#x27;out_peak/&#x27;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<p>完整的exomePeak2函数如下：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line"><span class="operator">&gt;</span> exomePeak2<span class="punctuation">(</span></span><br><span class="line">  bam_ip <span class="operator">=</span> <span class="literal">NULL</span><span class="punctuation">,</span></span><br><span class="line">  bam_input <span class="operator">=</span> <span class="literal">NULL</span><span class="punctuation">,</span></span><br><span class="line">  bam_treated_ip <span class="operator">=</span> <span class="literal">NULL</span><span class="punctuation">,</span></span><br><span class="line">  bam_treated_input <span class="operator">=</span> <span class="literal">NULL</span><span class="punctuation">,</span></span><br><span class="line">  txdb <span class="operator">=</span> <span class="literal">NULL</span><span class="punctuation">,</span></span><br><span class="line">  bsgenome <span class="operator">=</span> <span class="literal">NULL</span><span class="punctuation">,</span></span><br><span class="line">  genome <span class="operator">=</span> <span class="literal">NA</span><span class="punctuation">,</span></span><br><span class="line">  gff_dir <span class="operator">=</span> <span class="literal">NULL</span><span class="punctuation">,</span></span><br><span class="line">  mod_annot <span class="operator">=</span> <span class="literal">NULL</span><span class="punctuation">,</span></span><br><span class="line">  paired_end <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">,</span></span><br><span class="line">  library_type <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;unstranded&quot;</span><span class="punctuation">,</span> <span class="string">&quot;1st_strand&quot;</span><span class="punctuation">,</span> <span class="string">&quot;2nd_strand&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">  fragment_length <span class="operator">=</span> <span class="number">100</span><span class="punctuation">,</span></span><br><span class="line">  binding_length <span class="operator">=</span> <span class="number">25</span><span class="punctuation">,</span></span><br><span class="line">  step_length <span class="operator">=</span> binding_length<span class="punctuation">,</span></span><br><span class="line">  peak_width <span class="operator">=</span> fragment_length<span class="operator">/</span><span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">  pc_count_cutoff <span class="operator">=</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">  bg_count_cutoff <span class="operator">=</span> <span class="number">50</span><span class="punctuation">,</span></span><br><span class="line">  p_cutoff <span class="operator">=</span> <span class="number">1e-05</span><span class="punctuation">,</span></span><br><span class="line">  p_adj_cutoff <span class="operator">=</span> <span class="literal">NULL</span><span class="punctuation">,</span></span><br><span class="line">  log2FC_cutoff <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  parallel <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">,</span></span><br><span class="line">  background_method <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;all&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Gaussian_mixture&quot;</span><span class="punctuation">,</span> <span class="string">&quot;m6Aseq_prior&quot;</span><span class="punctuation">,</span> <span class="string">&quot;manual&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">  manual_background <span class="operator">=</span> <span class="literal">NULL</span><span class="punctuation">,</span></span><br><span class="line">  correct_GC_bg <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">,</span></span><br><span class="line">  qtnorm <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">,</span></span><br><span class="line">  glm_type <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;DESeq2&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Poisson&quot;</span><span class="punctuation">,</span> <span class="string">&quot;NB&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">  LFC_shrinkage <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;apeglm&quot;</span><span class="punctuation">,</span> <span class="string">&quot;ashr&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Gaussian&quot;</span><span class="punctuation">,</span> <span class="string">&quot;none&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">  export_results <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">,</span></span><br><span class="line">  export_format <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;CSV&quot;</span><span class="punctuation">,</span> <span class="string">&quot;BED&quot;</span><span class="punctuation">,</span> <span class="string">&quot;RDS&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">  table_style <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;bed&quot;</span><span class="punctuation">,</span> <span class="string">&quot;granges&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">  save_plot_GC <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">,</span></span><br><span class="line">  save_plot_analysis <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">,</span></span><br><span class="line">  save_plot_name <span class="operator">=</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">  save_dir <span class="operator">=</span> <span class="string">&quot;exomePeak2_output&quot;</span><span class="punctuation">,</span></span><br><span class="line">  peak_calling_mode <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;exon&quot;</span><span class="punctuation">,</span> <span class="string">&quot;full_tx&quot;</span><span class="punctuation">,</span> <span class="string">&quot;whole_genome&quot;</span><span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<h4 id="3-非传参的批量处理"><a href="#3-非传参的批量处理" class="headerlink" title="3. 非传参的批量处理"></a>3. 非传参的批量处理</h4><p>写一个函数进行批处理：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">ip_bam <span class="operator">&lt;-</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;sample-ip-1.sorted.highQ.bam&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;sample-ip-2.sorted.highQ.bam&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;sample-ip-3.sorted.highQ.bam&quot;</span><span class="punctuation">)</span></span><br><span class="line">input_bam <span class="operator">&lt;-</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;sample-input-1.sorted.highQ.bam&quot;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="string">&quot;sample-input-2.sorted.highQ.bam&quot;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="string">&quot;sample-input-3.sorted.highQ.bam&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">name <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;sample-1&quot;</span><span class="punctuation">,</span><span class="string">&quot;sample-2&quot;</span><span class="punctuation">,</span><span class="string">&quot;sample-3&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">lapply<span class="punctuation">(</span><span class="number">1</span><span class="operator">:</span><span class="number">3</span><span class="punctuation">,</span> <span class="keyword">function</span><span class="punctuation">(</span>x<span class="punctuation">)</span><span class="punctuation">&#123;</span></span><br><span class="line">  exomePeak2<span class="punctuation">(</span>bam_ip <span class="operator">=</span> ip_bam<span class="punctuation">[</span>x<span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">             bam_input <span class="operator">=</span> input_bam<span class="punctuation">[</span>x<span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">             paired_end <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">,</span></span><br><span class="line">             txdb <span class="operator">=</span> txdb<span class="punctuation">,</span></span><br><span class="line">             p_cutoff <span class="operator">=</span> <span class="number">1e-5</span><span class="punctuation">,</span></span><br><span class="line">             log2FC_cutoff <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">             save_dir <span class="operator">=</span> paste<span class="punctuation">(</span><span class="string">&#x27;out_peak/&#x27;</span><span class="punctuation">,</span>name<span class="punctuation">[</span>x<span class="punctuation">]</span><span class="punctuation">,</span>sep <span class="operator">=</span> <span class="string">&quot;&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">)</span> <span class="operator">-&gt;</span> result</span><br></pre></td></tr></table></figure>

<h4 id="4-传参的批处理方式"><a href="#4-传参的批处理方式" class="headerlink" title="4. 传参的批处理方式"></a>4. 传参的批处理方式</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cat</span> peak_calling.R</span><br></pre></td></tr></table></figure>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">library<span class="punctuation">(</span>GenomicFeatures<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>exomePeak2<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">args <span class="operator">&lt;-</span> commandArgs<span class="punctuation">(</span>trailingOnly<span class="operator">=</span><span class="literal">TRUE</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">ip_bam <span class="operator">&lt;-</span> args<span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span></span><br><span class="line">input_bam <span class="operator">&lt;-</span> args<span class="punctuation">[</span><span class="number">2</span><span class="punctuation">]</span></span><br><span class="line">gtf <span class="operator">&lt;-</span> args<span class="punctuation">[</span><span class="number">3</span><span class="punctuation">]</span></span><br><span class="line">out_dir <span class="operator">&lt;-</span> args<span class="punctuation">[</span><span class="number">4</span><span class="punctuation">]</span></span><br><span class="line"></span><br><span class="line">txdb <span class="operator">&lt;-</span> makeTxDbFromGFF<span class="punctuation">(</span>file <span class="operator">=</span> gtf<span class="punctuation">,</span>format <span class="operator">=</span> <span class="string">&quot;gtf&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">exomePeak2<span class="punctuation">(</span>bam_ip <span class="operator">=</span> ip_bam<span class="punctuation">,</span></span><br><span class="line">             bam_input <span class="operator">=</span> input_bam<span class="punctuation">,</span></span><br><span class="line">             paired_end <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">,</span></span><br><span class="line">             txdb <span class="operator">=</span> txdb<span class="punctuation">,</span></span><br><span class="line">             p_cutoff <span class="operator">=</span> <span class="number">1e-5</span><span class="punctuation">,</span></span><br><span class="line">             log2FC_cutoff <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">             save_dir <span class="operator">=</span> out_dir<span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Rscript peak_calling.R sample1-ip.bam sample1-input.bam gencode.vM31.primary_assembly.annotation.gtf out_peak/s1/</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>m6A-seq</category>
      </categories>
      <tags>
        <tag>MeRIP-seq</tag>
      </tags>
  </entry>
  <entry>
    <title>R语言传参之getopt</title>
    <url>/2022/12/17/R%E8%AF%AD%E8%A8%80%E4%BC%A0%E5%8F%82%E4%B9%8Bgetopt/</url>
    <content><![CDATA[<p>使用过程中发现使用R语言自带的CommandArgv()函数只能实现简单的传递功能，如果想要查看脚本具体的help信息似乎没办法实现。<br>R语言传递参数还有第二种方法，即利用getopt包的getopt()函数，它可以实现这样的功能。</p>
<span id="more"></span>

<h4 id="1-getopt包安装"><a href="#1-getopt包安装" class="headerlink" title="1. getopt包安装"></a>1. getopt包安装</h4><figure class="highlight r"><table><tr><td class="code"><pre><span class="line">install.packages<span class="punctuation">(</span><span class="string">&quot;getopt&quot;</span><span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>getopt<span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<h4 id="2-getopt使用"><a href="#2-getopt使用" class="headerlink" title="2. getopt使用"></a>2. getopt使用</h4><figure class="highlight r"><table><tr><td class="code"><pre><span class="line"><span class="comment">#getopt()函数用法</span></span><br><span class="line">getopt<span class="punctuation">(</span>spec <span class="operator">=</span> <span class="literal">NULL</span><span class="punctuation">,</span> opt <span class="operator">=</span> <span class="literal">NULL</span><span class="punctuation">,</span> command <span class="operator">=</span> get_Rscript_filename<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">  usage <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">,</span> debug <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<p>spec参数需要一个矩阵，这个矩阵描述接受的参数的形式以及参数对应的flag信息等等。</p>
<ul>
<li>第1列：参数的long name；</li>
<li>第2列：参数的short name；</li>
<li>第3列：参数是否必需，是必需的还是可选的。0代表不接受参数，1代表必须参数，2代表参数可选；</li>
<li>第4列：参数的类型，例如：logical、integer、double、complex、character、numeric；</li>
<li>第5列：注释信息，可选。</li>
</ul>
<p>opt参数表示参数来源，一般使用默认，即从commandArgs()命令中接收的参数。</p>
<p>usage参数，默认为FALSE,这时参数无实际意义，而是以用法的形式输出。</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">library<span class="punctuation">(</span>getopt<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">spec <span class="operator">=</span> matrix<span class="punctuation">(</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&#x27;version&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;v&#x27;</span><span class="punctuation">,</span> <span class="number">2</span><span class="punctuation">,</span> <span class="string">&quot;logical&quot;</span><span class="punctuation">,</span><span class="string">&quot;v1.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&#x27;help&#x27;</span>   <span class="punctuation">,</span> <span class="string">&#x27;h&#x27;</span><span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="string">&quot;logical&quot;</span><span class="punctuation">,</span><span class="string">&quot;help information&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&#x27;first&#x27;</span>  <span class="punctuation">,</span> <span class="string">&#x27;c&#x27;</span><span class="punctuation">,</span> <span class="number">1</span><span class="punctuation">,</span> <span class="string">&quot;integer&quot;</span><span class="punctuation">,</span><span class="string">&quot;the first args&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&#x27;second&#x27;</span>   <span class="punctuation">,</span> <span class="string">&#x27;m&#x27;</span><span class="punctuation">,</span> <span class="number">1</span><span class="punctuation">,</span> <span class="string">&quot;double&quot;</span><span class="punctuation">,</span><span class="string">&quot;the second args&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">              byrow<span class="operator">=</span><span class="literal">TRUE</span><span class="punctuation">,</span> ncol<span class="operator">=</span><span class="number">4</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">opt <span class="operator">=</span> getopt<span class="punctuation">(</span>spec<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">print<span class="punctuation">(</span>opt<span class="operator">$</span>first<span class="punctuation">)</span></span><br><span class="line">print<span class="punctuation">(</span>opt<span class="operator">$</span>second<span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<p>这样子只是完成了传递参数这一步，要想实现打印出帮助信息需要将usage参数打开，这样getopt()函数可以返回一个特定写法的帮助信息。</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="punctuation">(</span><span class="operator">!</span><span class="built_in">is.null</span><span class="punctuation">(</span>args<span class="operator">$</span>help<span class="punctuation">)</span> <span class="operator">||</span> <span class="built_in">is.null</span><span class="punctuation">(</span>args<span class="operator">$</span>count<span class="punctuation">)</span> <span class="operator">||</span> <span class="built_in">is.null</span><span class="punctuation">(</span>args<span class="operator">$</span>mean<span class="punctuation">)</span><span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">    cat<span class="punctuation">(</span>paste<span class="punctuation">(</span>getopt<span class="punctuation">(</span>spec<span class="punctuation">,</span> usage <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span><span class="punctuation">,</span> <span class="string">&quot;\n&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">    q<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>帮助信息如下：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">Usage<span class="operator">:</span> test_args.R <span class="punctuation">[</span><span class="operator">-</span><span class="punctuation">[</span><span class="operator">-</span>version<span class="operator">|</span>v<span class="punctuation">]</span><span class="punctuation">]</span> <span class="punctuation">[</span><span class="operator">-</span><span class="punctuation">[</span><span class="operator">-</span>help<span class="operator">|</span>h<span class="punctuation">]</span><span class="punctuation">]</span> <span class="punctuation">[</span><span class="operator">-</span><span class="punctuation">[</span><span class="operator">-</span>first<span class="operator">|</span>f<span class="punctuation">]</span> <span class="punctuation">[</span><span class="operator">&lt;</span>integer<span class="operator">&gt;</span><span class="punctuation">]</span><span class="punctuation">]</span> <span class="punctuation">[</span><span class="operator">-</span><span class="punctuation">[</span><span class="operator">-</span>second<span class="operator">|</span>s<span class="punctuation">]</span> <span class="operator">&lt;</span>character<span class="operator">&gt;</span><span class="punctuation">]</span> </span><br><span class="line">    <span class="operator">-</span>v<span class="operator">|</span><span class="operator">-</span><span class="operator">-</span>version   v1.0</span><br><span class="line">    <span class="operator">-</span>h<span class="operator">|</span><span class="operator">-</span><span class="operator">-</span>help      help information</span><br><span class="line">    <span class="operator">-</span>f<span class="operator">|</span><span class="operator">-</span><span class="operator">-</span>first     the first args</span><br><span class="line">    <span class="operator">-</span>s<span class="operator">|</span><span class="operator">-</span><span class="operator">-</span>second    the second args</span><br></pre></td></tr></table></figure>

<p>也可以自己写帮助信息：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">print_usage <span class="operator">&lt;-</span> <span class="keyword">function</span><span class="punctuation">(</span>spec<span class="operator">=</span><span class="literal">NULL</span><span class="punctuation">)</span><span class="punctuation">&#123;</span></span><br><span class="line">	cat<span class="punctuation">(</span><span class="string">&#x27; Rscript try.R  --first  --second</span></span><br><span class="line"><span class="string">Options: </span></span><br><span class="line"><span class="string">    --help    -h      NULL</span></span><br><span class="line"><span class="string">    --version -v	  v1.0</span></span><br><span class="line"><span class="string">    --first   -f	  first argument</span></span><br><span class="line"><span class="string">    --second  -s	  second argument</span></span><br><span class="line"><span class="string">    \n&#x27;</span><span class="punctuation">)</span></span><br><span class="line">    q<span class="punctuation">(</span>status<span class="operator">=</span><span class="number">1</span><span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span><span class="punctuation">(</span><span class="operator">!</span><span class="built_in">is.null</span><span class="punctuation">(</span>opt<span class="operator">$</span>help<span class="punctuation">)</span> <span class="operator">||</span> <span class="built_in">is.null</span><span class="punctuation">(</span>opt<span class="operator">$</span>first<span class="punctuation">)</span> <span class="operator">||</span> <span class="built_in">is.null</span><span class="punctuation">(</span>opt<span class="operator">$</span>second<span class="punctuation">)</span><span class="punctuation">)</span> <span class="punctuation">&#123;</span>print_usage<span class="punctuation">(</span>spec<span class="punctuation">)</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>帮助信息如下：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">Rscript try.R  <span class="operator">-</span><span class="operator">-</span>first <span class="number">1</span> <span class="operator">-</span><span class="operator">-</span>second second</span><br><span class="line">Options<span class="operator">:</span> </span><br><span class="line">    <span class="operator">-</span><span class="operator">-</span>help    <span class="operator">-</span>h      <span class="literal">NULL</span></span><br><span class="line">    <span class="operator">-</span><span class="operator">-</span>version <span class="operator">-</span>v	  v1.0</span><br><span class="line">    <span class="operator">-</span><span class="operator">-</span>first   <span class="operator">-</span>f	  first argument</span><br><span class="line">    <span class="operator">-</span><span class="operator">-</span>second  <span class="operator">-</span>s	  second argument</span><br></pre></td></tr></table></figure>

<p>到此为止就全部完成啦！</p>
]]></content>
      <categories>
        <category>R</category>
      </categories>
      <tags>
        <tag>R</tag>
      </tags>
  </entry>
  <entry>
    <title>生信文件中的染色体坐标：0-based与1-based</title>
    <url>/2022/12/18/%E6%96%87%E4%BB%B6%E4%B8%AD%E7%9A%84%E5%9D%90%E6%A0%87%EF%BC%9A0-based%E4%B8%8E1-based/</url>
    <content><![CDATA[<p>生物信息学有许多文件格式，不同的文件格式的染色体坐标方法并不一样，在文件处理中很容易混淆，因此记录一下。</p>
<span id="more"></span>

<h4 id="1-0-based与1-based"><a href="#1-0-based与1-based" class="headerlink" title="1. 0-based与1-based"></a>1. 0-based与1-based</h4><p>0-based即文件第一个碱基坐标以0开始，1-based即文件中第一个碱基坐标以1开始。<br><img src="/pics/2022-12-18-%E5%9D%90%E6%A0%871.png" alt="alt 图标"></p>
<table>
<thead>
<tr>
<th align="center">特征</th>
<th align="center">0-based</th>
<th align="center">1-based</th>
</tr>
</thead>
<tbody><tr>
<td align="center">第一个碱基坐标</td>
<td align="center">0</td>
<td align="center">1</td>
</tr>
<tr>
<td align="center">区间</td>
<td align="center">前闭后开[start,end)</td>
<td align="center">闭区间[start,end]</td>
</tr>
<tr>
<td align="center">区间长度</td>
<td align="center">end-start</td>
<td align="center">end-start+1</td>
</tr>
</tbody></table>
<p>简而言之，0-based与1-based的区别如下图：</p>
<ul>
<li>数字直接代表一个碱基</li>
<li>两个数字之间才代表一个碱基</li>
</ul>
<p><img src="/pics/2022-12-18-%E5%9D%90%E6%A0%87.jpg" alt="alt 图标"></p>
<h4 id="2-0-based与1-based坐标转换"><a href="#2-0-based与1-based坐标转换" class="headerlink" title="2. 0-based与1-based坐标转换"></a>2. 0-based与1-based坐标转换</h4><ul>
<li>0-based转1-based<ul>
<li>Start(1-based) &#x3D; Start(0-based) + 1</li>
<li>End(1-based) &#x3D; End(0-based)</li>
</ul>
</li>
<li>1-based转1-based<ul>
<li>Start(0-based) &#x3D; Start(1-based) - 1</li>
<li>End(0-based) &#x3D; End(1-based)</li>
</ul>
</li>
</ul>
<h4 id="3-文件格式所用的坐标系统总结"><a href="#3-文件格式所用的坐标系统总结" class="headerlink" title="3. 文件格式所用的坐标系统总结"></a>3. 文件格式所用的坐标系统总结</h4><p>0-based有：</p>
<table>
<thead>
<tr>
<th align="center">Format</th>
<th align="center">Type</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><strong>BED</strong></td>
<td align="center">0-based</td>
</tr>
<tr>
<td align="center"><strong>BAM</strong></td>
<td align="center">0-based</td>
</tr>
<tr>
<td align="center">BCF</td>
<td align="center">0-based</td>
</tr>
<tr>
<td align="center">narrowPeak(MACS2)</td>
<td align="center">0-based</td>
</tr>
<tr>
<td align="center">SAF(FeatureCount)</td>
<td align="center">0-based</td>
</tr>
<tr>
<td align="center">bedGraph</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">UCSC Genome Browser tables</td>
<td align="center">0-based</td>
</tr>
</tbody></table>
<p>1-based有：</p>
<table>
<thead>
<tr>
<th align="center">Format</th>
<th align="center">Type</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><strong>GTF</strong></td>
<td align="center">1-based</td>
</tr>
<tr>
<td align="center"><strong>GFF</strong></td>
<td align="center">1-based</td>
</tr>
<tr>
<td align="center"><strong>SAM</strong></td>
<td align="center">1-based</td>
</tr>
<tr>
<td align="center"><strong>VCF</strong></td>
<td align="center">1-based</td>
</tr>
<tr>
<td align="center">Wiggle</td>
<td align="center">1-based</td>
</tr>
<tr>
<td align="center">GenomicRanges</td>
<td align="center">1-based</td>
</tr>
<tr>
<td align="center">IGV</td>
<td align="center">1-based</td>
</tr>
<tr>
<td align="center">BLAST</td>
<td align="center">1-based</td>
</tr>
<tr>
<td align="center">GenBank&#x2F;EMBL Feature Table</td>
<td align="center">1-based</td>
</tr>
</tbody></table>
<p>参考链接：<br>1.<a href="https://www.jianshu.com/p/f8dd323d3c2c">https://www.jianshu.com/p/f8dd323d3c2c</a></p>
]]></content>
      <categories>
        <category>Bioinformatics</category>
      </categories>
  </entry>
  <entry>
    <title>R语言中的各种apply函数</title>
    <url>/2022/12/21/R%E8%AF%AD%E8%A8%80%E4%B8%AD%E7%9A%84%E5%90%84%E7%A7%8Dapply%E5%87%BD%E6%95%B0/</url>
    <content><![CDATA[<p>用R语言在写函数的时候，会经常用到apply函数，从而避免在R中使用循环，R语言中的apply函数主要有apply()、tapply()、lapply()、tapply()。各种apply函数很容易搞混淆，因此在这里记录一下。</p>
<span id="more"></span>

<h4 id="1-apply-函数"><a href="#1-apply-函数" class="headerlink" title="1. apply()函数"></a>1. apply()函数</h4><p>apply(X,MARGIN,FUN),输入为dataframe或matrix，以矢量、列表、数组形式输出，参数解释：</p>
<ul>
<li>X：dataframe或matrix</li>
<li>MARGIN：dataframe&#x2F;matrix的行或列，<ul>
<li>MARGIN&#x3D;1：对行进行操作</li>
<li>MARGIN&#x3D;2：对列执行操作</li>
</ul>
</li>
<li>FUN：对数据框、矩阵执行的操作</li>
</ul>
<p>例如：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line"><span class="operator">&gt;</span> m1 <span class="operator">&lt;-</span> matrix<span class="punctuation">(</span><span class="punctuation">(</span><span class="number">1</span><span class="operator">:</span><span class="number">10</span><span class="punctuation">)</span><span class="punctuation">,</span>nrow<span class="operator">=</span><span class="number">4</span><span class="punctuation">,</span> ncol<span class="operator">=</span><span class="number">5</span><span class="punctuation">,</span>byrow<span class="operator">=</span><span class="built_in">F</span><span class="punctuation">)</span></span><br><span class="line"><span class="operator">&gt;</span> m1</span><br><span class="line">     <span class="punctuation">[</span><span class="punctuation">,</span><span class="number">1</span><span class="punctuation">]</span> <span class="punctuation">[</span><span class="punctuation">,</span><span class="number">2</span><span class="punctuation">]</span> <span class="punctuation">[</span><span class="punctuation">,</span><span class="number">3</span><span class="punctuation">]</span> <span class="punctuation">[</span><span class="punctuation">,</span><span class="number">4</span><span class="punctuation">]</span> <span class="punctuation">[</span><span class="punctuation">,</span><span class="number">5</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">[</span><span class="number">1</span><span class="punctuation">,</span><span class="punctuation">]</span>    <span class="number">1</span>    <span class="number">5</span>    <span class="number">9</span>    <span class="number">3</span>    <span class="number">7</span></span><br><span class="line"><span class="punctuation">[</span><span class="number">2</span><span class="punctuation">,</span><span class="punctuation">]</span>    <span class="number">2</span>    <span class="number">6</span>   <span class="number">10</span>    <span class="number">4</span>    <span class="number">8</span></span><br><span class="line"><span class="punctuation">[</span><span class="number">3</span><span class="punctuation">,</span><span class="punctuation">]</span>    <span class="number">3</span>    <span class="number">7</span>    <span class="number">1</span>    <span class="number">5</span>    <span class="number">9</span></span><br><span class="line"><span class="punctuation">[</span><span class="number">4</span><span class="punctuation">,</span><span class="punctuation">]</span>    <span class="number">4</span>    <span class="number">8</span>    <span class="number">2</span>    <span class="number">6</span>   <span class="number">10</span></span><br><span class="line"><span class="comment"># 对行进行操作，计算每行的和</span></span><br><span class="line"><span class="operator">&gt;</span> apply<span class="punctuation">(</span>m1<span class="punctuation">,</span><span class="number">1</span><span class="punctuation">,</span><span class="built_in">sum</span><span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span> <span class="number">25</span> <span class="number">30</span> <span class="number">25</span> <span class="number">30</span></span><br><span class="line"><span class="comment"># 对列进行操作，计算每列的和</span></span><br><span class="line"><span class="operator">&gt;</span> apply<span class="punctuation">(</span>m1<span class="punctuation">,</span><span class="number">2</span><span class="punctuation">,</span><span class="built_in">sum</span><span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span> <span class="number">10</span> <span class="number">26</span> <span class="number">22</span> <span class="number">18</span> <span class="number">34</span></span><br></pre></td></tr></table></figure>

<h4 id="2-lapply-函数"><a href="#2-lapply-函数" class="headerlink" title="2. lapply()函数"></a>2. lapply()函数</h4><p>lapply(X,FUN)，输入为list、vector或data.frame，并返回与原始集合长度相同的列表list，lapply不需要MARGIN。</p>
<ul>
<li>X：向量vector或者object</li>
<li>FUN：对X的每个元素执行的操作</li>
</ul>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line"><span class="operator">&gt;</span> m2 <span class="operator">&lt;-</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;A&quot;</span><span class="punctuation">,</span><span class="string">&quot;B&quot;</span><span class="punctuation">,</span><span class="string">&quot;C&quot;</span><span class="punctuation">,</span><span class="string">&quot;D&quot;</span><span class="punctuation">)</span></span><br><span class="line"><span class="operator">&gt;</span> m2_lower <span class="operator">&lt;-</span>lapply<span class="punctuation">(</span>m2<span class="punctuation">,</span> tolower<span class="punctuation">)</span></span><br><span class="line"><span class="operator">&gt;</span> str<span class="punctuation">(</span>m2_lower<span class="punctuation">)</span></span><br><span class="line"><span class="comment">## List of 4</span></span><br><span class="line"><span class="comment">## $:chr&quot;a&quot;</span></span><br><span class="line"><span class="comment">## $:chr&quot;b&quot;</span></span><br><span class="line"><span class="comment">## $:chr&quot;c&quot;</span></span><br><span class="line"><span class="comment">## $:chr&quot;d&quot;</span></span><br></pre></td></tr></table></figure>
<p>我们可以使用unlist()将列表转换为向量。</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line"><span class="operator">&gt;</span> m2_lower2 <span class="operator">&lt;-</span> unlist<span class="punctuation">(</span>lapply<span class="punctuation">(</span>m2<span class="punctuation">,</span>tolower<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"><span class="operator">&gt;</span> str<span class="punctuation">(</span>m2_lower2<span class="punctuation">)</span></span><br><span class="line"><span class="comment">##  chr [1:4] &quot;a&quot; &quot;b&quot; &quot;c&quot; &quot;d&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="3-sapply-函数"><a href="#3-sapply-函数" class="headerlink" title="3.sapply()函数"></a>3.sapply()函数</h4><p>sapply()函数将列表、向量、数据框等作为输入，以向量或矩阵的形式输出。<br>sapply(X,FUN)</p>
<ul>
<li>X:vector or object</li>
<li>FUN:执行的操作函数</li>
</ul>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line"><span class="operator">&gt;</span> m3 <span class="operator">&lt;-</span> cars</span><br><span class="line"><span class="operator">&gt;</span> head<span class="punctuation">(</span>m3<span class="punctuation">)</span></span><br><span class="line">  speed dist</span><br><span class="line"><span class="number">1</span>     <span class="number">4</span>    <span class="number">2</span></span><br><span class="line"><span class="number">2</span>     <span class="number">4</span>   <span class="number">10</span></span><br><span class="line"><span class="number">3</span>     <span class="number">7</span>    <span class="number">4</span></span><br><span class="line"><span class="number">4</span>     <span class="number">7</span>   <span class="number">22</span></span><br><span class="line"><span class="number">5</span>     <span class="number">8</span>   <span class="number">16</span></span><br><span class="line"><span class="number">6</span>     <span class="number">9</span>   <span class="number">10</span></span><br><span class="line"><span class="operator">&gt;</span> m3_lmin <span class="operator">&lt;-</span> lapply<span class="punctuation">(</span>m3<span class="punctuation">,</span><span class="built_in">min</span><span class="punctuation">)</span></span><br><span class="line"><span class="operator">&gt;</span> m3_smin <span class="operator">&lt;-</span> sapply<span class="punctuation">(</span>m3<span class="punctuation">,</span><span class="built_in">min</span><span class="punctuation">)</span></span><br><span class="line"><span class="operator">&gt;</span> m3_lmin</span><br><span class="line"><span class="operator">$</span>speed</span><br><span class="line"><span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span> <span class="number">4</span></span><br><span class="line"></span><br><span class="line"><span class="operator">$</span>dist</span><br><span class="line"><span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span> <span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="operator">&gt;</span> m3_smin</span><br><span class="line">speed  dist </span><br><span class="line">    <span class="number">4</span>     <span class="number">2</span> </span><br></pre></td></tr></table></figure>
<p>sapply()函数执行的功能与lapply()函数相同,sapply()函数返回一个向量,lapply()函数返回一个向量。</p>
<p>apply()、sapply()、lapply()之间的区别：</p>
<table>
<thead>
<tr>
<th align="center">Function</th>
<th align="center">Arguments</th>
<th align="center">Objective</th>
<th align="center">Input</th>
<th align="center">Output</th>
</tr>
</thead>
<tbody><tr>
<td align="center">apply</td>
<td align="center">apply(x, MARGIN, FUN)</td>
<td align="center">Apply a function to the rows or columns or both</td>
<td align="center">Data.frame or matrix</td>
<td align="center">vector, list, array</td>
</tr>
<tr>
<td align="center">lapply</td>
<td align="center">lapply(X, FUN)</td>
<td align="center">Apply a function to all the elements of the input</td>
<td align="center">List, vector or data.frame</td>
<td align="center">list</td>
</tr>
<tr>
<td align="center">sapply</td>
<td align="center">sappy(X FUN)</td>
<td align="center">Apply a function to all the elements of the input</td>
<td align="center">List, vector or data.frame</td>
<td align="center">vector or matrix</td>
</tr>
</tbody></table>
<h4 id="4-tapply-函数"><a href="#4-tapply-函数" class="headerlink" title="4.tapply()函数"></a>4.tapply()函数</h4><p>tapply()计算向量中每个因子变量的度量（均值、中位数、最小值、最大值等）或函数，即对数据分组进行运算。也可以创建向量的子集，然后将FUN函数应用于每个子集。<br>tapply(X,INDEX,FUN&#x3D;NULL,simplify&#x3D;TRUE)</p>
<ul>
<li>X:object,通常是vector</li>
<li>INDEX:一个list对象，且该list中的每一个元素都是与X有同样长度的因子</li>
<li>FUN:是需要计算的函数</li>
<li>simplify是逻辑变量，若取值为TRUE（默认值），且函数FUN的计算结果总是为一个标量值，那么函数tapply返回一个数组；若取值为FALSE，则函数tapply的返回值为一个list对象。</li>
</ul>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line"><span class="operator">&gt;</span> iris</span><br><span class="line">    Sepal.Length Sepal.Width Petal.Length Petal.Width    Species</span><br><span class="line"><span class="number">1</span>            <span class="number">5.1</span>         <span class="number">3.5</span>          <span class="number">1.4</span>         <span class="number">0.2</span>     setosa</span><br><span class="line"><span class="number">2</span>            <span class="number">4.9</span>         <span class="number">3.0</span>          <span class="number">1.4</span>         <span class="number">0.2</span>     setosa</span><br><span class="line">......</span><br><span class="line"><span class="number">51</span>           <span class="number">7.0</span>         <span class="number">3.2</span>          <span class="number">4.7</span>         <span class="number">1.4</span> versicolor</span><br><span class="line"><span class="number">52</span>           <span class="number">6.4</span>         <span class="number">3.2</span>          <span class="number">4.5</span>         <span class="number">1.5</span> versicolor</span><br><span class="line">......	</span><br><span class="line"><span class="number">149</span>          <span class="number">6.2</span>         <span class="number">3.4</span>          <span class="number">5.4</span>         <span class="number">2.3</span>  virginica</span><br><span class="line"><span class="number">150</span>          <span class="number">5.9</span>         <span class="number">3.0</span>          <span class="number">5.1</span>         <span class="number">1.8</span>  virginica</span><br><span class="line"><span class="operator">&gt;</span> tapply<span class="punctuation">(</span>iris<span class="operator">$</span>Sepal.Length<span class="punctuation">,</span>iris<span class="operator">$</span>Species<span class="punctuation">,</span>median<span class="punctuation">)</span></span><br><span class="line">    setosa versicolor  virginica </span><br><span class="line">       <span class="number">5.0</span>        <span class="number">5.9</span>        <span class="number">6.5</span> </span><br></pre></td></tr></table></figure>

<p>tapply()函数的INDEX也可以是多列的组合，例如：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line"><span class="operator">&gt;</span> newiris<span class="operator">$</span>Sepal.Length_compare_with_5<span class="operator">&lt;-</span>ifelse<span class="punctuation">(</span>newiris<span class="operator">$</span>Sepal.Length<span class="operator">&gt;</span><span class="number">5.0</span><span class="punctuation">,</span><span class="string">&quot;over_than_5&quot;</span><span class="punctuation">,</span><span class="string">&quot;lower_than_5&quot;</span><span class="punctuation">)</span></span><br><span class="line"><span class="operator">&gt;</span> tapply<span class="punctuation">(</span>newiris<span class="operator">$</span>Sepal.Width<span class="punctuation">,</span>newiris<span class="punctuation">[</span><span class="punctuation">,</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;Species&quot;</span><span class="punctuation">,</span><span class="string">&quot;Sepal.Length_compare_with_5&quot;</span><span class="punctuation">)</span><span class="punctuation">]</span><span class="punctuation">,</span>mean<span class="punctuation">)</span></span><br><span class="line">     Sepal.Length_compare_with_5</span><br><span class="line">Species      lower_than_5 over_than_5</span><br><span class="line">setosa         <span class="number">3.213793</span>    <span class="number">3.723810</span></span><br><span class="line">versicolor     <span class="number">2.233333</span>    <span class="number">2.804255</span></span><br><span class="line">virginica      <span class="number">2.500000</span>    <span class="number">2.983673</span></span><br></pre></td></tr></table></figure>


<p>参考资料：<br>1.<a href="https://zhuanlan.zhihu.com/p/26029242">https://zhuanlan.zhihu.com/p/26029242</a> 这个里面有更多关于apply函数的详细解释，非常有帮助！</p>
]]></content>
      <categories>
        <category>R</category>
      </categories>
      <tags>
        <tag>R</tag>
      </tags>
  </entry>
  <entry>
    <title>ggplot2集锦之二scale相关设置</title>
    <url>/2023/02/09/ggplot2%E9%9B%86%E9%94%A6%E4%B9%8B%E4%BA%8Cscale%E7%9B%B8%E5%85%B3%E8%AE%BE%E7%BD%AE/</url>
    <content><![CDATA[<p>本文总结了ggplot2包绘图时scale_相关设置。</p>
<span id="more"></span>

<p>scale_主要用于在ggplot画图之后对各个图层进行调整。常用的有：<br><img src="/pics/2023-02-13-scale_table.jpg" alt="alt 图标"></p>
<h3 id="1-1-属性相关的scale设置"><a href="#1-1-属性相关的scale设置" class="headerlink" title="1.1 属性相关的scale设置"></a>1.1 属性相关的scale设置</h3><p>包括scale_size()、scale_alpha()、scale_shape()。这三个设置主要对ggplot的图层属性进行相关设置，包括尺寸、透明度和形状。<br>以下列出该设置的主要参数：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">scale_xxx<span class="punctuation">(</span>name <span class="operator">=</span> waiver<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span> breaks <span class="operator">=</span> waiver<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span> labels <span class="operator">=</span> waiver<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span> limits <span class="operator">=</span> <span class="literal">NULL</span><span class="punctuation">,</span> <span class="built_in">range</span> <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">1</span><span class="punctuation">,</span> <span class="number">6</span><span class="punctuation">)</span><span class="punctuation">,</span>.....<span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p>由上面参数可以看出，我们可以对该属性进行，name命名，breaks设置组别，labels组别标签，limits限定坐标轴范围或组别排序，这几个参数在大多数scale设置中基本上都会用到。range设置尺寸大小范围（如点图的点），这个参数在其他设置中相对少见。</p>
<h4 id="1-1-1-scale-size"><a href="#1-1-1-scale-size" class="headerlink" title="1.1.1 scale_size"></a>1.1.1 scale_size</h4><p>下面提供些例子作为参考：以R自带的mtcars数据集作为样本</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">ggplot<span class="punctuation">(</span>data<span class="operator">=</span>mtcars<span class="punctuation">,</span> aes<span class="punctuation">(</span>x<span class="operator">=</span>hp<span class="punctuation">,</span> y<span class="operator">=</span>mpg<span class="punctuation">,</span>size<span class="operator">=</span>mpg<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">     geom_point<span class="punctuation">(</span><span class="punctuation">)</span> </span><br></pre></td></tr></table></figure>
<p><img src="/pics/2023-02-08-ggplot-scale1.png" alt="alt 图标"><br>修改size的图例为”size name”,同时使用limits将size进行限定，只有在limits设置范围内的数据会被保留。</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">ggplot<span class="punctuation">(</span>data<span class="operator">=</span>mtcars<span class="punctuation">,</span> aes<span class="punctuation">(</span>x<span class="operator">=</span>hp<span class="punctuation">,</span> y<span class="operator">=</span>mpg<span class="punctuation">,</span>size<span class="operator">=</span>mpg<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">     geom_point<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">     scale_size<span class="punctuation">(</span><span class="string">&quot;size name&quot;</span><span class="punctuation">,</span>limits <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">15</span><span class="punctuation">,</span><span class="number">30</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><img src="/pics/2023-02-08-ggplot-scale2.png" alt="alt 图标"><br>range参数通过缩放修改点的大小。</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">ggplot<span class="punctuation">(</span>data<span class="operator">=</span>mtcars<span class="punctuation">,</span> aes<span class="punctuation">(</span>x<span class="operator">=</span>hp<span class="punctuation">,</span> y<span class="operator">=</span>mpg<span class="punctuation">,</span>size<span class="operator">=</span>mpg<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">     geom_point<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">     scale_size<span class="punctuation">(</span><span class="string">&quot;size name&quot;</span><span class="punctuation">,</span>limits <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">15</span><span class="punctuation">,</span><span class="number">30</span><span class="punctuation">)</span><span class="punctuation">,</span><span class="built_in">range</span> <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">1</span><span class="punctuation">,</span><span class="number">3</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><img src="/pics/2023-02-08-ggplot-scale3.png" alt="alt 图标"></p>
<blockquote>
<p>limits设置是针对数据的范围进行裁剪，而range设置纯粹的针对点的大小。scale_size()基本只用于散点图，同时与之对应的还有一个scale_radius()是对点进行设置半径，相比较而言scale_radius()基本上很少用到。最后scale_size诸多设置也可以用scale_size_area()进行设置。</p>
</blockquote>
<h4 id="1-1-2-scale-alpha"><a href="#1-1-2-scale-alpha" class="headerlink" title="1.1.2 scale_alpha"></a>1.1.2 scale_alpha</h4><p>alpha调整点的透明度，scale_alpha与scale_alpha_continuous()等价，参数如下：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">scale_alpha<span class="punctuation">(</span>...<span class="punctuation">,</span> <span class="built_in">range</span> <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">0.1</span><span class="punctuation">,</span> <span class="number">1</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p>关于alpha参数的其他设置如name、breaks等归进continuous_scale()、binned_scale()、 discrete_scale()函数，区别在于alpha分组的变量是连续型（数值型）还是离散型（如文本类型）。</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">continuous_scale<span class="punctuation">(</span></span><br><span class="line">  aesthetics<span class="punctuation">,</span></span><br><span class="line">  scale_name<span class="punctuation">,</span></span><br><span class="line">  palette<span class="punctuation">,</span></span><br><span class="line">  name <span class="operator">=</span> waiver<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">  breaks <span class="operator">=</span> waiver<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">  minor_breaks <span class="operator">=</span> waiver<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">  n.breaks <span class="operator">=</span> <span class="literal">NULL</span><span class="punctuation">,</span></span><br><span class="line">  labels <span class="operator">=</span> waiver<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">  limits <span class="operator">=</span> <span class="literal">NULL</span><span class="punctuation">,</span></span><br><span class="line">  rescaler <span class="operator">=</span> rescale<span class="punctuation">,</span></span><br><span class="line">  oob <span class="operator">=</span> censor<span class="punctuation">,</span></span><br><span class="line">  expand <span class="operator">=</span> waiver<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">  na.value <span class="operator">=</span> <span class="literal">NA_real_</span><span class="punctuation">,</span></span><br><span class="line">  trans <span class="operator">=</span> <span class="string">&quot;identity&quot;</span><span class="punctuation">,</span></span><br><span class="line">  guide <span class="operator">=</span> <span class="string">&quot;legend&quot;</span><span class="punctuation">,</span></span><br><span class="line">  position <span class="operator">=</span> <span class="string">&quot;left&quot;</span><span class="punctuation">,</span></span><br><span class="line">  super <span class="operator">=</span> ScaleContinuous</span><br><span class="line"><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p>例如,连续型:</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">ggplot<span class="punctuation">(</span>data<span class="operator">=</span>mtcars<span class="punctuation">,</span> aes<span class="punctuation">(</span>x<span class="operator">=</span>hp<span class="punctuation">,</span> y<span class="operator">=</span>mpg<span class="punctuation">,</span>size<span class="operator">=</span>mpg<span class="punctuation">,</span>alpha<span class="operator">=</span>mpg<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">     geom_point<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">     scale_size<span class="punctuation">(</span><span class="string">&quot;size name&quot;</span><span class="punctuation">,</span>limits <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">15</span><span class="punctuation">,</span><span class="number">30</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">     scale_alpha<span class="punctuation">(</span><span class="built_in">range</span><span class="operator">=</span><span class="built_in">c</span><span class="punctuation">(</span><span class="number">0.1</span><span class="punctuation">,</span><span class="number">1</span><span class="punctuation">)</span><span class="punctuation">)</span> </span><br></pre></td></tr></table></figure>
<p><img src="/pics/2023-02-08-ggplot-scale4.png" alt="alt 图标"></p>
<p>离散型：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">ggplot<span class="punctuation">(</span>data<span class="operator">=</span>mtcars<span class="punctuation">,</span> aes<span class="punctuation">(</span>x<span class="operator">=</span>hp<span class="punctuation">,</span> y<span class="operator">=</span>mpg<span class="punctuation">,</span>size<span class="operator">=</span>mpg<span class="punctuation">,</span>alpha<span class="operator">=</span>am<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">     geom_point<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">     scale_size<span class="punctuation">(</span><span class="string">&quot;size name&quot;</span><span class="punctuation">,</span>limits <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">15</span><span class="punctuation">,</span><span class="number">30</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">     scale_alpha_discrete<span class="punctuation">(</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><img src="/pics/2023-02-08-ggplot-scale5.png" alt="alt 图标"></p>
<h4 id="1-2-3-scale-shape"><a href="#1-2-3-scale-shape" class="headerlink" title="1.2.3 scale_shape"></a>1.2.3 scale_shape</h4><p>scale_shape只能用于离散型变量，例如：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">ggplot<span class="punctuation">(</span>data<span class="operator">=</span>mtcars<span class="punctuation">,</span> aes<span class="punctuation">(</span>x<span class="operator">=</span>hp<span class="punctuation">,</span> y<span class="operator">=</span>mpg<span class="punctuation">,</span>size<span class="operator">=</span>mpg<span class="punctuation">,</span>alpha<span class="operator">=</span>am<span class="punctuation">,</span>shape<span class="operator">=</span>am<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">     geom_point<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">     scale_size<span class="punctuation">(</span><span class="string">&quot;size name&quot;</span><span class="punctuation">,</span>limits <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">15</span><span class="punctuation">,</span><span class="number">30</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">     scale_alpha_discrete<span class="punctuation">(</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">     scale_shape<span class="punctuation">(</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><img src="/pics/2023-02-08-ggplot-scale6.png" alt="alt 图标"></p>
<h3 id="1-2-scale-坐标转换"><a href="#1-2-scale-坐标转换" class="headerlink" title="1.2 scale-坐标转换"></a>1.2 scale-坐标转换</h3><p>在R中坐标轴转换形式多样，如对数转换、平方根转换、坐标刻度前后调换等。<br>用到的函数有(*:x&#x2F;y)：</p>
<ul>
<li>scale_*_log10()</li>
<li>scale_*_reverse()</li>
<li>scale_*<em>sqrt()<br>以上函数都是基于scale</em>*_continuous()的，具体参数如下：<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">scale_x_continuous<span class="punctuation">(</span></span><br><span class="line">  name <span class="operator">=</span> waiver<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">  breaks <span class="operator">=</span> waiver<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">  minor_breaks <span class="operator">=</span> waiver<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">  n.breaks <span class="operator">=</span> <span class="literal">NULL</span><span class="punctuation">,</span></span><br><span class="line">  labels <span class="operator">=</span> waiver<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">  limits <span class="operator">=</span> <span class="literal">NULL</span><span class="punctuation">,</span></span><br><span class="line">  expand <span class="operator">=</span> waiver<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">  oob <span class="operator">=</span> censor<span class="punctuation">,</span></span><br><span class="line">  na.value <span class="operator">=</span> <span class="literal">NA_real_</span><span class="punctuation">,</span></span><br><span class="line">  trans <span class="operator">=</span> <span class="string">&quot;identity&quot;</span><span class="punctuation">,</span></span><br><span class="line">  guide <span class="operator">=</span> waiver<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">  position <span class="operator">=</span> <span class="string">&quot;bottom&quot;</span><span class="punctuation">,</span></span><br><span class="line">  sec.axis <span class="operator">=</span> waiver<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
以上的坐标轴转换可以通过scale_*_continuous()的trans参数实现。</li>
</ul>
<p>例如,转换前：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">ggplot<span class="punctuation">(</span>data<span class="operator">=</span>mtcars<span class="punctuation">,</span> aes<span class="punctuation">(</span>x<span class="operator">=</span>hp<span class="punctuation">,</span> y<span class="operator">=</span>mpg<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">     geom_point<span class="punctuation">(</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><img src="/pics/2023-02-08-ggplot-scale7.png" alt="alt 图标"></p>
<p>以下log10转换后，两个效果一样，如下图：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">ggplot<span class="punctuation">(</span>data<span class="operator">=</span>mtcars<span class="punctuation">,</span> aes<span class="punctuation">(</span>x<span class="operator">=</span>hp<span class="punctuation">,</span> y<span class="operator">=</span>mpg<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">     geom_point<span class="punctuation">(</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">     scale_x_log10<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">ggplot<span class="punctuation">(</span>data<span class="operator">=</span>mtcars<span class="punctuation">,</span> aes<span class="punctuation">(</span>x<span class="operator">=</span>hp<span class="punctuation">,</span> y<span class="operator">=</span>mpg<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">     geom_point<span class="punctuation">(</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">     scale_x_continuous<span class="punctuation">(</span>trans<span class="operator">=</span><span class="string">&quot;log10&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><img src="/pics/2023-02-08-ggplot-scale8.png" alt="alt 图标"></p>
<p>此外，借助coord_trans()函数，可以直接对x和y轴进行不同设置，如图:</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">ggplot<span class="punctuation">(</span>data<span class="operator">=</span>mtcars<span class="punctuation">,</span> aes<span class="punctuation">(</span>x<span class="operator">=</span>hp<span class="punctuation">,</span> y<span class="operator">=</span>mpg<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">     geom_point<span class="punctuation">(</span><span class="punctuation">)</span><span class="operator">+</span>coord_trans<span class="punctuation">(</span>x<span class="operator">=</span><span class="string">&quot;log10&quot;</span><span class="punctuation">,</span>y <span class="operator">=</span> <span class="string">&quot;sqrt&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><img src="/pics/2023-02-08-ggplot-scale9.png" alt="alt 图标"></p>
<blockquote>
<p>注：这样转变之后的坐标轴刻度并不会改变，只是将点进行缩放，如果要改变坐标轴刻度，可以直接在aes中改变。<br><code>ggplot(data=mtcars, aes(x=loog10(hp), y=sqrt(mpg))) + geom_point()</code></p>
</blockquote>
<h3 id="1-3-scale-时间设置"><a href="#1-3-scale-时间设置" class="headerlink" title="1.3 scale-时间设置"></a>1.3 scale-时间设置</h3><p>在scale设置中，常用的日期方面的设置函数包括：scale_x_date()，scale_y_date(),scale_x_datetime(),scale_y_datetime()</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">scale_x_date<span class="punctuation">(</span>name <span class="operator">=</span> waiver<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span> breaks <span class="operator">=</span> waiver<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span> date_breaks <span class="operator">=</span> waiver<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span> labels <span class="operator">=</span> waiver<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span> date_labels <span class="operator">=</span> waiver<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span> minor_breaks <span class="operator">=</span> waiver<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span> date_minor_breaks <span class="operator">=</span> waiver<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span> limits <span class="operator">=</span> <span class="literal">NULL</span><span class="punctuation">,</span> expand <span class="operator">=</span> waiver<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p>常用的设置参数有：name，breaks,labels,limits等，另外，特有的参数包括，date_labels,date_breaks,minor_breaks,date_minor_breks。从作用来说，date_breaks和breaks作用是一样的，如果两个参数同时出现在一个scale设置中，函数会默认优先使用date_breaks的参数内容。<br>minor_breaks()和date_minor_breaks()是在原有坐标轴刻度的基础上，绘制出子刻度。比如你的breaks 可能是以月为单位，minor_breaks可以设置为以日为单位，这样就可以在所画的图中看出更为精确的数据图形。</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">df <span class="operator">&lt;-</span> data.frame<span class="punctuation">(</span>date <span class="operator">=</span> Sys.Date<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">-</span> <span class="number">0</span><span class="operator">:</span><span class="number">29</span><span class="punctuation">,</span></span><br><span class="line">	count <span class="operator">=</span> runif<span class="punctuation">(</span><span class="number">30</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">ggplot<span class="punctuation">(</span>df<span class="punctuation">,</span> aes<span class="punctuation">(</span>date<span class="punctuation">,</span> count<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  geom_line<span class="punctuation">(</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">  scale_x_date<span class="punctuation">(</span>breaks<span class="operator">=</span>as.Date<span class="punctuation">(</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;2023-01-10&quot;</span><span class="punctuation">,</span><span class="string">&quot;2023-01-20&quot;</span><span class="punctuation">,</span><span class="string">&quot;2023-01-30&quot;</span><span class="punctuation">,</span><span class="string">&quot;2023-02-10&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">	labels<span class="operator">=</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;01-10&quot;</span><span class="punctuation">,</span><span class="string">&quot;01-20&quot;</span><span class="punctuation">,</span><span class="string">&quot;01-30&quot;</span><span class="punctuation">,</span><span class="string">&quot;02-10&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><img src="/pics/2023-02-08-ggplot-scale10.png" alt="alt 图标"></p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">ggplot<span class="punctuation">(</span>df<span class="punctuation">,</span> aes<span class="punctuation">(</span>date<span class="punctuation">,</span> count<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  geom_line<span class="punctuation">(</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">  scale_x_date<span class="punctuation">(</span>breaks<span class="operator">=</span>as.Date<span class="punctuation">(</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;2023-01-10&quot;</span><span class="punctuation">,</span><span class="string">&quot;2023-01-20&quot;</span><span class="punctuation">,</span><span class="string">&quot;2023-01-30&quot;</span><span class="punctuation">,</span><span class="string">&quot;2023-02-10&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">	labels<span class="operator">=</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;01-10&quot;</span><span class="punctuation">,</span><span class="string">&quot;01-20&quot;</span><span class="punctuation">,</span><span class="string">&quot;01-30&quot;</span><span class="punctuation">,</span><span class="string">&quot;02-10&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">	date_labels<span class="operator">=</span><span class="string">&quot;%y/%m/%d&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">ggplot<span class="punctuation">(</span>df<span class="punctuation">,</span> aes<span class="punctuation">(</span>date<span class="punctuation">,</span> count<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  geom_line<span class="punctuation">(</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">  scale_x_date<span class="punctuation">(</span>date_labels<span class="operator">=</span><span class="string">&quot;%y/%m/%d&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p>以上两段代码绘制出相同的图：<br><img src="/pics/2023-02-08-ggplot-scale11.png" alt="alt 图标"></p>
<p>1、在lables和date_labels同时出现的情况下，系统会优先使用date_labels设置<br>2、在时间设置方面，date_labels,以及date_breaks  设置要比 labels和breaks设置要简洁得多。</p>
<h3 id="1-4-scale-手动设置"><a href="#1-4-scale-手动设置" class="headerlink" title="1.4 scale-手动设置"></a>1.4 scale-手动设置</h3><p>在ggplot2 中，可以进行手动设置的函数有：scale_colour_manual(…, values)、scale_fill_manual(…,values)、scale_size_manual(…,values) scale_shape_manual(…,values)、scale_linetype_manual(…,values)、scale_alpha_manual(…,values)、scale_color_manual(…,values)。<br>基本上所有的属性设置，都可以进行手动设置。另外从以上的参数来看，手动设置函数，除了正常的参数以外，还有一个values参数，参数values的值可以是名称或者数字，名称用于指定相关设置选项的名称，数值则表示指定范围。通常用于设置图例。</p>
<p>以颜色为例scale_color_manual()：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">p <span class="operator">&lt;-</span> ggplot<span class="punctuation">(</span>data<span class="operator">=</span>mtcars<span class="punctuation">,</span> aes<span class="punctuation">(</span>x<span class="operator">=</span>hp<span class="punctuation">,</span> y<span class="operator">=</span>mpg<span class="punctuation">,</span> color<span class="operator">=</span>vs<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">     geom_point<span class="punctuation">(</span>size<span class="operator">=</span><span class="number">3</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><img src="/pics/2023-02-08-ggplot-scale12.png" alt="alt 图标"></p>
<p>直接手动改变颜色：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">p<span class="operator">+</span>scale_colour_manual<span class="punctuation">(</span>values<span class="operator">=</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;red&quot;</span><span class="punctuation">,</span><span class="string">&quot;blue&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><img src="/pics/2023-02-08-ggplot-scale13.png" alt="alt 图标"></p>
<p>通过数字改变：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">p <span class="operator">+</span> scale_color_manual<span class="punctuation">(</span>values <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">2</span><span class="operator">:</span><span class="number">3</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><img src="/pics/2023-02-08-ggplot-scale14.png" alt="alt 图标"></p>
<p>直接对因子变量直接进行赋值:</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">p<span class="operator">+</span>scale_colour_manual<span class="punctuation">(</span>values<span class="operator">=</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;V-Engine&quot;</span><span class="operator">=</span><span class="string">&quot;red&quot;</span><span class="punctuation">,</span><span class="string">&quot;Straight Engine&quot;</span><span class="operator">=</span><span class="string">&quot;blue&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><img src="/pics/2023-02-08-ggplot-scale13.png" alt="alt 图标"></p>
<h3 id="1-5-scale-颜色设置"><a href="#1-5-scale-颜色设置" class="headerlink" title="1.5 scale-颜色设置"></a>1.5 scale-颜色设置</h3><p>在ggplot的scale设置中，颜色相关的函数较多：<br>scale_color&#x2F;fill_manual(手动更改颜色)、scale_color&#x2F;fill_hue(通过更改色度)、scale_color_brewer(更改色盘)、scale_color&#x2F;fill_discrete(离散型)、scale_color&#x2F;fill_continuous、scale_color&#x2F;fill_gradient等等，continuous和gradient是一样的。</p>
<h4 id="1-5-1-scale-color-hue"><a href="#1-5-1-scale-color-hue" class="headerlink" title="1.5.1 scale_color_hue"></a>1.5.1 scale_color_hue</h4><p>参数详解：</p>
<ul>
<li>h表示色彩变化范围，变化范围为（0，360）</li>
<li>c表示色彩的浓度，由数据的最大值决定</li>
<li>l 表示色彩的亮度，变化范围为（0，100）</li>
<li>direction 为1表示色彩是顺时针，-1表示逆时针<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">scale_colour_hue<span class="punctuation">(</span>...<span class="punctuation">,</span></span><br><span class="line">  h <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">0</span><span class="punctuation">,</span> <span class="number">360</span><span class="punctuation">)</span> <span class="operator">+</span> <span class="number">15</span><span class="punctuation">,</span></span><br><span class="line">  <span class="built_in">c</span> <span class="operator">=</span> <span class="number">100</span><span class="punctuation">,</span></span><br><span class="line">  l <span class="operator">=</span> <span class="number">65</span><span class="punctuation">,</span></span><br><span class="line">  h.start <span class="operator">=</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  direction <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  na.value <span class="operator">=</span> <span class="string">&quot;grey50&quot;</span><span class="punctuation">,</span></span><br><span class="line">  aesthetics <span class="operator">=</span> <span class="string">&quot;colour&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure></li>
</ul>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">p <span class="operator">&lt;-</span> ggplot<span class="punctuation">(</span>data<span class="operator">=</span>mtcars<span class="punctuation">,</span> aes<span class="punctuation">(</span>x<span class="operator">=</span>hp<span class="punctuation">,</span> y<span class="operator">=</span>mpg<span class="punctuation">,</span> color<span class="operator">=</span>vs<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">           geom_point<span class="punctuation">(</span>size<span class="operator">=</span><span class="number">3</span><span class="punctuation">)</span></span><br><span class="line">p <span class="operator">+</span> scale_color_hue<span class="punctuation">(</span>h<span class="operator">=</span><span class="built_in">c</span><span class="punctuation">(</span><span class="number">0</span><span class="punctuation">,</span><span class="number">360</span><span class="punctuation">)</span><span class="punctuation">,</span><span class="built_in">c</span><span class="operator">=</span><span class="number">500</span><span class="punctuation">,</span>l<span class="operator">=</span><span class="built_in">c</span><span class="punctuation">(</span><span class="number">20</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><img src="/pics/2023-02-08-ggplot-scale14.png" alt="alt 图标"></p>
<h4 id="1-5-2-scale-color-brewer"><a href="#1-5-2-scale-color-brewer" class="headerlink" title="1.5.2 scale_color_brewer"></a>1.5.2 scale_color_brewer</h4><p>参数详解：</p>
<ul>
<li>type表示颜色样式 有seq 、 div 、qual 三个中选一个，”seq” (sequential), “div” (diverging) or “qual” (qualitative)</li>
<li>palette 表示颜色数量，数字直接表示颜色个数，也可以用相对应的名称<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">scale_colour_brewer<span class="punctuation">(</span>...<span class="punctuation">,</span></span><br><span class="line">  type <span class="operator">=</span> <span class="string">&quot;seq&quot;</span><span class="punctuation">,</span></span><br><span class="line">  palette <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  direction <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  aesthetics <span class="operator">=</span> <span class="string">&quot;colour&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
例如：<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">p<span class="operator">+</span>scale_color_brewer<span class="punctuation">(</span>type<span class="operator">=</span><span class="string">&quot;seq&quot;</span><span class="punctuation">,</span>palette<span class="operator">=</span><span class="string">&quot;Set2&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<img src="/pics/2023-02-08-ggplot-scale15.png" alt="alt 图标"></li>
</ul>
<h4 id="1-5-3-scale-color-gradient"><a href="#1-5-3-scale-color-gradient" class="headerlink" title="1.5.3 scale_color_gradient"></a>1.5.3 scale_color_gradient</h4><p>scale_n_gradient以两种颜色为梯度(low,high),scale_n_gradient2()以三种颜色为梯度(low,mid,high),scale_*gradientn()以n种颜色作为梯度。<br>参数详解：</p>
<ul>
<li>low 表示颜色梯度最底端的颜色</li>
<li>high 表示颜色梯度最高位置的颜色</li>
<li>space 表示颜色梯度计算空间，通常用lab 都是最好的</li>
<li>guide 该参数的值可以用colourbar 表示用颜色条，legend可以表示为离散变量<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">scale_colour_gradient<span class="punctuation">(</span>...<span class="punctuation">,</span></span><br><span class="line">  low <span class="operator">=</span> <span class="string">&quot;#132B43&quot;</span><span class="punctuation">,</span></span><br><span class="line">  high <span class="operator">=</span> <span class="string">&quot;#56B1F7&quot;</span><span class="punctuation">,</span></span><br><span class="line">  space <span class="operator">=</span> <span class="string">&quot;Lab&quot;</span><span class="punctuation">,</span></span><br><span class="line">  na.value <span class="operator">=</span> <span class="string">&quot;grey50&quot;</span><span class="punctuation">,</span></span><br><span class="line">  guide <span class="operator">=</span> <span class="string">&quot;colourbar&quot;</span><span class="punctuation">,</span></span><br><span class="line">  aesthetics <span class="operator">=</span> <span class="string">&quot;colour&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">scale_colour_gradient2<span class="punctuation">(</span>...<span class="punctuation">,</span></span><br><span class="line">  low <span class="operator">=</span> muted<span class="punctuation">(</span><span class="string">&quot;red&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">  mid <span class="operator">=</span> <span class="string">&quot;white&quot;</span><span class="punctuation">,</span></span><br><span class="line">  high <span class="operator">=</span> muted<span class="punctuation">(</span><span class="string">&quot;blue&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">  midpoint <span class="operator">=</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  space <span class="operator">=</span> <span class="string">&quot;Lab&quot;</span><span class="punctuation">,</span></span><br><span class="line">  na.value <span class="operator">=</span> <span class="string">&quot;grey50&quot;</span><span class="punctuation">,</span></span><br><span class="line">  guide <span class="operator">=</span> <span class="string">&quot;colourbar&quot;</span><span class="punctuation">,</span></span><br><span class="line">  aesthetics <span class="operator">=</span> <span class="string">&quot;colour&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">scale_colour_gradientn<span class="punctuation">(</span>...<span class="punctuation">,</span></span><br><span class="line">  colours<span class="punctuation">,</span></span><br><span class="line">  values <span class="operator">=</span> <span class="literal">NULL</span><span class="punctuation">,</span></span><br><span class="line">  space <span class="operator">=</span> <span class="string">&quot;Lab&quot;</span><span class="punctuation">,</span></span><br><span class="line">  na.value <span class="operator">=</span> <span class="string">&quot;grey50&quot;</span><span class="punctuation">,</span></span><br><span class="line">  guide <span class="operator">=</span> <span class="string">&quot;colourbar&quot;</span><span class="punctuation">,</span></span><br><span class="line">  aesthetics <span class="operator">=</span> <span class="string">&quot;colour&quot;</span><span class="punctuation">,</span></span><br><span class="line">  colors<span class="punctuation">)</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p>例如：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">p <span class="operator">&lt;-</span> ggplot<span class="punctuation">(</span>data<span class="operator">=</span>mtcars<span class="punctuation">,</span> aes<span class="punctuation">(</span>x<span class="operator">=</span>hp<span class="punctuation">,</span> y<span class="operator">=</span>mpg<span class="punctuation">,</span> color<span class="operator">=</span>mpg<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">           geom_point<span class="punctuation">(</span>size<span class="operator">=</span><span class="number">3</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><img src="/pics/2023-02-08-ggplot-scale16.png" alt="alt 图标"><br>两种颜色的梯度：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">p <span class="operator">+</span> scale_color_gradient<span class="punctuation">(</span>low<span class="operator">=</span><span class="string">&quot;red&quot;</span><span class="punctuation">,</span>high<span class="operator">=</span><span class="string">&quot;blue&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><img src="/pics/2023-02-08-ggplot-scale17.png" alt="alt 图标"></p>
<p>三种颜色的梯度：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">p <span class="operator">+</span> scale_color_gradient2<span class="punctuation">(</span>low<span class="operator">=</span>muted<span class="punctuation">(</span><span class="string">&quot;red&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span>mid<span class="operator">=</span><span class="string">&quot;white&quot;</span><span class="punctuation">,</span>high<span class="operator">=</span>muted<span class="punctuation">(</span><span class="string">&quot;blue&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<h4 id="1-5-4-scale-color-grey"><a href="#1-5-4-scale-color-grey" class="headerlink" title="1.5.4 scale_color_grey"></a>1.5.4 scale_color_grey</h4><p>grey的设置是对颜色进行灰度设置，另外，值得注意的是start和end的参数只能在0到1之间进行取值。<br>把颜色设置成灰度面板。</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">scale_colour<span class="operator">/</span>fill_grey<span class="punctuation">(</span>...<span class="punctuation">,</span> start <span class="operator">=</span> <span class="number">0.2</span><span class="punctuation">,</span> end <span class="operator">=</span> <span class="number">0.8</span><span class="punctuation">,</span> na.value <span class="operator">=</span> <span class="string">&quot;red&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<ul>
<li>start 从调色板的最低端颜色开始（颜色最浅开始）</li>
<li>end 到调试板最高位置的颜色（颜色最深开始）<br>例如：<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">p <span class="operator">+</span> scale_color_grey<span class="punctuation">(</span>end<span class="operator">=</span><span class="number">0.5</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<img src="/pics/2023-02-08-ggplot-scale18.png" alt="alt 图标"></li>
</ul>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">p <span class="operator">+</span> scale_color_grey<span class="punctuation">(</span>start <span class="operator">=</span><span class="number">0.5</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><img src="/pics/2023-02-08-ggplot-scale19.png" alt="alt 图标"></p>
<p>scale还有其他的各种作用，例如，scale_x_break()、scale_y_break()可以对坐标轴进行截断。</p>
<p>参考资料：</p>
<ol>
<li><a href="https://www.bbsmax.com/A/1O5EpAybJ7/">https://www.bbsmax.com/A/1O5EpAybJ7/</a></li>
<li><a href="https://www.bbsmax.com/A/x9J2W92W56/">https://www.bbsmax.com/A/x9J2W92W56/</a></li>
<li><a href="https://www.bbsmax.com/A/QV5Z9ZPeJy/">https://www.bbsmax.com/A/QV5Z9ZPeJy/</a></li>
</ol>
]]></content>
      <categories>
        <category>R</category>
        <category>ggplot2</category>
      </categories>
      <tags>
        <tag>R</tag>
        <tag>ggplot2</tag>
      </tags>
  </entry>
  <entry>
    <title>ggplot2集锦之一facet分面</title>
    <url>/2023/02/07/ggplot2%E9%9B%86%E9%94%A6%E4%B9%8B%E4%B8%80facet%E5%88%86%E9%9D%A2/</url>
    <content><![CDATA[<p>本文总结一下ggplot2包绘图的一些基本图形语法。</p>
<span id="more"></span>

<h3 id="1-ggplot2包的介绍"><a href="#1-ggplot2包的介绍" class="headerlink" title="1.ggplot2包的介绍"></a>1.ggplot2包的介绍</h3><p>在ggplot2中，图是采用+号函数创建并串联起来的，每个函数修改属于自己的部分。例如：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">ggplot<span class="punctuation">(</span>data<span class="operator">=</span>mtcars<span class="punctuation">,</span> aes<span class="punctuation">(</span>x<span class="operator">=</span>wt<span class="punctuation">,</span>y<span class="operator">=</span>mpg<span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">  geom_point<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  labs<span class="punctuation">(</span>title<span class="operator">=</span><span class="string">&quot;Automobile Data&quot;</span><span class="punctuation">,</span> x<span class="operator">=</span><span class="string">&quot;Weight&quot;</span><span class="punctuation">,</span> y<span class="operator">=</span><span class="string">&quot;Miles Per Gallon&quot;</span><span class="punctuation">)</span> <span class="operator">+</span> <span class="comment">#修改标题</span></span><br><span class="line">  theme<span class="punctuation">(</span>plot.title <span class="operator">=</span> element_text<span class="punctuation">(</span>hjust <span class="operator">=</span> <span class="number">0.5</span><span class="punctuation">)</span><span class="punctuation">)</span>    <span class="comment">#让标题居中</span></span><br></pre></td></tr></table></figure>

<p>基本元素：</p>
<ul>
<li>数据：作图用的数据集</li>
<li>几何图形 geom_:表示数据的几何形状，更多形状推荐<a href="https://ggplot2.tidyverse.org/reference/">这里</a><ul>
<li>点图、折线图、箱线图、小提琴图等等</li>
</ul>
</li>
<li>映射 aes(): 几何或者统计对象的映射<ul>
<li>x（x轴方向的位置）</li>
<li>y（y轴方向的位置）</li>
<li>color（点或者线等元素的颜色</li>
<li>size（点或者线等元素的大小）</li>
<li>shape（点或者线等元素的形状）</li>
<li>alpha（点或者线等元素的透明度）</li>
</ul>
</li>
<li>面 facet_: 数据图表的排列</li>
<li>标度 scale_(): 数据与美学维度之间的映射，比如图形宽度的数据范围</li>
<li>统计转换 stat_: 数据的统计，比如百分位，拟合曲线</li>
<li>坐标系统 coord_: 数据的转换</li>
<li>图层 layer：增加图层</li>
<li>主题 theme(): 图形的整体视觉默认值，如背景、网格、轴、默认字体、大小和颜色<br>ggplot默认至少需要前三样：数据、数据如何映射到美学aes()、几何图形geom_。</li>
</ul>
<h3 id="2-aes"><a href="#2-aes" class="headerlink" title="2. aes()"></a>2. aes()</h3><p>aes()函数是ggplot2中的映射函数, 所谓的映射即为数据集中的数据关联到相应的图形属性过程中一种对应关系。每个点都有自己图像上的属性，比如x坐标，y坐标，点的大小、颜色和形状，这些都叫做aesthetics，即图像上可观测到的属性，通过aes函数来赋值。</p>
<p><strong>关于aes(),ggplot2解释如下：</strong></p>
<blockquote>
<p>The aes argument stands for aesthetics. ggplot2 considers the X and Y axis of the plot to be aesthetics as well, along with color, size, shape, fill etc. If you want to have the color, size etc fixed (i.e. not vary based on a variable from the dataframe), you need to specify it outside the aes(), like this.</p>
</blockquote>
<p>即如果颜色是指定的，而不是根据数据值变化，那么需要将color参数下载aes()外面，如下：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line"><span class="operator">&gt;</span> ggplot<span class="punctuation">(</span>diamonds<span class="punctuation">,</span>aes<span class="punctuation">(</span>x<span class="operator">=</span>carat<span class="punctuation">,</span>color<span class="operator">=</span>color<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"><span class="operator">&gt;</span> ggplot<span class="punctuation">(</span>diamonds<span class="punctuation">,</span> aes<span class="punctuation">(</span>x<span class="operator">=</span>carat<span class="punctuation">)</span><span class="punctuation">,</span> color<span class="operator">=</span><span class="string">&quot;steelblue&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p>具体aes()如下图：<br><img src="/pics/2023-02-13-aes1.png" alt="alt 图标"><br>例如：<br><img src="/pics/2023-02-13-aes2.png" alt="alt 图标"></p>
<p><a href="https://bookdown.org/wangminjie/R4DS/tidyverse-ggplot2-stat-layer.html">图片来源</a></p>
<h3 id="3-facet分面"><a href="#3-facet分面" class="headerlink" title="3. facet分面"></a>3. facet分面</h3><p>分面设置在ggplot2应该也是要经常用到的一项画图内容，在数据对比以及分类显示上有着极为重要的作用。分组指的是在一个图形中显示两组或多组观察结果。 小面化指的是在单独、并排的图形上显示观察组。<br>facet_wrap和facet_grid不同在于facet_wrap是基于一个因子进行设置，facets表示形式为：~ 变量<br>而facet_grid是基于两个因子进行设置，facets表示形式为：变量 ~ 变量（行 ~ 列），如果把一个因子用点表示，也可以达到facet_wrap的效果，也可以用加号设置成两个以上变量<br>例如：变量+变量~变量 的形式，表示对三个变量设置分面。</p>
<h4 id="3-1-facet-wrap"><a href="#3-1-facet-wrap" class="headerlink" title="3.1 facet_wrap()"></a>3.1 facet_wrap()</h4><figure class="highlight r"><table><tr><td class="code"><pre><span class="line">facet_wrap<span class="punctuation">(</span>facets<span class="punctuation">,</span> nrow <span class="operator">=</span> <span class="literal">NULL</span><span class="punctuation">,</span> ncol <span class="operator">=</span> <span class="literal">NULL</span><span class="punctuation">,</span> scales <span class="operator">=</span> <span class="string">&quot;fixed&quot;</span><span class="punctuation">,</span> shrink <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">,</span> as.table <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">,</span> drop <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p>参数说明：</p>
<ul>
<li>nrow,ncol : 分面所设置成的行和列，参数为数值，表示几行或者几列</li>
<li>scales : 参数fixed表示固定坐标轴刻度，free表示反馈坐标轴刻度，也可以单独设置成free_x或free_y（把scales 设置成free之后，可以看出每个分面都有自己的坐标刻度，当然我们也可以单独对x轴或y轴设置）</li>
<li>shrink : 也和坐标轴刻度有关，如果为TRUE（默认值）则按统计后的数据调整刻度范围，否则按统计前的数据设定坐标</li>
<li>drop : 表示是否去掉没有数据的分组，默认情况下不显示，逻辑值为FALSE</li>
</ul>
<p><strong>实例：</strong><br>首先，将am、 vs和cyl变量转化为因子：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">mtcars<span class="operator">$</span>am <span class="operator">&lt;-</span> factor<span class="punctuation">(</span>mtcars<span class="operator">$</span>am<span class="punctuation">,</span> levels<span class="operator">=</span><span class="built_in">c</span><span class="punctuation">(</span><span class="number">0</span><span class="punctuation">,</span><span class="number">1</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">                   labels<span class="operator">=</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;Automatic&quot;</span><span class="punctuation">,</span><span class="string">&quot;Manual&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">mtcars<span class="operator">$</span>vs <span class="operator">&lt;-</span> factor<span class="punctuation">(</span>mtcars<span class="operator">$</span>vs<span class="punctuation">,</span> levels<span class="operator">=</span><span class="built_in">c</span><span class="punctuation">(</span><span class="number">0</span><span class="punctuation">,</span><span class="number">1</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">                   labels<span class="operator">=</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;V-Engine&quot;</span><span class="punctuation">,</span><span class="string">&quot;Straight Engine&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">mtcars<span class="operator">$</span>cyl <span class="operator">&lt;-</span> factor<span class="punctuation">(</span>mtcars<span class="operator">$</span>cyl<span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p>接下来，利用下面的代码绘图：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">ggplot<span class="punctuation">(</span>data<span class="operator">=</span>mtcars<span class="punctuation">,</span> aes<span class="punctuation">(</span>x<span class="operator">=</span>hp<span class="punctuation">,</span> y<span class="operator">=</span>mpg<span class="punctuation">,</span> shape<span class="operator">=</span>cyl<span class="punctuation">,</span> color<span class="operator">=</span>cyl<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">     geom_point<span class="punctuation">(</span>size<span class="operator">=</span><span class="number">3</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">     facet_wrap<span class="punctuation">(</span><span class="operator">~</span>vs<span class="punctuation">,</span>ncol<span class="operator">=</span><span class="number">1</span><span class="punctuation">,</span>scales<span class="operator">=</span><span class="string">&quot;free&quot;</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">     labs<span class="punctuation">(</span>title<span class="operator">=</span><span class="string">&quot;Automobiel Data by Engine Type&quot;</span><span class="punctuation">,</span></span><br><span class="line">          x<span class="operator">=</span><span class="string">&quot;Horsepower&quot;</span><span class="punctuation">,</span> y<span class="operator">=</span><span class="string">&quot;Miles Per Gallon&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><img src="/pics/2023-02-08-ggplot-facet1.png" alt="alt 图标"></p>
<h4 id="3-2-facet-grid"><a href="#3-2-facet-grid" class="headerlink" title="3.2 facet_grid()"></a>3.2 facet_grid()</h4><figure class="highlight r"><table><tr><td class="code"><pre><span class="line">facet_grid<span class="punctuation">(</span>facets<span class="punctuation">,</span> margins <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">,</span> scales <span class="operator">=</span> <span class="string">&quot;fixed&quot;</span><span class="punctuation">,</span> space <span class="operator">=</span> <span class="string">&quot;fixed&quot;</span><span class="punctuation">,</span> shrink <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">,</span> labeller <span class="operator">=</span> <span class="string">&quot;label_value&quot;</span><span class="punctuation">,</span> as.table <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">,</span> drop <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><strong>参数说明：</strong></p>
<ul>
<li>scales 、shrink、drop 同上</li>
<li>as.table ：和小图排列顺序有关的选项。如果为TRUE（默认）则按表格方式排列，即最大值（指分组level值）排在表格最后即右下角，否则排在左上角</li>
<li>margins ：通过TRUE或者FALSE表示否设置而一个总和的分面变量，默认情况为FALSE，即不设置</li>
<li>space ：表示分面空间是否可以按数据进行缩放，参数和scales一样</li>
</ul>
<p><strong>实例：</strong><br>利用下面的代码绘图：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">library<span class="punctuation">(</span>ggplot2<span class="punctuation">)</span></span><br><span class="line">ggplot<span class="punctuation">(</span>data<span class="operator">=</span>mtcars<span class="punctuation">,</span> aes<span class="punctuation">(</span>x<span class="operator">=</span>hp<span class="punctuation">,</span> y<span class="operator">=</span>mpg<span class="punctuation">,</span> shape<span class="operator">=</span>cyl<span class="punctuation">,</span> color<span class="operator">=</span>cyl<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line"> geom_point<span class="punctuation">(</span>size<span class="operator">=</span><span class="number">3</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line"> facet_grid<span class="punctuation">(</span>am<span class="operator">~</span>vs<span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line"> labs<span class="punctuation">(</span>title<span class="operator">=</span><span class="string">&quot;Automobiel Data by Engine Type&quot;</span><span class="punctuation">,</span></span><br><span class="line">      x<span class="operator">=</span><span class="string">&quot;Horsepower&quot;</span><span class="punctuation">,</span> y<span class="operator">=</span><span class="string">&quot;Miles Per Gallon&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><img src="/pics/2023-02-08-ggplot-facet.png" alt="alt 图标"></p>
<h3 id="4-刻度-scale-相关设置"><a href="#4-刻度-scale-相关设置" class="headerlink" title="4. 刻度 scale 相关设置"></a>4. 刻度 scale 相关设置</h3><p>scale_主要用于在ggplot画图之后对各个图层进行调整。</p>
<h4 id="4-1-相关属性设置"><a href="#4-1-相关属性设置" class="headerlink" title="4.1 相关属性设置"></a>4.1 相关属性设置</h4><p>包括scale_size()、scale_alpha()、scale_shape()。这三个设置主要对ggplot的图层属性进行相关设置，包括尺寸、透明度和形状。<br>以下列出该设置的主要参数：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">scale_xxx<span class="punctuation">(</span>name <span class="operator">=</span> waiver<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span> breaks <span class="operator">=</span> waiver<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span> labels <span class="operator">=</span> waiver<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span> limits <span class="operator">=</span> <span class="literal">NULL</span><span class="punctuation">,</span> <span class="built_in">range</span> <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">1</span><span class="punctuation">,</span> <span class="number">6</span><span class="punctuation">)</span><span class="punctuation">,</span>.....<span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p>由上面参数可以看出，我们可以对该属性进行，name命名，breaks设置组别，labels组别标签，limits限定坐标轴范围或组别排序，这几个参数在大多数scale设置中基本上都会用到。range设置尺寸大小范围（如点图的点），这个参数在其他设置中相对少见。</p>
<p><strong>scale_size</strong><br>下面提供些例子作为参考：以R自带的mtcars数据集作为样本</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">ggplot<span class="punctuation">(</span>data<span class="operator">=</span>mtcars<span class="punctuation">,</span> aes<span class="punctuation">(</span>x<span class="operator">=</span>hp<span class="punctuation">,</span> y<span class="operator">=</span>mpg<span class="punctuation">,</span>size<span class="operator">=</span>mpg<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">     geom_point<span class="punctuation">(</span><span class="punctuation">)</span> </span><br></pre></td></tr></table></figure>
<p><img src="/pics/2023-02-08-ggplot-scale1.png" alt="alt 图标"><br>修改size的图例为”size name”,同时使用limits将size进行限定，只有在limits设置范围内的数据会被保留。</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">ggplot<span class="punctuation">(</span>data<span class="operator">=</span>mtcars<span class="punctuation">,</span> aes<span class="punctuation">(</span>x<span class="operator">=</span>hp<span class="punctuation">,</span> y<span class="operator">=</span>mpg<span class="punctuation">,</span>size<span class="operator">=</span>mpg<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">     geom_point<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">     scale_size<span class="punctuation">(</span><span class="string">&quot;size name&quot;</span><span class="punctuation">,</span>limits <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">15</span><span class="punctuation">,</span><span class="number">30</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><img src="/pics/2023-02-08-ggplot-scale2.png" alt="alt 图标"><br>range参数通过缩放修改点的大小。</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">ggplot<span class="punctuation">(</span>data<span class="operator">=</span>mtcars<span class="punctuation">,</span> aes<span class="punctuation">(</span>x<span class="operator">=</span>hp<span class="punctuation">,</span> y<span class="operator">=</span>mpg<span class="punctuation">,</span>size<span class="operator">=</span>mpg<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">     geom_point<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">     scale_size<span class="punctuation">(</span><span class="string">&quot;size name&quot;</span><span class="punctuation">,</span>limits <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">15</span><span class="punctuation">,</span><span class="number">30</span><span class="punctuation">)</span><span class="punctuation">,</span><span class="built_in">range</span> <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">1</span><span class="punctuation">,</span><span class="number">3</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><img src="/pics/2023-02-08-ggplot-scale3.png" alt="alt 图标"></p>
<blockquote>
<p>limits设置是针对数据的范围进行裁剪，而range设置纯粹的针对点的大小。scale_size()基本只用于散点图，同时与之对应的还有一个scale_radius()是对点进行设置半径，相比较而言scale_radius()基本上很少用到。最后scale_size诸多设置也可以用scale_size_area()进行设置。</p>
</blockquote>
<p><strong>scale_alpha</strong><br>alpha调整点的透明度，scale_alpha与scale_alpha_continuous()等价，参数如下：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">scale_alpha<span class="punctuation">(</span>...<span class="punctuation">,</span> <span class="built_in">range</span> <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">0.1</span><span class="punctuation">,</span> <span class="number">1</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p>关于alpha参数的其他设置如name、breaks等归进continuous_scale()、binned_scale()、 discrete_scale()函数，区别在于alpha分组的变量是连续型（数值型）还是离散型（如文本类型）。</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">continuous_scale<span class="punctuation">(</span></span><br><span class="line">  aesthetics<span class="punctuation">,</span></span><br><span class="line">  scale_name<span class="punctuation">,</span></span><br><span class="line">  palette<span class="punctuation">,</span></span><br><span class="line">  name <span class="operator">=</span> waiver<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">  breaks <span class="operator">=</span> waiver<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">  minor_breaks <span class="operator">=</span> waiver<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">  n.breaks <span class="operator">=</span> <span class="literal">NULL</span><span class="punctuation">,</span></span><br><span class="line">  labels <span class="operator">=</span> waiver<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">  limits <span class="operator">=</span> <span class="literal">NULL</span><span class="punctuation">,</span></span><br><span class="line">  rescaler <span class="operator">=</span> rescale<span class="punctuation">,</span></span><br><span class="line">  oob <span class="operator">=</span> censor<span class="punctuation">,</span></span><br><span class="line">  expand <span class="operator">=</span> waiver<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">  na.value <span class="operator">=</span> <span class="literal">NA_real_</span><span class="punctuation">,</span></span><br><span class="line">  trans <span class="operator">=</span> <span class="string">&quot;identity&quot;</span><span class="punctuation">,</span></span><br><span class="line">  guide <span class="operator">=</span> <span class="string">&quot;legend&quot;</span><span class="punctuation">,</span></span><br><span class="line">  position <span class="operator">=</span> <span class="string">&quot;left&quot;</span><span class="punctuation">,</span></span><br><span class="line">  super <span class="operator">=</span> ScaleContinuous</span><br><span class="line"><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p>例如,连续型:</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">ggplot<span class="punctuation">(</span>data<span class="operator">=</span>mtcars<span class="punctuation">,</span> aes<span class="punctuation">(</span>x<span class="operator">=</span>hp<span class="punctuation">,</span> y<span class="operator">=</span>mpg<span class="punctuation">,</span>size<span class="operator">=</span>mpg<span class="punctuation">,</span>alpha<span class="operator">=</span>mpg<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">     geom_point<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">     scale_size<span class="punctuation">(</span><span class="string">&quot;size name&quot;</span><span class="punctuation">,</span>limits <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">15</span><span class="punctuation">,</span><span class="number">30</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">     scale_alpha<span class="punctuation">(</span><span class="built_in">range</span><span class="operator">=</span><span class="built_in">c</span><span class="punctuation">(</span><span class="number">0.1</span><span class="punctuation">,</span><span class="number">1</span><span class="punctuation">)</span><span class="punctuation">)</span> </span><br></pre></td></tr></table></figure>
<p><img src="/pics/2023-02-08-ggplot-scale4.png" alt="alt 图标"></p>
<p>离散型：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">ggplot<span class="punctuation">(</span>data<span class="operator">=</span>mtcars<span class="punctuation">,</span> aes<span class="punctuation">(</span>x<span class="operator">=</span>hp<span class="punctuation">,</span> y<span class="operator">=</span>mpg<span class="punctuation">,</span>size<span class="operator">=</span>mpg<span class="punctuation">,</span>alpha<span class="operator">=</span>am<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">     geom_point<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">     scale_size<span class="punctuation">(</span><span class="string">&quot;size name&quot;</span><span class="punctuation">,</span>limits <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">15</span><span class="punctuation">,</span><span class="number">30</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">     scale_alpha_discrete<span class="punctuation">(</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><img src="/pics/2023-02-08-ggplot-scale5.png" alt="alt 图标"></p>
<p><strong>scale_shape</strong><br>scale_shape只能用于离散型变量，例如：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">ggplot<span class="punctuation">(</span>data<span class="operator">=</span>mtcars<span class="punctuation">,</span> aes<span class="punctuation">(</span>x<span class="operator">=</span>hp<span class="punctuation">,</span> y<span class="operator">=</span>mpg<span class="punctuation">,</span>size<span class="operator">=</span>mpg<span class="punctuation">,</span>alpha<span class="operator">=</span>am<span class="punctuation">,</span>shape<span class="operator">=</span>am<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">     geom_point<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">     scale_size<span class="punctuation">(</span><span class="string">&quot;size name&quot;</span><span class="punctuation">,</span>limits <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">15</span><span class="punctuation">,</span><span class="number">30</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">     scale_alpha_discrete<span class="punctuation">(</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">     scale_shape<span class="punctuation">(</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><img src="/pics/2023-02-08-ggplot-scale6.png" alt="alt 图标"></p>
]]></content>
      <categories>
        <category>R</category>
        <category>ggplot2</category>
      </categories>
      <tags>
        <tag>R</tag>
        <tag>ggplot2</tag>
      </tags>
  </entry>
  <entry>
    <title>ggplot2集锦之三坐标系相关设置coord</title>
    <url>/2023/02/12/ggplot2%E9%9B%86%E9%94%A6%E4%B9%8B%E4%B8%89%E5%9D%90%E6%A0%87%E7%B3%BB%E7%9B%B8%E5%85%B3%E8%AE%BE%E7%BD%AEcoord/</url>
    <content><![CDATA[<p>这一篇介绍ggplot2中与坐标相关的设置。</p>
<span id="more"></span>

<h3 id="1-coord-catesian"><a href="#1-coord-catesian" class="headerlink" title="1. coord_catesian()"></a>1. coord_catesian()</h3><p>默认情况下使用scoord_cartesian这个坐标系。以下两个等价：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">p</span><br><span class="line">p <span class="operator">+</span> coord_cartesian<span class="punctuation">(</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><img src="/pics/2023-02-12-coord.png" alt="alt 图标"><br>参数：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">coord_cartesian<span class="punctuation">(</span></span><br><span class="line">  xlim <span class="operator">=</span> <span class="literal">NULL</span><span class="punctuation">,</span></span><br><span class="line">  ylim <span class="operator">=</span> <span class="literal">NULL</span><span class="punctuation">,</span></span><br><span class="line">  expand <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">,</span></span><br><span class="line">  default <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">,</span></span><br><span class="line">  clip <span class="operator">=</span> <span class="string">&quot;on&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p>xlim和ylim控制图片显示的区域范围，加上xlim和ylim之后,图如下：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">p<span class="operator">+</span>coord_cartesian<span class="punctuation">(</span>xlim <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">100</span><span class="punctuation">,</span><span class="number">150</span><span class="punctuation">)</span><span class="punctuation">,</span>ylim <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">20</span><span class="punctuation">,</span><span class="number">25</span><span class="punctuation">)</span><span class="punctuation">,</span>expand <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>注：coord_cartesian()的limits并不改变数据本身，只是相当于放大镜的作用，但是scale_x_continuous()中的limits会将指定范围之外的点全部变成NA，改变了原始数据，这样的话对数据进行统计时就会和原数据不一样。</p>
</blockquote>
<p><img src="/pics/2023-02-12-coord1.png" alt="alt 图标"></p>
<p>expand 为T则默认指定xlim轴两端还留一些空隙，F则控制范围即为图形的边缘。</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">p<span class="operator">+</span>coord_cartesian<span class="punctuation">(</span>xlim <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">100</span><span class="punctuation">,</span><span class="number">150</span><span class="punctuation">)</span><span class="punctuation">,</span>ylim <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">20</span><span class="punctuation">,</span><span class="number">25</span><span class="punctuation">)</span><span class="punctuation">,</span>expand <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><img src="/pics/2023-02-12-coord2.png" alt="alt 图标"></p>
<h3 id="2-coord-fixed"><a href="#2-coord-fixed" class="headerlink" title="2. coord_fixed()"></a>2. coord_fixed()</h3><p>coord_fixed()图形伸缩变换。</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">coord_fixed<span class="punctuation">(</span>ratio <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span> xlim <span class="operator">=</span> <span class="literal">NULL</span><span class="punctuation">,</span> ylim <span class="operator">=</span> <span class="literal">NULL</span><span class="punctuation">,</span> expand <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">,</span> clip <span class="operator">=</span> <span class="string">&quot;on&quot;</span><span class="punctuation">)</span> </span><br></pre></td></tr></table></figure>
<p>ratio值表示y&#x2F;x,即y周1单位是x周一单位的几倍，ratio越小，图形越扁。</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">p<span class="operator">+</span>coord_fixed<span class="punctuation">(</span>ratio<span class="operator">=</span><span class="number">1</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><img src="/pics/2023-02-12-coord3.jpg" alt="alt 图标"></p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">p<span class="operator">+</span>coord_fixed<span class="punctuation">(</span>ratio<span class="operator">=</span><span class="number">10</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><img src="/pics/2023-02-12-coord4.png" alt="alt 图标"></p>
<h3 id="3-coord-flip"><a href="#3-coord-flip" class="headerlink" title="3.coord_flip()"></a>3.coord_flip()</h3><p>横纵轴位置互换。</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">coord_flip<span class="punctuation">(</span>xlim <span class="operator">=</span> <span class="literal">NULL</span><span class="punctuation">,</span> ylim <span class="operator">=</span> <span class="literal">NULL</span><span class="punctuation">,</span> expand <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">p <span class="operator">+</span> coord_flip<span class="punctuation">(</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><img src="/pics/2023-02-12-coord5.png" alt="alt 图标"></p>
<h3 id="4-coord-trans"><a href="#4-coord-trans" class="headerlink" title="4. coord_trans()"></a>4. coord_trans()</h3><p>坐标形式转换：例如对数转换，平方根转换等等log10、log2、squal。</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">coord_trans<span class="punctuation">(</span></span><br><span class="line">  x <span class="operator">=</span> <span class="string">&quot;identity&quot;</span><span class="punctuation">,</span>y <span class="operator">=</span> <span class="string">&quot;identity&quot;</span><span class="punctuation">,</span></span><br><span class="line">  xlim <span class="operator">=</span> <span class="literal">NULL</span><span class="punctuation">,</span>ylim <span class="operator">=</span> <span class="literal">NULL</span><span class="punctuation">,</span></span><br><span class="line">  limx <span class="operator">=</span> deprecated<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span>limy <span class="operator">=</span> deprecated<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">  clip <span class="operator">=</span> <span class="string">&quot;on&quot;</span><span class="punctuation">,</span>expand <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p>转换前：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">p</span><br></pre></td></tr></table></figure>
<p><img src="/pics/2023-02-12-coord.png" alt="alt 图标"></p>
<p>转换后：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">p <span class="operator">+</span> coord_trans<span class="punctuation">(</span>x<span class="operator">=</span><span class="string">&quot;log2&quot;</span><span class="punctuation">,</span>y<span class="operator">=</span><span class="string">&quot;log2&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><img src="/pics/2023-02-12-coord6.png" alt="alt 图标"></p>
<p><strong>和scale_x_log的区别</strong></p>
<ul>
<li>后者等价于先将数据取对数，再拿进来处理，前者则是其他处理优先，最后作图时再取对数。</li>
</ul>
<ul>
<li>以拟合曲线为例：<br>如果用scale_x_log10就相当于把x的数据取了对数放进来做回归，拟合出一条直线。</li>
<li>如果使用coord_trans则是先用原有数据进行回归，得到一条拟合直线之后再变换坐标轴。</li>
</ul>
<h3 id="5-coord-equal"><a href="#5-coord-equal" class="headerlink" title="5. coord_equal()"></a>5. coord_equal()</h3><p>等坐标转换：使用这个函数后，x轴和y轴坐标会被转换成相等形式，此时图形会产生较大的缩放，radio可以进一步调整缩放比例（x和y的比值）。</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">p</span><br></pre></td></tr></table></figure>
<p><img src="/pics/2023-02-12-coord.png" alt="alt 图标"></p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">p <span class="operator">+</span> coord_equal<span class="punctuation">(</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><img src="/pics/2023-02-12-coord3.jpg" alt="alt 图标"></p>
<h3 id="6-coord-polar"><a href="#6-coord-polar" class="headerlink" title="6. coord_polar()"></a>6. coord_polar()</h3><p>进行极坐标转换，可以绘制饼图，参数方面theta可以选择x或y，表示外延的坐标，start是坐标开始的角度，默认其实位置是12点钟。direction 表示数据的方向，1是顺时针，-1为逆时针。</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">coord_polar<span class="punctuation">(</span>theta <span class="operator">=</span> <span class="string">&quot;x&quot;</span><span class="punctuation">,</span> start <span class="operator">=</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line"> direction <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span> clip <span class="operator">=</span> <span class="string">&quot;on&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p>theta&#x3D;”x”：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">p <span class="operator">+</span> coord_polar<span class="punctuation">(</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><img src="/pics/2023-02-12-coord8.png" alt="alt 图标"><br>theta&#x3D;”y”：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">p <span class="operator">+</span> coord_polar<span class="punctuation">(</span>theta<span class="operator">=</span><span class="string">&quot;y&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><img src="/pics/2023-02-12-coord7.png" alt="alt 图标"></p>
<p>饼图用theta&#x3D;”y”，两张图最外圈坐标的变化，是由theta参数的选择来决定的。</p>
<p>参考资料：</p>
<ol>
<li><a href="https://zhuanlan.zhihu.com/p/29553382">https://zhuanlan.zhihu.com/p/29553382</a></li>
</ol>
]]></content>
      <categories>
        <category>R</category>
        <category>ggplot2</category>
      </categories>
      <tags>
        <tag>R</tag>
        <tag>ggplot2</tag>
      </tags>
  </entry>
  <entry>
    <title>ggplot2集锦之四统计变换stat</title>
    <url>/2023/02/13/ggplot2%E9%9B%86%E9%94%A6%E4%B9%8B%E5%9B%9B%E7%BB%9F%E8%AE%A1%E5%8F%98%E6%8D%A2stat/</url>
    <content><![CDATA[<p>本文介绍ggplot2中stat_xxx()相关的设置。</p>
<span id="more"></span>

<p>使用ggplot2绘制图表时，涉及统计变换时，这时stat_xxx()函数就派上用场了。统计转换函数是在数据被绘制出来之前对数据进行聚合和其他计算。<br>常用的stat_xxx()函数有：stat_xxx()确定了数据的计算方法。因此，一个stat函数必须与一个geom()函数相对应才能进行计算。stat_与geom在一定程度上可以互换。<br>如图：<br><img src="/pics/2023-02-13-stat1.jpg" alt="alt 图标"><br>stat_smooth()、stat_bin()、stat_ecdf()、stat_count()、stat_density()、stat_function、stat_summray()等等。</p>
<h3 id="1-stat-summary"><a href="#1-stat-summary" class="headerlink" title="1. stat_summary()"></a>1. stat_summary()</h3><p>假定我们有一组数据，现在想画一个柱状图，一个柱子代表每一组group，柱子的高度代表的score的均值，这很容易搞定，但是如果我们想要加误差棒呢？我们需要再次整理数据，然后传递给ggplot，整合两个数据，一个用于绘制柱状图，一个用于绘制误差棒。</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">simple_data_bar <span class="operator">&lt;-</span> simple_data <span class="operator">%&gt;%</span></span><br><span class="line">  group_by<span class="punctuation">(</span>group<span class="punctuation">)</span> <span class="operator">%&gt;%</span> </span><br><span class="line">  summarize<span class="punctuation">(</span></span><br><span class="line">    mean_score <span class="operator">=</span> mean<span class="punctuation">(</span>score<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    .groups <span class="operator">=</span> <span class="string">&#x27;drop&#x27;</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">simple_data_errorbar <span class="operator">&lt;-</span> simple_data <span class="operator">%&gt;%</span> </span><br><span class="line">  group_by<span class="punctuation">(</span>group<span class="punctuation">)</span> <span class="operator">%&gt;%</span> </span><br><span class="line">  summarize<span class="punctuation">(</span></span><br><span class="line">    mean_score <span class="operator">=</span> mean<span class="punctuation">(</span>score<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    se <span class="operator">=</span> <span class="built_in">sqrt</span><span class="punctuation">(</span>var<span class="punctuation">(</span>score<span class="punctuation">)</span><span class="operator">/</span><span class="built_in">length</span><span class="punctuation">(</span>score<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    .groups <span class="operator">=</span> <span class="string">&#x27;drop&#x27;</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span> </span><br><span class="line">  mutate<span class="punctuation">(</span></span><br><span class="line">    lower <span class="operator">=</span> mean_score <span class="operator">-</span> se<span class="punctuation">,</span></span><br><span class="line">    upper <span class="operator">=</span> mean_score <span class="operator">+</span> se<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">ggplot<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  geom_col<span class="punctuation">(</span></span><br><span class="line">    aes<span class="punctuation">(</span>x <span class="operator">=</span> group<span class="punctuation">,</span> y <span class="operator">=</span> mean_score<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    data <span class="operator">=</span> simple_data_bar<span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  geom_errorbar<span class="punctuation">(</span></span><br><span class="line">    aes<span class="punctuation">(</span>x <span class="operator">=</span> group<span class="punctuation">,</span> y <span class="operator">=</span> mean_score<span class="punctuation">,</span> ymin <span class="operator">=</span> lower<span class="punctuation">,</span> ymax <span class="operator">=</span> upper<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    data <span class="operator">=</span> simple_data_errorbar<span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<p>如果使用stat_summary()函数，很简单就可以实现：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">simple_data <span class="operator">%&gt;%</span> </span><br><span class="line">  ggplot<span class="punctuation">(</span>aes<span class="punctuation">(</span>group<span class="punctuation">,</span> score<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  stat_summary<span class="punctuation">(</span>geom <span class="operator">=</span> <span class="string">&quot;bar&quot;</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  stat_summary<span class="punctuation">(</span>geom <span class="operator">=</span> <span class="string">&quot;errorbar&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<p>stat_**()函数可以将数据进行内部的统计转换，传递给ggplot()进行画图，因此不需要重新做一个dataframe，简单方便。</p>
<p>例如：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">ggplot<span class="punctuation">(</span>df<span class="punctuation">,</span>aes<span class="punctuation">(</span>x<span class="punctuation">,</span>y<span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line"> geom_point<span class="punctuation">(</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line"> stat_summary<span class="punctuation">(</span>fun <span class="operator">=</span> mean<span class="punctuation">,</span> geom <span class="operator">=</span> <span class="string">&quot;point&quot;</span><span class="punctuation">,</span> shape<span class="operator">=</span><span class="number">21</span><span class="punctuation">,</span>size<span class="operator">=</span><span class="number">3</span><span class="punctuation">,</span>fill<span class="operator">=</span><span class="string">&quot;white&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<p>上述例子里，stat_summary()对每一个x，计算y的均值，并在散点图上添加一个均值（白色点）。</p>
<p>stat_summary()适用的几何形状：geom_errorbar()、geom_pointrange()、geom_linerange()、geom_crossbar()、geom_point()。</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">ggplot<span class="punctuation">(</span>iris<span class="punctuation">,</span>aes<span class="punctuation">(</span>x<span class="operator">=</span>Species<span class="punctuation">,</span>y<span class="operator">=</span>Sepal.Length<span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line"> geom_errorbar<span class="punctuation">(</span>stat <span class="operator">=</span> <span class="string">&quot;summary&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">ggplot<span class="punctuation">(</span>iris<span class="punctuation">,</span>aes<span class="punctuation">(</span>x<span class="operator">=</span>Species<span class="punctuation">,</span>y<span class="operator">=</span>Sepal.Length<span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line"> stat_summary<span class="punctuation">(</span>geom <span class="operator">=</span> <span class="string">&quot;bar&quot;</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line"> stat_summary<span class="punctuation">(</span>geom <span class="operator">=</span> <span class="string">&quot;errorbar&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p>stat_summary()中函数可以是自定义函数。例如：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">my_fun <span class="operator">&lt;-</span> <span class="keyword">function</span><span class="punctuation">(</span>x<span class="punctuation">)</span><span class="punctuation">&#123;</span></span><br><span class="line">  tibble<span class="punctuation">(</span>y<span class="operator">=</span><span class="built_in">length</span><span class="punctuation">(</span>x<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">ggplot<span class="punctuation">(</span>iris<span class="punctuation">,</span>aes<span class="punctuation">(</span>x<span class="operator">=</span>Species<span class="punctuation">,</span>y<span class="operator">=</span>Sepal.Length<span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line"> geom_bar<span class="punctuation">(</span>stat <span class="operator">=</span> <span class="string">&quot;summary&quot;</span><span class="punctuation">,</span>fun.data <span class="operator">=</span> my_fun<span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<p>stat_summary()也可以添加文本，geom换成text即可。</p>
<h3 id="2-stat-smooth"><a href="#2-stat-smooth" class="headerlink" title="2. stat_smooth()"></a>2. stat_smooth()</h3><p>stat_summary()函数用于（为scatter plot）生成拟合曲线。例如，生成回归曲线,se&#x3D;FALSE生成的图片不包含置信区间。<br>适用几何形状：geom_smmooth、geom_line()、geom_point()。</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">ggplot<span class="punctuation">(</span>mtcars<span class="punctuation">,</span>aes<span class="punctuation">(</span>x<span class="operator">=</span>mpg<span class="punctuation">,</span>y<span class="operator">=</span>disp<span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line"> geom_point<span class="punctuation">(</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line"> stat_smooth<span class="punctuation">(</span>method<span class="operator">=</span><span class="string">&quot;lm&quot;</span><span class="punctuation">,</span>se<span class="operator">=</span><span class="literal">FALSE</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<h3 id="3-stat-bin"><a href="#3-stat-bin" class="headerlink" title="3. stat_bin()"></a>3. stat_bin()</h3><p>stat_bin()函数对x根据每个bin进行计数。适用的几何形状：geom_bar()、geom_histogram()、geom_freqpoly()。</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">ggplot<span class="punctuation">(</span>mtcars<span class="punctuation">,</span>aes<span class="punctuation">(</span>x<span class="operator">=</span>mpg<span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line"> geom_histogram<span class="punctuation">(</span>stat<span class="operator">=</span><span class="string">&quot;bin&quot;</span><span class="punctuation">,</span>binwidth<span class="operator">=</span><span class="number">1</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">ggplot<span class="punctuation">(</span>mtcars<span class="punctuation">,</span>aes<span class="punctuation">(</span>x<span class="operator">=</span>mpg<span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line"> stat_bin<span class="punctuation">(</span>geom <span class="operator">=</span> <span class="string">&quot;bar&quot;</span><span class="punctuation">,</span>binwidth <span class="operator">=</span> <span class="number">1</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<p>上述两个得到的图是一样的。<br><img src="/pics/2023-04-03-stat-bin.png" alt="alt 图标"></p>
<h3 id="4-stat-density"><a href="#4-stat-density" class="headerlink" title="4. stat_density()"></a>4. stat_density()</h3><p>stat_density()对一个连续的变量，生成一个density plot。</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">ggplot<span class="punctuation">(</span>mtcars<span class="punctuation">,</span>aes<span class="punctuation">(</span>mpg<span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line"> geom_density<span class="punctuation">(</span>fill<span class="operator">=</span><span class="string">&quot;lightblue&quot;</span><span class="punctuation">,</span>alpha<span class="operator">=</span><span class="number">0.5</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line"> geom_vline<span class="punctuation">(</span>aes<span class="punctuation">(</span>xintercept<span class="operator">=</span>mean<span class="punctuation">(</span>mpg<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">,</span>color<span class="operator">=</span><span class="string">&quot;red&quot;</span><span class="punctuation">,</span>linetype<span class="operator">=</span><span class="string">&quot;dashed&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><img src="/pics/2023-04-03-stat-density.png" alt="alt 图标"></p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">ggplot<span class="punctuation">(</span>mtcars<span class="punctuation">,</span>aes<span class="punctuation">(</span>mpg<span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line"> stat_density<span class="punctuation">(</span>fill<span class="operator">=</span><span class="string">&quot;lightblue&quot;</span><span class="punctuation">,</span>alpha<span class="operator">=</span><span class="number">0.5</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><img src="/pics/2023-04-03-stat-density2.png" alt="alt 图标"></p>
<h3 id="5-stat-ecdf"><a href="#5-stat-ecdf" class="headerlink" title="5.stat_ecdf()"></a>5.stat_ecdf()</h3><p>stat_scdf()函数生成一个概率密度分布图。</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">ggplot<span class="punctuation">(</span>mtcars<span class="punctuation">,</span>aes<span class="punctuation">(</span>mpg<span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line"> stat_ecdf<span class="punctuation">(</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><img src="/pics/2023-04-03-stat-ecdf.png" alt="alt 图标"></p>
<h3 id="6-stat-count"><a href="#6-stat-count" class="headerlink" title="6. stat_count()"></a>6. stat_count()</h3><p>state_identity()，表示映射值和data的值一样。<br>而stat_count()表示对data中的某个变量进行计数，stat_count()适用的几何形状：geom_point()、geom_bar()</p>
<p>例如，下面两个等价：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">ggplot<span class="punctuation">(</span>iris<span class="punctuation">,</span>aes<span class="punctuation">(</span>Species<span class="punctuation">,</span>after_stat<span class="punctuation">(</span>count<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line"> stat_count<span class="punctuation">(</span>geom<span class="operator">=</span><span class="string">&quot;bar&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">ggplot<span class="punctuation">(</span>iris<span class="punctuation">,</span>aes<span class="punctuation">(</span>Species<span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line"> stat_count<span class="punctuation">(</span>geom<span class="operator">=</span><span class="string">&quot;bar&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">ggplot<span class="punctuation">(</span>iris<span class="punctuation">,</span>aes<span class="punctuation">(</span>Species<span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line"> geom_bar<span class="punctuation">(</span>stat <span class="operator">=</span> <span class="string">&quot;count&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">ggplot<span class="punctuation">(</span>iris<span class="punctuation">,</span>aes<span class="punctuation">(</span>Species<span class="punctuation">,</span>after_stat<span class="punctuation">(</span>count<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line"> stat_count<span class="punctuation">(</span>geom <span class="operator">=</span> <span class="string">&quot;point&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">ggplot<span class="punctuation">(</span>iris<span class="punctuation">,</span>aes<span class="punctuation">(</span>Specie<span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line"> stat_count<span class="punctuation">(</span>geom <span class="operator">=</span> <span class="string">&quot;point&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">ggplot<span class="punctuation">(</span>iris<span class="punctuation">,</span>aes<span class="punctuation">(</span>Species<span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line"> geom_point<span class="punctuation">(</span>stat <span class="operator">=</span> <span class="string">&quot;count&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<h3 id="7-stat-density"><a href="#7-stat-density" class="headerlink" title="7. stat_density()"></a>7. stat_density()</h3><p>可以看做是直方图count计数的平滑版本。</p>
<p>适用几何形状：geom_area()、geom_line()、geom_point()、geom_density()。</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">ggplot<span class="punctuation">(</span>iris<span class="punctuation">,</span>aes<span class="punctuation">(</span>Sepal.Length<span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line"> stat_density<span class="punctuation">(</span>geom <span class="operator">=</span> <span class="string">&quot;area&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">ggplot<span class="punctuation">(</span>iris<span class="punctuation">,</span>aes<span class="punctuation">(</span>Sepal.Length<span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line"> geom_area<span class="punctuation">(</span>stat <span class="operator">=</span> <span class="string">&quot;density&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">ggplot<span class="punctuation">(</span>iris<span class="punctuation">,</span>aes<span class="punctuation">(</span>Sepal.Length<span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line"> stat_density<span class="punctuation">(</span>geom <span class="operator">=</span> <span class="string">&quot;line&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">ggplot<span class="punctuation">(</span>iris<span class="punctuation">,</span>aes<span class="punctuation">(</span>Sepal.Length<span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line"> geom_line<span class="punctuation">(</span>stat <span class="operator">=</span> <span class="string">&quot;density&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">ggplot<span class="punctuation">(</span>iris<span class="punctuation">,</span>aes<span class="punctuation">(</span>Sepal.Length<span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line"> stat_density<span class="punctuation">(</span>geom <span class="operator">=</span> <span class="string">&quot;point&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">ggplot<span class="punctuation">(</span>iris<span class="punctuation">,</span>aes<span class="punctuation">(</span>Sepal.Length<span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line"> geom_point<span class="punctuation">(</span>stat <span class="operator">=</span> <span class="string">&quot;density&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">ggplot<span class="punctuation">(</span>iris<span class="punctuation">,</span>aes<span class="punctuation">(</span>Sepal.Length<span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line"> geom_density<span class="punctuation">(</span>stat <span class="operator">=</span> <span class="string">&quot;density&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<h3 id="8-stat-boxplot"><a href="#8-stat-boxplot" class="headerlink" title="8. stat_boxplot()"></a>8. stat_boxplot()</h3><p>默认几何形状：boxplot()</p>
<p>适用几何形状：geom_boxplot()、geom_point()。</p>
<p>如下，boxplot()括号中的都可以省略。</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">ggplot<span class="punctuation">(</span>iris<span class="punctuation">,</span>aes<span class="punctuation">(</span>Species<span class="punctuation">,</span>Sepal.Length<span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line"> geom_boxplot<span class="punctuation">(</span>stat <span class="operator">=</span> <span class="string">&quot;boxplot&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">ggplot<span class="punctuation">(</span>iris<span class="punctuation">,</span>aes<span class="punctuation">(</span>Species<span class="punctuation">,</span>Sepal.Length<span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line"> stat_boxplot<span class="punctuation">(</span>geom <span class="operator">=</span> <span class="string">&quot;boxplot&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">ggplot<span class="punctuation">(</span>iris<span class="punctuation">,</span>aes<span class="punctuation">(</span>Species<span class="punctuation">,</span>Sepal.Length<span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line"> stat_point<span class="punctuation">(</span>geom <span class="operator">=</span> <span class="string">&quot;boxplot&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<h3 id="9-stat-ydensity"><a href="#9-stat-ydensity" class="headerlink" title="9. stat_ydensity()"></a>9. stat_ydensity()</h3><p>boxplot的密度图呈现。默认几何形状：geom_violin()；<br>适用几何形状：geom_violin()、geom_point()。</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">ggplot<span class="punctuation">(</span>iris<span class="punctuation">,</span>aes<span class="punctuation">(</span>Species<span class="punctuation">,</span>Sepal.Length<span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line"> stat_ydensity<span class="punctuation">(</span>geom <span class="operator">=</span> <span class="string">&quot;violin&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">ggplot<span class="punctuation">(</span>iris<span class="punctuation">,</span>aes<span class="punctuation">(</span>Species<span class="punctuation">,</span>Sepal.Length<span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line"> geom_violin<span class="punctuation">(</span>stat <span class="operator">=</span> <span class="string">&quot;ydensity&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">ggplot<span class="punctuation">(</span>iris<span class="punctuation">,</span>aes<span class="punctuation">(</span>Species<span class="punctuation">,</span>Sepal.Length<span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line"> stat_ydensity<span class="punctuation">(</span>geom <span class="operator">=</span> <span class="string">&quot;point&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">ggplot<span class="punctuation">(</span>iris<span class="punctuation">,</span>aes<span class="punctuation">(</span>Species<span class="punctuation">,</span>Sepal.Length<span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line"> geom_point<span class="punctuation">(</span>stat <span class="operator">=</span> <span class="string">&quot;ydensity&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<h3 id="10-stat-bindot"><a href="#10-stat-bindot" class="headerlink" title="10. stat_bindot()"></a>10. stat_bindot()</h3><p>适用几何形状：geom_dotplot()。</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">ggplot<span class="punctuation">(</span>iris<span class="punctuation">,</span>aes<span class="punctuation">(</span>Sepal.Length<span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line"> geom_dotplot<span class="punctuation">(</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<h3 id="11-stat-bin-2d"><a href="#11-stat-bin-2d" class="headerlink" title="11. stat_bin_2d()"></a>11. stat_bin_2d()</h3><p>统计落在x和y区域（长方形）上点的个数。<br>适用几何形状：geom_tile()、geom_point()、geom_bin2d()。</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">ggplot<span class="punctuation">(</span>iris<span class="punctuation">,</span>aes<span class="punctuation">(</span>Sepal.Length<span class="punctuation">,</span>Sepal.Width<span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line"> geom_tile<span class="punctuation">(</span>stat<span class="operator">=</span><span class="string">&quot;bin_2d&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">ggplot<span class="punctuation">(</span>iris<span class="punctuation">,</span>aes<span class="punctuation">(</span>Sepal.Length<span class="punctuation">,</span>Sepal.Width<span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line"> geom_point<span class="punctuation">(</span>stat<span class="operator">=</span><span class="string">&quot;bin_2d&quot;</span><span class="punctuation">,</span>position<span class="operator">=</span><span class="string">&quot;identity&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<h3 id="12-stat-bin-hex"><a href="#12-stat-bin-hex" class="headerlink" title="12. stat_bin_hex()"></a>12. stat_bin_hex()</h3><p>stat_bin_2d的六边形版本。适用几何形状：geom_hex()。</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">ggplot<span class="punctuation">(</span>iris<span class="punctuation">,</span>aes<span class="punctuation">(</span>Sepal.Length<span class="punctuation">,</span>Sepal.Width<span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line"> geom_hex<span class="punctuation">(</span>stat<span class="operator">=</span><span class="string">&quot;binhex&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">ggplot<span class="punctuation">(</span>iris<span class="punctuation">,</span>aes<span class="punctuation">(</span>Sepal.Length<span class="punctuation">,</span>Sepal.Width<span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line"> stat_bin_hex<span class="punctuation">(</span>geom <span class="operator">=</span> <span class="string">&quot;hex&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<h3 id="13-stat-density-2d"><a href="#13-stat-density-2d" class="headerlink" title="13. stat_density_2d()"></a>13. stat_density_2d()</h3><p>二维核密度估计，二维版本的stat_density()。<br>适用几何形状：geom_density_2d()、geom_raster()、geom_tile()、geom_path()、geom_point()、geom_polygon()。</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">ggplot<span class="punctuation">(</span>iris<span class="punctuation">,</span>aes<span class="punctuation">(</span>Sepal.Length<span class="punctuation">,</span>Sepal.Width<span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line"> geom_density2d<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">ggplot<span class="punctuation">(</span>iris<span class="punctuation">,</span>aes<span class="punctuation">(</span>Sepal.Length<span class="punctuation">,</span>Sepal.Width<span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line"> stat_density2d<span class="punctuation">(</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p>绘制出的图形为等高线。</p>
<h3 id="14-stat-ellipse"><a href="#14-stat-ellipse" class="headerlink" title="14. stat_ellipse()"></a>14. stat_ellipse()</h3><p>假定数据服从多元分布，计算椭圆图形需要的参数。<br>适用几何形状：geom_path()。</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">ggplot<span class="punctuation">(</span>iris<span class="punctuation">,</span>aes<span class="punctuation">(</span>x<span class="operator">=</span>Sepal.Length<span class="punctuation">,</span>y<span class="operator">=</span>Sepal.Width<span class="punctuation">,</span>color<span class="operator">=</span>Species<span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line"> geom_point<span class="punctuation">(</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line"> geom_path<span class="punctuation">(</span>stat <span class="operator">=</span> <span class="string">&quot;ellipse&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">ggplot<span class="punctuation">(</span>iris<span class="punctuation">,</span>aes<span class="punctuation">(</span>x<span class="operator">=</span>Sepal.Length<span class="punctuation">,</span>y<span class="operator">=</span>Sepal.Width<span class="punctuation">,</span>color<span class="operator">=</span>Species<span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line"> geom_point<span class="punctuation">(</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line"> stat_ellipse<span class="punctuation">(</span>geom <span class="operator">=</span> <span class="string">&quot;path&quot;</span><span class="punctuation">,</span>linetype<span class="operator">=</span><span class="number">2</span><span class="punctuation">,</span>type<span class="operator">=</span><span class="string">&quot;norm&quot;</span><span class="punctuation">,</span>level<span class="operator">=</span><span class="number">0.95</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><img src="/pics/2023-04-03-stat_ellipse.png" alt="alt 图标"></p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">iris <span class="operator">%&gt;%</span></span><br><span class="line">  ggplot<span class="punctuation">(</span>aes<span class="punctuation">(</span>x <span class="operator">=</span> Sepal.Length<span class="punctuation">,</span> y <span class="operator">=</span> Sepal.Width<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  geom_point<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  purrr<span class="operator">::</span>map<span class="punctuation">(</span></span><br><span class="line">    .x <span class="operator">=</span> seq<span class="punctuation">(</span><span class="number">0.1</span><span class="punctuation">,</span> <span class="number">0.9</span><span class="punctuation">,</span> by  <span class="operator">=</span> <span class="number">0.1</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    .f <span class="operator">=</span> <span class="keyword">function</span><span class="punctuation">(</span>level<span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">      stat_ellipse<span class="punctuation">(</span></span><br><span class="line">        geom <span class="operator">=</span> <span class="string">&quot;polygon&quot;</span><span class="punctuation">,</span> type <span class="operator">=</span> <span class="string">&quot;norm&quot;</span><span class="punctuation">,</span></span><br><span class="line">        size <span class="operator">=</span> <span class="number">0</span><span class="punctuation">,</span> alpha <span class="operator">=</span> <span class="number">0.1</span><span class="punctuation">,</span> fill <span class="operator">=</span> <span class="string">&quot;gray10&quot;</span><span class="punctuation">,</span></span><br><span class="line">        level <span class="operator">=</span> level</span><br><span class="line">      <span class="punctuation">)</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><img src="/pics/2023-04-03-stat_ellipse2.png" alt="alt 图标"></p>
<p>还有好多stat函数，如：stat_function()、stat_spoke()、stat_quantile()、stat_summary_2d()、stat_summary_hex()、stat_contour()、stat_contour_filled()。</p>
]]></content>
      <categories>
        <category>R</category>
        <category>ggplot2</category>
      </categories>
      <tags>
        <tag>R</tag>
        <tag>ggplot2</tag>
      </tags>
  </entry>
  <entry>
    <title>ggplot2集锦之五theme</title>
    <url>/2023/04/03/ggplot2%E9%9B%86%E9%94%A6%E4%B9%8B%E4%BA%94theme/</url>
    <content><![CDATA[<p>本文总结一下ggplot2包绘图时主题的美化。</p>
<span id="more"></span>

<h3 id="1-theme主题"><a href="#1-theme主题" class="headerlink" title="1.theme主题"></a>1.theme主题</h3><p>ggplot2有一些自带的常用的主题，如图：theme_bw()、默认背景theme_grey()、theme_linedraw()、theme_light()、theme_mininal()、theme_classic()、theme_void()。<br><img src="/pics/2023-04-03-theme.jpg" alt="alt 图标"></p>
<p>theme也可以自定义。可以将自己喜欢的theme()部分保存为变量，重复调用。</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">mytheme <span class="operator">&lt;-</span> theme<span class="punctuation">(</span>...<span class="punctuation">)</span></span><br><span class="line">ggplot<span class="punctuation">(</span>...<span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line"> mytheme</span><br></pre></td></tr></table></figure>

<p>常见的四种类型：<br>element_text()，对文本进行设置，如title、subtitle等。<br>element_line()，对线进行设置，如轴线、主网格线、次网格线等等。<br>element_rect()，修改基于矩形的组件，如绘图区域和面板区域的背景。<br>element_blank()，不绘制任何东西，并关闭相关的内容设置。</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">ggplot变量<span class="operator">+</span>theme<span class="punctuation">(</span>组件<span class="operator">=</span>element_功能<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<p>例：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">data<span class="punctuation">(</span>diamonds<span class="punctuation">)</span></span><br><span class="line">set.seed<span class="punctuation">(</span><span class="number">1234</span><span class="punctuation">)</span></span><br><span class="line">diamond <span class="operator">&lt;-</span> diamonds<span class="punctuation">[</span>sample<span class="punctuation">(</span>nrow<span class="punctuation">(</span>diamonds<span class="punctuation">)</span><span class="punctuation">,</span> <span class="number">2000</span><span class="punctuation">)</span><span class="punctuation">,</span> <span class="punctuation">]</span></span><br><span class="line">p <span class="operator">&lt;-</span> ggplot<span class="punctuation">(</span>data <span class="operator">=</span> diamond<span class="punctuation">)</span> <span class="operator">+</span>geom_point<span class="punctuation">(</span>aes<span class="punctuation">(</span>x<span class="operator">=</span>carat<span class="punctuation">,</span> y<span class="operator">=</span>price<span class="punctuation">,</span> colour<span class="operator">=</span>color<span class="punctuation">,</span>shape<span class="operator">=</span>cut<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span> labs<span class="punctuation">(</span>title<span class="operator">=</span><span class="string">&quot;TITLE&quot;</span><span class="punctuation">,</span>subtitle <span class="operator">=</span> <span class="string">&quot;SUBTITLE&quot;</span><span class="punctuation">,</span>caption <span class="operator">=</span> <span class="string">&quot;CAPTION&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><img src="/pics/2023-04-03-theme1.png" alt="alt 图标"></p>
<p>theme()函数内容：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">theme<span class="punctuation">(</span></span><br><span class="line">  line<span class="punctuation">,</span>rect<span class="punctuation">,</span>text<span class="punctuation">,</span>title<span class="punctuation">,</span></span><br><span class="line">  aspect.ratio<span class="punctuation">,</span></span><br><span class="line">  axis.title<span class="punctuation">,</span>axis.title.x<span class="punctuation">,</span>axis.title.x.top<span class="punctuation">,</span>axis.title.x.bottom<span class="punctuation">,</span></span><br><span class="line">  axis.title.y<span class="punctuation">,</span>axis.title.y.left<span class="punctuation">,</span>axis.title.y.right<span class="punctuation">,</span></span><br><span class="line">  axis.text<span class="punctuation">,</span>axis.text.x<span class="punctuation">,</span>axis.text.x.top<span class="punctuation">,</span>axis.text.x.bottom<span class="punctuation">,</span></span><br><span class="line">  axis.text.y<span class="punctuation">,</span>axis.text.y.left<span class="punctuation">,</span>axis.text.y.right<span class="punctuation">,</span></span><br><span class="line">  axis.ticks<span class="punctuation">,</span></span><br><span class="line">  axis.ticks.x<span class="punctuation">,</span>axis.ticks.x.top<span class="punctuation">,</span>axis.ticks.x.bottom<span class="punctuation">,</span></span><br><span class="line">  axis.ticks.y<span class="punctuation">,</span>axis.ticks.y.left<span class="punctuation">,</span>axis.ticks.y.right<span class="punctuation">,</span></span><br><span class="line">  axis.ticks.length<span class="punctuation">,</span></span><br><span class="line">  axis.ticks.length.x<span class="punctuation">,</span>axis.ticks.length.x.top<span class="punctuation">,</span>axis.ticks.length.x.bottom<span class="punctuation">,</span></span><br><span class="line">  axis.ticks.length.y<span class="punctuation">,</span>axis.ticks.length.y.left<span class="punctuation">,</span>axis.ticks.length.y.right<span class="punctuation">,</span></span><br><span class="line">  axis.line<span class="punctuation">,</span></span><br><span class="line">  axis.line.x<span class="punctuation">,</span>axis.line.x.top<span class="punctuation">,</span>axis.line.x.bottom<span class="punctuation">,</span></span><br><span class="line">  axis.line.y<span class="punctuation">,</span>axis.line.y.left<span class="punctuation">,</span>axis.line.y.right<span class="punctuation">,</span></span><br><span class="line">  legend.background<span class="punctuation">,</span></span><br><span class="line">  legend.margin<span class="punctuation">,</span></span><br><span class="line">  legend.spacing<span class="punctuation">,</span>legend.spacing.x<span class="punctuation">,</span>legend.spacing.y<span class="punctuation">,</span></span><br><span class="line">  legend.key<span class="punctuation">,</span>legend.key.size<span class="punctuation">,</span>legend.key.height<span class="punctuation">,</span>legend.key.width<span class="punctuation">,</span></span><br><span class="line">  legend.text<span class="punctuation">,</span>legend.text.align<span class="punctuation">,</span></span><br><span class="line">  legend.title<span class="punctuation">,</span>legend.title.align<span class="punctuation">,</span></span><br><span class="line">  legend.position<span class="punctuation">,</span></span><br><span class="line">  legend.direction<span class="punctuation">,</span></span><br><span class="line">  legend.justification<span class="punctuation">,</span></span><br><span class="line">  legend.box<span class="punctuation">,</span></span><br><span class="line">  legend.box.just<span class="punctuation">,</span>legend.box.margin<span class="punctuation">,</span>legend.box.background<span class="punctuation">,</span>legend.box.spacing<span class="punctuation">,</span></span><br><span class="line">  panel.background<span class="punctuation">,</span>panel.border<span class="punctuation">,</span></span><br><span class="line">  panel.spacing<span class="punctuation">,</span>panel.spacing.x<span class="punctuation">,</span>panel.spacing.y<span class="punctuation">,</span></span><br><span class="line">  panel.grid<span class="punctuation">,</span></span><br><span class="line">  panel.grid.major<span class="punctuation">,</span>panel.grid.major.x<span class="punctuation">,</span>panel.grid.major.y<span class="punctuation">,</span></span><br><span class="line">  panel.grid.minor<span class="punctuation">,</span>panel.grid.minor.x<span class="punctuation">,</span>panel.grid.minor.y<span class="punctuation">,</span></span><br><span class="line">  panel.ontop<span class="punctuation">,</span></span><br><span class="line">  plot.background<span class="punctuation">,</span></span><br><span class="line">  plot.title<span class="punctuation">,</span>plot.title.position<span class="punctuation">,</span></span><br><span class="line">  plot.subtitle<span class="punctuation">,</span></span><br><span class="line">  plot.caption<span class="punctuation">,</span>plot.caption.position<span class="punctuation">,</span></span><br><span class="line">  plot.tag<span class="punctuation">,</span></span><br><span class="line">  plot.tag.position<span class="punctuation">,</span></span><br><span class="line">  plot.margin<span class="punctuation">,</span></span><br><span class="line">  strip.background<span class="punctuation">,</span>strip.background.x<span class="punctuation">,</span>strip.background.y<span class="punctuation">,</span></span><br><span class="line">  strip.clip<span class="punctuation">,</span></span><br><span class="line">  strip.placement<span class="punctuation">,</span></span><br><span class="line">  strip.text<span class="punctuation">,</span>strip.text.x<span class="punctuation">,</span>strip.text.y<span class="punctuation">,</span></span><br><span class="line">  strip.switch.pad.grid<span class="punctuation">,</span></span><br><span class="line">  strip.switch.pad.wrap<span class="punctuation">,</span></span><br><span class="line">  ...<span class="punctuation">,</span></span><br><span class="line">  complete <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">,</span></span><br><span class="line">  validate <span class="operator">=</span> <span class="literal">TRUE</span></span><br><span class="line"><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<h3 id="2-修改背景、标题，坐标轴"><a href="#2-修改背景、标题，坐标轴" class="headerlink" title="2. 修改背景、标题，坐标轴"></a>2. 修改背景、标题，坐标轴</h3><h4 id="2-1-图像组件"><a href="#2-1-图像组件" class="headerlink" title="2.1 图像组件"></a>2.1 图像组件</h4><table>
<thead>
<tr>
<th align="center">组件</th>
<th align="center">对应的element功能</th>
<th align="center">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="center">plot.title</td>
<td align="center">element_rect()</td>
<td align="center">图像标题</td>
</tr>
<tr>
<td align="center">plot.background</td>
<td align="center">element_text()</td>
<td align="center">图像背景</td>
</tr>
<tr>
<td align="center">plot.margin</td>
<td align="center">margin()</td>
<td align="center">图像边距</td>
</tr>
</tbody></table>
<p>plot.background&#x3D;element_rect(fill &#x3D; NA)可以将背景矩形设为透明。</p>
<h4 id="2-2-标题组件"><a href="#2-2-标题组件" class="headerlink" title="2.2 标题组件"></a>2.2 标题组件</h4><table>
<thead>
<tr>
<th align="center">组件</th>
<th align="center">对应的element功能</th>
<th align="center">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="center">plot.title</td>
<td align="center">element_text()</td>
<td align="center">图片标题</td>
</tr>
<tr>
<td align="center">plot.subtitle</td>
<td align="center">element_text()</td>
<td align="center">图片副标题</td>
</tr>
<tr>
<td align="center">plot.caption</td>
<td align="center">elemnet_text()</td>
<td align="center">图片caption</td>
</tr>
</tbody></table>
<h4 id="2-3-坐标轴组件"><a href="#2-3-坐标轴组件" class="headerlink" title="2.3 坐标轴组件"></a>2.3 坐标轴组件</h4><table>
<thead>
<tr>
<th align="center">组件</th>
<th align="center">对应的element功能</th>
<th align="center">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="center">axis.title</td>
<td align="center">element_text()</td>
<td align="center">坐标轴标题</td>
</tr>
<tr>
<td align="center">axis.title.x</td>
<td align="center">element_text()</td>
<td align="center">x轴标题</td>
</tr>
<tr>
<td align="center">axis.title.y</td>
<td align="center">element_text()</td>
<td align="center">y轴标题</td>
</tr>
<tr>
<td align="center">axis.text</td>
<td align="center">element_text()</td>
<td align="center">坐标轴文本</td>
</tr>
<tr>
<td align="center">axis.text.x</td>
<td align="center">element_text()</td>
<td align="center">x轴文本</td>
</tr>
<tr>
<td align="center">axis.text.y</td>
<td align="center">element_text()</td>
<td align="center">y轴文本</td>
</tr>
<tr>
<td align="center">axis.ticks</td>
<td align="center">element_text()</td>
<td align="center">轴须</td>
</tr>
<tr>
<td align="center">axis.ticks.x</td>
<td align="center">element_text()</td>
<td align="center">x轴轴须</td>
</tr>
<tr>
<td align="center">axis.ticks.y</td>
<td align="center">element_text()</td>
<td align="center">y轴轴须</td>
</tr>
<tr>
<td align="center">axis.line</td>
<td align="center">element_line()</td>
<td align="center">轴线</td>
</tr>
</tbody></table>
<p>axis.line轴线处理，默认是隐藏的。</p>
<p>例子：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">p <span class="operator">+</span> theme<span class="punctuation">(</span>plot.title<span class="operator">=</span>element_text<span class="punctuation">(</span>size<span class="operator">=</span><span class="number">20</span><span class="punctuation">,</span> face<span class="operator">=</span><span class="string">&quot;bold&quot;</span><span class="punctuation">,</span> <span class="comment">#字体</span></span><br><span class="line">                                  color<span class="operator">=</span><span class="string">&quot;skyblue&quot;</span><span class="punctuation">,</span> <span class="comment">#颜色</span></span><br><span class="line">                                  hjust<span class="operator">=</span><span class="number">0.5</span><span class="punctuation">,</span> <span class="comment">#调整位置，正中间（水平）</span></span><br><span class="line">                                  lineheight<span class="operator">=</span><span class="number">1.2</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">          plot.subtitle<span class="operator">=</span>element_text<span class="punctuation">(</span>size<span class="operator">=</span><span class="number">15</span><span class="punctuation">,</span>face<span class="operator">=</span><span class="string">&quot;bold&quot;</span><span class="punctuation">,</span></span><br><span class="line">									 color <span class="operator">=</span> <span class="string">&quot;red&quot;</span><span class="punctuation">,</span>hjust<span class="operator">=</span><span class="number">0.5</span><span class="punctuation">)</span><span class="punctuation">,</span>  <span class="comment"># subtitle</span></span><br><span class="line">          plot.caption<span class="operator">=</span>element_text<span class="punctuation">(</span>size<span class="operator">=</span><span class="number">15</span><span class="punctuation">)</span><span class="punctuation">,</span>   <span class="comment"># caption</span></span><br><span class="line">          axis.title.x<span class="operator">=</span>element_text<span class="punctuation">(</span>vjust<span class="operator">=</span><span class="number">1</span><span class="punctuation">,</span> size<span class="operator">=</span><span class="number">20</span><span class="punctuation">)</span><span class="punctuation">,</span>  <span class="comment"># X axis title</span></span><br><span class="line">          axis.title.y<span class="operator">=</span>element_text<span class="punctuation">(</span>size<span class="operator">=</span><span class="number">10</span><span class="punctuation">,</span> color <span class="operator">=</span> <span class="string">&quot;blue&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span>  <span class="comment"># Y axis title</span></span><br><span class="line">          axis.text.x<span class="operator">=</span>element_text<span class="punctuation">(</span>size<span class="operator">=</span><span class="number">10</span><span class="punctuation">,</span> angle <span class="operator">=</span> <span class="number">45</span><span class="punctuation">,</span></span><br><span class="line">                                   color <span class="operator">=</span> <span class="string">&quot;red&quot;</span><span class="punctuation">,</span> vjust<span class="operator">=</span><span class="number">.5</span><span class="punctuation">)</span><span class="punctuation">,</span>  <span class="comment"># X axis text</span></span><br><span class="line">          axis.text.y<span class="operator">=</span>element_text<span class="punctuation">(</span>size<span class="operator">=</span><span class="number">10</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="comment"># Y axis text</span></span><br></pre></td></tr></table></figure>

<p><img src="/pics/2023-04-03-theme2.png" alt="alt 图标"></p>
<blockquote>
<p>一些其他参数、函数：<br>vjust，控制标题(或标签)和绘图之间的垂直间距。<br>hjust，控制水平间距。将其设置为0.5将标题居中。<br>face，设置字体(“plain”，“italic”，“bold”，“bold.italic”)<br>unit()，用于设定网格单位，如unit(1,”cm”)或unit(0.25,”in”)</p>
</blockquote>
<h3 id="2-修改图例"><a href="#2-修改图例" class="headerlink" title="2. 修改图例"></a>2. 修改图例</h3><p>图例组件：</p>
<table>
<thead>
<tr>
<th align="center">组件</th>
<th align="center">对应的element功能</th>
<th align="center">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="center">legend.background</td>
<td align="center">element_rect()</td>
<td align="center">图例背景</td>
</tr>
<tr>
<td align="center">legend.key</td>
<td align="center">element_rect()</td>
<td align="center">图例符号背景</td>
</tr>
<tr>
<td align="center">legend.key.size</td>
<td align="center">unit()</td>
<td align="center">图例符号大小</td>
</tr>
<tr>
<td align="center">legend.key.height</td>
<td align="center">unit()</td>
<td align="center">图例符号高度</td>
</tr>
<tr>
<td align="center">legend.key.width</td>
<td align="center">unit()</td>
<td align="center">图例符号宽度</td>
</tr>
<tr>
<td align="center">legend.margin</td>
<td align="center">unit()</td>
<td align="center">图例边距</td>
</tr>
<tr>
<td align="center">legend.text</td>
<td align="center">element_text()</td>
<td align="center">图例标签</td>
</tr>
<tr>
<td align="center">legend.text.align</td>
<td align="center">0-1</td>
<td align="center">图例标签对齐(0&#x3D;右，1&#x3D;左)</td>
</tr>
<tr>
<td align="center">legend.title</td>
<td align="center">element_text()</td>
<td align="center">图例名</td>
</tr>
<tr>
<td align="center">legend.title.align</td>
<td align="center">0-1</td>
<td align="center">图例名对齐(0&#x3D;右，1&#x3D;左)</td>
</tr>
<tr>
<td align="center">legend.justification</td>
<td align="center">c(x,y)图例的x和y的坐标</td>
<td align="center">将图例设置在图内部</td>
</tr>
<tr>
<td align="center">legend.position</td>
<td align="center">“none”, “left”, “right”, “bottom”, “top”,or two-element numeric vector</td>
<td align="center">图例位置</td>
</tr>
</tbody></table>
<h4 id="2-1-设置图例标题，文本和键的样式"><a href="#2-1-设置图例标题，文本和键的样式" class="headerlink" title="2.1 设置图例标题，文本和键的样式"></a>2.1 设置图例标题，文本和键的样式</h4><p>例如：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">p <span class="operator">+</span> theme<span class="punctuation">(</span>legend.title <span class="operator">=</span> element_text<span class="punctuation">(</span>size<span class="operator">=</span><span class="number">15</span><span class="punctuation">,</span> color <span class="operator">=</span> <span class="string">&quot;firebrick&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span> <span class="comment"># 图例名字</span></span><br><span class="line">          legend.text <span class="operator">=</span> element_text<span class="punctuation">(</span>size<span class="operator">=</span><span class="number">10</span><span class="punctuation">)</span><span class="punctuation">,</span>  <span class="comment"># 图例文本</span></span><br><span class="line">          legend.key<span class="operator">=</span>element_rect<span class="punctuation">(</span>fill<span class="operator">=</span><span class="string">&#x27;green&#x27;</span><span class="punctuation">)</span><span class="punctuation">,</span> <span class="comment"># 图例符号背景</span></span><br><span class="line">          legend.background <span class="operator">=</span> element_rect<span class="punctuation">(</span>fill <span class="operator">=</span> <span class="string">&quot;red&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span> <span class="comment">#图例背景</span></span><br><span class="line">          legend.key.size<span class="operator">=</span>unit<span class="punctuation">(</span><span class="number">1</span><span class="punctuation">,</span><span class="string">&quot;cm&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span> <span class="comment"># 图例符号大小</span></span><br><span class="line">          legned.text.align<span class="operator">=</span><span class="number">1</span><span class="punctuation">)</span>  <span class="comment"># 图例文本右对齐</span></span><br></pre></td></tr></table></figure>

<p><img src="/pics/2023-04-03-theme3.png" alt="alt 图标"></p>
<h4 id="2-2-删除图例和修改图例位置"><a href="#2-2-删除图例和修改图例位置" class="headerlink" title="2.2 删除图例和修改图例位置"></a>2.2 删除图例和修改图例位置</h4><p>删掉图例：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">p <span class="operator">+</span> theme<span class="punctuation">(</span>legend.position<span class="operator">=</span><span class="string">&quot;None&quot;</span><span class="punctuation">)</span> <span class="operator">+</span> labs<span class="punctuation">(</span>subtitle<span class="operator">=</span><span class="string">&quot;No Legend&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><img src="/pics/2023-04-03-theme4.png" alt="alt 图标"></p>
<p>修改图例位置：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">p <span class="operator">+</span> theme<span class="punctuation">(</span>legend.position<span class="operator">=</span><span class="string">&quot;bottom&quot;</span><span class="punctuation">,</span> legend.box <span class="operator">=</span> <span class="string">&quot;horizontal&quot;</span><span class="punctuation">)</span> <span class="operator">+</span> labs<span class="punctuation">(</span>subtitle<span class="operator">=</span><span class="string">&quot;Legend bottom&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><img src="/pics/2023-04-03-theme5.png" alt="alt 图标"></p>
<p>修改图例到图片内部：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">p <span class="operator">+</span> theme<span class="punctuation">(</span>legend.title <span class="operator">=</span> element_text<span class="punctuation">(</span>size<span class="operator">=</span><span class="number">12</span><span class="punctuation">,</span> color <span class="operator">=</span> <span class="string">&quot;salmon&quot;</span><span class="punctuation">,</span> face<span class="operator">=</span><span class="string">&quot;bold&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">           legend.justification<span class="operator">=</span><span class="built_in">c</span><span class="punctuation">(</span><span class="number">1</span><span class="punctuation">,</span><span class="number">0</span><span class="punctuation">)</span><span class="punctuation">,</span> </span><br><span class="line">           legend.position<span class="operator">=</span><span class="built_in">c</span><span class="punctuation">(</span><span class="number">0.95</span><span class="punctuation">,</span> <span class="number">0.05</span><span class="punctuation">)</span><span class="punctuation">,</span>  <span class="comment">#c(0, 1)为面板左上角，c(1, 0)为面板右下角，c(0.5, 0，5)为面板中间</span></span><br><span class="line">           legend.background <span class="operator">=</span> element_blank<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">           legend.key <span class="operator">=</span> element_blank<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span> </span><br><span class="line">  labs<span class="punctuation">(</span>subtitle<span class="operator">=</span><span class="string">&quot;Legend: Bottom-Right Inside the Plot&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><img src="/pics/2023-04-03-theme6.png" alt="alt 图标"></p>
<blockquote>
<p>legend.position也可以用两个元素构成的数值向量来控制，主要是设置图例在图片中间所在具体位置，而不是图片的外围。数值大小一般在0-1之间，超出数值往往导致图例隐藏。<br>其他诸如guide_legend()或guide_colourbar()等函数也可以用来修改图例。以及向legend.position\legend.direction\legend.justification\legend.box等属性控制图例在图像中的布局。</p>
</blockquote>
<h3 id="3-修改面板"><a href="#3-修改面板" class="headerlink" title="3. 修改面板"></a>3. 修改面板</h3><table>
<thead>
<tr>
<th align="center">组件</th>
<th align="center">对应的element_功能()</th>
<th align="center">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="center">panel.background</td>
<td align="center">element_rect()</td>
<td align="center">面板背景（数据下面）</td>
</tr>
<tr>
<td align="center">panel.border</td>
<td align="center">element_rect()</td>
<td align="center">面板边界（数据上面）</td>
</tr>
<tr>
<td align="center">panel.grid</td>
<td align="center">element_line()</td>
<td align="center">网格线</td>
</tr>
<tr>
<td align="center">panel.grid.major</td>
<td align="center">element_line()</td>
<td align="center">主网格线</td>
</tr>
<tr>
<td align="center">panel.grid.major.x</td>
<td align="center">element_line()</td>
<td align="center">竖直主网格线</td>
</tr>
<tr>
<td align="center">panel.grid.major.y</td>
<td align="center">element_line()</td>
<td align="center">水平主网格线</td>
</tr>
<tr>
<td align="center">panel.grid.minor</td>
<td align="center">element_line()</td>
<td align="center">次网格线</td>
</tr>
<tr>
<td align="center">panel.grid.minor.x</td>
<td align="center">element_line()</td>
<td align="center">竖直次网格线</td>
</tr>
<tr>
<td align="center">panel.grid.minor.y</td>
<td align="center">element_line()</td>
<td align="center">水平次网格线</td>
</tr>
<tr>
<td align="center">aspect.ratio</td>
<td align="center">数值(m&#x2F;n,两个整数)</td>
<td align="center">图像宽高比</td>
</tr>
</tbody></table>
<h4 id="3-1-更改绘图背景"><a href="#3-1-更改绘图背景" class="headerlink" title="3.1 更改绘图背景"></a>3.1 更改绘图背景</h4><figure class="highlight r"><table><tr><td class="code"><pre><span class="line">p <span class="operator">+</span> theme<span class="punctuation">(</span>panel.background <span class="operator">=</span> element_rect<span class="punctuation">(</span>fill <span class="operator">=</span> <span class="string">&#x27;grey80&#x27;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">          plot.background<span class="operator">=</span>element_rect<span class="punctuation">(</span>fill<span class="operator">=</span><span class="string">&quot;lightblue&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span> </span><br><span class="line">          plot.margin <span class="operator">=</span> unit<span class="punctuation">(</span><span class="built_in">c</span><span class="punctuation">(</span><span class="number">3</span><span class="punctuation">,</span> <span class="number">2</span><span class="punctuation">,</span> <span class="number">1</span><span class="punctuation">,</span> <span class="number">1</span><span class="punctuation">)</span><span class="punctuation">,</span> <span class="string">&quot;cm&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span>  <span class="comment">#设置绘图区域距离边的据类，上，右，下，左</span></span><br><span class="line">    labs<span class="punctuation">(</span>title<span class="operator">=</span><span class="string">&quot;Modified Background&quot;</span><span class="punctuation">,</span> subtitle<span class="operator">=</span><span class="string">&quot;Change Plot Margin&quot;</span><span class="punctuation">)</span> </span><br></pre></td></tr></table></figure>
<p><img src="/pics/2023-04-03-theme7.png" alt="alt 图标"></p>
<h4 id="3-2-更改主次网格线以及X、Y坐标轴"><a href="#3-2-更改主次网格线以及X、Y坐标轴" class="headerlink" title="3.2 更改主次网格线以及X、Y坐标轴"></a>3.2 更改主次网格线以及X、Y坐标轴</h4><figure class="highlight r"><table><tr><td class="code"><pre><span class="line">p <span class="operator">+</span> theme<span class="punctuation">(</span>panel.grid.major <span class="operator">=</span> element_line<span class="punctuation">(</span>colour <span class="operator">=</span> <span class="string">&quot;blue&quot;</span><span class="punctuation">,</span> linewidth<span class="operator">=</span><span class="number">1.5</span><span class="punctuation">)</span><span class="punctuation">,</span> <span class="comment">#主网格线 蓝色</span></span><br><span class="line">          panel.grid.minor <span class="operator">=</span> element_line<span class="punctuation">(</span>colour <span class="operator">=</span> <span class="string">&quot;red&quot;</span><span class="punctuation">,</span> linewidth<span class="operator">=</span><span class="number">0.25</span><span class="punctuation">,</span> </span><br><span class="line">                                          linetype <span class="operator">=</span> <span class="string">&quot;dashed&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span><span class="comment"># 次网格线 红色</span></span><br><span class="line">          panel.border <span class="operator">=</span> element_blank<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">          axis.line.x <span class="operator">=</span> element_line<span class="punctuation">(</span>colour <span class="operator">=</span> <span class="string">&quot;yellow&quot;</span><span class="punctuation">,</span> linewidth<span class="operator">=</span><span class="number">1.5</span><span class="punctuation">,</span> </span><br><span class="line">                                     lineend <span class="operator">=</span> <span class="string">&quot;butt&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span> <span class="comment"># x轴 黄色，y轴 绿色</span></span><br><span class="line">          axis.line.y <span class="operator">=</span> element_line<span class="punctuation">(</span>colour <span class="operator">=</span> <span class="string">&quot;green&quot;</span><span class="punctuation">,</span>linewidth<span class="operator">=</span><span class="number">1.5</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span> </span><br><span class="line">    labs<span class="punctuation">(</span>subtitle<span class="operator">=</span><span class="string">&quot;Change Major and Minor grid, Axis Lines&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><img src="/pics/2023-04-03-theme8.png" alt="alt 图标"></p>
<h4 id="3-3-删除主次网格线"><a href="#3-3-删除主次网格线" class="headerlink" title="3.3 删除主次网格线"></a>3.3 删除主次网格线</h4><figure class="highlight r"><table><tr><td class="code"><pre><span class="line">p <span class="operator">+</span> theme<span class="punctuation">(</span>panel.grid.major <span class="operator">=</span> element_blank<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span> <span class="comment">#主网格线</span></span><br><span class="line">          panel.grid.minor <span class="operator">=</span> element_blank<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span> <span class="comment">#次网格线</span></span><br><span class="line">          panel.border <span class="operator">=</span> element_blank<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span> <span class="comment">#边框</span></span><br><span class="line">          axis.title <span class="operator">=</span> element_blank<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span>  <span class="comment">#轴标题</span></span><br><span class="line">          axis.text <span class="operator">=</span> element_blank<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span> <span class="comment"># 文本</span></span><br><span class="line">          axis.ticks <span class="operator">=</span> element_blank<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  labs<span class="punctuation">(</span>title<span class="operator">=</span><span class="string">&quot;Modified Background&quot;</span><span class="punctuation">,</span> subtitle<span class="operator">=</span><span class="string">&quot;Remove major and minor axis grid, border, axis title, text and ticks&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><img src="/pics/2023-04-03-theme9.png" alt="alt 图标"></p>
<h3 id="4-分面组件"><a href="#4-分面组件" class="headerlink" title="4. 分面组件"></a>4. 分面组件</h3><p>利用facet绘制多个图像时使用。</p>
<table>
<thead>
<tr>
<th align="center">组件</th>
<th align="center">对应的element_功能()</th>
<th align="center">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="center">strip.background</td>
<td align="center">element_rect()</td>
<td align="center">分面标签背景</td>
</tr>
<tr>
<td align="center">strip.text</td>
<td align="center">element_text()</td>
<td align="center">条状文本</td>
</tr>
<tr>
<td align="center">strip.text.x</td>
<td align="center">element_text()</td>
<td align="center">水平条状文本</td>
</tr>
<tr>
<td align="center">strip.text.y</td>
<td align="center">element_text()</td>
<td align="center">竖直条状文本</td>
</tr>
<tr>
<td align="center">panel.spacing</td>
<td align="center">unit()</td>
<td align="center">分面间边距</td>
</tr>
<tr>
<td align="center">panel.spacing.x</td>
<td align="center">unit()</td>
<td align="center">竖直分面间边距</td>
</tr>
<tr>
<td align="center">panel.spacing.y</td>
<td align="center">unit()</td>
<td align="center">水平分面间边距</td>
</tr>
</tbody></table>
<h3 id="5-gides"><a href="#5-gides" class="headerlink" title="5. gides()"></a>5. gides()</h3><p>在ggplot2中，美学映射相应的标度函数可以调整图形本身的效果的同时调整图例的外观，但是有时候只想改变图例的外形，并不想影响图形的效果，这时就可以使用guides()函数。<br>override.aes()可以只修改图例中的外观，例如size、shape等等，而图形本身的外观不受影响。</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">iris <span class="operator">%&gt;%</span></span><br><span class="line">  ggplot<span class="punctuation">(</span>aes<span class="punctuation">(</span>x <span class="operator">=</span> Sepal.Length<span class="punctuation">,</span> y <span class="operator">=</span> Sepal.Width<span class="punctuation">,</span> color <span class="operator">=</span> Species<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  geom_point<span class="punctuation">(</span>alpha <span class="operator">=</span> <span class="number">.5</span><span class="punctuation">,</span> size <span class="operator">=</span> <span class="number">1</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  guides<span class="punctuation">(</span>color <span class="operator">=</span> guide_legend<span class="punctuation">(</span>override.aes <span class="operator">=</span> <span class="built_in">list</span><span class="punctuation">(</span>size <span class="operator">=</span> <span class="number">3</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<p><img src="/pics/2023-05-01-guide.png" alt="alt 图标"></p>
<p>如果是多个参数，用list就可以。</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">iris <span class="operator">%&gt;%</span></span><br><span class="line">  ggplot<span class="punctuation">(</span>aes<span class="punctuation">(</span>x <span class="operator">=</span> Sepal.Length<span class="punctuation">,</span> y <span class="operator">=</span> Sepal.Width<span class="punctuation">,</span> color <span class="operator">=</span> Species<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  geom_point<span class="punctuation">(</span>alpha <span class="operator">=</span> <span class="number">.5</span><span class="punctuation">,</span> size <span class="operator">=</span> <span class="number">1</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  guides<span class="punctuation">(</span>color <span class="operator">=</span> guide_legend<span class="punctuation">(</span>override.aes <span class="operator">=</span> <span class="built_in">list</span><span class="punctuation">(</span>size <span class="operator">=</span> <span class="number">3</span><span class="punctuation">,</span> alpha<span class="operator">=</span><span class="number">0.5</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<p>参考资料：</p>
<ol>
<li><a href="https://zhuanlan.zhihu.com/p/79968177">https://zhuanlan.zhihu.com/p/79968177</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/463041897">https://zhuanlan.zhihu.com/p/463041897</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/370223674">https://zhuanlan.zhihu.com/p/370223674</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/374283162">https://zhuanlan.zhihu.com/p/374283162</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/460976888">https://zhuanlan.zhihu.com/p/460976888</a></li>
</ol>
]]></content>
      <categories>
        <category>R</category>
        <category>ggplot2</category>
      </categories>
      <tags>
        <tag>R</tag>
        <tag>ggplot2</tag>
      </tags>
  </entry>
  <entry>
    <title>ggplot2集锦之六绘制各种图形1</title>
    <url>/2023/04/07/ggplot2%E9%9B%86%E9%94%A6%E4%B9%8B%E5%85%AD%E7%BB%98%E5%88%B6%E5%90%84%E7%A7%8D%E5%9B%BE%E5%BD%A21/</url>
    <content><![CDATA[<p>本文总结一下ggplot2包绘制各种类型的图，本文包括：散点图、条形图、折线图、条带图、面积图、阶梯图、密度图、累计分布曲线。</p>
<span id="more"></span>

<h3 id="1-散点图"><a href="#1-散点图" class="headerlink" title="1.散点图"></a>1.散点图</h3><h4 id="1-1-散点图"><a href="#1-1-散点图" class="headerlink" title="1.1 散点图"></a>1.1 散点图</h4><p>绘制散点图，用geom_point()。<br>数据如下：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">library<span class="punctuation">(</span>ggplot2<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">head<span class="punctuation">(</span>mpg<span class="punctuation">)</span></span><br><span class="line"><span class="comment"># A tibble: 6 x 11</span></span><br><span class="line">  manufacturer model displ  year   cyl trans      drv     cty   hwy fl    <span class="built_in">class</span>  </span><br><span class="line">  <span class="operator">&lt;</span>chr<span class="operator">&gt;</span>        <span class="operator">&lt;</span>chr<span class="operator">&gt;</span> <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span> <span class="operator">&lt;</span>int<span class="operator">&gt;</span> <span class="operator">&lt;</span>int<span class="operator">&gt;</span> <span class="operator">&lt;</span>chr<span class="operator">&gt;</span>      <span class="operator">&lt;</span>chr<span class="operator">&gt;</span> <span class="operator">&lt;</span>int<span class="operator">&gt;</span> <span class="operator">&lt;</span>int<span class="operator">&gt;</span> <span class="operator">&lt;</span>chr<span class="operator">&gt;</span> <span class="operator">&lt;</span>chr<span class="operator">&gt;</span>  </span><br><span class="line"><span class="number">1</span> audi         a4      <span class="number">1.8</span>  <span class="number">1999</span>     <span class="number">4</span> auto<span class="punctuation">(</span>l5<span class="punctuation">)</span>   f        <span class="number">18</span>    <span class="number">29</span> p     compact</span><br><span class="line"><span class="number">2</span> audi         a4      <span class="number">1.8</span>  <span class="number">1999</span>     <span class="number">4</span> manual<span class="punctuation">(</span>m5<span class="punctuation">)</span> f        <span class="number">21</span>    <span class="number">29</span> p     compact</span><br><span class="line"><span class="number">3</span> audi         a4      <span class="number">2</span>    <span class="number">2008</span>     <span class="number">4</span> manual<span class="punctuation">(</span>m6<span class="punctuation">)</span> f        <span class="number">20</span>    <span class="number">31</span> p     compact</span><br><span class="line"><span class="number">4</span> audi         a4      <span class="number">2</span>    <span class="number">2008</span>     <span class="number">4</span> auto<span class="punctuation">(</span>av<span class="punctuation">)</span>   f        <span class="number">21</span>    <span class="number">30</span> p     compact</span><br><span class="line"><span class="number">5</span> audi         a4      <span class="number">2.8</span>  <span class="number">1999</span>     <span class="number">6</span> auto<span class="punctuation">(</span>l5<span class="punctuation">)</span>   f        <span class="number">16</span>    <span class="number">26</span> p     compact</span><br><span class="line"><span class="number">6</span> audi         a4      <span class="number">2.8</span>  <span class="number">1999</span>     <span class="number">6</span> manual<span class="punctuation">(</span>m5<span class="punctuation">)</span> f        <span class="number">18</span>    <span class="number">26</span> p     compact</span><br></pre></td></tr></table></figure>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">ggplot<span class="punctuation">(</span>mpg<span class="punctuation">,</span>aes<span class="punctuation">(</span>x <span class="operator">=</span> displ<span class="punctuation">,</span>y <span class="operator">=</span> cty<span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line"> geom_point<span class="punctuation">(</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<h4 id="1-2-散点图加拟合曲线"><a href="#1-2-散点图加拟合曲线" class="headerlink" title="1.2 散点图加拟合曲线"></a>1.2 散点图加拟合曲线</h4><figure class="highlight r"><table><tr><td class="code"><pre><span class="line">ggplot<span class="punctuation">(</span>mpg<span class="punctuation">,</span>aes<span class="punctuation">(</span>x <span class="operator">=</span> displ<span class="punctuation">,</span>y <span class="operator">=</span> cty<span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line"> geom_point<span class="punctuation">(</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line"> stat_smooth<span class="punctuation">(</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><img src="/pics/2023-04-07-plot1.png" alt="alt 图标"></p>
<h3 id="2-柱状图-x2F-直方图-x2F-条形图"><a href="#2-柱状图-x2F-直方图-x2F-条形图" class="headerlink" title="2.柱状图&#x2F;直方图&#x2F;条形图"></a>2.柱状图&#x2F;直方图&#x2F;条形图</h3><p>柱状图用geom_bar、geom_histogram、geom_col。geom_bar() 默认使用的统计变换方法是 count，而 geom_col() 使用 identity 不做变换。</p>
<h4 id="2-1-简单柱状图"><a href="#2-1-简单柱状图" class="headerlink" title="2.1 简单柱状图"></a>2.1 简单柱状图</h4><figure class="highlight r"><table><tr><td class="code"><pre><span class="line">ggplot<span class="punctuation">(</span>mpg<span class="punctuation">,</span> aes<span class="punctuation">(</span><span class="built_in">class</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line"> geom_bar<span class="punctuation">(</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">df <span class="operator">&lt;-</span> data.frame<span class="punctuation">(</span>trt <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;a&quot;</span><span class="punctuation">,</span> <span class="string">&quot;b&quot;</span><span class="punctuation">,</span> <span class="string">&quot;c&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span> outcome <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">2.3</span><span class="punctuation">,</span> <span class="number">1.9</span><span class="punctuation">,</span> <span class="number">3.2</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">ggplot<span class="punctuation">(</span>df<span class="punctuation">,</span> aes<span class="punctuation">(</span>trt<span class="punctuation">,</span> outcome<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  geom_col<span class="punctuation">(</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<h4 id="2-2-水平条形图"><a href="#2-2-水平条形图" class="headerlink" title="2.2 水平条形图"></a>2.2 水平条形图</h4><p>1.翻转x、y轴：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">ggplot<span class="punctuation">(</span>mpg<span class="punctuation">,</span> aes<span class="punctuation">(</span><span class="built_in">class</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line"> geom_bar<span class="punctuation">(</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line"> coord_flip<span class="punctuation">(</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p>2.调整x、y轴：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">ggplot<span class="punctuation">(</span>mpg<span class="punctuation">,</span> aes<span class="punctuation">(</span>y<span class="operator">=</span><span class="built_in">class</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line"> geom_bar<span class="punctuation">(</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><img src="/pics/2023-04-07-plot2.png" alt="alt 图标"></p>
<h4 id="2-3-柱状堆叠图"><a href="#2-3-柱状堆叠图" class="headerlink" title="2.3 柱状堆叠图"></a>2.3 柱状堆叠图</h4><figure class="highlight r"><table><tr><td class="code"><pre><span class="line">ggplot<span class="punctuation">(</span>mpg<span class="punctuation">,</span> aes<span class="punctuation">(</span><span class="built_in">class</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line"> geom_bar<span class="punctuation">(</span>aes<span class="punctuation">(</span>fill <span class="operator">=</span> drv<span class="punctuation">)</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p>堆积条形图，并翻转堆积顺序：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">ggplot<span class="punctuation">(</span>mpg<span class="punctuation">,</span> aes<span class="punctuation">(</span>y <span class="operator">=</span> <span class="built_in">class</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  geom_bar<span class="punctuation">(</span>aes<span class="punctuation">(</span>fill <span class="operator">=</span> drv<span class="punctuation">)</span><span class="punctuation">,</span> position <span class="operator">=</span> position_stack<span class="punctuation">(</span>reverse <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<h4 id="2-4-百分比条形图"><a href="#2-4-百分比条形图" class="headerlink" title="2.4 百分比条形图"></a>2.4 百分比条形图</h4><figure class="highlight r"><table><tr><td class="code"><pre><span class="line">ggplot<span class="punctuation">(</span>mpg<span class="punctuation">,</span> aes<span class="punctuation">(</span><span class="built_in">class</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line"> geom_bar<span class="punctuation">(</span>aes<span class="punctuation">(</span>fill <span class="operator">=</span> drv<span class="punctuation">)</span><span class="punctuation">,</span> </span><br><span class="line"> 	          position <span class="operator">=</span> <span class="string">&#x27;fill&#x27;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<h4 id="2-5-并列分组条形图"><a href="#2-5-并列分组条形图" class="headerlink" title="2.5 并列分组条形图"></a>2.5 并列分组条形图</h4><figure class="highlight r"><table><tr><td class="code"><pre><span class="line">ggplot<span class="punctuation">(</span>mpg<span class="punctuation">,</span> aes<span class="punctuation">(</span><span class="built_in">class</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line"> geom_bar<span class="punctuation">(</span>aes<span class="punctuation">(</span>fill <span class="operator">=</span> drv<span class="punctuation">)</span><span class="punctuation">,</span> position <span class="operator">=</span> position_dodge<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><img src="/pics/2023-04-07-plot3.png" alt="alt 图标"></p>
<h4 id="2-6-双向柱状图"><a href="#2-6-双向柱状图" class="headerlink" title="2.6 双向柱状图"></a>2.6 双向柱状图</h4><figure class="highlight r"><table><tr><td class="code"><pre><span class="line">df <span class="operator">&lt;-</span> data.frame<span class="punctuation">(</span>x<span class="operator">=</span><span class="built_in">rep</span><span class="punctuation">(</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;x1&quot;</span><span class="punctuation">,</span><span class="string">&quot;x2&quot;</span><span class="punctuation">,</span><span class="string">&quot;x3&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span>each<span class="operator">=</span><span class="number">2</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">				 num<span class="operator">=</span>rnorm<span class="punctuation">(</span><span class="number">6</span><span class="punctuation">,</span>mean <span class="operator">=</span> <span class="number">3</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">				 group<span class="operator">=</span><span class="built_in">rep</span><span class="punctuation">(</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;up&quot;</span><span class="punctuation">,</span><span class="string">&quot;down&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span><span class="number">3</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">df </span><br><span class="line">   x      num group</span><br><span class="line"><span class="number">1</span> x1 <span class="number">1.377343</span>    up</span><br><span class="line"><span class="number">2</span> x1 <span class="number">3.456258</span>  down</span><br><span class="line"><span class="number">3</span> x2 <span class="number">3.184073</span>    up</span><br><span class="line"><span class="number">4</span> x2 <span class="number">3.057976</span>  down</span><br><span class="line"><span class="number">5</span> x3 <span class="number">3.692116</span>    up</span><br><span class="line"><span class="number">6</span> x3 <span class="number">1.633762</span>  down</span><br></pre></td></tr></table></figure>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">ggplot<span class="punctuation">(</span>df<span class="punctuation">,</span> aes<span class="punctuation">(</span>x <span class="operator">=</span> factor<span class="punctuation">(</span>x<span class="punctuation">,</span>levels <span class="operator">=</span> unique<span class="punctuation">(</span>x<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">               y <span class="operator">=</span> ifelse<span class="punctuation">(</span>group <span class="operator">==</span> <span class="string">&quot;Up&quot;</span><span class="punctuation">,</span> value<span class="punctuation">,</span> <span class="operator">-</span>value<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">               fill <span class="operator">=</span> group<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  geom_bar<span class="punctuation">(</span>stat <span class="operator">=</span> <span class="string">&#x27;identity&#x27;</span><span class="punctuation">)</span><span class="operator">+</span> </span><br><span class="line">  coord_flip<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img src="/pics/2023-04-07-plot4.png" alt="alt 图标"></p>
<h3 id="3-折线图"><a href="#3-折线图" class="headerlink" title="3. 折线图"></a>3. 折线图</h3><figure class="highlight r"><table><tr><td class="code"><pre><span class="line">head<span class="punctuation">(</span>economics<span class="punctuation">)</span></span><br><span class="line"><span class="comment">## # A tibble: 6 x 6</span></span><br><span class="line"><span class="comment">##         date   pce    pop psavert uempmed unemploy</span></span><br><span class="line"><span class="comment">##       &lt;date&gt; &lt;dbl&gt;  &lt;int&gt;   &lt;dbl&gt;   &lt;dbl&gt;    &lt;int&gt;</span></span><br><span class="line"><span class="comment">## 1 1967-07-01 507.4 198712    12.5     4.5     2944</span></span><br><span class="line"><span class="comment">## 2 1967-08-01 510.5 198911    12.5     4.7     2945</span></span><br><span class="line"><span class="comment">## 3 1967-09-01 516.3 199113    11.7     4.6     2958</span></span><br><span class="line"><span class="comment">## 4 1967-10-01 512.9 199311    12.5     4.9     3143</span></span><br><span class="line"><span class="comment">## 5 1967-11-01 518.1 199498    12.5     4.7     3066</span></span><br><span class="line"><span class="comment">## 6 1967-12-01 525.8 199657    12.1     4.8     3018</span></span><br></pre></td></tr></table></figure>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">ggplot<span class="punctuation">(</span>data <span class="operator">=</span> economics<span class="punctuation">,</span> aes<span class="punctuation">(</span>x<span class="operator">=</span>date<span class="punctuation">,</span> y<span class="operator">=</span>unemploy<span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line"> geom_line<span class="punctuation">(</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<h3 id="4-条带图"><a href="#4-条带图" class="headerlink" title="4. 条带图"></a>4. 条带图</h3><p>geom_ribbon绘制条带图，</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">ggplot<span class="punctuation">(</span>data <span class="operator">=</span> economics<span class="punctuation">,</span> aes<span class="punctuation">(</span>x<span class="operator">=</span>date<span class="punctuation">,</span> y<span class="operator">=</span>unemploy<span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line"> geom_ribbon<span class="punctuation">(</span>aes<span class="punctuation">(</span>x <span class="operator">=</span> date<span class="punctuation">,</span></span><br><span class="line">                 ymax<span class="operator">=</span>unemploy<span class="operator">+</span><span class="number">1000</span><span class="punctuation">,</span></span><br><span class="line">                 ymin<span class="operator">=</span>unemploy<span class="operator">-</span><span class="number">1000</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">                 fill<span class="operator">=</span><span class="string">&quot;grey&quot;</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line"> geom_line<span class="punctuation">(</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<h3 id="4-面积图"><a href="#4-面积图" class="headerlink" title="4. 面积图"></a>4. 面积图</h3><p>geom_area是特殊的条带图（ymin&#x3D;0）。</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">ggplot<span class="punctuation">(</span>data <span class="operator">=</span> economics<span class="punctuation">,</span> aes<span class="punctuation">(</span>x<span class="operator">=</span>date<span class="punctuation">,</span> y<span class="operator">=</span>unemploy<span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line"> geom_area<span class="punctuation">(</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<h3 id="5-阶梯图"><a href="#5-阶梯图" class="headerlink" title="5. 阶梯图"></a>5. 阶梯图</h3><figure class="highlight r"><table><tr><td class="code"><pre><span class="line">set.seed<span class="punctuation">(</span><span class="number">1111</span><span class="punctuation">)</span></span><br><span class="line">ss <span class="operator">&lt;-</span> economics<span class="punctuation">[</span>sample<span class="punctuation">(</span><span class="number">1</span><span class="operator">:</span>nrow<span class="punctuation">(</span>economics<span class="punctuation">)</span><span class="punctuation">,</span> <span class="number">20</span><span class="punctuation">)</span><span class="punctuation">,</span><span class="punctuation">]</span></span><br><span class="line">ggplot<span class="punctuation">(</span>ss<span class="punctuation">,</span> aes<span class="punctuation">(</span>x<span class="operator">=</span>date<span class="punctuation">,</span> y<span class="operator">=</span>unemploy<span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">  geom_step<span class="punctuation">(</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><img src="/pics/2023-04-07-plot5.png" alt="alt 图标"></p>
<h3 id="6-密度图"><a href="#6-密度图" class="headerlink" title="6. 密度图"></a>6. 密度图</h3><figure class="highlight r"><table><tr><td class="code"><pre><span class="line">df1 <span class="operator">&lt;-</span> data.frame<span class="punctuation">(</span>num<span class="operator">=</span>rnorm<span class="punctuation">(</span><span class="number">500</span><span class="punctuation">,</span>mean <span class="operator">=</span> <span class="number">50</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">				 group<span class="operator">=</span><span class="built_in">rep</span><span class="punctuation">(</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;group1&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span><span class="number">500</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">df2 <span class="operator">&lt;-</span> data.frame<span class="punctuation">(</span>num<span class="operator">=</span>rnorm<span class="punctuation">(</span><span class="number">500</span><span class="punctuation">,</span>mean <span class="operator">=</span> <span class="number">52</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">				 group<span class="operator">=</span><span class="built_in">rep</span><span class="punctuation">(</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;group2&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span><span class="number">500</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">df <span class="operator">&lt;-</span> rbind<span class="punctuation">(</span>df1<span class="punctuation">,</span>df2<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">ggplot<span class="punctuation">(</span>df<span class="punctuation">,</span>aes<span class="punctuation">(</span>num<span class="punctuation">,</span>group<span class="operator">=</span>group<span class="punctuation">,</span>color<span class="operator">=</span>group<span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line"> geom_density<span class="punctuation">(</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<h3 id="7-累计分布图"><a href="#7-累计分布图" class="headerlink" title="7. 累计分布图"></a>7. 累计分布图</h3><figure class="highlight r"><table><tr><td class="code"><pre><span class="line">ggplot<span class="punctuation">(</span>df<span class="punctuation">,</span>aes<span class="punctuation">(</span>num<span class="punctuation">,</span>group<span class="operator">=</span>group<span class="punctuation">,</span>color<span class="operator">=</span>group<span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line"> stat_ecdf<span class="punctuation">(</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<p><img src="/pics/2023-04-07-plot6.png" alt="alt 图标"></p>
<h3 id="8-point-errorbars"><a href="#8-point-errorbars" class="headerlink" title="8. point-errorbars"></a>8. point-errorbars</h3><figure class="highlight r"><table><tr><td class="code"><pre><span class="line">ggplot<span class="punctuation">(</span>iris<span class="punctuation">,</span>aes<span class="punctuation">(</span>x <span class="operator">=</span> Species<span class="punctuation">,</span> y <span class="operator">=</span> Sepal.Length<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  stat_summary<span class="punctuation">(</span></span><br><span class="line">    fun.y <span class="operator">=</span> mean<span class="punctuation">,</span> fun.ymax <span class="operator">=</span> <span class="keyword">function</span><span class="punctuation">(</span>x<span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">      mean<span class="punctuation">(</span>x<span class="punctuation">)</span> <span class="operator">+</span> <span class="number">2</span> <span class="operator">*</span> sd<span class="punctuation">(</span>x<span class="punctuation">)</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    fun.ymin <span class="operator">=</span> <span class="keyword">function</span><span class="punctuation">(</span>x<span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">      mean<span class="punctuation">(</span>x<span class="punctuation">)</span> <span class="operator">-</span> <span class="number">2</span> <span class="operator">*</span> sd<span class="punctuation">(</span>x<span class="punctuation">)</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span> geom <span class="operator">=</span> <span class="string">&quot;pointrange&quot;</span><span class="punctuation">,</span></span><br><span class="line">    fatten <span class="operator">=</span> <span class="number">5</span></span><br><span class="line">  <span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<p><img src="/pics/2023-05-01-point-errorbar.png" alt="alt 图标"></p>
<p>参考资料：</p>
<ol>
<li><a href="https://zhuanlan.zhihu.com/p/336912400">https://zhuanlan.zhihu.com/p/336912400</a></li>
</ol>
]]></content>
      <categories>
        <category>R</category>
        <category>ggplot2</category>
      </categories>
      <tags>
        <tag>R</tag>
        <tag>ggplot2</tag>
      </tags>
  </entry>
  <entry>
    <title>ggplot2集锦之六绘制各种图形2</title>
    <url>/2023/04/07/ggplot2%E9%9B%86%E9%94%A6%E4%B9%8B%E5%85%AD%E7%BB%98%E5%88%B6%E5%90%84%E7%A7%8D%E5%9B%BE%E5%BD%A22/</url>
    <content><![CDATA[<p>本文总结一下ggplot2包绘制各种类型的图，本文包括：小提琴图、箱线图、抖动散点图。</p>
<span id="more"></span>

<h3 id="1-小提琴图"><a href="#1-小提琴图" class="headerlink" title="1. 小提琴图"></a>1. 小提琴图</h3><figure class="highlight r"><table><tr><td class="code"><pre><span class="line">df1 <span class="operator">&lt;-</span> data.frame<span class="punctuation">(</span>num<span class="operator">=</span>rnorm<span class="punctuation">(</span><span class="number">500</span><span class="punctuation">,</span>mean <span class="operator">=</span> <span class="number">50</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">				 group<span class="operator">=</span><span class="built_in">rep</span><span class="punctuation">(</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;group1&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span><span class="number">500</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">df2 <span class="operator">&lt;-</span> data.frame<span class="punctuation">(</span>num<span class="operator">=</span>rnorm<span class="punctuation">(</span><span class="number">500</span><span class="punctuation">,</span>mean <span class="operator">=</span> <span class="number">52</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">				 group<span class="operator">=</span><span class="built_in">rep</span><span class="punctuation">(</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;group2&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span><span class="number">500</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">df <span class="operator">&lt;-</span> rbind<span class="punctuation">(</span>df1<span class="punctuation">,</span>df2<span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">ggplot<span class="punctuation">(</span>df<span class="punctuation">,</span>aes<span class="punctuation">(</span>x<span class="operator">=</span>group<span class="punctuation">,</span>y<span class="operator">=</span>num<span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line"> geom_violin<span class="punctuation">(</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<h3 id="2-箱线图"><a href="#2-箱线图" class="headerlink" title="2. 箱线图"></a>2. 箱线图</h3><p>箱线图通过四分位数描述数据分布，从上到下依次是最大值、上四分位数、中位数、下四分位数、最小值。<br>其中，盒子中间的线表示中位数，盒子的上下边缘表示数据的上下四分位数，盒子上下的线段称为“须”，表示数据的范围。在盒须图中，小圆点表示离群值。</p>
<p>盒须图中的最小值不一定是数据的最小值，因为盒须图是基于数据的分位数绘制的。盒子的下边缘是数据的第一四分位数（即将数据从小到大排列后，第25%位置的数），而须的下端通常是数据中最小的非离群值，也就是大于等于下边缘1.5倍四分位距的最小值。</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">ggplot<span class="punctuation">(</span>df<span class="punctuation">,</span>aes<span class="punctuation">(</span>x<span class="operator">=</span>group<span class="punctuation">,</span>y<span class="operator">=</span>num<span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line"> geom_boxplot<span class="punctuation">(</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<p>有缺口的箱线图</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">ggplot<span class="punctuation">(</span>df<span class="punctuation">,</span>aes<span class="punctuation">(</span>x<span class="operator">=</span>group<span class="punctuation">,</span>y<span class="operator">=</span>num<span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line"> geom_boxplot<span class="punctuation">(</span>notch <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<h3 id="3-抖动散点图"><a href="#3-抖动散点图" class="headerlink" title="3. 抖动散点图"></a>3. 抖动散点图</h3><figure class="highlight r"><table><tr><td class="code"><pre><span class="line">ggplot<span class="punctuation">(</span>df<span class="punctuation">,</span>aes<span class="punctuation">(</span>x<span class="operator">=</span>group<span class="punctuation">,</span>y<span class="operator">=</span>num<span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line"> geom_jitter<span class="punctuation">(</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<p><img src="/pics/2023-04-07-plot7.png" alt="alt 图标"></p>
<h3 id="4-组合图"><a href="#4-组合图" class="headerlink" title="4. 组合图"></a>4. 组合图</h3><h4 id="4-1-小提琴图和箱线图组合"><a href="#4-1-小提琴图和箱线图组合" class="headerlink" title="4.1 小提琴图和箱线图组合"></a>4.1 小提琴图和箱线图组合</h4><figure class="highlight r"><table><tr><td class="code"><pre><span class="line">ggplot<span class="punctuation">(</span>df<span class="punctuation">,</span>aes<span class="punctuation">(</span>x<span class="operator">=</span>group<span class="punctuation">,</span>y<span class="operator">=</span>num<span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line"> geom_violin<span class="punctuation">(</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line"> geom_boxplot<span class="punctuation">(</span>width<span class="operator">=</span><span class="number">0.1</span><span class="punctuation">,</span>position <span class="operator">=</span> position_identity<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line"> stat_summary<span class="punctuation">(</span>fun.y<span class="operator">=</span><span class="string">&quot;mean&quot;</span><span class="punctuation">,</span>geom<span class="operator">=</span><span class="string">&quot;point&quot;</span><span class="punctuation">,</span>shape<span class="operator">=</span><span class="number">23</span><span class="punctuation">,</span>fill<span class="operator">=</span><span class="string">&quot;red&quot;</span><span class="punctuation">,</span>size<span class="operator">=</span><span class="number">2</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<h4 id="4-2-和抖动散点图组合"><a href="#4-2-和抖动散点图组合" class="headerlink" title="4.2 和抖动散点图组合"></a>4.2 和抖动散点图组合</h4><figure class="highlight r"><table><tr><td class="code"><pre><span class="line">ggplot<span class="punctuation">(</span>df<span class="punctuation">,</span>aes<span class="punctuation">(</span>x<span class="operator">=</span>group<span class="punctuation">,</span>y<span class="operator">=</span>num<span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line"> geom_violin<span class="punctuation">(</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line"> geom_jitter<span class="punctuation">(</span>color <span class="operator">=</span> <span class="string">&quot;grey&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">ggplot<span class="punctuation">(</span>df<span class="punctuation">,</span>aes<span class="punctuation">(</span>x<span class="operator">=</span>group<span class="punctuation">,</span>y<span class="operator">=</span>num<span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line"> geom_boxplot<span class="punctuation">(</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line"> geom_jitter<span class="punctuation">(</span>color <span class="operator">=</span> <span class="string">&quot;grey&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<p><img src="/pics/2023-04-07-plot8.png" alt="alt 图标"></p>
]]></content>
      <categories>
        <category>R</category>
        <category>ggplot2</category>
      </categories>
      <tags>
        <tag>R</tag>
        <tag>ggplot2</tag>
      </tags>
  </entry>
  <entry>
    <title>ggplot2集锦之六绘制各种图形3</title>
    <url>/2023/04/07/ggplot2%E9%9B%86%E9%94%A6%E4%B9%8B%E5%85%AD%E7%BB%98%E5%88%B6%E5%90%84%E7%A7%8D%E5%9B%BE%E5%BD%A23/</url>
    <content><![CDATA[<p>本文总结一下ggplot2包绘制各种类型的图，本文包括：饼状图、环状图、雷达图、山峦图。</p>
<span id="more"></span>

<h3 id="1-饼图"><a href="#1-饼图" class="headerlink" title="1. 饼图"></a>1. 饼图</h3><figure class="highlight r"><table><tr><td class="code"><pre><span class="line">pie_df <span class="operator">&lt;-</span> data.frame<span class="punctuation">(</span>group <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;Male&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Female&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Child&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span>value <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">25</span><span class="punctuation">,</span> <span class="number">25</span><span class="punctuation">,</span> <span class="number">50</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">pie_df<span class="operator">$</span>percent <span class="operator">&lt;-</span> paste0<span class="punctuation">(</span>pie_df<span class="operator">$</span>value<span class="punctuation">,</span><span class="string">&quot;%&quot;</span><span class="punctuation">)</span></span><br><span class="line">pie_df</span><br><span class="line">   group value percent</span><br><span class="line"><span class="number">1</span>   Male    <span class="number">25</span>    <span class="number">25</span><span class="operator">%</span></span><br><span class="line"><span class="operator">2 Female    25    25%</span></span><br><span class="line"><span class="number">3</span>  Child    <span class="number">50</span>    <span class="number">50</span>%</span><br></pre></td></tr></table></figure>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">ggplot<span class="punctuation">(</span>pie_df<span class="punctuation">,</span> aes<span class="punctuation">(</span>x<span class="operator">=</span><span class="string">&quot;&quot;</span><span class="punctuation">,</span> y<span class="operator">=</span>value<span class="punctuation">,</span> fill<span class="operator">=</span>group<span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line"> geom_bar<span class="punctuation">(</span>width <span class="operator">=</span> <span class="number">0.5</span><span class="punctuation">,</span> stat <span class="operator">=</span> <span class="string">&quot;identity&quot;</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line"> coord_polar<span class="punctuation">(</span>theta<span class="operator">=</span><span class="string">&#x27;y&#x27;</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line"> theme_void<span class="punctuation">(</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line"> geom_text<span class="punctuation">(</span>aes<span class="punctuation">(</span>y <span class="operator">=</span> value<span class="operator">/</span><span class="number">2</span> <span class="operator">+</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">0</span><span class="punctuation">,</span> <span class="built_in">cumsum</span><span class="punctuation">(</span>value<span class="punctuation">)</span><span class="punctuation">[</span><span class="operator">-</span><span class="built_in">length</span><span class="punctuation">(</span>value<span class="punctuation">)</span><span class="punctuation">]</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">                label <span class="operator">=</span> paste0<span class="punctuation">(</span>group<span class="punctuation">,</span><span class="string">&quot;: &quot;</span><span class="punctuation">,</span> percent<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">,</span> size<span class="operator">=</span><span class="number">5</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><img src="/pics/2023-04-08-plot-pie1.png" alt="alt 图标"></p>
<h3 id="2-环状图"><a href="#2-环状图" class="headerlink" title="2. 环状图"></a>2. 环状图</h3><p>本质是根据y轴进行极坐标转换，因此绘制环状图时，需要一些假数据。</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">pie_df <span class="operator">&lt;-</span> data.frame<span class="punctuation">(</span>group <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;Male&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Female&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Child&quot;</span><span class="punctuation">,</span><span class="string">&quot;Male&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Female&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Child&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span>value <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">25</span><span class="punctuation">,</span><span class="number">25</span><span class="punctuation">,</span><span class="number">50</span><span class="punctuation">,</span><span class="number">0</span><span class="punctuation">,</span><span class="number">0</span><span class="punctuation">,</span><span class="number">0</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">					 x<span class="operator">=</span><span class="built_in">rep</span><span class="punctuation">(</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;T&quot;</span><span class="punctuation">,</span><span class="string">&quot;F&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span>each<span class="operator">=</span><span class="number">3</span><span class="punctuation">)</span><span class="punctuation">,</span>percent<span class="operator">=</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;25%&quot;</span><span class="punctuation">,</span><span class="string">&quot;25%&quot;</span><span class="punctuation">,</span><span class="string">&quot;25%&quot;</span><span class="punctuation">,</span><span class="string">&quot;0&quot;</span><span class="punctuation">,</span><span class="string">&quot;0&quot;</span><span class="punctuation">,</span><span class="string">&quot;0&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">pie_df</span><br><span class="line">   group value x percent</span><br><span class="line"><span class="number">1</span>   Male    <span class="number">25</span> <span class="built_in">T</span>     <span class="number">25</span><span class="operator">%</span></span><br><span class="line"><span class="operator">2 Female    25 T     25%</span></span><br><span class="line"><span class="number">3</span>  Child    <span class="number">50</span> <span class="built_in">T</span>     <span class="number">25</span>%</span><br><span class="line"><span class="number">4</span>   Male     <span class="number">0</span> <span class="built_in">F</span>       <span class="number">0</span></span><br><span class="line"><span class="number">5</span> Female     <span class="number">0</span> <span class="built_in">F</span>       <span class="number">0</span></span><br><span class="line"><span class="number">6</span>  Child     <span class="number">0</span> <span class="built_in">F</span>       <span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>给环状图加标签时，只对真实数据添加label，假数据label设置为空。</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">ggplot<span class="punctuation">(</span>pie_df<span class="punctuation">,</span> aes<span class="punctuation">(</span>x<span class="operator">=</span>x<span class="punctuation">,</span> y<span class="operator">=</span>value<span class="punctuation">,</span> fill<span class="operator">=</span>group<span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line"> geom_bar<span class="punctuation">(</span>width <span class="operator">=</span> <span class="number">0.5</span><span class="punctuation">,</span> stat <span class="operator">=</span> <span class="string">&quot;identity&quot;</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line"> coord_polar<span class="punctuation">(</span>theta<span class="operator">=</span><span class="string">&#x27;y&#x27;</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line"> theme_void<span class="punctuation">(</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line"> geom_text<span class="punctuation">(</span>aes<span class="punctuation">(</span>y <span class="operator">=</span> value<span class="operator">/</span><span class="number">2</span> <span class="operator">+</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">0</span><span class="punctuation">,</span> <span class="built_in">cumsum</span><span class="punctuation">(</span>value<span class="punctuation">)</span><span class="punctuation">[</span><span class="operator">-</span><span class="built_in">length</span><span class="punctuation">(</span>value<span class="punctuation">)</span><span class="punctuation">]</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">                label <span class="operator">=</span> ifelse<span class="punctuation">(</span>value<span class="operator">&gt;</span><span class="number">0</span><span class="punctuation">,</span>paste0<span class="punctuation">(</span>group<span class="punctuation">,</span><span class="string">&quot;: &quot;</span><span class="punctuation">,</span> percent<span class="punctuation">)</span><span class="punctuation">,</span><span class="string">&quot;&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span> size<span class="operator">=</span><span class="number">5</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><img src="/pics/2023-04-08-plot-pie2.png" alt="alt 图标"></p>
<h3 id="3-雷达图"><a href="#3-雷达图" class="headerlink" title="3. 雷达图"></a>3. 雷达图</h3><p>雷达图用ggplot2的扩展包ggradar包绘制。</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">devtools<span class="operator">::</span>install_github<span class="punctuation">(</span><span class="string">&quot;ricardo-bion/ggradar&quot;</span><span class="punctuation">,</span> dependencies<span class="operator">=</span><span class="literal">TRUE</span><span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>ggradar<span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">set.seed<span class="punctuation">(</span><span class="number">123</span><span class="punctuation">)</span></span><br><span class="line">mydata<span class="operator">&lt;-</span>matrix<span class="punctuation">(</span>runif<span class="punctuation">(</span><span class="number">24</span><span class="punctuation">,</span><span class="number">0</span><span class="punctuation">,</span><span class="number">1</span><span class="punctuation">)</span><span class="punctuation">,</span><span class="number">4</span><span class="punctuation">,</span><span class="number">6</span><span class="punctuation">)</span></span><br><span class="line">rownames<span class="punctuation">(</span>mydata<span class="punctuation">)</span> <span class="operator">&lt;-</span> <span class="built_in">LETTERS</span><span class="punctuation">[</span><span class="number">1</span><span class="operator">:</span><span class="number">4</span><span class="punctuation">]</span></span><br><span class="line">colnames<span class="punctuation">(</span>mydata<span class="punctuation">)</span> <span class="operator">&lt;-</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;Chinese&quot;</span><span class="punctuation">,</span><span class="string">&quot;Maths&quot;</span><span class="punctuation">,</span><span class="string">&quot;English&quot;</span><span class="punctuation">,</span><span class="string">&quot;Biology&quot;</span><span class="punctuation">,</span><span class="string">&quot;Art&quot;</span><span class="punctuation">,</span><span class="string">&quot;Physics&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">mydf <span class="operator">&lt;-</span> data.frame<span class="punctuation">(</span>mydata<span class="punctuation">)</span></span><br><span class="line">Name <span class="operator">&lt;-</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;ST1&quot;</span><span class="punctuation">,</span><span class="string">&quot;ST2&quot;</span><span class="punctuation">,</span><span class="string">&quot;ST3&quot;</span><span class="punctuation">,</span><span class="string">&quot;ST4&quot;</span><span class="punctuation">)</span></span><br><span class="line">mydf <span class="operator">&lt;-</span> data.frame<span class="punctuation">(</span>Name<span class="punctuation">,</span>mydf<span class="punctuation">,</span>stringsAsFactors<span class="operator">=</span><span class="literal">FALSE</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">ggradar<span class="punctuation">(</span>mydf<span class="punctuation">,</span>grid.line.width<span class="operator">=</span><span class="number">0.5</span><span class="punctuation">,</span></span><br><span class="line">	background.circle.colour <span class="operator">=</span> <span class="string">&quot;white&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p>但是不知道为什么没有区分颜色，用group.colours也无法修改。<br><img src="/pics/2023-04-08-plot-radar.png" alt="alt 图标"></p>
<h3 id="4-山峦图"><a href="#4-山峦图" class="headerlink" title="4. 山峦图"></a>4. 山峦图</h3><figure class="highlight r"><table><tr><td class="code"><pre><span class="line">library<span class="punctuation">(</span>ggridges<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">head<span class="punctuation">(</span>diamonds<span class="punctuation">)</span></span><br><span class="line"><span class="comment"># A tibble: 6 x 10</span></span><br><span class="line">  carat cut       color clarity depth table price     x     y     z</span><br><span class="line">  <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span> <span class="operator">&lt;</span>ord<span class="operator">&gt;</span>     <span class="operator">&lt;</span>ord<span class="operator">&gt;</span> <span class="operator">&lt;</span>ord<span class="operator">&gt;</span>   <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span> <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span> <span class="operator">&lt;</span>int<span class="operator">&gt;</span> <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span> <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span> <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span></span><br><span class="line"><span class="number">1</span>  <span class="number">0.23</span> Ideal     E     SI2      <span class="number">61.5</span>    <span class="number">55</span>   <span class="number">326</span>  <span class="number">3.95</span>  <span class="number">3.98</span>  <span class="number">2.43</span></span><br><span class="line"><span class="number">2</span>  <span class="number">0.21</span> Premium   E     SI1      <span class="number">59.8</span>    <span class="number">61</span>   <span class="number">326</span>  <span class="number">3.89</span>  <span class="number">3.84</span>  <span class="number">2.31</span></span><br><span class="line"><span class="number">3</span>  <span class="number">0.23</span> Good      E     VS1      <span class="number">56.9</span>    <span class="number">65</span>   <span class="number">327</span>  <span class="number">4.05</span>  <span class="number">4.07</span>  <span class="number">2.31</span></span><br><span class="line"><span class="number">4</span>  <span class="number">0.29</span> Premium   I     VS2      <span class="number">62.4</span>    <span class="number">58</span>   <span class="number">334</span>  <span class="number">4.2</span>   <span class="number">4.23</span>  <span class="number">2.63</span></span><br><span class="line"><span class="number">5</span>  <span class="number">0.31</span> Good      J     SI2      <span class="number">63.3</span>    <span class="number">58</span>   <span class="number">335</span>  <span class="number">4.34</span>  <span class="number">4.35</span>  <span class="number">2.75</span></span><br><span class="line"><span class="number">6</span>  <span class="number">0.24</span> Very Good J     VVS2     <span class="number">62.8</span>    <span class="number">57</span>   <span class="number">336</span>  <span class="number">3.94</span>  <span class="number">3.96</span>  <span class="number">2.48</span></span><br></pre></td></tr></table></figure>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">ggplot<span class="punctuation">(</span>diamonds<span class="punctuation">,</span> aes<span class="punctuation">(</span>x<span class="operator">=</span>price<span class="punctuation">,</span> y<span class="operator">=</span>cut<span class="punctuation">,</span> fill<span class="operator">=</span>cut<span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">     geom_density_ridges<span class="punctuation">(</span>scale<span class="operator">=</span><span class="number">4</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">     scale_fill_cyclical<span class="punctuation">(</span>values <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;blue&quot;</span><span class="punctuation">,</span> <span class="string">&quot;green&quot;</span><span class="punctuation">,</span><span class="string">&quot;red&quot;</span><span class="punctuation">,</span><span class="string">&quot;yellow&quot;</span><span class="punctuation">,</span><span class="string">&quot;purple&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">     theme_ridges<span class="punctuation">(</span>grid <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><img src="/pics/2023-04-08-plot-ridge.png" alt="alt 图标"></p>
<p>通过scale_fill_cyclical()修改颜色，添加图例，并修改图例标签：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">ggplot<span class="punctuation">(</span>diamonds<span class="punctuation">,</span> aes<span class="punctuation">(</span>x<span class="operator">=</span>price<span class="punctuation">,</span> y<span class="operator">=</span>cut<span class="punctuation">,</span> fill<span class="operator">=</span>cut<span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">  geom_density_ridges<span class="punctuation">(</span>scale<span class="operator">=</span><span class="number">4</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">  scale_fill_cyclical<span class="punctuation">(</span>values <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;blue&quot;</span><span class="punctuation">,</span> <span class="string">&quot;green&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span> guide<span class="operator">=</span><span class="string">&quot;legend&quot;</span><span class="punctuation">,</span></span><br><span class="line">                      labels<span class="operator">=</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;Fair&quot;</span><span class="operator">=</span><span class="string">&quot;blue&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Good&quot;</span><span class="operator">=</span><span class="string">&quot;green&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">                      name<span class="operator">=</span><span class="string">&quot;Fill colors&quot;</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">  theme_ridges<span class="punctuation">(</span>grid <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<p>修改颜色透明度，以及x轴的范围</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">ggplot<span class="punctuation">(</span>diamonds<span class="punctuation">,</span> aes<span class="punctuation">(</span>x<span class="operator">=</span>price<span class="punctuation">,</span> y<span class="operator">=</span>cut<span class="punctuation">,</span> fill<span class="operator">=</span>cut<span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">  geom_density_ridges<span class="punctuation">(</span>scale<span class="operator">=</span><span class="number">4</span><span class="punctuation">,</span>alpha<span class="operator">=</span><span class="number">0.5</span><span class="punctuation">,</span>from<span class="operator">=</span><span class="number">0</span><span class="punctuation">,</span>to<span class="operator">=</span><span class="number">15000</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">  scale_fill_cyclical<span class="punctuation">(</span>values <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;blue&quot;</span><span class="punctuation">,</span> <span class="string">&quot;green&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span> guide<span class="operator">=</span><span class="string">&quot;legend&quot;</span><span class="punctuation">,</span></span><br><span class="line">                      labels<span class="operator">=</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;Fair&quot;</span><span class="operator">=</span><span class="string">&quot;blue&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Good&quot;</span><span class="operator">=</span><span class="string">&quot;green&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">                      name<span class="operator">=</span><span class="string">&quot;Fill colors&quot;</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">  theme_ridges<span class="punctuation">(</span>grid <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<p><img src="/pics/2023-04-08-plot-ridge2.png" alt="alt 图标"></p>
]]></content>
      <categories>
        <category>R</category>
        <category>ggplot2</category>
      </categories>
      <tags>
        <tag>R</tag>
        <tag>ggplot2</tag>
      </tags>
  </entry>
  <entry>
    <title>ggplot2集锦之六绘制各种图形4</title>
    <url>/2023/04/10/ggplot2%E9%9B%86%E9%94%A6%E4%B9%8B%E5%85%AD%E7%BB%98%E5%88%B6%E5%90%84%E7%A7%8D%E5%9B%BE%E5%BD%A24/</url>
    <content><![CDATA[<p>本文总结一下基于ggplot2包绘制各种类型的图，本文包括：棒棒糖图、哑铃图。</p>
<span id="more"></span>

<h3 id="1-棒棒糖图"><a href="#1-棒棒糖图" class="headerlink" title="1. 棒棒糖图"></a>1. 棒棒糖图</h3><p>棒棒糖图本质是点图加上柱状图&#x2F;线段。</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">data <span class="operator">&lt;-</span> diamond<span class="punctuation">[</span><span class="built_in">c</span><span class="punctuation">(</span><span class="number">1</span><span class="operator">:</span><span class="number">10</span><span class="punctuation">)</span><span class="punctuation">,</span><span class="punctuation">]</span></span><br><span class="line">data<span class="operator">$</span>name <span class="operator">&lt;-</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;A&quot;</span><span class="punctuation">,</span><span class="string">&quot;B&quot;</span><span class="punctuation">,</span><span class="string">&quot;C&quot;</span><span class="punctuation">,</span><span class="string">&quot;D&quot;</span><span class="punctuation">,</span><span class="string">&quot;E&quot;</span><span class="punctuation">,</span><span class="string">&quot;F&quot;</span><span class="punctuation">,</span><span class="string">&quot;G&quot;</span><span class="punctuation">,</span><span class="string">&quot;H&quot;</span><span class="punctuation">,</span><span class="string">&quot;I&quot;</span><span class="punctuation">,</span><span class="string">&quot;J&quot;</span><span class="punctuation">)</span></span><br><span class="line">data</span><br><span class="line"><span class="comment"># A tibble: 10 x 11</span></span><br><span class="line">   carat cut       color clarity depth table price     x     y     z name </span><br><span class="line">   <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span> <span class="operator">&lt;</span>ord<span class="operator">&gt;</span>     <span class="operator">&lt;</span>ord<span class="operator">&gt;</span> <span class="operator">&lt;</span>ord<span class="operator">&gt;</span>   <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span> <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span> <span class="operator">&lt;</span>int<span class="operator">&gt;</span> <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span> <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span> <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span> <span class="operator">&lt;</span>chr<span class="operator">&gt;</span></span><br><span class="line"> <span class="number">1</span>  <span class="number">0.61</span> Good      E     I1       <span class="number">63.4</span>  <span class="number">57.1</span>  <span class="number">1168</span>  <span class="number">5.37</span>  <span class="number">5.43</span>  <span class="number">3.42</span> A    </span><br><span class="line"> <span class="number">2</span>  <span class="number">0.53</span> Premium   G     SI2      <span class="number">60.8</span>  <span class="number">58</span>    <span class="number">1173</span>  <span class="number">5.21</span>  <span class="number">5.19</span>  <span class="number">3.16</span> B    </span><br><span class="line"> <span class="number">3</span>  <span class="number">0.23</span> Very Good E     VVS2     <span class="number">62.3</span>  <span class="number">55</span>     <span class="number">505</span>  <span class="number">3.9</span>   <span class="number">3.93</span>  <span class="number">2.44</span> C    </span><br><span class="line"> <span class="number">4</span>  <span class="number">1.33</span> Ideal     J     VS1      <span class="number">61.3</span>  <span class="number">57</span>    <span class="number">6118</span>  <span class="number">7.11</span>  <span class="number">7.08</span>  <span class="number">4.35</span> D    </span><br><span class="line"> <span class="number">5</span>  <span class="number">0.3</span>  Ideal     E     VVS1     <span class="number">61.6</span>  <span class="number">56</span>     <span class="number">838</span>  <span class="number">4.3</span>   <span class="number">4.34</span>  <span class="number">2.66</span> E    </span><br><span class="line"> <span class="number">6</span>  <span class="number">0.3</span>  Ideal     D     VS2      <span class="number">60.8</span>  <span class="number">57</span>     <span class="number">911</span>  <span class="number">4.34</span>  <span class="number">4.31</span>  <span class="number">2.63</span> <span class="built_in">F</span>    </span><br><span class="line"> <span class="number">7</span>  <span class="number">2.01</span> Good      H     I1       <span class="number">63.9</span>  <span class="number">59</span>    <span class="number">7024</span>  <span class="number">8.01</span>  <span class="number">7.92</span>  <span class="number">5.09</span> G    </span><br><span class="line"> <span class="number">8</span>  <span class="number">1.12</span> Ideal     H     VS2      <span class="number">61.8</span>  <span class="number">55</span>    <span class="number">6110</span>  <span class="number">6.64</span>  <span class="number">6.7</span>   <span class="number">4.12</span> H    </span><br><span class="line"> <span class="number">9</span>  <span class="number">1.02</span> Ideal     G     VVS2     <span class="number">62.1</span>  <span class="number">57</span>    <span class="number">8401</span>  <span class="number">6.43</span>  <span class="number">6.45</span>  <span class="number">4</span>    I    </span><br><span class="line"><span class="number">10</span>  <span class="number">0.74</span> Ideal     <span class="built_in">F</span>     VS1      <span class="number">62.3</span>  <span class="number">56</span>    <span class="number">3226</span>  <span class="number">5.76</span>  <span class="number">5.79</span>  <span class="number">3.6</span>  J    </span><br></pre></td></tr></table></figure>
<p>绘制散点加线段。</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">ggplot<span class="punctuation">(</span>data<span class="punctuation">,</span>aes<span class="punctuation">(</span>x <span class="operator">=</span> reorder<span class="punctuation">(</span>name<span class="punctuation">,</span>price<span class="punctuation">)</span><span class="punctuation">,</span>y <span class="operator">=</span> price<span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line"> geom_point<span class="punctuation">(</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line"> geom_segment<span class="punctuation">(</span>aes<span class="punctuation">(</span>x <span class="operator">=</span> name<span class="punctuation">,</span>xend<span class="operator">=</span>name<span class="punctuation">,</span>y<span class="operator">=</span><span class="number">0</span><span class="punctuation">,</span>yend<span class="operator">=</span>price<span class="punctuation">)</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p>修改y轴基线更改设定的阈值。</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">ggplot<span class="punctuation">(</span>data<span class="punctuation">,</span>aes<span class="punctuation">(</span>x <span class="operator">=</span> reorder<span class="punctuation">(</span>name<span class="punctuation">,</span>price<span class="punctuation">)</span><span class="punctuation">,</span>y <span class="operator">=</span> price<span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line"> geom_point<span class="punctuation">(</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line"> geom_segment<span class="punctuation">(</span>aes<span class="punctuation">(</span>x <span class="operator">=</span> name<span class="punctuation">,</span>xend<span class="operator">=</span>name<span class="punctuation">,</span>y<span class="operator">=</span><span class="number">2000</span><span class="punctuation">,</span>yend<span class="operator">=</span>price<span class="punctuation">)</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p>美化：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">ggplot<span class="punctuation">(</span>data<span class="punctuation">,</span>aes<span class="punctuation">(</span>x <span class="operator">=</span> reorder<span class="punctuation">(</span>name<span class="punctuation">,</span>price<span class="punctuation">)</span><span class="punctuation">,</span>y <span class="operator">=</span> price<span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line"> geom_segment<span class="punctuation">(</span>aes<span class="punctuation">(</span>x <span class="operator">=</span> reorder<span class="punctuation">(</span>name<span class="punctuation">,</span>price<span class="punctuation">)</span><span class="punctuation">,</span>xend<span class="operator">=</span>name<span class="punctuation">,</span>y<span class="operator">=</span><span class="number">2000</span><span class="punctuation">,</span>yend<span class="operator">=</span>price<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line"> 	linewidth<span class="operator">=</span><span class="number">1.5</span><span class="punctuation">,</span>color<span class="operator">=</span><span class="string">&quot;#C9CACA&quot;</span><span class="punctuation">,</span>linetype<span class="operator">=</span><span class="string">&quot;solid&quot;</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line"> geom_point<span class="punctuation">(</span>size<span class="operator">=</span><span class="number">5</span><span class="punctuation">,</span>color<span class="operator">=</span><span class="string">&quot;#74C6BE&quot;</span><span class="punctuation">,</span>fill<span class="operator">=</span><span class="string">&quot;#74C6BE&quot;</span><span class="punctuation">,</span>shape<span class="operator">=</span><span class="number">21</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p>翻转，横向棒棒糖图：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">ggplot<span class="punctuation">(</span>data<span class="punctuation">,</span>aes<span class="punctuation">(</span>x <span class="operator">=</span> reorder<span class="punctuation">(</span>name<span class="punctuation">,</span>price<span class="punctuation">)</span><span class="punctuation">,</span>y <span class="operator">=</span> price<span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line"> geom_segment<span class="punctuation">(</span>aes<span class="punctuation">(</span>x <span class="operator">=</span> reorder<span class="punctuation">(</span>name<span class="punctuation">,</span>price<span class="punctuation">)</span><span class="punctuation">,</span>xend<span class="operator">=</span>name<span class="punctuation">,</span>y<span class="operator">=</span><span class="number">2000</span><span class="punctuation">,</span>yend<span class="operator">=</span>price<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line"> 	linewidth<span class="operator">=</span><span class="number">1.5</span><span class="punctuation">,</span>color<span class="operator">=</span><span class="string">&quot;#C9CACA&quot;</span><span class="punctuation">,</span>linetype<span class="operator">=</span><span class="string">&quot;solid&quot;</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line"> geom_point<span class="punctuation">(</span>size<span class="operator">=</span><span class="number">5</span><span class="punctuation">,</span>color<span class="operator">=</span><span class="string">&quot;#74C6BE&quot;</span><span class="punctuation">,</span>fill<span class="operator">=</span><span class="string">&quot;#74C6BE&quot;</span><span class="punctuation">,</span>shape<span class="operator">=</span><span class="number">21</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line"> coord_flip<span class="punctuation">(</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><img src="/pics/2023-04-10-plot-bbt1.png" alt="alt 图标"></p>
<p>ifelse修改指定感兴趣的点的样式：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">ggplot<span class="punctuation">(</span>data<span class="punctuation">,</span>aes<span class="punctuation">(</span>x <span class="operator">=</span> reorder<span class="punctuation">(</span>name<span class="punctuation">,</span>price<span class="punctuation">)</span><span class="punctuation">,</span>y <span class="operator">=</span> price<span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line"> geom_segment<span class="punctuation">(</span>aes<span class="punctuation">(</span>x <span class="operator">=</span> reorder<span class="punctuation">(</span>name<span class="punctuation">,</span>price<span class="punctuation">)</span><span class="punctuation">,</span>xend<span class="operator">=</span>name<span class="punctuation">,</span>y<span class="operator">=</span><span class="number">0</span><span class="punctuation">,</span>yend<span class="operator">=</span>price<span class="punctuation">)</span><span class="punctuation">,</span> </span><br><span class="line"> 	size<span class="operator">=</span>ifelse<span class="punctuation">(</span>data<span class="operator">$</span>name<span class="operator">%in%</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;A&quot;</span><span class="punctuation">,</span><span class="string">&quot;I&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span><span class="number">3</span><span class="punctuation">,</span><span class="number">1.5</span><span class="punctuation">)</span><span class="punctuation">,</span> </span><br><span class="line"> 	color<span class="operator">=</span>ifelse<span class="punctuation">(</span>data<span class="operator">$</span>name<span class="operator">%in%</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;A&quot;</span><span class="punctuation">,</span><span class="string">&quot;I&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span><span class="string">&quot;#f6b37f&quot;</span><span class="punctuation">,</span><span class="string">&quot;#C9CACA&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line"> geom_point<span class="punctuation">(</span>size<span class="operator">=</span>ifelse<span class="punctuation">(</span>data<span class="operator">$</span>name<span class="operator">%in%</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;A&quot;</span><span class="punctuation">,</span><span class="string">&quot;I&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span><span class="number">8</span><span class="punctuation">,</span><span class="number">5</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line"> 	color<span class="operator">=</span>ifelse<span class="punctuation">(</span>data<span class="operator">$</span>name<span class="operator">%in%</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;A&quot;</span><span class="punctuation">,</span><span class="string">&quot;I&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span><span class="string">&quot;#f6b37f&quot;</span><span class="punctuation">,</span><span class="string">&quot;#74C6BE&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span> </span><br><span class="line"> 	fill<span class="operator">=</span>ifelse<span class="punctuation">(</span>data<span class="operator">$</span>name<span class="operator">%in%</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;A&quot;</span><span class="punctuation">,</span><span class="string">&quot;I&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span><span class="string">&quot;#f6b37f&quot;</span><span class="punctuation">,</span><span class="string">&quot;#74C6BE&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line"> coord_flip<span class="punctuation">(</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><img src="/pics/2023-04-10-plot-bbt3.png" alt="alt 图标"></p>
<p>如果想要不同的颜色，那么加一个分组变量即可。</p>
<h3 id="2-哑铃图"><a href="#2-哑铃图" class="headerlink" title="2. 哑铃图"></a>2. 哑铃图</h3><p>哑铃图本质是不同分组的点图加两个点之间的线段。</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">data</span><br><span class="line">name	group1	group2</span><br><span class="line">A	<span class="number">100</span>	<span class="number">200</span></span><br><span class="line">B 	<span class="number">129</span>	<span class="number">389</span></span><br></pre></td></tr></table></figure>
<p>构造数据：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">data<span class="operator">$</span>price2 <span class="operator">&lt;-</span> data<span class="operator">$</span>price<span class="operator">/</span><span class="number">2</span></span><br><span class="line"></span><br><span class="line">ggplot<span class="punctuation">(</span>data<span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line"> geom_segment<span class="punctuation">(</span>aes<span class="punctuation">(</span>x<span class="operator">=</span>reorder<span class="punctuation">(</span>name<span class="punctuation">,</span>price<span class="punctuation">)</span><span class="punctuation">,</span> xend<span class="operator">=</span>reorder<span class="punctuation">(</span>name<span class="punctuation">,</span>price<span class="punctuation">)</span><span class="punctuation">,</span>y<span class="operator">=</span>price<span class="punctuation">,</span>yend<span class="operator">=</span>price2<span class="punctuation">)</span><span class="punctuation">,</span>color<span class="operator">=</span><span class="string">&quot;grey&quot;</span><span class="punctuation">,</span>linewidth<span class="operator">=</span><span class="number">1.5</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line"> geom_point<span class="punctuation">(</span>aes<span class="punctuation">(</span>x<span class="operator">=</span>reorder<span class="punctuation">(</span>name<span class="punctuation">,</span>price<span class="punctuation">)</span><span class="punctuation">,</span> y<span class="operator">=</span>price<span class="punctuation">)</span><span class="punctuation">,</span>color<span class="operator">=</span><span class="string">&quot;#A4B8F7&quot;</span><span class="punctuation">,</span>size<span class="operator">=</span><span class="number">5</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line"> geom_point<span class="punctuation">(</span>aes<span class="punctuation">(</span>x<span class="operator">=</span>reorder<span class="punctuation">(</span>name<span class="punctuation">,</span>price<span class="punctuation">)</span><span class="punctuation">,</span> y<span class="operator">=</span>price2<span class="punctuation">)</span><span class="punctuation">,</span>color<span class="operator">=</span><span class="string">&quot;#F484B2&quot;</span><span class="punctuation">,</span>size<span class="operator">=</span><span class="number">5</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line"> coord_flip<span class="punctuation">(</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><img src="/pics/2023-04-10-plot-bbt2.png" alt="alt 图标"></p>
<p>参考资料：</p>
<ol>
<li><a href="https://zhuanlan.zhihu.com/p/448849834">https://zhuanlan.zhihu.com/p/448849834</a></li>
</ol>
]]></content>
      <categories>
        <category>R</category>
        <category>ggplot2</category>
      </categories>
      <tags>
        <tag>R</tag>
        <tag>ggplot2</tag>
      </tags>
  </entry>
  <entry>
    <title>R语言绘制韦恩图和upset图</title>
    <url>/2023/04/10/R%E8%AF%AD%E8%A8%80%E7%BB%98%E5%88%B6%E9%9F%A6%E6%81%A9%E5%9B%BE%E5%92%8Cupset%E5%9B%BE/</url>
    <content><![CDATA[<p>本文总结一下：韦恩图、upset图。</p>
<span id="more"></span>

<h3 id="1-韦恩图"><a href="#1-韦恩图" class="headerlink" title="1. 韦恩图"></a>1. 韦恩图</h3><h4 id="1-1-ggvenn"><a href="#1-1-ggvenn" class="headerlink" title="1.1 ggvenn"></a>1.1 ggvenn</h4><p>利用ggvenn绘制韦恩图，ggvenn的输入是一个list。</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">library<span class="punctuation">(</span>ggvenn<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">a <span class="operator">&lt;-</span> <span class="built_in">list</span><span class="punctuation">(</span>A<span class="operator">=</span><span class="built_in">c</span><span class="punctuation">(</span><span class="number">1</span><span class="punctuation">,</span><span class="number">2</span><span class="punctuation">,</span><span class="number">3</span><span class="punctuation">,</span><span class="number">5</span><span class="punctuation">,</span><span class="number">7</span><span class="punctuation">)</span><span class="punctuation">,</span>B<span class="operator">=</span><span class="built_in">c</span><span class="punctuation">(</span><span class="number">2</span><span class="punctuation">,</span><span class="number">3</span><span class="punctuation">,</span><span class="number">4</span><span class="punctuation">,</span><span class="number">1</span><span class="punctuation">,</span><span class="number">6</span><span class="punctuation">)</span><span class="punctuation">,</span>C<span class="operator">=</span><span class="built_in">c</span><span class="punctuation">(</span><span class="number">2</span><span class="punctuation">,</span><span class="number">3</span><span class="punctuation">,</span><span class="number">7</span><span class="punctuation">,</span><span class="number">6</span><span class="punctuation">,</span><span class="number">8</span><span class="punctuation">)</span><span class="punctuation">,</span>D<span class="operator">=</span><span class="built_in">c</span><span class="punctuation">(</span><span class="number">1</span><span class="punctuation">,</span><span class="number">2</span><span class="punctuation">,</span><span class="number">5</span><span class="punctuation">,</span><span class="number">6</span><span class="punctuation">,</span><span class="number">3</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p>ggvenn默认将所有的set都绘制韦恩图，也可以通过set名字指定数据集绘制韦恩图。</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">ggvenn<span class="punctuation">(</span>a<span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><img src="/pics/2023-04-11-venn1.png" alt="alt 图标"></p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">ggvenn<span class="punctuation">(</span>a<span class="punctuation">,</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;A&quot;</span><span class="punctuation">,</span><span class="string">&quot;B&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><img src="/pics/2023-04-11-venn2.png" alt="alt 图标"></p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">ggvenn<span class="punctuation">(</span>a<span class="punctuation">,</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;A&quot;</span><span class="punctuation">,</span><span class="string">&quot;B&quot;</span><span class="punctuation">,</span><span class="string">&quot;C&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><img src="/pics/2023-04-11-venn3.png" alt="alt 图标"><br>美化一下：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line"><span class="built_in">list</span><span class="punctuation">(</span>A<span class="operator">=</span>a<span class="punctuation">[[</span><span class="number">1</span><span class="punctuation">]</span><span class="punctuation">]</span><span class="punctuation">,</span>B<span class="operator">=</span>a<span class="punctuation">[[</span><span class="number">2</span><span class="punctuation">]</span><span class="punctuation">]</span><span class="punctuation">,</span>C<span class="operator">=</span>a<span class="punctuation">[[</span><span class="number">3</span><span class="punctuation">]</span><span class="punctuation">]</span><span class="punctuation">,</span>D<span class="operator">=</span>a<span class="punctuation">[[</span><span class="number">4</span><span class="punctuation">]</span><span class="punctuation">]</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span> </span><br><span class="line">  ggvenn<span class="punctuation">(</span>show_percentage <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">,</span>show_elements <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span>label_sep <span class="operator">=</span> <span class="string">&quot;,&quot;</span><span class="punctuation">,</span></span><br><span class="line">         digits <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span>stroke_color <span class="operator">=</span> <span class="string">&quot;white&quot;</span><span class="punctuation">,</span></span><br><span class="line">         fill_color <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;#E41A1C&quot;</span><span class="punctuation">,</span> <span class="string">&quot;#1E90FF&quot;</span><span class="punctuation">,</span> </span><br><span class="line">                        <span class="string">&quot;#FF8C00&quot;</span><span class="punctuation">,</span><span class="string">&quot;#4DAF4A&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">         set_name_color <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;#E41A1C&quot;</span><span class="punctuation">,</span> <span class="string">&quot;#1E90FF&quot;</span><span class="punctuation">,</span><span class="string">&quot;#FF8C00&quot;</span><span class="punctuation">,</span><span class="string">&quot;#4DAF4A&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><img src="/pics/2023-04-11-venn4.png" alt="alt 图标"></p>
<h4 id="1-2-VennDiagram"><a href="#1-2-VennDiagram" class="headerlink" title="1.2 VennDiagram"></a>1.2 VennDiagram</h4><p>利用VennDiagram包绘制韦恩图,会保存到文件里。</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">venn.plot <span class="operator">&lt;-</span> venn.diagram<span class="punctuation">(</span></span><br><span class="line">  x <span class="operator">=</span> <span class="built_in">list</span><span class="punctuation">(</span>A<span class="operator">=</span><span class="built_in">c</span><span class="punctuation">(</span><span class="number">1</span><span class="punctuation">,</span><span class="number">2</span><span class="punctuation">,</span><span class="number">3</span><span class="punctuation">,</span><span class="number">5</span><span class="punctuation">,</span><span class="number">7</span><span class="punctuation">)</span><span class="punctuation">,</span>B<span class="operator">=</span><span class="built_in">c</span><span class="punctuation">(</span><span class="number">2</span><span class="punctuation">,</span><span class="number">3</span><span class="punctuation">,</span><span class="number">4</span><span class="punctuation">,</span><span class="number">1</span><span class="punctuation">,</span><span class="number">6</span><span class="punctuation">)</span><span class="punctuation">,</span>C<span class="operator">=</span><span class="built_in">c</span><span class="punctuation">(</span><span class="number">2</span><span class="punctuation">,</span><span class="number">3</span><span class="punctuation">,</span><span class="number">7</span><span class="punctuation">,</span><span class="number">6</span><span class="punctuation">,</span><span class="number">8</span><span class="punctuation">)</span><span class="punctuation">,</span>D<span class="operator">=</span><span class="built_in">c</span><span class="punctuation">(</span><span class="number">1</span><span class="punctuation">,</span><span class="number">2</span><span class="punctuation">,</span><span class="number">5</span><span class="punctuation">,</span><span class="number">6</span><span class="punctuation">,</span><span class="number">3</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">  filename <span class="operator">=</span> <span class="string">&quot;Venn.png&quot;</span><span class="punctuation">,</span> imagetype <span class="operator">=</span> <span class="string">&quot;png&quot;</span><span class="punctuation">,</span></span><br><span class="line">  lwd <span class="operator">=</span> <span class="number">3</span><span class="punctuation">,</span> lty<span class="operator">=</span><span class="string">&quot;dotted&quot;</span><span class="punctuation">,</span></span><br><span class="line">  fill <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;#E41A1C&quot;</span><span class="punctuation">,</span> <span class="string">&quot;#1E90FF&quot;</span><span class="punctuation">,</span><span class="string">&quot;#FF8C00&quot;</span><span class="punctuation">,</span><span class="string">&quot;#4DAF4A&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">  alpha <span class="operator">=</span> <span class="number">0.6</span><span class="punctuation">,</span></span><br><span class="line">  label.col <span class="operator">=</span> <span class="string">&quot;white&quot;</span><span class="punctuation">,</span></span><br><span class="line">  cex <span class="operator">=</span> <span class="number">1.5</span><span class="punctuation">,</span></span><br><span class="line">  fontfamily <span class="operator">=</span> <span class="string">&quot;serif&quot;</span><span class="punctuation">,</span></span><br><span class="line">  fontface <span class="operator">=</span> <span class="string">&quot;bold&quot;</span><span class="punctuation">,</span></span><br><span class="line">  cat.col <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;#E41A1C&quot;</span><span class="punctuation">,</span> <span class="string">&quot;#1E90FF&quot;</span><span class="punctuation">,</span><span class="string">&quot;#FF8C00&quot;</span><span class="punctuation">,</span><span class="string">&quot;#4DAF4A&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">  cat.cex <span class="operator">=</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">  cat.fontfamily <span class="operator">=</span> <span class="string">&quot;serif&quot;</span><span class="punctuation">,</span></span><br><span class="line">  cat.fontface <span class="operator">=</span> <span class="string">&quot;bold&quot;</span><span class="punctuation">,</span></span><br><span class="line">  margin <span class="operator">=</span> <span class="number">0.05</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><img src="/pics/2023-04-11-venn5.png" alt="alt 图标"></p>
<h4 id="1-3-VennDiagram提取交集元素"><a href="#1-3-VennDiagram提取交集元素" class="headerlink" title="1.3 VennDiagram提取交集元素"></a>1.3 VennDiagram提取交集元素</h4><p>VennDiagram包中的函数get.venn.partitions()可以实现这个功能：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">venn_list <span class="operator">&lt;-</span> <span class="built_in">list</span><span class="punctuation">(</span>A<span class="operator">=</span><span class="built_in">c</span><span class="punctuation">(</span><span class="number">1</span><span class="punctuation">,</span><span class="number">2</span><span class="punctuation">,</span><span class="number">3</span><span class="punctuation">,</span><span class="number">5</span><span class="punctuation">,</span><span class="number">7</span><span class="punctuation">)</span><span class="punctuation">,</span>B<span class="operator">=</span><span class="built_in">c</span><span class="punctuation">(</span><span class="number">2</span><span class="punctuation">,</span><span class="number">3</span><span class="punctuation">,</span><span class="number">4</span><span class="punctuation">,</span><span class="number">1</span><span class="punctuation">,</span><span class="number">6</span><span class="punctuation">)</span><span class="punctuation">,</span>C<span class="operator">=</span><span class="built_in">c</span><span class="punctuation">(</span><span class="number">2</span><span class="punctuation">,</span><span class="number">3</span><span class="punctuation">,</span><span class="number">7</span><span class="punctuation">,</span><span class="number">6</span><span class="punctuation">,</span><span class="number">8</span><span class="punctuation">)</span><span class="punctuation">,</span>D<span class="operator">=</span><span class="built_in">c</span><span class="punctuation">(</span><span class="number">1</span><span class="punctuation">,</span><span class="number">2</span><span class="punctuation">,</span><span class="number">5</span><span class="punctuation">,</span><span class="number">6</span><span class="punctuation">,</span><span class="number">3</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">inter <span class="operator">&lt;-</span> get.venn.partitions<span class="punctuation">(</span>venn_list<span class="punctuation">)</span></span><br><span class="line"><span class="keyword">for</span> <span class="punctuation">(</span>i <span class="keyword">in</span> <span class="number">1</span><span class="operator">:</span>nrow<span class="punctuation">(</span>inter<span class="punctuation">)</span><span class="punctuation">)</span> inter<span class="punctuation">[</span>i<span class="punctuation">,</span><span class="string">&#x27;values&#x27;</span><span class="punctuation">]</span> <span class="operator">&lt;-</span> paste<span class="punctuation">(</span>inter<span class="punctuation">[[</span>i<span class="punctuation">,</span><span class="string">&#x27;..values..&#x27;</span><span class="punctuation">]</span><span class="punctuation">]</span><span class="punctuation">,</span> collapse <span class="operator">=</span> <span class="string">&#x27;, &#x27;</span><span class="punctuation">)</span></span><br><span class="line">write.table<span class="punctuation">(</span>inter<span class="punctuation">[</span><span class="operator">-</span><span class="built_in">c</span><span class="punctuation">(</span><span class="number">5</span><span class="punctuation">,</span> <span class="number">6</span><span class="punctuation">)</span><span class="punctuation">]</span><span class="punctuation">,</span> <span class="string">&#x27;venn4_inter.txt&#x27;</span><span class="punctuation">,</span> row.names <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">,</span> sep <span class="operator">=</span> <span class="string">&#x27;\t&#x27;</span><span class="punctuation">,</span> <span class="built_in">quote</span> <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p>venn4_inter.txt结果如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">A       B       C       D       ..count..       values</span><br><span class="line">TRUE    TRUE    TRUE    TRUE    2       2, 3</span><br><span class="line">FALSE   TRUE    TRUE    TRUE    1       6</span><br><span class="line">TRUE    FALSE   TRUE    TRUE    0</span><br><span class="line">FALSE   FALSE   TRUE    TRUE    0</span><br><span class="line">TRUE    TRUE    FALSE   TRUE    1       1</span><br><span class="line">FALSE   TRUE    FALSE   TRUE    0</span><br><span class="line">TRUE    FALSE   FALSE   TRUE    1       5</span><br><span class="line">FALSE   FALSE   FALSE   TRUE    0</span><br><span class="line">TRUE    TRUE    TRUE    FALSE   0</span><br><span class="line">FALSE   TRUE    TRUE    FALSE   0</span><br><span class="line">TRUE    FALSE   TRUE    FALSE   1       7</span><br><span class="line">FALSE   FALSE   TRUE    FALSE   1       8</span><br><span class="line">TRUE    TRUE    FALSE   FALSE   0</span><br><span class="line">FALSE   TRUE    FALSE   FALSE   1       4</span><br><span class="line">TRUE    FALSE   FALSE   FALSE   0</span><br></pre></td></tr></table></figure>

<h3 id="2-upset图"><a href="#2-upset图" class="headerlink" title="2. upset图"></a>2. upset图</h3><p>UpSetR 提供了两个转换函数 fromList 和 fromExpression 用于格式化数据。</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">venn_list <span class="operator">&lt;-</span> <span class="built_in">list</span><span class="punctuation">(</span>A<span class="operator">=</span><span class="built_in">c</span><span class="punctuation">(</span><span class="number">1</span><span class="punctuation">,</span><span class="number">2</span><span class="punctuation">,</span><span class="number">3</span><span class="punctuation">,</span><span class="number">5</span><span class="punctuation">,</span><span class="number">7</span><span class="punctuation">,</span><span class="number">9</span><span class="punctuation">,</span><span class="number">10</span><span class="punctuation">)</span><span class="punctuation">,</span>B<span class="operator">=</span><span class="built_in">c</span><span class="punctuation">(</span><span class="number">2</span><span class="punctuation">,</span><span class="number">3</span><span class="punctuation">,</span><span class="number">4</span><span class="punctuation">,</span><span class="number">1</span><span class="punctuation">,</span><span class="number">6</span><span class="punctuation">)</span><span class="punctuation">,</span>C<span class="operator">=</span><span class="built_in">c</span><span class="punctuation">(</span><span class="number">2</span><span class="punctuation">,</span><span class="number">3</span><span class="punctuation">,</span><span class="number">7</span><span class="punctuation">,</span><span class="number">8</span><span class="punctuation">)</span><span class="punctuation">,</span>D<span class="operator">=</span><span class="built_in">c</span><span class="punctuation">(</span><span class="number">1</span><span class="punctuation">,</span><span class="number">2</span><span class="punctuation">,</span><span class="number">5</span><span class="punctuation">,</span><span class="number">6</span><span class="punctuation">,</span><span class="number">3</span><span class="punctuation">,</span><span class="number">5</span><span class="punctuation">,</span><span class="number">8</span><span class="punctuation">,</span><span class="number">10</span><span class="punctuation">,</span><span class="number">14</span><span class="punctuation">,</span><span class="number">15</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">upset<span class="punctuation">(</span>fromList<span class="punctuation">(</span>venn_list<span class="punctuation">)</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p>等价于：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">b <span class="operator">&lt;-</span> fromList<span class="punctuation">(</span>venn_list<span class="punctuation">)</span></span><br><span class="line">upset<span class="punctuation">(</span>b<span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><img src="/pics/2023-04-11-upset1.png" alt="alt 图标"></p>
<p>order.by默认升序排列，降序排列加decreasing&#x3D;FALSE:</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">upset<span class="punctuation">(</span>fromList<span class="punctuation">(</span>venn_list<span class="punctuation">)</span><span class="punctuation">,</span> order.by <span class="operator">=</span> <span class="string">&quot;freq&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><img src="/pics/2023-04-11-upset2.png" alt="alt 图标"></p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">upset<span class="punctuation">(</span>fromList<span class="punctuation">(</span>venn_list<span class="punctuation">)</span><span class="punctuation">,</span> order.by <span class="operator">=</span> <span class="string">&quot;freq&quot;</span><span class="punctuation">,</span>descreasing <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><img src="/pics/2023-04-11-upset3.png" alt="alt 图标"></p>
<p>绘制部分集合：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">upset<span class="punctuation">(</span>fromList<span class="punctuation">(</span>venn_list<span class="punctuation">)</span><span class="punctuation">,</span> nsets<span class="operator">=</span><span class="number">2</span><span class="punctuation">,</span> order.by <span class="operator">=</span> <span class="string">&quot;freq&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><img src="/pics/2023-04-11-upset4.png" alt="alt 图标"></p>
<p>美化：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">upset<span class="punctuation">(</span>fromList<span class="punctuation">(</span>venn_list<span class="punctuation">)</span><span class="punctuation">,</span> nsets <span class="operator">=</span> <span class="number">6</span><span class="punctuation">,</span> </span><br><span class="line">      number.angles <span class="operator">=</span> <span class="number">30</span><span class="punctuation">,</span> <span class="comment"># 柱子上方数字倾斜角度</span></span><br><span class="line">      point.size <span class="operator">=</span> <span class="number">3.5</span><span class="punctuation">,</span>  <span class="comment"># 点的大小</span></span><br><span class="line">      line.size <span class="operator">=</span> <span class="number">2</span><span class="punctuation">,</span>  <span class="comment"># 线的大小</span></span><br><span class="line">      mainbar.y.label <span class="operator">=</span> <span class="string">&quot;Intersections&quot;</span><span class="punctuation">,</span> </span><br><span class="line">      sets.x.label <span class="operator">=</span> <span class="string">&quot;set&quot;</span><span class="punctuation">,</span> </span><br><span class="line">      text.scale <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">1.3</span><span class="punctuation">,</span> <span class="number">1.3</span><span class="punctuation">,</span> <span class="number">1</span><span class="punctuation">,</span> <span class="number">1</span><span class="punctuation">,</span> <span class="number">2</span><span class="punctuation">,</span> <span class="number">1</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<p>text.scale 参数值的顺序为：</p>
<ul>
<li>柱状图的轴标签和刻度</li>
<li>条形图的轴标签和刻度</li>
<li>集合名称</li>
<li>柱子上方表示交集大小的数值</li>
</ul>
<p><img src="/pics/2023-04-11-upset5.png" alt="alt 图标"></p>
<p>参考资料：</p>
<ol>
<li><a href="https://zhuanlan.zhihu.com/p/370210775">https://zhuanlan.zhihu.com/p/370210775</a></li>
</ol>
]]></content>
      <categories>
        <category>R</category>
      </categories>
      <tags>
        <tag>R</tag>
      </tags>
  </entry>
  <entry>
    <title>ggplot2集锦之七文本注释函数</title>
    <url>/2023/04/12/ggplot2%E9%9B%86%E9%94%A6%E4%B9%8B%E4%B8%83%E6%B3%A8%E9%87%8A%E5%87%BD%E6%95%B0/</url>
    <content><![CDATA[<p>在基础绘图系统中，注释功能主要由次级函数来实现，如text()函数可以添加文本、mtext()函数添加轴标签、segments()添加短线、arrows()函数添加箭头、rect()函数添加矩形等。而在ggplot2绘图系统中，一方面可以使用一些几何图形函数、统计变换函数充当注释函数，另一方面它还有专门的注释函数annotate()。<br>本文总结一下ggplot2包中的文本注释函数，包括：geom_text()、geom_label()、annotate()。</p>
<span id="more"></span>

<h3 id="1-geom-text"><a href="#1-geom-text" class="headerlink" title="1. geom_text()"></a>1. geom_text()</h3><p>geom_text()的用法和ggplot2中图形函数的使用规则一致：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">geom_text<span class="punctuation">(</span></span><br><span class="line">  mapping <span class="operator">=</span> <span class="literal">NULL</span><span class="punctuation">,</span></span><br><span class="line">  data <span class="operator">=</span> <span class="literal">NULL</span><span class="punctuation">,</span></span><br><span class="line">  stat <span class="operator">=</span> <span class="string">&quot;identity&quot;</span><span class="punctuation">,</span></span><br><span class="line">  position <span class="operator">=</span> <span class="string">&quot;identity&quot;</span><span class="punctuation">,</span></span><br><span class="line">  ...<span class="punctuation">,</span></span><br><span class="line">  parse <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">,</span></span><br><span class="line">  nudge_x <span class="operator">=</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  nudge_y <span class="operator">=</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  check_overlap <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">,</span></span><br><span class="line">  na.rm <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">,</span></span><br><span class="line">  show.legend <span class="operator">=</span> <span class="literal">NA</span><span class="punctuation">,</span></span><br><span class="line">  inherit.aes <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p>参数：</p>
<ul>
<li><strong>nudge_x、nudge_y</strong>：偏移量；与vjust和hjust参数不同的是，它的单位和对应坐标轴的刻度相同；</li>
<li><strong>check_overlap</strong>：逻辑型参数；若设为TRUE，则重叠的文本注释会被去除。</li>
</ul>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">library<span class="punctuation">(</span>ggplot2<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">p <span class="operator">&lt;-</span> ggplot<span class="punctuation">(</span>mtcars<span class="punctuation">,</span> aes<span class="punctuation">(</span>x <span class="operator">=</span> wt<span class="punctuation">,</span> y <span class="operator">=</span> mpg<span class="punctuation">,</span> col <span class="operator">=</span> vs<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  geom_point<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line">p</span><br></pre></td></tr></table></figure>
<p>添加标签：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">p <span class="operator">+</span> geom_text<span class="punctuation">(</span>aes<span class="punctuation">(</span>label <span class="operator">=</span> rownames<span class="punctuation">(</span>mtcars<span class="punctuation">)</span><span class="punctuation">,</span> vjust <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span> hjust <span class="operator">=</span> <span class="string">&quot;outward&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><img src="/pics/2023-04-12-plot-text1.png" alt="alt 图标"></p>
<p>利用check_overlap把重复的文本去掉：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">p <span class="operator">+</span> geom_text<span class="punctuation">(</span>aes<span class="punctuation">(</span>label <span class="operator">=</span> rownames<span class="punctuation">(</span>mtcars<span class="punctuation">)</span><span class="punctuation">,</span> vjust <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span> hjust <span class="operator">=</span> <span class="string">&quot;outward&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">              check_overlap <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><img src="/pics/2023-04-12-plot-text2.png" alt="alt 图标"></p>
<p>给条形图添加注释：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">ggplot<span class="punctuation">(</span>mtcars<span class="punctuation">[</span><span class="built_in">c</span><span class="punctuation">(</span><span class="number">1</span><span class="operator">:</span><span class="number">10</span><span class="punctuation">)</span><span class="punctuation">,</span><span class="punctuation">]</span><span class="punctuation">,</span>aes<span class="punctuation">(</span>x <span class="operator">=</span> rownames<span class="punctuation">(</span>mtcars<span class="punctuation">[</span><span class="built_in">c</span><span class="punctuation">(</span><span class="number">1</span><span class="operator">:</span><span class="number">10</span><span class="punctuation">)</span><span class="punctuation">,</span><span class="punctuation">]</span><span class="punctuation">)</span><span class="punctuation">,</span>y <span class="operator">=</span> mpg<span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line"> geom_bar<span class="punctuation">(</span>stat<span class="operator">=</span><span class="string">&quot;identity&quot;</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line"> geom_text<span class="punctuation">(</span>aes<span class="punctuation">(</span>label<span class="operator">=</span>mpg<span class="punctuation">,</span>y <span class="operator">=</span> mpg<span class="operator">+</span><span class="number">1</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><img src="/pics/2023-04-12-plot-text5.png" alt="alt 图标"></p>
<h3 id="2-geom-label"><a href="#2-geom-label" class="headerlink" title="2. geom_label()"></a>2. geom_label()</h3><p>geom_label()函数用法：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">geom_label<span class="punctuation">(</span></span><br><span class="line">  mapping <span class="operator">=</span> <span class="literal">NULL</span><span class="punctuation">,</span></span><br><span class="line">  data <span class="operator">=</span> <span class="literal">NULL</span><span class="punctuation">,</span></span><br><span class="line">  stat <span class="operator">=</span> <span class="string">&quot;identity&quot;</span><span class="punctuation">,</span></span><br><span class="line">  position <span class="operator">=</span> <span class="string">&quot;identity&quot;</span><span class="punctuation">,</span></span><br><span class="line">  ...<span class="punctuation">,</span></span><br><span class="line">  parse <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">,</span></span><br><span class="line">  nudge_x <span class="operator">=</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  nudge_y <span class="operator">=</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  label.padding <span class="operator">=</span> unit<span class="punctuation">(</span><span class="number">0.25</span><span class="punctuation">,</span> <span class="string">&quot;lines&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">  label.r <span class="operator">=</span> unit<span class="punctuation">(</span><span class="number">0.15</span><span class="punctuation">,</span> <span class="string">&quot;lines&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">  label.size <span class="operator">=</span> <span class="number">0.25</span><span class="punctuation">,</span></span><br><span class="line">  na.rm <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">,</span></span><br><span class="line">  show.legend <span class="operator">=</span> <span class="literal">NA</span><span class="punctuation">,</span></span><br><span class="line">  inherit.aes <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p>参数：</p>
<ul>
<li><strong>label.padding</strong>：标签文本与外框的距离大小；</li>
<li><strong>label.r</strong>：外框圆角的半径；</li>
<li><strong>label.size</strong>：外框线条的尺寸，单位为毫米（mm）。</li>
</ul>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">p <span class="operator">+</span> geom_label<span class="punctuation">(</span>aes<span class="punctuation">(</span>label <span class="operator">=</span> rownames<span class="punctuation">(</span>mtcars<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">,</span> nudge_x <span class="operator">=</span> <span class="number">0.15</span><span class="punctuation">,</span></span><br><span class="line">               label.padding <span class="operator">=</span> unit<span class="punctuation">(</span><span class="number">0.1</span><span class="punctuation">,</span> <span class="string">&quot;lines&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">               label.r <span class="operator">=</span> unit<span class="punctuation">(</span><span class="number">0.05</span><span class="punctuation">,</span> <span class="string">&quot;lines&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">               label.size <span class="operator">=</span> <span class="number">0.1</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><img src="/pics/2023-04-12-plot-text3.png" alt="alt 图标"><br>可以看到标签有大量的重叠，可以用ggrepel包注释避免重叠。</p>
<h3 id="3-geom-label-repel-与geom-text-repel"><a href="#3-geom-label-repel-与geom-text-repel" class="headerlink" title="3. geom_label_repel()与geom_text_repel()"></a>3. geom_label_repel()与geom_text_repel()</h3><figure class="highlight r"><table><tr><td class="code"><pre><span class="line">library<span class="punctuation">(</span>ggrepel<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">p<span class="operator">+</span>geom_text_repel<span class="punctuation">(</span>aes<span class="punctuation">(</span>wt<span class="punctuation">,</span>mpg<span class="punctuation">,</span>label<span class="operator">=</span>rownames<span class="punctuation">(</span>mtcars<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">p<span class="operator">+</span>geom_label_repel<span class="punctuation">(</span>aes<span class="punctuation">(</span>wt<span class="punctuation">,</span>mpg<span class="punctuation">,</span>label<span class="operator">=</span>rownames<span class="punctuation">(</span>mtcars<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<p><img src="/pics/2023-04-12-plot-text4.png" alt="alt 图标"></p>
<p>参数：</p>
<ul>
<li>segment.color:连接点与标签的线段的颜色</li>
<li>segment.size:线段的粗细</li>
<li>segment.alpha:线段的透明度</li>
<li>box.padding:文本框周边填充</li>
<li>point.padding:点周围填充</li>
<li>arrow:grid:arrow提供的箭头</li>
<li>force:强制性将重叠文本散开</li>
<li>max.oter:最大迭代次数</li>
<li>nudge_x&#x2F;y:标签开始位置在坐标轴的移动距离</li>
<li>direction:允许标签的方向，x、y or both</li>
</ul>
<h3 id="4-annotate"><a href="#4-annotate" class="headerlink" title="4. annotate()"></a>4. annotate()</h3><figure class="highlight r"><table><tr><td class="code"><pre><span class="line">p1 <span class="operator">&lt;-</span> p <span class="operator">+</span> annotate<span class="punctuation">(</span><span class="string">&quot;text&quot;</span><span class="punctuation">,</span> x <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">2</span><span class="punctuation">,</span> <span class="number">5</span><span class="punctuation">)</span><span class="punctuation">,</span> y <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">15</span><span class="punctuation">,</span> <span class="number">25</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">                   label <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;text1&quot;</span><span class="punctuation">,</span> <span class="string">&quot;text2&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">p2 <span class="operator">&lt;-</span> p <span class="operator">+</span> annotate<span class="punctuation">(</span><span class="string">&quot;label&quot;</span><span class="punctuation">,</span> x <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">2</span><span class="punctuation">,</span> <span class="number">5</span><span class="punctuation">)</span><span class="punctuation">,</span> y <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">15</span><span class="punctuation">,</span> <span class="number">25</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">                   label <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;label1&quot;</span><span class="punctuation">,</span> <span class="string">&quot;label2&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">p1<span class="operator">+</span>p2</span><br></pre></td></tr></table></figure>
<p><img src="/pics/2023-04-12-plot-text6.png" alt="alt 图标"></p>
]]></content>
      <categories>
        <category>R</category>
        <category>ggplot2</category>
      </categories>
      <tags>
        <tag>R</tag>
        <tag>ggplot2</tag>
      </tags>
  </entry>
  <entry>
    <title>dplyr包中函数使用</title>
    <url>/2023/04/13/dplyr%E5%8C%85%E4%B8%AD%E5%87%BD%E6%95%B0%E4%BD%BF%E7%94%A8/</url>
    <content><![CDATA[<p>本文总结一下dplyr包中函数的使用，包括：</p>
<ul>
<li><code>select()</code></li>
<li><code>rename()</code></li>
<li><code>filter()</code></li>
<li><code>mutate()</code></li>
<li><code>arrange()</code></li>
<li><code>summarise()</code></li>
<li><code>group_by()</code></li>
<li><code>left_join()</code></li>
<li><code>right_join()</code></li>
<li><code>full_join()</code></li>
<li><code>semi_join()</code></li>
<li><code>anti_join()</code></li>
<li><code>%&gt;%</code></li>
<li><code>separate()</code></li>
<li><code>unite()</code></li>
<li><code>distinct()</code></li>
<li><code>across()</code><span id="more"></span></li>
</ul>
<h3 id="1-select"><a href="#1-select" class="headerlink" title="1. select()"></a>1. select()</h3><p>一些operators：</p>
<ul>
<li><code>：</code>a range of consecutive variables</li>
<li><code>！</code>补集，即非</li>
<li><code>&amp;、|</code>交集与、并集或</li>
<li><code>c()</code>combine selections</li>
</ul>
<p>一些辅助函数如下，在<code>select()</code>中直接使用列时不需要引用””，但使用上述辅助函数时必须引用””。<br>对于列：</p>
<ul>
<li><code>everything()</code>选择所有变量，一般调整数据集中变量顺序时使用</li>
<li><code>last_cols()</code>Select last variable, possibly with an offset.</li>
<li><code>group_cols()</code>Select all grouping columns.</li>
</ul>
<p>根据名字选择：</p>
<ul>
<li><code>starts_with(&quot;X&quot;)</code> 以 “X”开头的变量名</li>
<li><code>ends_with(&quot;X&quot;)</code> 以 “X”结束的变量名</li>
<li><code>contains(&quot;X&quot;)</code> 包含 “X”的变量名</li>
<li><code>matches(&quot;X&quot;)</code>匹配正则表达式”X”的变量名</li>
<li><code>num_ranges(&quot;x&quot;,1:5)</code>变量名为 x01, x02, x03, x04 and x05</li>
</ul>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">library<span class="punctuation">(</span>tidyverse<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">my_iris <span class="operator">&lt;-</span> as_tibble<span class="punctuation">(</span>iris<span class="punctuation">)</span></span><br><span class="line">my_iris</span><br><span class="line"><span class="comment"># A tibble: 150 x 5</span></span><br><span class="line">   Sepal.Length Sepal.Width Petal.Length Petal.Width Species</span><br><span class="line">          <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span>       <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span>        <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span>       <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span> <span class="operator">&lt;</span>fct<span class="operator">&gt;</span>  </span><br><span class="line"> <span class="number">1</span>          <span class="number">5.1</span>         <span class="number">3.5</span>          <span class="number">1.4</span>         <span class="number">0.2</span> setosa </span><br><span class="line"> <span class="number">2</span>          <span class="number">4.9</span>         <span class="number">3</span>            <span class="number">1.4</span>         <span class="number">0.2</span> setosa </span><br><span class="line"> <span class="number">3</span>          <span class="number">4.7</span>         <span class="number">3.2</span>          <span class="number">1.3</span>         <span class="number">0.2</span> setosa </span><br><span class="line"><span class="comment"># ... with 147 more rows</span></span><br></pre></td></tr></table></figure>
<p>选择一列：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">my_iris <span class="operator">%&gt;%</span> select<span class="punctuation">(</span>Sepal.Length<span class="punctuation">)</span></span><br><span class="line"><span class="comment"># A tibble: 150 x 1</span></span><br><span class="line">   Sepal.Length</span><br><span class="line">          <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span></span><br><span class="line"> <span class="number">1</span>          <span class="number">5.1</span></span><br><span class="line"> <span class="number">2</span>          <span class="number">4.9</span></span><br><span class="line"> <span class="number">3</span>          <span class="number">4.7</span></span><br><span class="line"><span class="comment"># ... with 147 more rows</span></span><br></pre></td></tr></table></figure>
<p>选择多列：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">my_iris <span class="operator">%&gt;%</span> select<span class="punctuation">(</span>Species<span class="punctuation">,</span>Petal.Length<span class="punctuation">)</span></span><br><span class="line"><span class="comment"># A tibble: 150 x 2</span></span><br><span class="line">   Species Petal.Length</span><br><span class="line">   <span class="operator">&lt;</span>fct<span class="operator">&gt;</span>          <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span></span><br><span class="line"> <span class="number">1</span> setosa           <span class="number">1.4</span></span><br><span class="line"> <span class="number">2</span> setosa           <span class="number">1.4</span></span><br><span class="line"> <span class="number">3</span> setosa           <span class="number">1.3</span></span><br><span class="line"><span class="comment"># ... with 147 more rows</span></span><br></pre></td></tr></table></figure>
<p>选择范围的列:</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">my_iris <span class="operator">%&gt;%</span> select<span class="punctuation">(</span>Sepal.Length<span class="operator">:</span>Petal.Length<span class="punctuation">)</span></span><br><span class="line"><span class="comment"># A tibble: 150 x 3</span></span><br><span class="line">   Sepal.Length Sepal.Width Petal.Length</span><br><span class="line">          <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span>       <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span>        <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span></span><br><span class="line"> <span class="number">1</span>          <span class="number">5.1</span>         <span class="number">3.5</span>          <span class="number">1.4</span></span><br><span class="line"> <span class="number">2</span>          <span class="number">4.9</span>         <span class="number">3</span>            <span class="number">1.4</span></span><br><span class="line"> <span class="number">3</span>          <span class="number">4.7</span>         <span class="number">3.2</span>          <span class="number">1.3</span></span><br><span class="line"><span class="comment"># ... with 147 more rows</span></span><br></pre></td></tr></table></figure>
<p>反向选择列：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">my_iris <span class="operator">%&gt;%</span> select<span class="punctuation">(</span><span class="operator">!</span>Sepal.Length<span class="punctuation">)</span></span><br><span class="line"><span class="comment"># A tibble: 150 x 4</span></span><br><span class="line">   Sepal.Width Petal.Length Petal.Width Species</span><br><span class="line">         <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span>        <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span>       <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span> <span class="operator">&lt;</span>fct<span class="operator">&gt;</span>  </span><br><span class="line"> <span class="number">1</span>         <span class="number">3.5</span>          <span class="number">1.4</span>         <span class="number">0.2</span> setosa </span><br><span class="line"> <span class="number">2</span>         <span class="number">3</span>            <span class="number">1.4</span>         <span class="number">0.2</span> setosa </span><br><span class="line"> <span class="number">3</span>         <span class="number">3.2</span>          <span class="number">1.3</span>         <span class="number">0.2</span> setosa </span><br><span class="line"><span class="comment"># ... with 147 more rows</span></span><br></pre></td></tr></table></figure>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">my_iris <span class="operator">%&gt;%</span> select<span class="punctuation">(</span><span class="operator">!</span><span class="punctuation">(</span>Sepal.Length<span class="operator">:</span>Petal.Length<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment"># A tibble: 150 x 2</span></span><br><span class="line">   Petal.Width Species</span><br><span class="line">         <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span> <span class="operator">&lt;</span>fct<span class="operator">&gt;</span>  </span><br><span class="line"> <span class="number">1</span>         <span class="number">0.2</span> setosa </span><br><span class="line"> <span class="number">2</span>         <span class="number">0.2</span> setosa </span><br><span class="line"> <span class="number">3</span>         <span class="number">0.2</span> setosa </span><br><span class="line"><span class="comment"># ... with 147 more rows</span></span><br></pre></td></tr></table></figure>
<p>根据列名选择列：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">my_iris <span class="operator">%&gt;%</span> select<span class="punctuation">(</span>starts_with<span class="punctuation">(</span><span class="string">&quot;Petal&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment"># A tibble: 150 x 2</span></span><br><span class="line">   Petal.Length Petal.Width</span><br><span class="line">          <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span>       <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span></span><br><span class="line"> <span class="number">1</span>          <span class="number">1.4</span>         <span class="number">0.2</span></span><br><span class="line"> <span class="number">2</span>          <span class="number">1.4</span>         <span class="number">0.2</span></span><br><span class="line"> <span class="number">3</span>          <span class="number">1.3</span>         <span class="number">0.2</span></span><br><span class="line"> <span class="comment"># ... with 147 more rows</span></span><br><span class="line">my_iris <span class="operator">%&gt;%</span> select<span class="punctuation">(</span>ends_with<span class="punctuation">(</span><span class="string">&quot;Width&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment"># A tibble: 150 x 2</span></span><br><span class="line">   Sepal.Width Petal.Width</span><br><span class="line">         <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span>       <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span></span><br><span class="line"> <span class="number">1</span>         <span class="number">3.5</span>         <span class="number">0.2</span></span><br><span class="line"> <span class="number">2</span>         <span class="number">3</span>           <span class="number">0.2</span></span><br><span class="line"> <span class="number">3</span>         <span class="number">3.2</span>         <span class="number">0.2</span></span><br><span class="line"> <span class="comment"># ... with 147 more rows</span></span><br><span class="line">my_iris <span class="operator">%&gt;%</span> select<span class="punctuation">(</span>contains<span class="punctuation">(</span><span class="string">&quot;Petal&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment"># A tibble: 150 x 2</span></span><br><span class="line">   Petal.Length Petal.Width</span><br><span class="line">          <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span>       <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span></span><br><span class="line"> <span class="number">1</span>          <span class="number">1.4</span>         <span class="number">0.2</span></span><br><span class="line"> <span class="number">2</span>          <span class="number">1.4</span>         <span class="number">0.2</span></span><br><span class="line"> <span class="number">3</span>          <span class="number">1.3</span>         <span class="number">0.2</span></span><br><span class="line"> <span class="comment"># ... with 147 more rows</span></span><br></pre></td></tr></table></figure>
<p>其他用法：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">my_iris <span class="operator">%&gt;%</span> select<span class="punctuation">(</span><span class="operator">-</span><span class="punctuation">(</span><span class="number">1</span><span class="operator">:</span><span class="number">3</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">my_iris <span class="operator">%&gt;%</span> select<span class="punctuation">(</span><span class="operator">-</span><span class="number">1</span><span class="punctuation">,</span><span class="operator">-</span><span class="number">3</span><span class="punctuation">)</span></span><br><span class="line">my_iris <span class="operator">%&gt;%</span> selcet<span class="punctuation">(</span><span class="operator">-</span><span class="string">&quot;Petal.Width&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">my_iris <span class="operator">%&gt;%</span> select<span class="punctuation">(</span><span class="operator">!</span>starts_with<span class="punctuation">(</span><span class="string">&quot;Petal&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">my_iris <span class="operator">%&gt;%</span> select<span class="punctuation">(</span><span class="operator">!</span>ends_with<span class="punctuation">(</span><span class="string">&quot;Width&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">my_iris <span class="operator">%&gt;%</span> select<span class="punctuation">(</span><span class="operator">!</span>contains<span class="punctuation">(</span><span class="string">&quot;Petal&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">my_iris <span class="operator">%&gt;%</span> select<span class="punctuation">(</span>matches<span class="punctuation">(</span><span class="string">&quot;.Wid.&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">my_iris <span class="operator">%&gt;%</span> select<span class="punctuation">(</span>one_of<span class="punctuation">(</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;col1&quot;</span><span class="punctuation">,</span><span class="string">&quot;col2&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">my_iris <span class="operator">%&gt;%</span> select<span class="punctuation">(</span><span class="built_in">is.numeric</span><span class="punctuation">)</span></span><br><span class="line">my_iris <span class="operator">%&gt;%</span> select<span class="punctuation">(</span>where<span class="punctuation">(</span><span class="built_in">is.character</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">my_iris <span class="operator">%&gt;%</span> select<span class="punctuation">(</span>starts_with<span class="punctuation">(</span><span class="string">&quot;Petal&quot;</span><span class="punctuation">)</span> <span class="operator">&amp;</span> ends_with<span class="punctuation">(</span><span class="string">&quot;Width&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">my_iris <span class="operator">%&gt;%</span> select<span class="punctuation">(</span>starts_with<span class="punctuation">(</span><span class="string">&quot;Petal&quot;</span><span class="punctuation">)</span> <span class="operator">|</span> ends_with<span class="punctuation">(</span><span class="string">&quot;Width&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">my_iris <span class="operator">%&gt;%</span> select<span class="punctuation">(</span>starts_with<span class="punctuation">(</span><span class="string">&quot;Petal&quot;</span><span class="punctuation">)</span> <span class="operator">&amp;</span> <span class="operator">!</span>ends_with<span class="punctuation">(</span><span class="string">&quot;Width&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<h3 id="2-rename"><a href="#2-rename" class="headerlink" title="2. rename()"></a>2. rename()</h3><p>修改列的名字：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">rename<span class="punctuation">(</span>.data<span class="punctuation">,</span>new_name<span class="operator">=</span>old_name<span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">my_iris <span class="operator">%&gt;%</span> </span><br><span class="line"> select<span class="punctuation">(</span>Species<span class="punctuation">,</span>Petal.Length<span class="punctuation">)</span> <span class="operator">%&gt;%</span></span><br><span class="line"> rename<span class="punctuation">(</span>Spe <span class="operator">=</span> Species<span class="punctuation">)</span></span><br><span class="line"><span class="comment"># A tibble: 150 x 2</span></span><br><span class="line">   Spe    Petal.Length</span><br><span class="line">   <span class="operator">&lt;</span>fct<span class="operator">&gt;</span>         <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span></span><br><span class="line"> <span class="number">1</span> setosa          <span class="number">1.4</span></span><br><span class="line"> <span class="number">2</span> setosa          <span class="number">1.4</span></span><br><span class="line"> <span class="number">3</span> setosa          <span class="number">1.3</span></span><br><span class="line"><span class="comment"># ... with 147 more rows</span></span><br></pre></td></tr></table></figure>

<h3 id="3-filter"><a href="#3-filter" class="headerlink" title="3. filter()"></a>3. filter()</h3><p>对数据行进行筛选，保留符合条件的行，以下为关系运算符：</p>
<ul>
<li><code>==</code> , <code>&gt;</code> , <code>&gt;=</code> etc</li>
<li><code>&amp;</code> , <code> |</code>,<code>!</code>, <code>xor()</code> </li>
<li><code>is.na()</code> 、 <code>!is.na()</code> </li>
<li><code>%in%</code> </li>
<li><code>between()</code> , <code>near()</code></li>
</ul>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">my_iris <span class="operator">%&gt;%</span> filter<span class="punctuation">(</span>Species<span class="operator">==</span><span class="string">&quot;virginica&quot;</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment"># A tibble: 50 x 5</span></span><br><span class="line">   Sepal.Length Sepal.Width Petal.Length Petal.Width Species  </span><br><span class="line">          <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span>       <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span>        <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span>       <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span> <span class="operator">&lt;</span>fct<span class="operator">&gt;</span>    </span><br><span class="line"> <span class="number">1</span>          <span class="number">6.3</span>         <span class="number">3.3</span>          <span class="number">6</span>           <span class="number">2.5</span> virginica</span><br><span class="line"> <span class="number">2</span>          <span class="number">5.8</span>         <span class="number">2.7</span>          <span class="number">5.1</span>         <span class="number">1.9</span> virginica</span><br><span class="line"> <span class="number">3</span>          <span class="number">7.1</span>         <span class="number">3</span>            <span class="number">5.9</span>         <span class="number">2.1</span> virginica</span><br><span class="line"><span class="comment"># ... with 47 more rows</span></span><br></pre></td></tr></table></figure>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">my_iris <span class="operator">%&gt;%</span> filter<span class="punctuation">(</span>Species<span class="operator">==</span><span class="string">&quot;virginica&quot;</span><span class="punctuation">,</span>Sepal.Length<span class="operator">&gt;</span><span class="number">5</span><span class="punctuation">)</span></span><br><span class="line">my_iris <span class="operator">%&gt;%</span> filter<span class="punctuation">(</span>Species<span class="operator">==</span><span class="string">&quot;virginica&quot;</span><span class="operator">&amp;</span>Sepal.Length<span class="operator">&gt;</span><span class="number">5</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment"># A tibble: 49 x 5</span></span><br><span class="line">   Sepal.Length Sepal.Width Petal.Length Petal.Width Species  </span><br><span class="line">          <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span>       <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span>        <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span>       <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span> <span class="operator">&lt;</span>fct<span class="operator">&gt;</span>    </span><br><span class="line"> <span class="number">1</span>          <span class="number">6.3</span>         <span class="number">3.3</span>          <span class="number">6</span>           <span class="number">2.5</span> virginica</span><br><span class="line"> <span class="number">2</span>          <span class="number">5.8</span>         <span class="number">2.7</span>          <span class="number">5.1</span>         <span class="number">1.9</span> virginica</span><br><span class="line"> <span class="number">3</span>          <span class="number">7.1</span>         <span class="number">3</span>            <span class="number">5.9</span>         <span class="number">2.1</span> virginica</span><br><span class="line"><span class="comment"># ... with 46 more rows</span></span><br></pre></td></tr></table></figure>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">my_iris <span class="operator">%&gt;%</span> filter<span class="punctuation">(</span>Species<span class="operator">==</span><span class="string">&quot;virginica&quot;</span><span class="operator">&amp;</span>Sepal.Length<span class="operator">&gt;</span>mean<span class="punctuation">(</span>Sepal.Length<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment"># A tibble: 44 x 5</span></span><br><span class="line">   Sepal.Length Sepal.Width Petal.Length Petal.Width Species  </span><br><span class="line">          <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span>       <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span>        <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span>       <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span> <span class="operator">&lt;</span>fct<span class="operator">&gt;</span>    </span><br><span class="line"> <span class="number">1</span>          <span class="number">6.3</span>         <span class="number">3.3</span>          <span class="number">6</span>           <span class="number">2.5</span> virginica</span><br><span class="line"> <span class="number">2</span>          <span class="number">7.1</span>         <span class="number">3</span>            <span class="number">5.9</span>         <span class="number">2.1</span> virginica</span><br><span class="line"> <span class="number">3</span>          <span class="number">6.3</span>         <span class="number">2.9</span>          <span class="number">5.6</span>         <span class="number">1.8</span> virginica</span><br><span class="line"><span class="comment"># ... with 41 more rows</span></span><br></pre></td></tr></table></figure>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">my_iris <span class="operator">%&gt;%</span> filter<span class="punctuation">(</span>Sepal.Length <span class="operator">==</span> <span class="built_in">max</span><span class="punctuation">(</span>Sepal.Length<span class="punctuation">)</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<p>其他：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 选择全部为0的列：</span></span><br><span class="line">myfun <span class="operator">&lt;-</span> <span class="keyword">function</span><span class="punctuation">(</span>x<span class="punctuation">)</span> <span class="built_in">sum</span><span class="punctuation">(</span>x<span class="punctuation">)</span><span class="operator">==</span><span class="number">0</span></span><br><span class="line">df <span class="operator">%&gt;%</span> select<span class="punctuation">(</span>where<span class="punctuation">(</span>myfun<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#去掉全部为NA的列：</span></span><br><span class="line">df <span class="operator">%&gt;%</span> select<span class="punctuation">(</span>where<span class="punctuation">(</span><span class="operator">~</span> <span class="operator">!</span><span class="built_in">all</span><span class="punctuation">(</span><span class="built_in">is.na</span><span class="punctuation">(</span>.x<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">df <span class="operator">%&gt;%</span> filter<span class="punctuation">(</span>if_any<span class="punctuation">(</span>everything<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span><span class="operator">~</span> <span class="operator">!</span><span class="built_in">is.na</span><span class="punctuation">(</span>.x<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<h3 id="4-mutate"><a href="#4-mutate" class="headerlink" title="4. mutate()"></a>4. mutate()</h3><figure class="highlight plaintext"><figcaption><span>函数用于给数据生成新的列。</span></figcaption><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">```R</span><br><span class="line">my_iris %&gt;% </span><br><span class="line">	select(Sepal.Length,Petal.Length,Species) %&gt;%</span><br><span class="line">	mutate(Length=Sepal.Length+Petal.Length,</span><br><span class="line">		Length2=Sepal.Length-Petal.Length) %&gt;%</span><br><span class="line">	filter(Species==&quot;virginica&quot;)</span><br><span class="line"># A tibble: 50 x 5</span><br><span class="line">   Sepal.Length Petal.Length Species   Length Length2</span><br><span class="line">          &lt;dbl&gt;        &lt;dbl&gt; &lt;fct&gt;      &lt;dbl&gt;   &lt;dbl&gt;</span><br><span class="line"> 1          6.3          6   virginica   12.3   0.300</span><br><span class="line"> 2          5.8          5.1 virginica   10.9   0.7  </span><br><span class="line"> 3          7.1          5.9 virginica   13     1.2  </span><br><span class="line"># ... with 47 more rows</span><br><span class="line"># i Use `print(n = ...)` to see more rows</span><br></pre></td></tr></table></figure>

<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">my_iris <span class="operator">%&gt;%</span> </span><br><span class="line">  mutate<span class="punctuation">(</span></span><br><span class="line">    new_col <span class="operator">=</span> case_when<span class="punctuation">(</span></span><br><span class="line">      Petal.Length <span class="operator">&lt;</span> <span class="number">5</span>                     <span class="operator">~</span> <span class="string">&quot;A&quot;</span><span class="punctuation">,</span></span><br><span class="line">      Petal.Length <span class="operator">&gt;=</span> <span class="number">5</span> <span class="operator">&amp;</span> Petal.Length <span class="operator">&lt;</span> <span class="number">6</span> <span class="operator">~</span> <span class="string">&quot;B&quot;</span><span class="punctuation">,</span></span><br><span class="line">      Petal.Length <span class="operator">&gt;=</span> <span class="number">6</span> <span class="operator">&amp;</span> Petal.Length <span class="operator">&lt;</span> <span class="number">7</span> <span class="operator">~</span> <span class="string">&quot;C&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="literal">TRUE</span>                                 <span class="operator">~</span> <span class="string">&quot;D&quot;</span></span><br><span class="line">  <span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<h3 id="5-arrange"><a href="#5-arrange" class="headerlink" title="5. arrange()"></a>5. arrange()</h3><p>根据一个变量或多个变量对数据的行进行排序，默认为升序排列。<br>根据变量1升序排列：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">my_iris <span class="operator">%&gt;%</span> arrange<span class="punctuation">(</span>Petal.Length<span class="punctuation">)</span></span><br><span class="line"><span class="comment"># A tibble: 150 x 5</span></span><br><span class="line">   Sepal.Length Sepal.Width Petal.Length Petal.Width Species</span><br><span class="line">          <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span>       <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span>        <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span>       <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span> <span class="operator">&lt;</span>fct<span class="operator">&gt;</span>  </span><br><span class="line"> <span class="number">1</span>          <span class="number">4.6</span>         <span class="number">3.6</span>          <span class="number">1</span>           <span class="number">0.2</span> setosa </span><br><span class="line"> <span class="number">2</span>          <span class="number">4.3</span>         <span class="number">3</span>            <span class="number">1.1</span>         <span class="number">0.1</span> setosa </span><br><span class="line"> <span class="number">3</span>          <span class="number">5.8</span>         <span class="number">4</span>            <span class="number">1.2</span>         <span class="number">0.2</span> setosa </span><br><span class="line"> <span class="number">4</span>          <span class="number">5</span>           <span class="number">3.2</span>          <span class="number">1.2</span>         <span class="number">0.2</span> setosa </span><br><span class="line"> <span class="number">5</span>          <span class="number">4.7</span>         <span class="number">3.2</span>          <span class="number">1.3</span>         <span class="number">0.2</span> setosa </span><br><span class="line"><span class="comment"># ... with 145 more rows</span></span><br></pre></td></tr></table></figure>
<p>根据变量1降序排列,用desc()或加负号-：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">my_iris <span class="operator">%&gt;%</span> arrange<span class="punctuation">(</span><span class="operator">-</span>Petal.Length<span class="punctuation">)</span></span><br><span class="line">my_iris <span class="operator">%&gt;%</span> arrange<span class="punctuation">(</span>desc<span class="punctuation">(</span>Petal.Length<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment"># A tibble: 150 x 5</span></span><br><span class="line">   Sepal.Length Sepal.Width Petal.Length Petal.Width Species  </span><br><span class="line">          <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span>       <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span>        <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span>       <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span> <span class="operator">&lt;</span>fct<span class="operator">&gt;</span>    </span><br><span class="line"> <span class="number">1</span>          <span class="number">7.7</span>         <span class="number">2.6</span>          <span class="number">6.9</span>         <span class="number">2.3</span> virginica</span><br><span class="line"> <span class="number">2</span>          <span class="number">7.7</span>         <span class="number">3.8</span>          <span class="number">6.7</span>         <span class="number">2.2</span> virginica</span><br><span class="line"> <span class="number">3</span>          <span class="number">7.7</span>         <span class="number">2.8</span>          <span class="number">6.7</span>         <span class="number">2</span>   virginica</span><br><span class="line"> <span class="number">4</span>          <span class="number">7.6</span>         <span class="number">3</span>            <span class="number">6.6</span>         <span class="number">2.1</span> virginica</span><br><span class="line"> <span class="number">5</span>          <span class="number">7.9</span>         <span class="number">3.8</span>          <span class="number">6.4</span>         <span class="number">2</span>   virginica</span><br><span class="line"><span class="comment"># ... with 145 more rows</span></span><br></pre></td></tr></table></figure>

<p>先根据变量1升序排列，再根据变量2升序排列：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">my_iris <span class="operator">%&gt;%</span> arrange<span class="punctuation">(</span>Petal.Length<span class="punctuation">,</span>Petal.Width<span class="punctuation">)</span></span><br><span class="line"><span class="comment"># A tibble: 150 x 5</span></span><br><span class="line">   Sepal.Length Sepal.Width Petal.Length Petal.Width Species</span><br><span class="line">          <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span>       <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span>        <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span>       <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span> <span class="operator">&lt;</span>fct<span class="operator">&gt;</span>  </span><br><span class="line"> <span class="number">1</span>          <span class="number">4.6</span>         <span class="number">3.6</span>          <span class="number">1</span>           <span class="number">0.2</span> setosa </span><br><span class="line"> <span class="number">2</span>          <span class="number">4.3</span>         <span class="number">3</span>            <span class="number">1.1</span>         <span class="number">0.1</span> setosa </span><br><span class="line"> <span class="number">3</span>          <span class="number">5.8</span>         <span class="number">4</span>            <span class="number">1.2</span>         <span class="number">0.2</span> setosa </span><br><span class="line"> <span class="number">4</span>          <span class="number">5</span>           <span class="number">3.2</span>          <span class="number">1.2</span>         <span class="number">0.2</span> setosa </span><br><span class="line"> <span class="number">5</span>          <span class="number">4.7</span>         <span class="number">3.2</span>          <span class="number">1.3</span>         <span class="number">0.2</span> setosa </span><br><span class="line"><span class="comment"># ... with 145 more rows</span></span><br></pre></td></tr></table></figure>
<p>先根据变量1降序排列，再根据变量2升序排列：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">my_iris <span class="operator">%&gt;%</span> arrange<span class="punctuation">(</span>desc<span class="punctuation">(</span>Petal.Length<span class="punctuation">)</span><span class="punctuation">,</span>Petal.Width<span class="punctuation">)</span></span><br><span class="line"><span class="comment"># A tibble: 150 x 5</span></span><br><span class="line">   Sepal.Length Sepal.Width Petal.Length Petal.Width Species  </span><br><span class="line">          <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span>       <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span>        <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span>       <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span> <span class="operator">&lt;</span>fct<span class="operator">&gt;</span>    </span><br><span class="line"> <span class="number">1</span>          <span class="number">7.7</span>         <span class="number">2.6</span>          <span class="number">6.9</span>         <span class="number">2.3</span> virginica</span><br><span class="line"> <span class="number">2</span>          <span class="number">7.7</span>         <span class="number">2.8</span>          <span class="number">6.7</span>         <span class="number">2</span>   virginica</span><br><span class="line"> <span class="number">3</span>          <span class="number">7.7</span>         <span class="number">3.8</span>          <span class="number">6.7</span>         <span class="number">2.2</span> virginica</span><br><span class="line"> <span class="number">4</span>          <span class="number">7.6</span>         <span class="number">3</span>            <span class="number">6.6</span>         <span class="number">2.1</span> virginica</span><br><span class="line"> <span class="number">5</span>          <span class="number">7.9</span>         <span class="number">3.8</span>          <span class="number">6.4</span>         <span class="number">2</span>   virginica</span><br><span class="line"><span class="comment"># ... with 145 more rows</span></span><br></pre></td></tr></table></figure>

<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">my_iris<span class="operator">%&gt;%</span> arrange<span class="punctuation">(</span>across<span class="punctuation">(</span>starts_with<span class="punctuation">(</span><span class="string">&quot;Sepal&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">#&gt;     Sepal.Length Sepal.Width Petal.Length Petal.Width    Species</span></span><br><span class="line"><span class="comment">#&gt; 1            4.3         3.0          1.1         0.1     setosa</span></span><br><span class="line"><span class="comment">#&gt; 2            4.4         2.9          1.4         0.2     setosa</span></span><br><span class="line"><span class="comment">#&gt; 3            4.4         3.0          1.3         0.2     setosa</span></span><br><span class="line"><span class="comment">#&gt; 4            4.4         3.2          1.3         0.2     setosa</span></span><br><span class="line"><span class="comment">#&gt; 5            4.5         2.3          1.3         0.3     setosa</span></span><br><span class="line">......</span><br><span class="line">my_iris <span class="operator">%&gt;%</span> arrange<span class="punctuation">(</span>across<span class="punctuation">(</span>starts_with<span class="punctuation">(</span><span class="string">&quot;Sepal&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span>desc<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">#&gt;     Sepal.Length Sepal.Width Petal.Length Petal.Width    Species</span></span><br><span class="line"><span class="comment">#&gt; 1            7.9         3.8          6.4         2.0  virginica</span></span><br><span class="line"><span class="comment">#&gt; 2            7.7         3.8          6.7         2.2  virginica</span></span><br><span class="line"><span class="comment">#&gt; 3            7.7         3.0          6.1         2.3  virginica</span></span><br><span class="line"><span class="comment">#&gt; 4            7.7         2.8          6.7         2.0  virginica</span></span><br><span class="line"><span class="comment">#&gt; 5            7.7         2.6          6.9         2.3  virginica</span></span><br><span class="line">......</span><br></pre></td></tr></table></figure>
<h3 id="6-summarise"><a href="#6-summarise" class="headerlink" title="6. summarise()"></a>6. summarise()</h3><p>用于统计汇总，往往与其他函数配合使用。<br>计算均值：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">my_iris <span class="operator">%&gt;%</span> summarise<span class="punctuation">(</span>mean_s.len <span class="operator">=</span> mean<span class="punctuation">(</span>Sepal.Length<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment"># A tibble: 1 x 1</span></span><br><span class="line">  mean_s.len</span><br><span class="line">       <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span></span><br><span class="line"><span class="number">1</span>       <span class="number">5.84</span></span><br></pre></td></tr></table></figure>
<p>计算标准差：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">my_iris <span class="operator">%&gt;%</span> summarise<span class="punctuation">(</span>sd_s.len <span class="operator">=</span> sd<span class="punctuation">(</span>Sepal.Length<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment"># A tibble: 1 x 1</span></span><br><span class="line">  sd_s.len</span><br><span class="line">     <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span></span><br><span class="line"><span class="number">1</span>    <span class="number">0.828</span></span><br></pre></td></tr></table></figure>
<p>多个统计：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">my_iris <span class="operator">%&gt;%</span> summarise<span class="punctuation">(</span></span><br><span class="line">	mean_s.len <span class="operator">=</span> mean<span class="punctuation">(</span>Sepal.Length<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">	sd_s.len <span class="operator">=</span> sd<span class="punctuation">(</span>Sepal.Length<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">	n<span class="operator">=</span>n<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">	sum_s.len <span class="operator">=</span> <span class="built_in">sum</span><span class="punctuation">(</span>Sepal.Length<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment"># A tibble: 1 x 4</span></span><br><span class="line">  mean_s.len sd_s.len     n sum_s.len</span><br><span class="line">       <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span>    <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span> <span class="operator">&lt;</span>int<span class="operator">&gt;</span>     <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span></span><br><span class="line"><span class="number">1</span>       <span class="number">5.84</span>    <span class="number">0.828</span>   <span class="number">150</span>      <span class="number">876.</span></span><br></pre></td></tr></table></figure>

<h3 id="7-group-by"><a href="#7-group-by" class="headerlink" title="7. group_by()"></a>7. group_by()</h3><figure class="highlight plaintext"><figcaption><span>经常和 ```group_by()``` 一起用，用于分组统计：</span></figcaption><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">```R</span><br><span class="line">my_iris %&gt;% </span><br><span class="line"> group_by(Species) %&gt;%</span><br><span class="line"> summarise(</span><br><span class="line">	mean_s.len = mean(Sepal.Length),</span><br><span class="line">	sd_s.len = sd(Sepal.Length),</span><br><span class="line">	n=n(),</span><br><span class="line">	sum_s.len = sum(Sepal.Length))</span><br><span class="line"># A tibble: 3 x 5</span><br><span class="line">  Species    mean_s.len sd_s.len     n sum_s.len</span><br><span class="line">  &lt;fct&gt;           &lt;dbl&gt;    &lt;dbl&gt; &lt;int&gt;     &lt;dbl&gt;</span><br><span class="line">1 setosa           5.01    0.352    50      250.</span><br><span class="line">2 versicolor       5.94    0.516    50      297.</span><br><span class="line">3 virginica        6.59    0.636    50      329.</span><br></pre></td></tr></table></figure>

<h3 id="8-xxx-join"><a href="#8-xxx-join" class="headerlink" title="8. xxx_join()"></a>8. xxx_join()</h3><p>xxx_join():</p>
<ul>
<li><code>left_join()</code> :左连接</li>
<li><code>right_jion()</code> ：右连接</li>
<li><code>full_join()</code> ：全连接</li>
<li><code>inner_join()</code> ：内连接</li>
<li><code>semi_join(x,y)</code> 、 <code>anti_join(x,y)</code> ：筛选连接</li>
</ul>
<p>左连接，以df1中的gene_name为准</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">left_join<span class="punctuation">(</span>df1<span class="punctuation">,</span>df2<span class="punctuation">,</span>by<span class="operator">=</span><span class="string">&quot;gene_name&quot;</span><span class="punctuation">)</span></span><br><span class="line">df1 <span class="operator">%&gt;%</span> left_join<span class="punctuation">(</span>df2<span class="punctuation">,</span>by <span class="operator">=</span> <span class="string">&quot;gene_name&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<p>右连接，以df2中的gene_name为准</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">right_join<span class="punctuation">(</span>df1<span class="punctuation">,</span>df2<span class="punctuation">,</span>by<span class="operator">=</span><span class="string">&quot;gene_name&quot;</span><span class="punctuation">)</span></span><br><span class="line">df1 <span class="operator">%&gt;%</span> right_join<span class="punctuation">(</span>df2<span class="punctuation">,</span>by <span class="operator">=</span> <span class="string">&quot;gene_name&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<p>全连接，df1和df2中的gene_name的行全部都会保留</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">full_join<span class="punctuation">(</span>df1<span class="punctuation">,</span>df2<span class="punctuation">,</span>by<span class="operator">=</span><span class="string">&quot;gene_name&quot;</span><span class="punctuation">)</span></span><br><span class="line">df1 <span class="operator">%&gt;%</span> full_join<span class="punctuation">(</span>df2<span class="punctuation">,</span>by <span class="operator">=</span> <span class="string">&quot;gene_name&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<p>内连接，df1和df2中都有的gene_name的行才会保留</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">inner_join<span class="punctuation">(</span>df1<span class="punctuation">,</span>df2<span class="punctuation">,</span>by<span class="operator">=</span><span class="string">&quot;gene_name&quot;</span><span class="punctuation">)</span></span><br><span class="line">df1 <span class="operator">%&gt;%</span> inner_join<span class="punctuation">(</span>df2<span class="punctuation">,</span>by <span class="operator">=</span> <span class="string">&quot;gene_name&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<p>筛选连接，不改变x数据框的数量，但会影响x的观测，即剔除一些行，类似于filter()。<br>半连接 <code>semi_join(x,y)</code> 保留gene_name与df2的gene_name一样的所有行：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">semi_join<span class="punctuation">(</span>df1<span class="punctuation">,</span>df2<span class="punctuation">,</span>by <span class="operator">=</span> <span class="string">&quot;gene_name&quot;</span><span class="punctuation">)</span></span><br><span class="line">df1 <span class="operator">%&gt;%</span> semi_join<span class="punctuation">(</span>df2<span class="punctuation">,</span>by <span class="operator">=</span> <span class="string">&quot;gene_name&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p>等价于：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">df1 <span class="operator">%&gt;%</span> filter<span class="punctuation">(</span>gene_name <span class="operator">%in%</span> df2<span class="operator">$</span>gene_name<span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<p>反连接 <code>anti_join(x,y)</code> ,丢弃与df2中gene_name一样的所有行：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">anti_join<span class="punctuation">(</span>df1<span class="punctuation">,</span>df2<span class="punctuation">,</span>by <span class="operator">=</span> <span class="string">&quot;gene_name&quot;</span><span class="punctuation">)</span></span><br><span class="line">df1 <span class="operator">%&gt;%</span> anti_join<span class="punctuation">(</span>df2<span class="punctuation">,</span>by <span class="operator">=</span> <span class="string">&quot;gene_name&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p>等价于：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">df1 <span class="operator">%&gt;%</span> filter<span class="punctuation">(</span><span class="operator">!</span>gene_name <span class="operator">%in%</span> df2<span class="operator">$</span>gene_name<span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<h3 id="9-管道符-gt"><a href="#9-管道符-gt" class="headerlink" title="9. 管道符%&gt;%"></a>9. 管道符%&gt;%</h3><p>把管道符左边的传给右边。</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">df <span class="operator">%&gt;%</span> head<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line">df <span class="operator">%&gt;%</span> tail<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line">df <span class="operator">%&gt;%</span> slice<span class="punctuation">(</span><span class="number">1</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p>以下三个等价，取出Sepal.Length值最大的行：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">my_iris <span class="operator">%&gt;%</span> </span><br><span class="line"> group_by<span class="punctuation">(</span>Species<span class="punctuation">)</span> <span class="operator">%&gt;%</span> </span><br><span class="line"> slice<span class="punctuation">(</span><span class="number">1</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">my_iris <span class="operator">%&gt;%</span> </span><br><span class="line"> arrange<span class="punctuation">(</span>desc<span class="punctuation">(</span>Sepal.Length<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span></span><br><span class="line"> slice<span class="punctuation">(</span><span class="number">1</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">my_iris <span class="operator">%&gt;%</span> slice_max<span class="punctuation">(</span>Sepal.Length<span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<h3 id="10-separate"><a href="#10-separate" class="headerlink" title="10. separate()"></a>10. separate()</h3><figure class="highlight plaintext"><figcaption><span>将某一列根据指定符号，分割成两列：</span></figcaption><table><tr><td class="code"><pre><span class="line">```R</span><br><span class="line">tb &lt;- tibble::tribble(</span><br><span class="line">  ~day, ~price,</span><br><span class="line">  1,   &quot;30-45&quot;,</span><br><span class="line">  2,   &quot;40-95&quot;,</span><br><span class="line">  3,   &quot;89-65&quot;,</span><br><span class="line">  4,   &quot;45-63&quot;,</span><br><span class="line">  5,   &quot;52-42&quot;</span><br><span class="line">)</span><br><span class="line">tb1 &lt;- tb %&gt;% </span><br><span class="line">  separate(price, into = c(&quot;low&quot;, &quot;high&quot;), sep = &quot;-&quot;)</span><br><span class="line">tb1</span><br><span class="line"># A tibble: 5 x 3</span><br><span class="line">    day low   high </span><br><span class="line">  &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt;</span><br><span class="line">1     1 30    45   </span><br><span class="line">2     2 40    95   </span><br><span class="line">3     3 89    65   </span><br><span class="line">4     4 45    63   </span><br><span class="line">5     5 52    42   </span><br></pre></td></tr></table></figure>

<h3 id="11-unite"><a href="#11-unite" class="headerlink" title="11. unite()"></a>11. unite()</h3><figure class="highlight plaintext"><figcaption><span>将某两个列合并为一个列：</span></figcaption><table><tr><td class="code"><pre><span class="line">```R</span><br><span class="line">tb1 %&gt;% </span><br><span class="line">  unite(col = &quot;price&quot;, c(low, high), sep = &quot;:&quot;, remove = FALSE)</span><br><span class="line">tb1</span><br><span class="line">## # A tibble: 5 × 4</span><br><span class="line">##     day price low   high </span><br><span class="line">##   &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;</span><br><span class="line">## 1     1 30:45 30    45   </span><br><span class="line">## 2     2 40:95 40    95   </span><br><span class="line">## 3     3 89:65 89    65   </span><br><span class="line">## 4     4 45:63 45    63   </span><br><span class="line">## 5     5 52:42 52    42</span><br></pre></td></tr></table></figure>

<h3 id="12-distinct"><a href="#12-distinct" class="headerlink" title="12. distinct()"></a>12. distinct()</h3><p>对数据框进行筛选，筛选出不重复的行，类似于unique()。</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">df <span class="operator">&lt;-</span> tibble<span class="operator">::</span>tribble<span class="punctuation">(</span></span><br><span class="line">  <span class="operator">~</span>x<span class="punctuation">,</span> <span class="operator">~</span>y<span class="punctuation">,</span> <span class="operator">~</span>z<span class="punctuation">,</span></span><br><span class="line">  <span class="number">1</span><span class="punctuation">,</span> <span class="number">1</span><span class="punctuation">,</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="number">1</span><span class="punctuation">,</span> <span class="number">1</span><span class="punctuation">,</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">  <span class="number">1</span><span class="punctuation">,</span> <span class="number">1</span><span class="punctuation">,</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="number">2</span><span class="punctuation">,</span> <span class="number">1</span><span class="punctuation">,</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">  <span class="number">2</span><span class="punctuation">,</span> <span class="number">2</span><span class="punctuation">,</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">  <span class="number">3</span><span class="punctuation">,</span> <span class="number">3</span><span class="punctuation">,</span> <span class="number">1</span><span class="punctuation">)</span></span><br><span class="line">df</span><br><span class="line"><span class="comment">## # A tibble: 6 × 3</span></span><br><span class="line"><span class="comment">##       x     y     z</span></span><br><span class="line"><span class="comment">##   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></span><br><span class="line"><span class="comment">## 1     1     1     1</span></span><br><span class="line"><span class="comment">## 2     1     1     2</span></span><br><span class="line"><span class="comment">## 3     1     1     1</span></span><br><span class="line"><span class="comment">## 4     2     1     2</span></span><br><span class="line"><span class="comment">## 5     2     2     3</span></span><br><span class="line"><span class="comment">## 6     3     3     1</span></span><br><span class="line">df <span class="operator">%&gt;%</span></span><br><span class="line">  distinct<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">## # A tibble: 5 × 3</span></span><br><span class="line"><span class="comment">##       x     y     z</span></span><br><span class="line"><span class="comment">##   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></span><br><span class="line"><span class="comment">## 1     1     1     1</span></span><br><span class="line"><span class="comment">## 2     1     1     2</span></span><br><span class="line"><span class="comment">## 3     2     1     2</span></span><br><span class="line"><span class="comment">## 4     2     2     3</span></span><br><span class="line"><span class="comment">## 5     3     3     1</span></span><br></pre></td></tr></table></figure>
<p>筛选出df中不重复的x</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">df <span class="operator">%&gt;%</span></span><br><span class="line">  distinct<span class="punctuation">(</span>x<span class="punctuation">)</span></span><br><span class="line"><span class="comment">## # A tibble: 3 × 1</span></span><br><span class="line"><span class="comment">##       x</span></span><br><span class="line"><span class="comment">##   &lt;dbl&gt;</span></span><br><span class="line"><span class="comment">## 1     1</span></span><br><span class="line"><span class="comment">## 2     2</span></span><br><span class="line"><span class="comment">## 3     3</span></span><br></pre></td></tr></table></figure>
<p>筛选不重复的x和y。</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">df <span class="operator">%&gt;%</span></span><br><span class="line">  distinct<span class="punctuation">(</span>x<span class="punctuation">,</span> y<span class="punctuation">)</span></span><br><span class="line"><span class="comment">## # A tibble: 4 × 2</span></span><br><span class="line"><span class="comment">##       x     y</span></span><br><span class="line"><span class="comment">##   &lt;dbl&gt; &lt;dbl&gt;</span></span><br><span class="line"><span class="comment">## 1     1     1</span></span><br><span class="line"><span class="comment">## 2     2     1</span></span><br><span class="line"><span class="comment">## 3     2     2</span></span><br><span class="line"><span class="comment">## 4     3     3</span></span><br></pre></td></tr></table></figure>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">df <span class="operator">%&gt;%</span></span><br><span class="line">  distinct<span class="punctuation">(</span>x<span class="punctuation">,</span> y<span class="punctuation">,</span> .keep_all <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">)</span> <span class="comment"># 只保留最先出现的row</span></span><br><span class="line"><span class="comment">## # A tibble: 4 × 3</span></span><br><span class="line"><span class="comment">##       x     y     z</span></span><br><span class="line"><span class="comment">##   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></span><br><span class="line"><span class="comment">## 1     1     1     1</span></span><br><span class="line"><span class="comment">## 2     2     1     2</span></span><br><span class="line"><span class="comment">## 3     2     2     3</span></span><br><span class="line"><span class="comment">## 4     3     3     1</span></span><br><span class="line">df <span class="operator">%&gt;%</span></span><br><span class="line">  distinct<span class="punctuation">(</span></span><br><span class="line">    across<span class="punctuation">(</span><span class="built_in">c</span><span class="punctuation">(</span>x<span class="punctuation">,</span> y<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    .keep_all <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">)</span></span><br><span class="line">df <span class="operator">%&gt;%</span></span><br><span class="line">  group_by<span class="punctuation">(</span>x<span class="punctuation">)</span> <span class="operator">%&gt;%</span></span><br><span class="line">  distinct<span class="punctuation">(</span>y<span class="punctuation">,</span> .keep_all <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">## # A tibble: 4 × 3</span></span><br><span class="line"><span class="comment">## # Groups:   x [3]</span></span><br><span class="line"><span class="comment">##       x     y     z</span></span><br><span class="line"><span class="comment">##   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></span><br><span class="line"><span class="comment">## 1     1     1     1</span></span><br><span class="line"><span class="comment">## 2     2     1     2</span></span><br><span class="line"><span class="comment">## 3     2     2     3</span></span><br><span class="line"><span class="comment">## 4     3     3     1</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><figcaption><span>处理的对象是vector；功能是统计不同的元素有多少个；返回一个数值。</span></figcaption><table><tr><td class="code"><pre><span class="line">```R</span><br><span class="line">c(1, 1, 1, 2, 2, 1, 3, 3) %&gt;% n_distinct()</span><br><span class="line">## [1] 3</span><br><span class="line"></span><br><span class="line">df$z %&gt;% n_distinct()</span><br><span class="line">## [1] 3</span><br></pre></td></tr></table></figure>
<p>根据x分组统计每个元素的个数：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">df <span class="operator">%&gt;%</span></span><br><span class="line">  group_by<span class="punctuation">(</span>x<span class="punctuation">)</span> <span class="operator">%&gt;%</span></span><br><span class="line">  summarise<span class="punctuation">(</span></span><br><span class="line">    n <span class="operator">=</span> n_distinct<span class="punctuation">(</span>z<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">## # A tibble: 3 × 2</span></span><br><span class="line"><span class="comment">##       x     n</span></span><br><span class="line"><span class="comment">##   &lt;dbl&gt; &lt;int&gt;</span></span><br><span class="line"><span class="comment">## 1     1     2</span></span><br><span class="line"><span class="comment">## 2     2     2</span></span><br><span class="line"><span class="comment">## 3     3     1</span></span><br></pre></td></tr></table></figure>

<h3 id="13-统计"><a href="#13-统计" class="headerlink" title="13. 统计"></a>13. 统计</h3><p>统计数据框行数：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">my_iris <span class="operator">%&gt;%</span> </span><br><span class="line"> summarise<span class="punctuation">(</span>n<span class="operator">=</span>n<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p>统计每个Species出现的次数：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">my_iris <span class="operator">%&gt;%</span> </span><br><span class="line"> group_by<span class="punctuation">(</span>Species<span class="punctuation">)</span> <span class="operator">%&gt;%</span></span><br><span class="line"> summarise<span class="punctuation">(</span>n<span class="operator">=</span>n<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">my_iris <span class="operator">%&gt;%</span> </span><br><span class="line"> count<span class="punctuation">(</span>Species<span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p>统计A、B不同组合出现的次数：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">my_df <span class="operator">%&gt;%</span> count<span class="punctuation">(</span>A<span class="punctuation">,</span>B<span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<p>以下两个等价，count通过创建一个新的变量进行计数(注：变量内容为TRUE&#x2F;FALSE)：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">my_iris <span class="operator">%&gt;%</span> </span><br><span class="line"> filter<span class="punctuation">(</span>Sepal.Length<span class="operator">&gt;</span><span class="number">7</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span></span><br><span class="line"> summarise<span class="punctuation">(</span>n<span class="operator">=</span>n<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">my_iris <span class="operator">%&gt;%</span> count<span class="punctuation">(</span>new_col <span class="operator">=</span> Sepal.Length<span class="operator">&gt;</span><span class="number">7</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<p>统计Sepal.Length&gt;7的比例：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">my_iris <span class="operator">%&gt;%</span> </span><br><span class="line"> mutate<span class="punctuation">(</span>new_col <span class="operator">=</span> Sepal.Length <span class="operator">&gt;</span><span class="number">7</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span> </span><br><span class="line"> summarise<span class="punctuation">(</span>mean<span class="operator">=</span>mean<span class="punctuation">(</span>new_col<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment"># A tibble: 1 x 1</span></span><br><span class="line">   mean</span><br><span class="line">  <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span></span><br><span class="line"><span class="number">1</span>  <span class="number">0.08</span></span><br></pre></td></tr></table></figure>

<h3 id="14-across"><a href="#14-across" class="headerlink" title="14. across()"></a>14. across()</h3><figure class="highlight plaintext"><figcaption><span>函数对多列执行相同的函数操作，返回数据框。</span></figcaption><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">对Sepal.Length和Petal.Length两列求均值：</span><br><span class="line"></span><br><span class="line">```R</span><br><span class="line">my_iris %&gt;% summarise(</span><br><span class="line">	across(c(Sepal.Length,Petal.Length),mean)</span><br><span class="line">	)</span><br><span class="line"></span><br><span class="line">my_iris %&gt;% summarise(</span><br><span class="line">	across(ends_with(&quot;Length&quot;),mean)</span><br><span class="line">	)</span><br></pre></td></tr></table></figure>
<p>多列多个统计函数：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">my_iris <span class="operator">%&gt;%</span> </span><br><span class="line"> group_by<span class="punctuation">(</span>Species<span class="punctuation">)</span> <span class="operator">%&gt;%</span> </span><br><span class="line"> summarise<span class="punctuation">(</span></span><br><span class="line"> 	across<span class="punctuation">(</span>ends_with<span class="punctuation">(</span><span class="string">&quot;Length&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span><span class="built_in">list</span><span class="punctuation">(</span>mean<span class="operator">=</span>mean<span class="punctuation">,</span>sd<span class="operator">=</span>sd<span class="punctuation">)</span><span class="punctuation">,</span>na.rm<span class="operator">=</span><span class="literal">TRUE</span><span class="punctuation">)</span></span><br><span class="line"> 	<span class="punctuation">)</span></span><br><span class="line"><span class="comment"># A tibble: 3 x 5</span></span><br><span class="line">  Species    Sepal.Length_mean Sepal.Length_sd Petal.Length_mean Petal.Length_sd</span><br><span class="line">  <span class="operator">&lt;</span>fct<span class="operator">&gt;</span>                  <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span>           <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span>             <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span>           <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span></span><br><span class="line"><span class="number">1</span> setosa                  <span class="number">5.01</span>           <span class="number">0.352</span>              <span class="number">1.46</span>           <span class="number">0.174</span></span><br><span class="line"><span class="number">2</span> versicolor              <span class="number">5.94</span>           <span class="number">0.516</span>              <span class="number">4.26</span>           <span class="number">0.470</span></span><br><span class="line"><span class="number">3</span> virginica               <span class="number">6.59</span>           <span class="number">0.636</span>              <span class="number">5.55</span>           <span class="number">0.552</span></span><br></pre></td></tr></table></figure>


<p>参考资料：</p>
<ol>
<li><a href="https://dplyr.tidyverse.org/">https://dplyr.tidyverse.org/</a></li>
<li><a href="https://bookdown.org/wangminjie/R4DS/tidyverse-dplyr-apply.html">https://bookdown.org/wangminjie/R4DS/tidyverse-dplyr-apply.html</a></li>
</ol>
]]></content>
      <categories>
        <category>R</category>
        <category>Tidyverse</category>
      </categories>
      <tags>
        <tag>R - Tidyverse</tag>
      </tags>
  </entry>
  <entry>
    <title>R中数据的tidy规整函数</title>
    <url>/2023/04/17/R%E4%B8%AD%E6%95%B0%E6%8D%AE%E7%9A%84tidy%E8%A7%84%E6%95%B4%E5%87%BD%E6%95%B0/</url>
    <content><![CDATA[<p>本文总结R中利用tidyverse包中的函数来对数据进行规整。</p>
<span id="more"></span>

<h3 id="1-tidy的数据"><a href="#1-tidy的数据" class="headerlink" title="1. tidy的数据"></a>1. tidy的数据</h3><p>在R中数据需要是tidy的，即每个变量单独为一列，一行代表一次观察。<br>但是实际很多时候我们的数据并不是tidy的，比如，以下两个表格：<br><strong>表1（宽表格）:</strong></p>
<table>
<thead>
<tr>
<th>name</th>
<th>rep1</th>
<th>rep2</th>
<th>rep3</th>
</tr>
</thead>
<tbody><tr>
<td>name1</td>
<td>1</td>
<td>2</td>
<td>3</td>
</tr>
<tr>
<td>name2</td>
<td>4</td>
<td>5</td>
<td>6</td>
</tr>
<tr>
<td>name3</td>
<td>7</td>
<td>8</td>
<td>9</td>
</tr>
</tbody></table>
<p><strong>表2（长表格）:</strong></p>
<table>
<thead>
<tr>
<th>name</th>
<th>exp</th>
<th>rep</th>
</tr>
</thead>
<tbody><tr>
<td>name1</td>
<td>1</td>
<td>rep1</td>
</tr>
<tr>
<td>name1</td>
<td>2</td>
<td>rep2</td>
</tr>
<tr>
<td>name1</td>
<td>3</td>
<td>rep3</td>
</tr>
<tr>
<td>name2</td>
<td>4</td>
<td>rep1</td>
</tr>
<tr>
<td>name2</td>
<td>5</td>
<td>rep2</td>
</tr>
<tr>
<td>name2</td>
<td>6</td>
<td>rep3</td>
</tr>
<tr>
<td>name3</td>
<td>7</td>
<td>rep1</td>
</tr>
<tr>
<td>name3</td>
<td>8</td>
<td>rep2</td>
</tr>
<tr>
<td>name3</td>
<td>9</td>
<td>rep3</td>
</tr>
</tbody></table>
<p>在绘制ggplot2时，明显需要将表1（非tidy的）转化为表2（tidy的），但是每次手动转换很麻烦，所以tidyverse包提供了转换的函数，使用以下函数转换很方便：</p>
<p><strong><code>pivot_longer()</code></strong> 能够将宽表格变成长表格。<br><strong><code>pivot_wider()</code></strong> 将长表格变成宽表格。</p>
<h3 id="2-tidyr-pivot-longer"><a href="#2-tidyr-pivot-longer" class="headerlink" title="2. tidyr::pivot_longer()"></a>2. tidyr::pivot_longer()</h3><p>参数：</p>
<ul>
<li>cols：哪些列需要转换</li>
<li>name_to：用于分组的列，即选取的需要转换的列的列名，构成新的一列，新的这一列的名字</li>
<li>values_to：选取的需要转换的列的值，构成新的一列，新的列的名字</li>
</ul>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">data <span class="operator">&lt;-</span> data.frame<span class="punctuation">(</span></span><br><span class="line">  name <span class="operator">=</span> paste0<span class="punctuation">(</span><span class="built_in">rep</span><span class="punctuation">(</span><span class="string">&quot;name&quot;</span><span class="punctuation">,</span><span class="number">5</span><span class="punctuation">)</span><span class="punctuation">,</span><span class="number">1</span><span class="operator">:</span><span class="number">5</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">  A <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">0.7</span><span class="punctuation">,</span> <span class="number">1.0</span><span class="punctuation">,</span> <span class="number">1.5</span><span class="punctuation">,</span> <span class="number">1.8</span><span class="punctuation">,</span> <span class="number">2.2</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">  B <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">0.5</span><span class="punctuation">,</span> <span class="number">0.7</span><span class="punctuation">,</span> <span class="number">0.9</span><span class="punctuation">,</span> <span class="number">1.3</span><span class="punctuation">,</span> <span class="number">1.8</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">  C <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">0.3</span><span class="punctuation">,</span> <span class="number">0.6</span><span class="punctuation">,</span> <span class="number">1.0</span><span class="punctuation">,</span> <span class="number">1.2</span><span class="punctuation">,</span> <span class="number">2.2</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">  D <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">0.4</span><span class="punctuation">,</span> <span class="number">0.7</span><span class="punctuation">,</span> <span class="number">1.2</span><span class="punctuation">,</span> <span class="number">1.5</span><span class="punctuation">,</span> <span class="number">3.2</span><span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">long_data <span class="operator">&lt;-</span> data <span class="operator">%&gt;%</span> </span><br><span class="line"> pivot_longer<span class="punctuation">(</span></span><br><span class="line"> 	<span class="comment"># cols=-name, 多种写法</span></span><br><span class="line"> 	cols<span class="operator">=</span>A<span class="operator">:</span>D<span class="punctuation">,</span></span><br><span class="line"> 	names_to<span class="operator">=</span><span class="string">&quot;rep&quot;</span><span class="punctuation">,</span></span><br><span class="line"> 	values_to<span class="operator">=</span><span class="string">&quot;exp&quot;</span></span><br><span class="line"> 	<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">long_data</span><br><span class="line"><span class="comment"># A tibble: 20 x 3</span></span><br><span class="line">   name  <span class="built_in">rep</span>     <span class="built_in">exp</span></span><br><span class="line">   <span class="operator">&lt;</span>fct<span class="operator">&gt;</span> <span class="operator">&lt;</span>chr<span class="operator">&gt;</span> <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span></span><br><span class="line"> <span class="number">1</span> name1 A       <span class="number">0.7</span></span><br><span class="line"> <span class="number">2</span> name1 B       <span class="number">0.5</span></span><br><span class="line"> <span class="number">3</span> name1 C       <span class="number">0.3</span></span><br><span class="line"> <span class="number">4</span> name1 D       <span class="number">0.4</span></span><br><span class="line"> <span class="number">5</span> name2 A       <span class="number">1</span>  </span><br><span class="line"> <span class="number">6</span> name2 B       <span class="number">0.7</span></span><br><span class="line"> <span class="number">7</span> name2 C       <span class="number">0.6</span></span><br><span class="line"> <span class="number">8</span> name2 D       <span class="number">0.7</span></span><br><span class="line"> <span class="number">9</span> name3 A       <span class="number">1.5</span></span><br><span class="line"><span class="number">10</span> name3 B       <span class="number">0.9</span></span><br><span class="line"><span class="number">11</span> name3 C       <span class="number">1</span>  </span><br><span class="line"><span class="number">12</span> name3 D       <span class="number">1.2</span></span><br><span class="line"><span class="number">13</span> name4 A       <span class="number">1.8</span></span><br><span class="line"><span class="number">14</span> name4 B       <span class="number">1.3</span></span><br><span class="line"><span class="number">15</span> name4 C       <span class="number">1.2</span></span><br><span class="line"><span class="number">16</span> name4 D       <span class="number">1.5</span></span><br><span class="line"><span class="number">17</span> name5 A       <span class="number">2.2</span></span><br><span class="line"><span class="number">18</span> name5 B       <span class="number">1.8</span></span><br><span class="line"><span class="number">19</span> name5 C       <span class="number">2.2</span></span><br><span class="line"><span class="number">20</span> name5 D       <span class="number">3.2</span></span><br></pre></td></tr></table></figure>

<h3 id="3-tidyr-pivot-wider"><a href="#3-tidyr-pivot-wider" class="headerlink" title="3. tidyr::pivot_wider()"></a>3. tidyr::pivot_wider()</h3><p>将长表格变回宽表格，用pivot_wider()。<br>参数：</p>
<ul>
<li>names_from:转换之后列名所在的列的列名</li>
<li>values_from:转换之后列中值所在的列名</li>
</ul>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">long_data <span class="operator">%&gt;%</span> </span><br><span class="line"> pivot_wider<span class="punctuation">(</span></span><br><span class="line"> 	names_from<span class="operator">=</span><span class="string">&quot;rep&quot;</span><span class="punctuation">,</span></span><br><span class="line"> 	values_from<span class="operator">=</span><span class="string">&quot;exp&quot;</span><span class="punctuation">)</span></span><br><span class="line">name      A     B     C     D</span><br><span class="line">  <span class="operator">&lt;</span>fct<span class="operator">&gt;</span> <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span> <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span> <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span> <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span></span><br><span class="line"><span class="number">1</span> name1   <span class="number">0.7</span>   <span class="number">0.5</span>   <span class="number">0.3</span>   <span class="number">0.4</span></span><br><span class="line"><span class="number">2</span> name2   <span class="number">1</span>     <span class="number">0.7</span>   <span class="number">0.6</span>   <span class="number">0.7</span></span><br><span class="line"><span class="number">3</span> name3   <span class="number">1.5</span>   <span class="number">0.9</span>   <span class="number">1</span>     <span class="number">1.2</span></span><br><span class="line"><span class="number">4</span> name4   <span class="number">1.8</span>   <span class="number">1.3</span>   <span class="number">1.2</span>   <span class="number">1.5</span></span><br><span class="line"><span class="number">5</span> name5   <span class="number">2.2</span>   <span class="number">1.8</span>   <span class="number">2.2</span>   <span class="number">3.2</span></span><br></pre></td></tr></table></figure>

<h3 id="4-列名转换成多个变量"><a href="#4-列名转换成多个变量" class="headerlink" title="4. 列名转换成多个变量"></a>4. 列名转换成多个变量</h3><p>当想要将原始的数据框的列名转换为多个变量时，怎么办?如下例,将A、B、C成为物种变量，其他的para1、para2、para3成为parameter变量：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">df <span class="operator">&lt;-</span> data.frame<span class="punctuation">(</span></span><br><span class="line">         day <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">1L</span><span class="punctuation">,</span> <span class="number">2L</span><span class="punctuation">,</span> <span class="number">3L</span><span class="punctuation">,</span> <span class="number">4L</span><span class="punctuation">,</span> <span class="number">5L</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    A_para1 <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">1.1</span><span class="punctuation">,</span> <span class="number">1.2</span><span class="punctuation">,</span> <span class="number">1.3</span><span class="punctuation">,</span> <span class="number">1.4</span><span class="punctuation">,</span> <span class="number">1.5</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">     A_para2 <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">2.1</span><span class="punctuation">,</span> <span class="number">2.2</span><span class="punctuation">,</span> <span class="number">2.3</span><span class="punctuation">,</span> <span class="number">2.4</span><span class="punctuation">,</span> <span class="number">2.5</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">     A_para3 <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">3.1</span><span class="punctuation">,</span> <span class="number">3.2</span><span class="punctuation">,</span> <span class="number">3.3</span><span class="punctuation">,</span> <span class="number">3.4</span><span class="punctuation">,</span> <span class="number">3.5</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    B_para1 <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">4.1</span><span class="punctuation">,</span> <span class="number">4.2</span><span class="punctuation">,</span> <span class="number">4.3</span><span class="punctuation">,</span> <span class="number">4.4</span><span class="punctuation">,</span> <span class="number">4.5</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">     B_para2 <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">5.1</span><span class="punctuation">,</span> <span class="number">5.2</span><span class="punctuation">,</span> <span class="number">5.3</span><span class="punctuation">,</span> <span class="number">5.4</span><span class="punctuation">,</span> <span class="number">5.5</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">     B_para3 <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">6.1</span><span class="punctuation">,</span> <span class="number">6.2</span><span class="punctuation">,</span> <span class="number">6.3</span><span class="punctuation">,</span> <span class="number">6.4</span><span class="punctuation">,</span> <span class="number">6.5</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    C_para1 <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">7.1</span><span class="punctuation">,</span> <span class="number">7.2</span><span class="punctuation">,</span> <span class="number">7.3</span><span class="punctuation">,</span> <span class="number">7.4</span><span class="punctuation">,</span> <span class="number">7.5</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">     C_para2 <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">8.1</span><span class="punctuation">,</span> <span class="number">8.2</span><span class="punctuation">,</span> <span class="number">8.3</span><span class="punctuation">,</span> <span class="number">8.4</span><span class="punctuation">,</span> <span class="number">8.5</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">     C_para3 <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">9.1</span><span class="punctuation">,</span> <span class="number">9.2</span><span class="punctuation">,</span> <span class="number">9.3</span><span class="punctuation">,</span> <span class="number">9.4</span><span class="punctuation">,</span> <span class="number">9.5</span><span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">df <span class="operator">%&gt;%</span> </span><br><span class="line">  pivot_longer<span class="punctuation">(</span></span><br><span class="line">    cols <span class="operator">=</span> <span class="operator">!</span>day<span class="punctuation">,</span></span><br><span class="line">    names_to <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;species&quot;</span><span class="punctuation">,</span> <span class="string">&quot;parameter&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    names_pattern <span class="operator">=</span> <span class="string">&quot;(.*)_(.*)&quot;</span><span class="punctuation">,</span></span><br><span class="line">    values_to <span class="operator">=</span> <span class="string">&quot;value&quot;</span></span><br><span class="line"><span class="punctuation">)</span></span><br><span class="line"><span class="comment"># A tibble: 45 x 4</span></span><br><span class="line">     day species parameter value</span><br><span class="line">   <span class="operator">&lt;</span>int<span class="operator">&gt;</span> <span class="operator">&lt;</span>chr<span class="operator">&gt;</span>   <span class="operator">&lt;</span>chr<span class="operator">&gt;</span>     <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span></span><br><span class="line"> <span class="number">1</span>     <span class="number">1</span> A       para1       <span class="number">1.1</span></span><br><span class="line"> <span class="number">2</span>     <span class="number">1</span> A       para2       <span class="number">2.1</span></span><br><span class="line"> <span class="number">3</span>     <span class="number">1</span> A       para3       <span class="number">3.1</span></span><br><span class="line"> <span class="number">4</span>     <span class="number">1</span> B       para1       <span class="number">4.1</span></span><br><span class="line"> <span class="number">5</span>     <span class="number">1</span> B       para2       <span class="number">5.1</span></span><br><span class="line"> <span class="number">6</span>     <span class="number">1</span> B       para3       <span class="number">6.1</span></span><br><span class="line"> <span class="number">7</span>     <span class="number">1</span> C       para1       <span class="number">7.1</span></span><br><span class="line"> <span class="number">8</span>     <span class="number">1</span> C       para2       <span class="number">8.1</span></span><br><span class="line"> <span class="number">9</span>     <span class="number">1</span> C       para3       <span class="number">9.1</span></span><br><span class="line"><span class="number">10</span>     <span class="number">2</span> A       para1       <span class="number">1.2</span></span><br><span class="line"><span class="comment"># ... with 35 more rows</span></span><br></pre></td></tr></table></figure>

<h3 id="5-复杂的情形"><a href="#5-复杂的情形" class="headerlink" title="5. 复杂的情形"></a>5. 复杂的情形</h3><p>希望原始数据框的列名中，一部分进入变量，一部分保持原来的列名，比如，从表1到表2：<br><strong>表1：</strong></p>
<table>
<thead>
<tr>
<th>name</th>
<th>A_para1</th>
<th>A_para2</th>
<th>A_para3</th>
<th>B_para1</th>
<th>B_para2</th>
<th>B_para3</th>
</tr>
</thead>
<tbody><tr>
<td>name1</td>
<td>1</td>
<td>2</td>
<td>3</td>
<td>4</td>
<td>5</td>
<td>6</td>
</tr>
<tr>
<td>name2</td>
<td>7</td>
<td>8</td>
<td>9</td>
<td>10</td>
<td>1</td>
<td>2</td>
</tr>
<tr>
<td>name3</td>
<td>3</td>
<td>4</td>
<td>5</td>
<td>6</td>
<td>7</td>
<td>8</td>
</tr>
</tbody></table>
<p><strong>表2：</strong></p>
<table>
<thead>
<tr>
<th>name</th>
<th>rep</th>
<th>para1</th>
<th>para2</th>
<th>para3</th>
</tr>
</thead>
<tbody><tr>
<td>name1</td>
<td>A</td>
<td>1</td>
<td>2</td>
<td>3</td>
</tr>
<tr>
<td>name2</td>
<td>A</td>
<td>7</td>
<td>8</td>
<td>9</td>
</tr>
<tr>
<td>name3</td>
<td>A</td>
<td>3</td>
<td>4</td>
<td>5</td>
</tr>
<tr>
<td>name1</td>
<td>B</td>
<td>4</td>
<td>5</td>
<td>6</td>
</tr>
<tr>
<td>name2</td>
<td>B</td>
<td>10</td>
<td>1</td>
<td>2</td>
</tr>
<tr>
<td>name3</td>
<td>B</td>
<td>6</td>
<td>7</td>
<td>8</td>
</tr>
</tbody></table>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">df_part_longer <span class="operator">&lt;-</span> df <span class="operator">%&gt;%</span> </span><br><span class="line">  tidyr<span class="operator">::</span>pivot_longer<span class="punctuation">(</span></span><br><span class="line">   cols <span class="operator">=</span> <span class="operator">!</span>day<span class="punctuation">,</span></span><br><span class="line">   names_to <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;species&quot;</span><span class="punctuation">,</span> <span class="string">&quot;.value&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">   names_pattern <span class="operator">=</span> <span class="string">&quot;(.*)_(.*)&quot;</span></span><br><span class="line"><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">df_part_longer</span><br><span class="line"><span class="comment"># A tibble: 15 x 5</span></span><br><span class="line">     day species para1 para2 para3</span><br><span class="line">   <span class="operator">&lt;</span>int<span class="operator">&gt;</span> <span class="operator">&lt;</span>chr<span class="operator">&gt;</span>   <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span> <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span> <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span></span><br><span class="line"> <span class="number">1</span>     <span class="number">1</span> A         <span class="number">1.1</span>   <span class="number">2.1</span>   <span class="number">3.1</span></span><br><span class="line"> <span class="number">2</span>     <span class="number">1</span> B         <span class="number">4.1</span>   <span class="number">5.1</span>   <span class="number">6.1</span></span><br><span class="line"> <span class="number">3</span>     <span class="number">1</span> C         <span class="number">7.1</span>   <span class="number">8.1</span>   <span class="number">9.1</span></span><br><span class="line"> <span class="number">4</span>     <span class="number">2</span> A         <span class="number">1.2</span>   <span class="number">2.2</span>   <span class="number">3.2</span></span><br><span class="line"> <span class="number">5</span>     <span class="number">2</span> B         <span class="number">4.2</span>   <span class="number">5.2</span>   <span class="number">6.2</span></span><br><span class="line"> <span class="number">6</span>     <span class="number">2</span> C         <span class="number">7.2</span>   <span class="number">8.2</span>   <span class="number">9.2</span></span><br><span class="line"> <span class="number">7</span>     <span class="number">3</span> A         <span class="number">1.3</span>   <span class="number">2.3</span>   <span class="number">3.3</span></span><br><span class="line"> <span class="number">8</span>     <span class="number">3</span> B         <span class="number">4.3</span>   <span class="number">5.3</span>   <span class="number">6.3</span></span><br><span class="line"> <span class="number">9</span>     <span class="number">3</span> C         <span class="number">7.3</span>   <span class="number">8.3</span>   <span class="number">9.3</span></span><br><span class="line"><span class="number">10</span>     <span class="number">4</span> A         <span class="number">1.4</span>   <span class="number">2.4</span>   <span class="number">3.4</span></span><br><span class="line"><span class="number">11</span>     <span class="number">4</span> B         <span class="number">4.4</span>   <span class="number">5.4</span>   <span class="number">6.4</span></span><br><span class="line"><span class="number">12</span>     <span class="number">4</span> C         <span class="number">7.4</span>   <span class="number">8.4</span>   <span class="number">9.4</span></span><br><span class="line"><span class="number">13</span>     <span class="number">5</span> A         <span class="number">1.5</span>   <span class="number">2.5</span>   <span class="number">3.5</span></span><br><span class="line"><span class="number">14</span>     <span class="number">5</span> B         <span class="number">4.5</span>   <span class="number">5.5</span>   <span class="number">6.5</span></span><br><span class="line"><span class="number">15</span>     <span class="number">5</span> C         <span class="number">7.5</span>   <span class="number">8.5</span>   <span class="number">9.5</span></span><br></pre></td></tr></table></figure>

<p>反过来：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">df_part_longer <span class="operator">%&gt;%</span> </span><br><span class="line">  tidyr<span class="operator">::</span>pivot_wider<span class="punctuation">(</span></span><br><span class="line">    names_from <span class="operator">=</span> species<span class="punctuation">,</span></span><br><span class="line">    values_from <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span>para1<span class="punctuation">,</span> para2<span class="punctuation">,</span> para3<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    names_glue <span class="operator">=</span> <span class="string">&quot;&#123;species&#125;_&#123;.value&#125;&quot;</span></span><br><span class="line">  <span class="punctuation">)</span></span><br><span class="line"><span class="comment"># A tibble: 5 x 10</span></span><br><span class="line">    day A_para1 B_para1 C_para1 A_para2 B_para2 C_para2 A_para3 B_para3 C_para3</span><br><span class="line">  <span class="operator">&lt;</span>int<span class="operator">&gt;</span>   <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span>   <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span>   <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span>   <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span>   <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span>   <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span>   <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span>   <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span>   <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span></span><br><span class="line"><span class="number">1</span>     <span class="number">1</span>     <span class="number">1.1</span>     <span class="number">4.1</span>     <span class="number">7.1</span>     <span class="number">2.1</span>     <span class="number">5.1</span>     <span class="number">8.1</span>     <span class="number">3.1</span>     <span class="number">6.1</span>     <span class="number">9.1</span></span><br><span class="line"><span class="number">2</span>     <span class="number">2</span>     <span class="number">1.2</span>     <span class="number">4.2</span>     <span class="number">7.2</span>     <span class="number">2.2</span>     <span class="number">5.2</span>     <span class="number">8.2</span>     <span class="number">3.2</span>     <span class="number">6.2</span>     <span class="number">9.2</span></span><br><span class="line"><span class="number">3</span>     <span class="number">3</span>     <span class="number">1.3</span>     <span class="number">4.3</span>     <span class="number">7.3</span>     <span class="number">2.3</span>     <span class="number">5.3</span>     <span class="number">8.3</span>     <span class="number">3.3</span>     <span class="number">6.3</span>     <span class="number">9.3</span></span><br><span class="line"><span class="number">4</span>     <span class="number">4</span>     <span class="number">1.4</span>     <span class="number">4.4</span>     <span class="number">7.4</span>     <span class="number">2.4</span>     <span class="number">5.4</span>     <span class="number">8.4</span>     <span class="number">3.4</span>     <span class="number">6.4</span>     <span class="number">9.4</span></span><br><span class="line"><span class="number">5</span>     <span class="number">5</span>     <span class="number">1.5</span>     <span class="number">4.5</span>     <span class="number">7.5</span>     <span class="number">2.5</span>     <span class="number">5.5</span>     <span class="number">8.5</span>     <span class="number">3.5</span>     <span class="number">6.5</span>     <span class="number">9.5</span></span><br></pre></td></tr></table></figure>



<p>参考资料：</p>
<ol>
<li><a href="https://bookdown.org/wangminjie/R4DS/tidyverse-tidyr.html">https://bookdown.org/wangminjie/R4DS/tidyverse-tidyr.html</a></li>
</ol>
]]></content>
      <categories>
        <category>R</category>
        <category>Tidyverse</category>
      </categories>
      <tags>
        <tag>R</tag>
        <tag>Tidyverse</tag>
      </tags>
  </entry>
  <entry>
    <title>FPKM、RPKM、CPM、TPM计算方式</title>
    <url>/2023/04/20/FPKM%E3%80%81RPKM%E3%80%81CPM%E3%80%81TPM%E8%AE%A1%E7%AE%97%E6%96%B9%E5%BC%8F/</url>
    <content><![CDATA[<p>本文总结CPM、RPKM、FPKM、TMP、RPM的计算。</p>
<span id="more"></span>

<h3 id="1-RPM-x2F-CPM"><a href="#1-RPM-x2F-CPM" class="headerlink" title="1. RPM&#x2F;CPM"></a>1. RPM&#x2F;CPM</h3><p>Reads&#x2F;Counts per million mapped reads。</p>
<p>计算方式：<br>    <em><strong>RPM&#x3D;ExonMappedReads*10^6&#x2F;TotalMappedReads</strong></em></p>
<ul>
<li>只对文库大小测序深度进行了normalize，没有考虑基因长度的影响。</li>
<li>适用于reads不受基因长度影响的测序，如miRNA测序等。</li>
<li>可以用于比较同一个基因在不同样品间的差异，不能用于比较不同基因之间的表达差异。</li>
</ul>
<h3 id="2-RPKM-x2F-FPKM"><a href="#2-RPKM-x2F-FPKM" class="headerlink" title="2. RPKM&#x2F;FPKM"></a>2. RPKM&#x2F;FPKM</h3><p>Reads per kilobase(kb) per million mapped reads。</p>
<p><img src="/pics/2023-04-20-FPKM.jpg" alt="alt 图标"><br><img src="/pics/2023-04-20-RPKM.jpg" alt="alt 图标"></p>
<p>以RPKM为例，计算公式：<br><strong>长度以kb为单位：</strong><br>    <em>ExonMappedReads*10^6&#x2F;(TotalMappedReads*ExonLength)</em><br><strong>长度以bp为单位：</strong><br>    <em>ExonMappedReads*10^3*10^6&#x2F;(TotalMappedReads*ExonLength)</em></p>
<ul>
<li>对基因长度和测序深度都进行了归一化。</li>
<li>RPKM适用于单端测序，一条read就是一个count。</li>
<li>FPKM适用于双端测序，双端测序时一条read测了两遍，因此两条同样的read只能count一次，称为fragment。</li>
</ul>
<h3 id="3-TPM"><a href="#3-TPM" class="headerlink" title="3. TPM"></a>3. TPM</h3><p>Transcript per kilobase(kb) per million mapped reads。</p>
<p><img src="/pics/2023-04-20-TPM.jpg" alt="alt 图标"></p>
<p>计算公式：<br><strong>长度以KB为单位：</strong><br>    <em>TPM&#x3D;(Ni&#x2F;Li)*10^6&#x2F;sum(Ni&#x2F;Li+……..+ Rm&#x2F;Lm)</em><br><strong>长度以bp为单位：</strong><br>    <em>TPM&#x3D;(Ni&#x2F;Li)*10^6*10^3&#x2F;sum(Ni&#x2F;Li+……..+ Rm&#x2F;Lm)</em></p>
<ul>
<li>每项意义：<ul>
<li><em>Ni</em>：mapping到基因i上的read数； </li>
<li><em>Li</em>：基因i的外显子长度的总和；</li>
<li><em>Li</em>的单位是kb，如果是bp，分子需要再除以1000；</li>
</ul>
</li>
<li>分子*Ni&#x2F;(Li(bp)&#x2F;1000)*是根据基因&#x2F;转录本的长度校正count值；</li>
<li>分母*sum(Ni&#x2F;Li+……..+ Rm&#x2F;Lm)*是根据基因&#x2F;转录本长度校正之后的count值总和；</li>
<li>TPM先对基因长度进行标准化，再对测序深度进行标准化。</li>
</ul>
<h3 id="4-RPKM和TPM关系"><a href="#4-RPKM和TPM关系" class="headerlink" title="4. RPKM和TPM关系"></a>4. RPKM和TPM关系</h3><p><img src="/pics/2023-04-20-TPM-FPKM.jpg" alt="alt 图标"></p>
<h3 id="5-各种标准化方法对比"><a href="#5-各种标准化方法对比" class="headerlink" title="5. 各种标准化方法对比"></a>5. 各种标准化方法对比</h3><p><img src="/pics/2023-04-20-normalization-duibi.jpg" alt="alt 图标"></p>
<p>参考：</p>
<ol>
<li><a href="https://www.jianshu.com/p/1940c5954c81">https://www.jianshu.com/p/1940c5954c81</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/580665520">https://zhuanlan.zhihu.com/p/580665520</a></li>
</ol>
]]></content>
      <categories>
        <category>RNA-seq</category>
      </categories>
      <tags>
        <tag>RNA-seq</tag>
      </tags>
  </entry>
  <entry>
    <title>RiboMiner获取最长转录本信息</title>
    <url>/2023/04/20/RiboMiner%E8%8E%B7%E5%8F%96%E6%9C%80%E9%95%BF%E8%BD%AC%E5%BD%95%E6%9C%AC%E4%BF%A1%E6%81%AF/</url>
    <content><![CDATA[<p>本文总结利用RiboMiner包获取最长转录本信息及序列。</p>
<span id="more"></span>

<h3 id="1-得到所有转录本的信息"><a href="#1-得到所有转录本的信息" class="headerlink" title="1. 得到所有转录本的信息"></a>1. 得到所有转录本的信息</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">prepare_transcripts -g Homo_sapiens.GRCh38.88.gtf -f Homo_sapiens.GRCh38.dna.primary_assembly.fa -o Ribo_ann</span><br></pre></td></tr></table></figure>
<ul>
<li>input<ul>
<li>基因组gtf文件</li>
<li>基因组序列</li>
</ul>
</li>
<li>output<ul>
<li>transcripts_cds.txt 所有转录本的cds序列信息</li>
<li>transcripts_sequence.fa 所有转录本序列</li>
</ul>
</li>
</ul>
<h3 id="2-得到最长转录本的信息"><a href="#2-得到最长转录本的信息" class="headerlink" title="2. 得到最长转录本的信息"></a>2. 得到最长转录本的信息</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">OutputTranscriptInfo -c transcripts_cds.txt -g Homo_sapiens.GRCh38.88.gtf -f transcripts_sequence.fa -o longest.transcripts.info.txt -O all.transcripts.info.txt</span><br></pre></td></tr></table></figure>

<ul>
<li>input:<ul>
<li>transcripts_cds.txt 所有转录本的cds序列</li>
<li>transcripts_sequence.fa 所有转录本序列</li>
<li>Homo_sapiens.GRCh38.88.gtf 参考基因组gtf文件</li>
</ul>
</li>
<li>output:<ul>
<li>longest.transcripts.info.txt 最长转录本的信息</li>
<li>all.transcripts.info.txt 所有转录本的信息</li>
</ul>
</li>
</ul>
<h3 id="3-得到最长转录本的序列"><a href="#3-得到最长转录本的序列" class="headerlink" title="3. 得到最长转录本的序列"></a>3. 得到最长转录本的序列</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">GetProteinCodingSequence -i transcripts_sequence.fa  -c longest.transcripts.info.txt -o output_prefix --mode whole --table 1 &#123;-l -r -S&#125;</span><br><span class="line"></span><br><span class="line">GetProteinCodingSequence -i transcripts_sequence.fa  -c longest.transcripts.info.txt -o longest</span><br></pre></td></tr></table></figure>

<ul>
<li>input:<ul>
<li>longest.transcripts.info.txt 最长转录本的信息</li>
<li>transcripts_sequence.fa 所有转录本的序列</li>
</ul>
</li>
<li>output：<ul>
<li>longest_amino_acid_sequences.fa 最长转录本的氨基酸序列</li>
<li>longest_cds_sequences.fa 最长转录本的cds序列</li>
<li>longest_transcript_sequences.fa 最长转录本的基因组序列</li>
</ul>
</li>
</ul>
<h3 id="4-得到UTR序列"><a href="#4-得到UTR序列" class="headerlink" title="4. 得到UTR序列"></a>4. 得到UTR序列</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">GetUTRSequences -i input_transcript_sequences.fa -o output_prefix -c transcripts_cds.txt</span><br><span class="line"></span><br><span class="line">GetUTRSequences -i longest_transcript_sequences.fa -o longest -c Ribo_ann/transcripts_cds.txt</span><br><span class="line"></span><br><span class="line">GetUTRSequences -i Ribo_ann/transcripts_sequence.fa -o all -c Ribo_ann/transcripts_cds.txt</span><br></pre></td></tr></table></figure>

<ul>
<li>input:<ul>
<li>input_transcript_sequences.fa 从transcript_sequence.fa中得到的任何序列</li>
<li>transcript_cds.txt 转录本的cds起始位置信息</li>
</ul>
</li>
<li>output:<ul>
<li>prefix&#x2F;longest&#x2F;all_3UTR.fa 3UTR序列</li>
<li>prefix&#x2F;longest&#x2F;all_5UTR.fa 5UTR序列</li>
<li>prefix&#x2F;longest&#x2F;all_CDS.fa CDS序列</li>
<li>prefix&#x2F;longest&#x2F;all.transcripts.info.txt 转录本信息</li>
</ul>
</li>
</ul>
<p>参考：<br>1.<a href="https://github.com/xryanglab/RiboMiner">https://github.com/xryanglab/RiboMiner</a></p>
]]></content>
      <categories>
        <category>Ribo-seq</category>
      </categories>
      <tags>
        <tag>Ribo-seq</tag>
      </tags>
  </entry>
  <entry>
    <title>R中purrr包的循环迭代map函数家族</title>
    <url>/2023/04/25/R%E4%B8%ADpurrr%E5%8C%85%E7%9A%84%E5%BE%AA%E7%8E%AF%E8%BF%AD%E4%BB%A3map%E5%87%BD%E6%95%B0%E5%AE%B6%E6%97%8F/</url>
    <content><![CDATA[<p>R中的循环，除了手动for循环（不推荐）、apply函数家族，还有purrr包中的map()函数家族。</p>
<span id="more"></span>

<p>purrr包中的map()函数是函数的函数，这样的编程方式成为泛函式编程，表示函数作用在函数上。<br>map()函数通过循环迭代可以确定返回的数据类型，如下：</p>
<ul>
<li>map_chr(.x, .f): 返回字符型向量</li>
<li>map_lgl(.x, .f): 返回逻辑型向量</li>
<li>map_dbl(.x, .f): 返回实数型向量</li>
<li>map_int(.x, .f): 返回整数型向量</li>
<li>map_df(.x, .f) : 返回数据框</li>
<li>map_dfr(.x, .f): 返回数据框列表，再 bind_rows 按行合并为一个数据框</li>
<li>map_dfc(.x, .f): 返回数据框列表，再 bind_cols 按列合并为一个数据框</li>
</ul>
<h3 id="1-map"><a href="#1-map" class="headerlink" title="1. map()"></a>1. map()</h3><p>map(x,f)函数第一个参数是list或vector，第二个参数是函数，map()将函数f应用到list&#x2F;vector的每个元素，然后输入的list&#x2F;vector中的每一个元素都对应一个输出，最后将这些元素对应的输出聚合成一个新的list。<br>data.frame是列表的一种特殊形式，所以数据框也可以作为map函数的输入。<br>过程如下图：</p>
<p><img src="/pics/2023-04-25-map1.png" alt="alt 图标"></p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">data <span class="operator">&lt;-</span> <span class="built_in">list</span><span class="punctuation">(</span></span><br><span class="line">  col1 <span class="operator">=</span> <span class="built_in">round</span><span class="punctuation">(</span>runif<span class="punctuation">(</span><span class="number">10</span><span class="punctuation">,</span> <span class="number">50</span><span class="punctuation">,</span> <span class="number">100</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">  col2 <span class="operator">=</span> <span class="built_in">round</span><span class="punctuation">(</span>runif<span class="punctuation">(</span><span class="number">10</span><span class="punctuation">,</span> <span class="number">50</span><span class="punctuation">,</span> <span class="number">100</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">  col3 <span class="operator">=</span> <span class="built_in">round</span><span class="punctuation">(</span>runif<span class="punctuation">(</span><span class="number">10</span><span class="punctuation">,</span> <span class="number">50</span><span class="punctuation">,</span> <span class="number">100</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">  col4 <span class="operator">=</span> <span class="built_in">round</span><span class="punctuation">(</span>runif<span class="punctuation">(</span><span class="number">10</span><span class="punctuation">,</span> <span class="number">50</span><span class="punctuation">,</span> <span class="number">100</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">  col5 <span class="operator">=</span> <span class="built_in">round</span><span class="punctuation">(</span>runif<span class="punctuation">(</span><span class="number">10</span><span class="punctuation">,</span> <span class="number">50</span><span class="punctuation">,</span> <span class="number">100</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">)</span></span><br><span class="line">data</span><br><span class="line"><span class="operator">$</span>col1</span><br><span class="line"> <span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span> <span class="number">80</span> <span class="number">74</span> <span class="number">90</span> <span class="number">75</span> <span class="number">64</span> <span class="number">70</span> <span class="number">51</span> <span class="number">84</span> <span class="number">67</span> <span class="number">68</span></span><br><span class="line"></span><br><span class="line"><span class="operator">$</span>col2</span><br><span class="line"> <span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span>  <span class="number">97</span>  <span class="number">82</span>  <span class="number">97</span> <span class="number">100</span>  <span class="number">62</span>  <span class="number">85</span>  <span class="number">74</span>  <span class="number">99</span>  <span class="number">66</span>  <span class="number">67</span></span><br><span class="line"></span><br><span class="line"><span class="operator">$</span>col3</span><br><span class="line"> <span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span> <span class="number">69</span> <span class="number">82</span> <span class="number">91</span> <span class="number">51</span> <span class="number">94</span> <span class="number">87</span> <span class="number">86</span> <span class="number">77</span> <span class="number">57</span> <span class="number">53</span></span><br><span class="line"></span><br><span class="line"><span class="operator">$</span>col4</span><br><span class="line"> <span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span> <span class="number">88</span> <span class="number">62</span> <span class="number">59</span> <span class="number">92</span> <span class="number">61</span> <span class="number">96</span> <span class="number">94</span> <span class="number">69</span> <span class="number">65</span> <span class="number">64</span></span><br><span class="line"></span><br><span class="line"><span class="operator">$</span>col5</span><br><span class="line"> <span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span> <span class="number">79</span> <span class="number">92</span> <span class="number">50</span> <span class="number">57</span> <span class="number">92</span> <span class="number">94</span> <span class="number">61</span> <span class="number">59</span> <span class="number">70</span> <span class="number">68</span></span><br></pre></td></tr></table></figure>

<p>用map函数求每个col的均值：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">map<span class="punctuation">(</span>data<span class="punctuation">,</span>mean<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">data <span class="operator">%&gt;%</span> map<span class="punctuation">(</span>mean<span class="punctuation">)</span></span><br><span class="line"><span class="operator">$</span>col1</span><br><span class="line"><span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span> <span class="number">72.3</span></span><br><span class="line"></span><br><span class="line"><span class="operator">$</span>col2</span><br><span class="line"><span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span> <span class="number">82.9</span></span><br><span class="line"></span><br><span class="line"><span class="operator">$</span>col3</span><br><span class="line"><span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span> <span class="number">74.7</span></span><br><span class="line"></span><br><span class="line"><span class="operator">$</span>col4</span><br><span class="line"><span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span> <span class="number">75</span></span><br><span class="line"></span><br><span class="line"><span class="operator">$</span>col5</span><br><span class="line"><span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span> <span class="number">72.2</span></span><br></pre></td></tr></table></figure>

<p>等价于：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line"><span class="built_in">list</span><span class="punctuation">(</span></span><br><span class="line">  col1 <span class="operator">=</span> mean<span class="punctuation">(</span>exams<span class="operator">$</span>col1<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">  col2 <span class="operator">=</span> mean<span class="punctuation">(</span>exams<span class="operator">$</span>col2<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">  col3 <span class="operator">=</span> mean<span class="punctuation">(</span>exams<span class="operator">$</span>col3<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">  col4 <span class="operator">=</span> mean<span class="punctuation">(</span>exams<span class="operator">$</span>col4<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">  col5 <span class="operator">=</span> mean<span class="punctuation">(</span>exams<span class="operator">$</span>col5<span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<p>map函数也可以添加其他f的参数：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">map<span class="punctuation">(</span>x<span class="punctuation">,</span>f<span class="punctuation">,</span>...<span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<p>过程如图：<br><img src="/pics/2023-04-25-map_arg.png" alt="alt 图标"></p>
<p>例如，降序排列：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">data <span class="operator">%&gt;%</span> map<span class="punctuation">(</span>sort<span class="punctuation">,</span> decreasing<span class="operator">=</span><span class="literal">TRUE</span><span class="punctuation">)</span></span><br><span class="line"><span class="operator">$</span>col1</span><br><span class="line"> <span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span> <span class="number">90</span> <span class="number">84</span> <span class="number">80</span> <span class="number">75</span> <span class="number">74</span> <span class="number">70</span> <span class="number">68</span> <span class="number">67</span> <span class="number">64</span> <span class="number">51</span></span><br><span class="line"></span><br><span class="line"><span class="operator">$</span>col2</span><br><span class="line"> <span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span> <span class="number">100</span>  <span class="number">99</span>  <span class="number">97</span>  <span class="number">97</span>  <span class="number">85</span>  <span class="number">82</span>  <span class="number">74</span>  <span class="number">67</span>  <span class="number">66</span>  <span class="number">62</span></span><br><span class="line"></span><br><span class="line"><span class="operator">$</span>col3</span><br><span class="line"> <span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span> <span class="number">94</span> <span class="number">91</span> <span class="number">87</span> <span class="number">86</span> <span class="number">82</span> <span class="number">77</span> <span class="number">69</span> <span class="number">57</span> <span class="number">53</span> <span class="number">51</span></span><br><span class="line"></span><br><span class="line"><span class="operator">$</span>col4</span><br><span class="line"> <span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span> <span class="number">96</span> <span class="number">94</span> <span class="number">92</span> <span class="number">88</span> <span class="number">69</span> <span class="number">65</span> <span class="number">64</span> <span class="number">62</span> <span class="number">61</span> <span class="number">59</span></span><br><span class="line"></span><br><span class="line"><span class="operator">$</span>col5</span><br><span class="line"> <span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span> <span class="number">94</span> <span class="number">92</span> <span class="number">92</span> <span class="number">79</span> <span class="number">70</span> <span class="number">68</span> <span class="number">61</span> <span class="number">59</span> <span class="number">57</span> <span class="number">50</span></span><br></pre></td></tr></table></figure>

<h3 id="2-map-函数家族"><a href="#2-map-函数家族" class="headerlink" title="2. map()函数家族"></a>2. map()函数家族</h3><h4 id="2-1-map-dbl"><a href="#2-1-map-dbl" class="headerlink" title="2.1 map_dbl()"></a>2.1 map_dbl()</h4><p>如果每个元素是数值型，map_dbl()会聚合所有元素构成一个原子型向量:<br>返回数值型向量：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">data <span class="operator">%&gt;%</span> map_dbl<span class="punctuation">(</span>mean<span class="punctuation">)</span></span><br><span class="line">col1 col2 col3 col4 col5 </span><br><span class="line"><span class="number">72.3</span> <span class="number">82.9</span> <span class="number">74.7</span> <span class="number">75.0</span> <span class="number">72.2</span></span><br></pre></td></tr></table></figure>
<p><img src="/pics/2023-04-25-map_dbl.png" alt="alt 图标"></p>
<h4 id="2-2-map-df"><a href="#2-2-map-df" class="headerlink" title="2.2 map_df()"></a>2.2 map_df()</h4><p>返回数据框：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">data <span class="operator">%&gt;%</span> map_df<span class="punctuation">(</span>mean<span class="punctuation">)</span></span><br><span class="line"><span class="comment"># A tibble: 1 x 5</span></span><br><span class="line">   col1  col2  col3  col4  col5</span><br><span class="line">  <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span> <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span> <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span> <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span> <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span></span><br><span class="line"><span class="number">1</span>  <span class="number">72.3</span>  <span class="number">82.9</span>  <span class="number">74.7</span>    <span class="number">75</span>  <span class="number">72.2</span></span><br></pre></td></tr></table></figure>

<p>其他类似的函数也是一样的用法。</p>
<h4 id="2-3-map-at"><a href="#2-3-map-at" class="headerlink" title="2.3 map_at()"></a>2.3 map_at()</h4><p>根据一个位置向量，在指定位置进行某个函数操作：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">data <span class="operator">%&gt;%</span> map_at<span class="punctuation">(</span><span class="built_in">c</span><span class="punctuation">(</span><span class="number">1</span><span class="punctuation">,</span><span class="number">3</span><span class="punctuation">)</span><span class="punctuation">,</span><span class="built_in">sqrt</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">data <span class="operator">%&gt;%</span> map_at<span class="punctuation">(</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;col1&quot;</span><span class="punctuation">,</span><span class="string">&quot;col3&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span><span class="built_in">sqrt</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<h4 id="2-4-map-if"><a href="#2-4-map-if" class="headerlink" title="2.4 map_if()"></a>2.4 map_if()</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">```R</span><br><span class="line">is_even &lt;- function(x)&#123;</span><br><span class="line">  !as.logical(x %% 2)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">data$col3 %&gt;% map_if(is_even, sqrt)</span><br></pre></td></tr></table></figure>

<h4 id="2-5-map-df-、map-dfr-、map-dfc"><a href="#2-5-map-df-、map-dfr-、map-dfc" class="headerlink" title="2.5 map_df()、map_dfr()、map_dfc()"></a>2.5 map_df()、map_dfr()、map_dfc()</h4><p>map_df()过程：</p>
<p><img src="/pics/2023-04-25-map_df.png" alt="alt 图标"></p>
<p>map_dfr()过程：</p>
<p><img src="/pics/2023-04-25-map_dfr.png" alt="alt 图标"></p>
<p>map_dfc()过程：</p>
<p><img src="/pics/2023-04-25-map_dfc.png" alt="alt 图标"></p>
<h3 id="3-自定义函数"><a href="#3-自定义函数" class="headerlink" title="3. 自定义函数"></a>3. 自定义函数</h3><figure class="highlight r"><table><tr><td class="code"><pre><span class="line">my_fun <span class="operator">&lt;-</span> <span class="keyword">function</span><span class="punctuation">(</span>x<span class="punctuation">)</span><span class="punctuation">&#123;</span></span><br><span class="line">  mean<span class="punctuation">(</span>x<span class="punctuation">)</span> <span class="operator">+</span> sd<span class="punctuation">(</span>x<span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">data <span class="operator">%&gt;%</span> map_df<span class="punctuation">(</span>my_fun<span class="punctuation">)</span></span><br><span class="line"><span class="comment"># A tibble: 1 x 5</span></span><br><span class="line">   col1  col2  col3  col4  col5</span><br><span class="line">  <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span> <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span> <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span> <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span> <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span></span><br><span class="line"><span class="number">1</span>  <span class="number">83.3</span>  <span class="number">97.8</span>  <span class="number">90.9</span>  <span class="number">90.4</span>  <span class="number">88.4</span></span><br></pre></td></tr></table></figure>

<p>也可以这样：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">data <span class="operator">%&gt;%</span> map_df<span class="punctuation">(</span><span class="keyword">function</span><span class="punctuation">(</span>x<span class="punctuation">)</span> mean<span class="punctuation">(</span>x<span class="punctuation">)</span><span class="operator">+</span>sd<span class="punctuation">(</span>x<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment"># A tibble: 1 x 5</span></span><br><span class="line">   col1  col2  col3  col4  col5</span><br><span class="line">  <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span> <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span> <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span> <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span> <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span></span><br><span class="line"><span class="number">1</span>  <span class="number">83.3</span>  <span class="number">97.8</span>  <span class="number">90.9</span>  <span class="number">90.4</span>  <span class="number">88.4</span></span><br></pre></td></tr></table></figure>

<p>还可以省略function：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">data <span class="operator">%&gt;%</span> map<span class="punctuation">(</span><span class="operator">~</span> mean<span class="punctuation">(</span>.x<span class="punctuation">)</span> <span class="operator">+</span> sd<span class="punctuation">(</span>.x<span class="punctuation">)</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<p>甚至可以：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">data <span class="operator">%&gt;%</span> map<span class="punctuation">(</span><span class="operator">~</span> mean<span class="punctuation">(</span>.<span class="punctuation">)</span> <span class="operator">+</span> sd<span class="punctuation">(</span>.<span class="punctuation">)</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<h3 id="4-map-和modify"><a href="#4-map-和modify" class="headerlink" title="4. map()和modify()"></a>4. map()和modify()</h3><p>两者的区别在于map()函数返回的永远是list，但是modify()返回的和输入的对象类型是一样的。modify()函数也有类似于map()函数的其他函数，如modify_if()、modify_at()。<br>例如:</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">data <span class="operator">%&gt;%</span> map<span class="punctuation">(</span><span class="operator">~</span> mean<span class="punctuation">(</span>.<span class="punctuation">)</span> <span class="operator">+</span> sd<span class="punctuation">(</span>.<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"><span class="operator">$</span>col1</span><br><span class="line"><span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span> <span class="number">83.32573</span></span><br><span class="line"></span><br><span class="line"><span class="operator">$</span>col2</span><br><span class="line"><span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span> <span class="number">97.84025</span></span><br><span class="line"></span><br><span class="line"><span class="operator">$</span>col3</span><br><span class="line"><span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span> <span class="number">90.87302</span></span><br><span class="line"></span><br><span class="line"><span class="operator">$</span>col4</span><br><span class="line"><span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span> <span class="number">90.41284</span></span><br><span class="line"></span><br><span class="line"><span class="operator">$</span>col5</span><br><span class="line"><span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span> <span class="number">88.36443</span></span><br><span class="line"></span><br><span class="line">data <span class="operator">%&gt;%</span> modify<span class="punctuation">(</span><span class="operator">~</span> mean<span class="punctuation">(</span>.<span class="punctuation">)</span> <span class="operator">+</span> sd<span class="punctuation">(</span>.<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"><span class="operator">$</span>col1</span><br><span class="line"><span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span> <span class="number">83.32573</span></span><br><span class="line"></span><br><span class="line"><span class="operator">$</span>col2</span><br><span class="line"><span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span> <span class="number">97.84025</span></span><br><span class="line"></span><br><span class="line"><span class="operator">$</span>col3</span><br><span class="line"><span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span> <span class="number">90.87302</span></span><br><span class="line"></span><br><span class="line"><span class="operator">$</span>col4</span><br><span class="line"><span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span> <span class="number">90.41284</span></span><br><span class="line"></span><br><span class="line"><span class="operator">$</span>col5</span><br><span class="line"><span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span> <span class="number">88.36443</span></span><br></pre></td></tr></table></figure>

<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">data <span class="operator">%&gt;%</span> as_tibble<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span> map<span class="punctuation">(</span><span class="operator">~</span> mean<span class="punctuation">(</span>.<span class="punctuation">)</span> <span class="operator">+</span> sd<span class="punctuation">(</span>.<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"> <span class="comment"># 同上</span></span><br><span class="line">data <span class="operator">%&gt;%</span> as_tibble<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span> modify<span class="punctuation">(</span><span class="operator">~</span> mean<span class="punctuation">(</span>.<span class="punctuation">)</span> <span class="operator">+</span> sd<span class="punctuation">(</span>.<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment"># A tibble: 10 x 5</span></span><br><span class="line">    col1  col2  col3  col4  col5</span><br><span class="line">   <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span> <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span> <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span> <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span> <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span></span><br><span class="line"> <span class="number">1</span>  <span class="number">83.3</span>  <span class="number">97.8</span>  <span class="number">90.9</span>  <span class="number">90.4</span>  <span class="number">88.4</span></span><br><span class="line"> <span class="number">2</span>  <span class="number">83.3</span>  <span class="number">97.8</span>  <span class="number">90.9</span>  <span class="number">90.4</span>  <span class="number">88.4</span></span><br><span class="line"> <span class="number">3</span>  <span class="number">83.3</span>  <span class="number">97.8</span>  <span class="number">90.9</span>  <span class="number">90.4</span>  <span class="number">88.4</span></span><br><span class="line"> <span class="number">4</span>  <span class="number">83.3</span>  <span class="number">97.8</span>  <span class="number">90.9</span>  <span class="number">90.4</span>  <span class="number">88.4</span></span><br><span class="line"> <span class="number">5</span>  <span class="number">83.3</span>  <span class="number">97.8</span>  <span class="number">90.9</span>  <span class="number">90.4</span>  <span class="number">88.4</span></span><br><span class="line"> <span class="number">6</span>  <span class="number">83.3</span>  <span class="number">97.8</span>  <span class="number">90.9</span>  <span class="number">90.4</span>  <span class="number">88.4</span></span><br><span class="line"> <span class="number">7</span>  <span class="number">83.3</span>  <span class="number">97.8</span>  <span class="number">90.9</span>  <span class="number">90.4</span>  <span class="number">88.4</span></span><br><span class="line"> <span class="number">8</span>  <span class="number">83.3</span>  <span class="number">97.8</span>  <span class="number">90.9</span>  <span class="number">90.4</span>  <span class="number">88.4</span></span><br><span class="line"> <span class="number">9</span>  <span class="number">83.3</span>  <span class="number">97.8</span>  <span class="number">90.9</span>  <span class="number">90.4</span>  <span class="number">88.4</span></span><br><span class="line"><span class="number">10</span>  <span class="number">83.3</span>  <span class="number">97.8</span>  <span class="number">90.9</span>  <span class="number">90.4</span>  <span class="number">88.4</span></span><br></pre></td></tr></table></figure>

<h3 id="5-map2"><a href="#5-map2" class="headerlink" title="5. map2()"></a>5. map2()</h3><p>map2()和map()函数类似，map2()接受两个向量，且向量必须等长。<br>map2()函数中两个向量的元素，用<code>.x</code>和<code>.y</code>代替。</p>
<p><img src="/pics/2023-04-25-map2.png" alt="alt 图标"></p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">x <span class="operator">&lt;-</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">1</span><span class="punctuation">,</span> <span class="number">2</span><span class="punctuation">,</span> <span class="number">3</span><span class="punctuation">)</span></span><br><span class="line">y <span class="operator">&lt;-</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">4</span><span class="punctuation">,</span> <span class="number">5</span><span class="punctuation">,</span> <span class="number">6</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">map2<span class="punctuation">(</span>x<span class="punctuation">,</span> y<span class="punctuation">,</span> <span class="operator">~</span> .x <span class="operator">+</span> .y<span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">[[</span><span class="number">1</span><span class="punctuation">]</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span> <span class="number">5</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">[[</span><span class="number">2</span><span class="punctuation">]</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span> <span class="number">7</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">[[</span><span class="number">3</span><span class="punctuation">]</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span> <span class="number">9</span></span><br></pre></td></tr></table></figure>
<p>对tibble中不同的列进行迭代：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">df <span class="operator">&lt;-</span></span><br><span class="line">  tibble<span class="punctuation">(</span></span><br><span class="line">    a <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">1</span><span class="punctuation">,</span> <span class="number">2</span><span class="punctuation">,</span> <span class="number">3</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    b <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">4</span><span class="punctuation">,</span> <span class="number">5</span><span class="punctuation">,</span> <span class="number">6</span><span class="punctuation">)</span></span><br><span class="line">  <span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">df <span class="operator">%&gt;%</span> </span><br><span class="line">  mutate<span class="punctuation">(</span><span class="built_in">min</span> <span class="operator">=</span> map2_dbl<span class="punctuation">(</span>a<span class="punctuation">,</span> b<span class="punctuation">,</span> <span class="operator">~</span><span class="built_in">min</span><span class="punctuation">(</span>.x<span class="punctuation">,</span> .y<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment"># A tibble: 3 x 3</span></span><br><span class="line">      a     b   <span class="built_in">min</span></span><br><span class="line">  <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span> <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span> <span class="operator">&lt;</span>dbl<span class="operator">&gt;</span></span><br><span class="line"><span class="number">1</span>     <span class="number">1</span>     <span class="number">4</span>     <span class="number">1</span></span><br><span class="line"><span class="number">2</span>     <span class="number">2</span>     <span class="number">5</span>     <span class="number">2</span></span><br><span class="line"><span class="number">3</span>     <span class="number">3</span>     <span class="number">6</span>     <span class="number">3</span></span><br></pre></td></tr></table></figure>

<h3 id="6-pmap"><a href="#6-pmap" class="headerlink" title="6. pmap()"></a>6. pmap()</h3><p>pmap()函数不一样的地方：</p>
<ul>
<li>map()函数和map2()函数，指定传递给函数f的向量，向量各自放在各自的位置上</li>
<li>pmap()需要将函数传递给函数的向量名先装入一个list，然后再传递给函数f</li>
</ul>
<p><img src="/pics/2023-04-25-pmap.png" alt="alt 图标"></p>
<p>tbible是特殊的list，这种结构可以直接应用函数：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">tibble<span class="punctuation">(</span></span><br><span class="line">  a <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">50</span><span class="punctuation">,</span> <span class="number">60</span><span class="punctuation">,</span> <span class="number">70</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">  b <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">10</span><span class="punctuation">,</span> <span class="number">90</span><span class="punctuation">,</span> <span class="number">40</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">  <span class="built_in">c</span> <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">1</span><span class="punctuation">,</span> <span class="number">105</span><span class="punctuation">,</span> <span class="number">200</span><span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">)</span> <span class="operator">%&gt;%</span> </span><br><span class="line">pmap_dbl<span class="punctuation">(</span><span class="built_in">min</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<p>pmap()函数中，用<code>..1</code>、<code>..2</code>、<code>..3</code>分别代表三个向量。</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">x <span class="operator">&lt;-</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">1</span><span class="punctuation">,</span> <span class="number">2</span><span class="punctuation">,</span> <span class="number">3</span><span class="punctuation">)</span></span><br><span class="line">y <span class="operator">&lt;-</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">4</span><span class="punctuation">,</span> <span class="number">5</span><span class="punctuation">,</span> <span class="number">6</span><span class="punctuation">)</span></span><br><span class="line">z <span class="operator">&lt;-</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">2</span><span class="punctuation">,</span> <span class="number">3</span><span class="punctuation">,</span> <span class="number">4</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">pmap<span class="punctuation">(</span><span class="built_in">list</span><span class="punctuation">(</span>x<span class="punctuation">,</span> y<span class="punctuation">,</span> z<span class="punctuation">)</span><span class="punctuation">,</span> <span class="operator">~</span> ..1 <span class="operator">+</span> ..2 <span class="operator">+</span> ..3<span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">[[</span><span class="number">1</span><span class="punctuation">]</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span> <span class="number">7</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">[[</span><span class="number">2</span><span class="punctuation">]</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span> <span class="number">10</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">[[</span><span class="number">3</span><span class="punctuation">]</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span> <span class="number">13</span></span><br></pre></td></tr></table></figure>

<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">params <span class="operator">&lt;-</span> tibble<span class="operator">::</span>tribble<span class="punctuation">(</span></span><br><span class="line">  <span class="operator">~</span> n<span class="punctuation">,</span> <span class="operator">~</span> <span class="built_in">min</span><span class="punctuation">,</span> <span class="operator">~</span> <span class="built_in">max</span><span class="punctuation">,</span></span><br><span class="line">   <span class="number">1L</span><span class="punctuation">,</span>     <span class="number">0</span><span class="punctuation">,</span>     <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">   <span class="number">2L</span><span class="punctuation">,</span>    <span class="number">10</span><span class="punctuation">,</span>   <span class="number">100</span><span class="punctuation">,</span></span><br><span class="line">   <span class="number">3L</span><span class="punctuation">,</span>   <span class="number">100</span><span class="punctuation">,</span>  <span class="number">1000</span></span><br><span class="line"><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">pmap<span class="punctuation">(</span>params<span class="punctuation">,</span> <span class="operator">~</span>runif<span class="punctuation">(</span>n <span class="operator">=</span> ..1<span class="punctuation">,</span> <span class="built_in">min</span> <span class="operator">=</span> ..2<span class="punctuation">,</span> <span class="built_in">max</span> <span class="operator">=</span> ..3<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">[[</span><span class="number">1</span><span class="punctuation">]</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span> <span class="number">0.3534275</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">[[</span><span class="number">2</span><span class="punctuation">]</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span> <span class="number">72.76199</span> <span class="number">92.31143</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">[[</span><span class="number">3</span><span class="punctuation">]</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span> <span class="number">207.7082</span> <span class="number">692.6508</span> <span class="number">867.5282</span></span><br></pre></td></tr></table></figure>
<p>如果提供给pmap()的.f是命名函数，且有三个参数（），正好与三个同名元素（params$n,params$min,params$max）一样，则会自动匹配。</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">pmap<span class="punctuation">(</span>params<span class="punctuation">,</span>runif<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<h3 id="7-reduce"><a href="#7-reduce" class="headerlink" title="7. reduce()"></a>7. reduce()</h3><p>参考：<br>1.<a href="https://bookdown.org/wangminjie/R4DS/tidyverse-purrr.html">https://bookdown.org/wangminjie/R4DS/tidyverse-purrr.html</a></p>
]]></content>
      <categories>
        <category>R</category>
        <category>Tidyverse</category>
      </categories>
      <tags>
        <tag>R</tag>
        <tag>Tidyverse</tag>
      </tags>
  </entry>
  <entry>
    <title>awk高级用法</title>
    <url>/2023/05/02/awk%E4%B8%8E%E5%87%BD%E6%95%B0%E7%BB%93%E5%90%88%E7%94%A8%E6%B3%95/</url>
    <content><![CDATA[<p>总结awk中使用内置函数以及if-else、for循环等用法。</p>
<span id="more"></span>

<p>awk中除了一些内置函数之外，也可以与其他函数结合在一起使用实现一些复杂的用法。</p>
<h3 id="1-awk中内置函数"><a href="#1-awk中内置函数" class="headerlink" title="1. awk中内置函数"></a>1. awk中内置函数</h3><table>
<thead>
<tr>
<th align="center">函数</th>
<th align="center">函数作用</th>
<th align="center">用法</th>
<th align="center">命令输出</th>
</tr>
</thead>
<tbody><tr>
<td align="center">length($0)</td>
<td align="center">输出$0的长度</td>
<td align="center"><code>echo &quot;hello&quot; | awk &#39;&#123;print length($0)&#125;&#39;</code></td>
<td align="center">5</td>
</tr>
<tr>
<td align="center">substr(str,start,length)</td>
<td align="center">返回字符串中从start位置开始长度为length的子串</td>
<td align="center"><code>echo &quot;hello world&quot; | awk &#39;&#123;print substr($0,7,5)&#125;&#39;</code></td>
<td align="center">world</td>
</tr>
<tr>
<td align="center">index(str,sub)</td>
<td align="center">返回str字符串中第一次出现子串sub的位置，如果没有匹配，返回0</td>
<td align="center"><code>echo &quot;hello&quot; | awk &#39;&#123;print index($0,&quot;world&quot;)&#125;&#39;</code></td>
<td align="center">7</td>
</tr>
<tr>
<td align="center">split(str,arr,sep)</td>
<td align="center">将字符串按照分隔符sep分隔成数组arr</td>
<td align="center"><code>echo &quot;1,2,3,4&quot; | awk &#39;&#123;split($0,arr,&quot;,&quot;);print arr[3]&#125;&#39;</code></td>
<td align="center">3</td>
</tr>
<tr>
<td align="center">gsub(regexp,replacement,str)</td>
<td align="center">用字符串replacement替换字符串str中所有匹配正则表达式regexp的子串</td>
<td align="center"><code>echo &quot;hello world&quot; | awk &#39;&#123;gsub(/o/,&quot;O&quot;,$0);print&#125;&#39;</code></td>
<td align="center">hellO wOrld</td>
</tr>
<tr>
<td align="center">six(x)、cos(x)、tan(x)、exp(x)、log(x)、sqrt(x)</td>
<td align="center">数学函数，计算正弦值、余弦值、正切值、指数函数、对数、平方根</td>
<td align="center"><code>echo &quot;3.1415926&quot; | awk &#39;&#123;print sin($0)&#125;&#39;</code></td>
<td align="center">0.001592665</td>
</tr>
<tr>
<td align="center">sstrftime(format,timestamp)</td>
<td align="center">将时间戳timestamp格式转换为指定的日期格式</td>
<td align="center"><code>echo $(date +%s) | awk &#39;&#123;print strftime(&quot;%Y-%m-%d %H:%M:%S&quot;, $1)&#125;&#39; </code></td>
<td align="center">输出当前时间的日期格式2023-05-02 12:24:59</td>
</tr>
<tr>
<td align="center">tolower($0)、toupper($0)</td>
<td align="center">将字符串转换为大&#x2F;小写</td>
<td align="center"><code>echo &quot;hello world&quot; | awk &#39;&#123;print toupper($0)&#125;&#39;</code></td>
<td align="center">HELLO WORLD</td>
</tr>
</tbody></table>
<h3 id="2-awk中使用控制语句：if-else条件语句-x2F-for循环-x2F-while循环-x2F-do-while循环"><a href="#2-awk中使用控制语句：if-else条件语句-x2F-for循环-x2F-while循环-x2F-do-while循环" class="headerlink" title="2. awk中使用控制语句：if-else条件语句&#x2F;for循环&#x2F;while循环&#x2F;do-while循环"></a>2. awk中使用控制语句：if-else条件语句&#x2F;for循环&#x2F;while循环&#x2F;do-while循环</h3><ul>
<li><p><code>if/else</code> 条件语句：可以根据指定的条件执行不同的操作。</p>
 <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">awk <span class="string">&#x27;&#123;if($1 &gt; 10) &#123;print &quot;large&quot;&#125; else &#123;print &quot;small&quot;&#125;&#125;&#x27;</span> file.txt</span><br></pre></td></tr></table></figure>
<p>  上面的命令根据第一个字段的值输出 “large” 或 “small”。</p>
</li>
<li><p><code>for</code> 循环：可以使用 <code>for</code> 循环对指定的字段进行遍历。</p>
 <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">awk <span class="string">&#x27;&#123;for(i=1; i&lt;=NF; i++) &#123;print $i&#125;&#125;&#x27;</span> file.txt</span><br></pre></td></tr></table></figure>
<p> 上面的命令遍历每个字段并输出。</p>
</li>
<li><p><code>while</code> 循环：可以使用 <code>while</code> 循环对指定的条件进行迭代。</p>
 <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">awk <span class="string">&#x27;&#123;i=1; while(i&lt;=NF) &#123;print $i; i++&#125;&#125;&#x27;</span> file.txt</span><br></pre></td></tr></table></figure>
<p> 上面的命令使用 <code>while</code> 循环遍历每个字段并输出。</p>
</li>
<li><p><code>do/while</code> 循环：可以使用 <code>do/while</code> 循环对指定的操作进行迭代，直到满足指定的条件为止。</p>
 <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">awk <span class="string">&#x27;&#123;i=1; do &#123;print $i; i++&#125; while(i&lt;=NF)&#125;&#x27;</span> file.txt</span><br></pre></td></tr></table></figure>
<p> 上面的命令使用 <code>do/while</code> 循环遍历每个字段并输出。</p>
</li>
</ul>
<h3 id="3-awk中使用数组"><a href="#3-awk中使用数组" class="headerlink" title="3. awk中使用数组"></a>3. awk中使用数组</h3><p>在 <code>awk</code> 中，数组是一种非常有用的数据结构，可以用于存储和处理文本数据。<code>awk</code> 中的数组是关联数组，也就是说，数组的下标可以是任意字符串或数字。</p>
<p>以下是 <code>awk</code> 中使用数组的示例：</p>
<ol>
<li><p>声明和初始化数组：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">awk <span class="string">&#x27;BEGIN&#123;arr[&quot;apple&quot;]=1; arr[&quot;orange&quot;]=2; arr[&quot;banana&quot;]=3; print arr[&quot;apple&quot;], arr[&quot;orange&quot;], arr[&quot;banana&quot;]&#125;&#x27;</span> file.txt</span><br></pre></td></tr></table></figure>

<p>上面的命令中，声明了一个名为 <code>arr</code> 的数组，并初始化了三个元素，然后输出了这些元素的值。</p>
</li>
<li><p>遍历数组：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">awk <span class="string">&#x27;BEGIN&#123;arr[&quot;apple&quot;]=1; arr[&quot;orange&quot;]=2; arr[&quot;banana&quot;]=3; for(i in arr) &#123;print i, arr[i]&#125;&#125;&#x27;</span> file.txt</span><br></pre></td></tr></table></figure>

<p>上面的命令中，使用 <code>for</code> 循环遍历了 <code>arr</code> 数组，并输出了数组中每个元素的下标和值。</p>
</li>
<li><p>使用数组进行计数：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">awk <span class="string">&#x27;&#123;count[$1]++&#125; END&#123;for(i in count) &#123;print i, count[i]&#125;&#125;&#x27;</span> file.txt</span><br></pre></td></tr></table></figure>

<p>上面的命令中，每次处理一行时，将第一个字段作为数组 <code>count</code> 的下标，并将对应的元素加 1。在处理完所有行后，使用 <code>for</code> 循环遍历 <code>count</code> 数组，并输出每个元素的下标和值，从而实现对每个值出现次数的计数。</p>
</li>
</ol>
<p>以上是 <code>awk</code> 中使用数组的示例，数组在 <code>awk</code> 中的使用非常灵活，可以根据需要进行不同的操作。</p>
<h3 id="4-awk分隔符"><a href="#4-awk分隔符" class="headerlink" title="4. awk分隔符"></a>4. awk分隔符</h3><ol>
<li>使用多个分隔符<br> awk默认使用空格或tab为分隔符，使用多个分隔符时，用-F参数指定 <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">awk -F <span class="string">&#x27;[,;]&#x27;</span> <span class="string">&#x27;&#123;print $1,$2,$3&#125;&#x27;</span> file.txt</span><br></pre></td></tr></table></figure></li>
<li>自定义输出分隔符<br> 使用OFS变量定义自定义输出分隔符： <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">awk <span class="string">&#x27;BEGIN&#123;OFS=&quot;,&quot;&#125; &#123;print $1,$2,$3&#125;&#x27;</span> file.txt</span><br></pre></td></tr></table></figure></li>
<li>使用正则表达式<br> 使用正则表达式匹配文本： <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">awk <span class="string">&#x27;/pattern/&#123;print $1,$2&#125;&#x27;</span> file.txt</span><br></pre></td></tr></table></figure>
 输出文件中包含pattern的行的第一列和第二列。</li>
</ol>
<h3 id="5-awk高级用法实例"><a href="#5-awk高级用法实例" class="headerlink" title="5. awk高级用法实例"></a>5. awk高级用法实例</h3><p>有一个test文件内容如下：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cat</span> <span class="built_in">test</span></span><br><span class="line">1       3</span><br><span class="line">1       4</span><br><span class="line">1       5</span><br><span class="line">2       2</span><br><span class="line">2       5</span><br><span class="line">2       3</span><br></pre></td></tr></table></figure>
<p>利用awk根据第一列值的不同进行分组，求第二列在相应组别中所占的比例。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">awk <span class="string">&#x27;BEGIN&#123;</span></span><br><span class="line"><span class="string">	while (getline &lt; &quot;test&quot;)</span></span><br><span class="line"><span class="string">	&#123;</span></span><br><span class="line"><span class="string">		a[$1]+=$2</span></span><br><span class="line"><span class="string">	&#125;</span></span><br><span class="line"><span class="string">	close(&quot;test&quot;)</span></span><br><span class="line"><span class="string">	while (getline &lt; &quot;test&quot;)</span></span><br><span class="line"><span class="string">	&#123;</span></span><br><span class="line"><span class="string">		for (i in a)</span></span><br><span class="line"><span class="string">		&#123;</span></span><br><span class="line"><span class="string">			if ($i==i)</span></span><br><span class="line"><span class="string">			&#123; print $1,$2,a[i],$2/a[i] &#125;</span></span><br><span class="line"><span class="string">		&#125;</span></span><br><span class="line"><span class="string">	&#125;</span></span><br><span class="line"><span class="string">	close(&quot;test&quot;)</span></span><br><span class="line"><span class="string">&#125;&#x27;</span></span><br></pre></td></tr></table></figure>
<p>结果：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">1 3 12 0.25</span><br><span class="line">1 4 12 0.333333</span><br><span class="line">1 5 12 0.416667</span><br><span class="line">2 2 10 0.2</span><br><span class="line">2 5 10 0.5</span><br><span class="line">2 3 10 0.3</span><br></pre></td></tr></table></figure>
<p>需要将文件遍历两遍，第一遍根据不同的分组计算不同组别的总和（求不同分组的和必然要将文件每一行都遍历一遍），第二遍求每一行相应数据所占的比例。所以需要将该文件遍历两遍，awk中将文件遍历两遍，可以使用getline函数。geline类似于python中的readline，一行一行地读取数据，最后遍历完之后将求得的和存入数组，然后关闭文件再重新进行第二遍的读取。</p>
<p>第一列是字符串时也适用：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cat</span> <span class="built_in">test</span></span><br><span class="line">a       3</span><br><span class="line">a       4</span><br><span class="line">b       5</span><br><span class="line">b       2</span><br><span class="line">c       5</span><br><span class="line">c       3</span><br></pre></td></tr></table></figure>
<p>结果如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">a 3 7 0.428571</span><br><span class="line">a 4 7 0.571429</span><br><span class="line">b 5 7 0.714286</span><br><span class="line">b 2 7 0.285714</span><br><span class="line">c 5 8 0.625</span><br><span class="line">c 3 8 0.375</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>linux</tag>
      </tags>
  </entry>
  <entry>
    <title>ggplot2绘制动图</title>
    <url>/2023/05/02/ggplot2%E7%BB%98%E5%88%B6%E5%8A%A8%E5%9B%BE/</url>
    <content><![CDATA[<p>总结在R中使用ggplot2绘制动图。</p>
<span id="more"></span>

<h3 id="1-举例"><a href="#1-举例" class="headerlink" title="1. 举例"></a>1. 举例</h3><p>绘制动图，两个步骤：静态图绘制、图形组装。ggplot2绘制动图需要用到<code>gganimate</code>这个包。</p>
<p>例如：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">library<span class="punctuation">(</span>tidyverse<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>covdata<span class="punctuation">)</span> <span class="comment"># remotes::install_github(&quot;kjhealy/covdata&quot;)</span></span><br><span class="line">library<span class="punctuation">(</span>gganimate<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">covdata<span class="operator">::</span>covnat_weekly <span class="operator">%&gt;%</span></span><br><span class="line">  dplyr<span class="operator">::</span>filter<span class="punctuation">(</span>iso3 <span class="operator">==</span> <span class="string">&quot;AUT&quot;</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span></span><br><span class="line">  dplyr<span class="operator">::</span>filter<span class="punctuation">(</span>cu_cases <span class="operator">&gt;</span> <span class="number">0</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span></span><br><span class="line">  ggplot<span class="punctuation">(</span>aes<span class="punctuation">(</span>x <span class="operator">=</span> date<span class="punctuation">,</span> y <span class="operator">=</span> cases<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  geom_path<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  labs<span class="punctuation">(</span></span><br><span class="line">    title <span class="operator">=</span> <span class="string">&quot;澳大利亚新冠肺炎累积确诊病例&quot;</span><span class="punctuation">,</span></span><br><span class="line">    subtitle <span class="operator">=</span> <span class="string">&quot;数据来源https://kjhealy.github.io/covdata/&quot;</span></span><br><span class="line">  <span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p>加一行就可以使图片动起来：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">covdata<span class="operator">::</span>covnat_weekly <span class="operator">%&gt;%</span></span><br><span class="line">  dplyr<span class="operator">::</span>filter<span class="punctuation">(</span>iso3 <span class="operator">==</span> <span class="string">&quot;AUT&quot;</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span></span><br><span class="line">  dplyr<span class="operator">::</span>filter<span class="punctuation">(</span>cu_cases <span class="operator">&gt;</span> <span class="number">0</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span></span><br><span class="line">  ggplot<span class="punctuation">(</span>aes<span class="punctuation">(</span>x <span class="operator">=</span> date<span class="punctuation">,</span> y <span class="operator">=</span> cases<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  geom_path<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  labs<span class="punctuation">(</span></span><br><span class="line">    title <span class="operator">=</span> <span class="string">&quot;澳大利亚新冠肺炎累积确诊病例&quot;</span><span class="punctuation">,</span></span><br><span class="line">    subtitle <span class="operator">=</span> <span class="string">&quot;数据来源https://kjhealy.github.io/covdata/&quot;</span></span><br><span class="line">  <span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">  transition_reveal<span class="punctuation">(</span>along <span class="operator">=</span> date<span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<p><img src="/pics/2023-05-02-preview.gif" alt="alt 图标"></p>
<h3 id="2-gganimate中的函数"><a href="#2-gganimate中的函数" class="headerlink" title="2. gganimate中的函数"></a>2. gganimate中的函数</h3><ul>
<li><code>transition_*()</code>: 定义动画是根据哪个变量进行”动”，以及如何”动”</li>
<li><code>view_*()</code>: 定义坐标轴随数据变化.</li>
<li><code>shadow_*()</code>: 影子（旧数据的历史记忆）?定义点相继出现的方式.</li>
<li><code>enter_*()/exit_*()</code>: 定义新数据出现和旧数据退去的方式.</li>
<li><code>ease_aes()</code>: 美观定义，控制变化的节奏(如何让整个动画看起来更舒适).</li>
</ul>
<ul>
<li><code>transition_states(states=)</code> states参数带有分组信息，可以等价于静态图中的分面</li>
<li><code>transition_time(time=)</code> time一般认为是连续的值，是transition_states的一个特例（transition_length默认为time）。</li>
<li><code>transition_reveal(along=)</code> along参数按照某个变量依次显示，如沿着x轴显示</li>
<li><code>transition_filter(至少2个筛选条件，transition_length = , filter_length =)</code> 动图将会在这些筛选条件对应的子图之间转换。</li>
<li><code>transition_layers()</code> 按照图层依次显示。</li>
</ul>
<p><a href="https://bookdown.org/wangminjie/R4DS/tidyverse-ggplot2-gganimate.html">绘制动图的详细解说</a></p>
]]></content>
      <categories>
        <category>R</category>
        <category>ggplot2</category>
      </categories>
      <tags>
        <tag>R</tag>
        <tag>ggplot2</tag>
      </tags>
  </entry>
  <entry>
    <title>绘制桑基图</title>
    <url>/2023/07/08/%E7%BB%98%E5%88%B6%E6%A1%91%E5%9F%BA%E5%9B%BE/</url>
    <content><![CDATA[<p>本文介绍用以下包绘制桑基图。</p>
<ul>
<li>ggalluvial包</li>
<li>sankeyD3包</li>
</ul>
<span id="more"></span>

<h3 id="1-ggalluvial包绘制桑基图"><a href="#1-ggalluvial包绘制桑基图" class="headerlink" title="1. ggalluvial包绘制桑基图"></a>1. ggalluvial包绘制桑基图</h3><h4 id="1-1-长数据绘制"><a href="#1-1-长数据绘制" class="headerlink" title="1.1 长数据绘制"></a>1.1 长数据绘制</h4><p>数据准备：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line"><span class="operator">&gt;</span> head<span class="punctuation">(</span>my_data<span class="punctuation">)</span></span><br><span class="line"><span class="comment"># A tibble: 6 x 7</span></span><br><span class="line">   Freq group            stage m6A   x     y        id</span><br><span class="line">  <span class="operator">&lt;</span>int<span class="operator">&gt;</span> <span class="operator">&lt;</span>chr<span class="operator">&gt;</span>            <span class="operator">&lt;</span>chr<span class="operator">&gt;</span> <span class="operator">&lt;</span>fct<span class="operator">&gt;</span> <span class="operator">&lt;</span>fct<span class="operator">&gt;</span> <span class="operator">&lt;</span>fct<span class="operator">&gt;</span> <span class="operator">&lt;</span>int<span class="operator">&gt;</span></span><br><span class="line"><span class="number">1</span>   <span class="number">404</span> m6A<span class="operator">+</span>m6A<span class="operator">-</span>m6A<span class="operator">-</span>m6A<span class="operator">-</span> Stage1   m6A<span class="operator">+</span>  Stage1   m6A<span class="operator">+</span>      <span class="number">2</span></span><br><span class="line"><span class="number">2</span>   <span class="number">404</span> m6A<span class="operator">+</span>m6A<span class="operator">-</span>m6A<span class="operator">-</span>m6A<span class="operator">-</span> Stage2   m6A<span class="operator">-</span>  Stage2   m6A<span class="operator">-</span>      <span class="number">2</span></span><br><span class="line"><span class="number">3</span>   <span class="number">404</span> m6A<span class="operator">+</span>m6A<span class="operator">-</span>m6A<span class="operator">-</span>m6A<span class="operator">-</span> Stage3   m6A<span class="operator">-</span>  Stage3   m6A<span class="operator">-</span>      <span class="number">2</span></span><br><span class="line"><span class="number">4</span>   <span class="number">404</span> m6A<span class="operator">+</span>m6A<span class="operator">-</span>m6A<span class="operator">-</span>m6A<span class="operator">-</span> Stage4   m6A<span class="operator">-</span>  Stage4   m6A<span class="operator">-</span>      <span class="number">2</span></span><br><span class="line"><span class="number">5</span>   <span class="number">363</span> m6A<span class="operator">-</span>m6A<span class="operator">+</span>m6A<span class="operator">-</span>m6A<span class="operator">-</span> Stage1   m6A<span class="operator">-</span>  Stage1   m6A<span class="operator">-</span>      <span class="number">3</span></span><br><span class="line"><span class="number">6</span>   <span class="number">363</span> m6A<span class="operator">-</span>m6A<span class="operator">+</span>m6A<span class="operator">-</span>m6A<span class="operator">-</span> Stage2   m6A<span class="operator">+</span>  Stage2   m6A<span class="operator">+</span>      <span class="number">3</span></span><br><span class="line"><span class="number">7</span>   <span class="number">363</span> m6A<span class="operator">-</span>m6A<span class="operator">+</span>m6A<span class="operator">-</span>m6A<span class="operator">-</span> Stage3   m6A<span class="operator">-</span>  Stage3   m6A<span class="operator">-</span>      <span class="number">3</span></span><br><span class="line"><span class="number">8</span>   <span class="number">363</span> m6A<span class="operator">-</span>m6A<span class="operator">+</span>m6A<span class="operator">-</span>m6A<span class="operator">-</span> Stage4   m6A<span class="operator">-</span>  Stage4   m6A<span class="operator">-</span>      <span class="number">3</span></span><br></pre></td></tr></table></figure>
<p>绘图所需要的数据，如上所示，这个方法绘图，数据需要是tidy的,即用长数据作图。<br>绘图代码：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">p1 <span class="operator">&lt;-</span> ggplot<span class="punctuation">(</span>my_data<span class="punctuation">,</span></span><br><span class="line">       aes<span class="punctuation">(</span>x <span class="operator">=</span> x<span class="punctuation">,</span> stratum <span class="operator">=</span> m6A<span class="punctuation">,</span> alluvium <span class="operator">=</span> id<span class="punctuation">,</span></span><br><span class="line">           y <span class="operator">=</span> Freq<span class="punctuation">,</span></span><br><span class="line">           fill <span class="operator">=</span> m6A<span class="punctuation">,</span> label <span class="operator">=</span> m6A<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  scale_x_discrete<span class="punctuation">(</span>expand <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">.1</span><span class="punctuation">,</span> <span class="number">.1</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  geom_flow<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  geom_stratum<span class="punctuation">(</span>alpha <span class="operator">=</span> <span class="number">.5</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  geom_text<span class="punctuation">(</span>stat <span class="operator">=</span> <span class="string">&quot;stratum&quot;</span><span class="punctuation">,</span> size <span class="operator">=</span> <span class="number">3</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  theme<span class="punctuation">(</span>legend.position <span class="operator">=</span> <span class="string">&quot;none&quot;</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  theme_classic<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line">p1</span><br></pre></td></tr></table></figure>
<p>结果如图：<br><img src="D:/Blog/source/pics/2023-07-11-sankey1.png" alt="alt 图标"></p>
<p>绘图语法与ggplot2一致,函数包含以下变量：</p>
<ul>
<li>首先确定图的axis，x轴表示不同时期，沿着x轴表示不同位置的水平分组；</li>
<li>每个轴上的分组被描绘成不透明的块，称为地层（strata）。Stage1轴包含m6A+和m6A-;</li>
<li>被称为**冲积(alluvia)**的水平(x-)样条横跨地块的宽度。在这个图中，每个冲积层对应于每个轴变量的固定值，由其在轴上的垂直位置表示，以及由其填充颜色表示的Survived变量的固定值。</li>
<li>在相邻轴线之间的冲积层片段是水流（flow）。<br>冲积层在<strong>矿脉处（lodes）</strong>与地层相交。上述图中没有显示矿脉，但可以推断为填充的矩形，这些矩形在图的每一端延伸流过地层的流动，或连接中心地层两侧的流动。</li>
</ul>
<p>具体到本例，即：</p>
<ul>
<li><strong>axis：</strong>x轴为不同stage、x轴不同取值的组合代表不同分组，y轴由每个轴变量的值表示，即每个分组的flow宽度，即Freq；</li>
<li><strong>stratum：</strong>为x轴每个分块的取值；</li>
<li><strong>alluvium：</strong>为每个分组的id，用以区分不同的组；</li>
</ul>
<p>但是这样画出的图，不详细区分每个组分，在stage2出来之后，就不会记得stage1的状态。如果要区分每一个group的话，需要在geom_flow()中加<code>stat = &quot;alluvium&quot;</code>参数，配合<code>lode.guidance = &quot;frontback&quot;</code>参数一起，效果更好，color指定边界的颜色：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">p2 <span class="operator">&lt;-</span> ggplot<span class="punctuation">(</span>my_data<span class="punctuation">,</span></span><br><span class="line">       aes<span class="punctuation">(</span>x <span class="operator">=</span> x<span class="punctuation">,</span> stratum <span class="operator">=</span> m6A<span class="punctuation">,</span> alluvium <span class="operator">=</span> id<span class="punctuation">,</span></span><br><span class="line">           y <span class="operator">=</span> Freq<span class="punctuation">,</span></span><br><span class="line">           fill <span class="operator">=</span> m6A<span class="punctuation">,</span> label <span class="operator">=</span> m6A<span class="punctuation">,</span>alpha<span class="operator">=</span><span class="number">0.5</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  geom_flow<span class="punctuation">(</span>stat <span class="operator">=</span> <span class="string">&quot;alluvium&quot;</span><span class="punctuation">,</span> lode.guidance <span class="operator">=</span> <span class="string">&quot;frontback&quot;</span><span class="punctuation">,</span></span><br><span class="line">            color <span class="operator">=</span> <span class="string">&quot;darkgray&quot;</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  geom_stratum<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  geom_text<span class="punctuation">(</span>stat <span class="operator">=</span> <span class="string">&quot;stratum&quot;</span><span class="punctuation">,</span> size <span class="operator">=</span> <span class="number">3</span><span class="punctuation">,</span>color<span class="operator">=</span><span class="string">&quot;black&quot;</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  theme<span class="punctuation">(</span>legend.position <span class="operator">=</span> <span class="string">&quot;bottom&quot;</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  theme_classic<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line">p2</span><br></pre></td></tr></table></figure>
<p><img src="/pics/2023-07-11-sankey2.png" alt="alt 图标"></p>
<h4 id="1-2-宽数据绘制"><a href="#1-2-宽数据绘制" class="headerlink" title="1.2 宽数据绘制"></a>1.2 宽数据绘制</h4><figure class="highlight r"><table><tr><td class="code"><pre><span class="line">head<span class="punctuation">(</span>my_df<span class="punctuation">)</span></span><br><span class="line">   MII  L1C  L2C   <span class="number">4</span>C Freq            group</span><br><span class="line"><span class="number">1</span> m6A<span class="operator">-</span> m6A<span class="operator">-</span> m6A<span class="operator">-</span> m6A<span class="operator">-</span> <span class="number">4329</span> m6A<span class="operator">-</span>m6A<span class="operator">-</span>m6A<span class="operator">-</span>m6A<span class="operator">-</span></span><br><span class="line"><span class="number">2</span> m6A<span class="operator">+</span> m6A<span class="operator">-</span> m6A<span class="operator">-</span> m6A<span class="operator">-</span>  <span class="number">404</span> m6A<span class="operator">+</span>m6A<span class="operator">-</span>m6A<span class="operator">-</span>m6A<span class="operator">-</span></span><br><span class="line"><span class="number">3</span> m6A<span class="operator">-</span> m6A<span class="operator">+</span> m6A<span class="operator">-</span> m6A<span class="operator">-</span>  <span class="number">363</span> m6A<span class="operator">-</span>m6A<span class="operator">+</span>m6A<span class="operator">-</span>m6A<span class="operator">-</span></span><br><span class="line"><span class="number">4</span> m6A<span class="operator">+</span> m6A<span class="operator">+</span> m6A<span class="operator">-</span> m6A<span class="operator">-</span>  <span class="number">558</span> m6A<span class="operator">+</span>m6A<span class="operator">+</span>m6A<span class="operator">-</span>m6A<span class="operator">-</span></span><br><span class="line"><span class="number">5</span> m6A<span class="operator">-</span> m6A<span class="operator">-</span> m6A<span class="operator">+</span> m6A<span class="operator">-</span>  <span class="number">523</span> m6A<span class="operator">-</span>m6A<span class="operator">-</span>m6A<span class="operator">+</span>m6A<span class="operator">-</span></span><br><span class="line"><span class="number">6</span> m6A<span class="operator">+</span> m6A<span class="operator">-</span> m6A<span class="operator">+</span> m6A<span class="operator">-</span>  <span class="number">174</span> m6A<span class="operator">+</span>m6A<span class="operator">-</span>m6A<span class="operator">+</span>m6A<span class="operator">-</span></span><br></pre></td></tr></table></figure>
<p>宽数据绘制：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">ggplot<span class="punctuation">(</span>my_df<span class="punctuation">,</span></span><br><span class="line">       aes<span class="punctuation">(</span>y <span class="operator">=</span> Freq<span class="punctuation">,</span></span><br><span class="line">           <span class="comment">#fill=group,</span></span><br><span class="line">           axis1 <span class="operator">=</span> MII<span class="punctuation">,</span> axis2 <span class="operator">=</span> L1C<span class="punctuation">,</span> axis3 <span class="operator">=</span> L2C<span class="punctuation">,</span>axis4 <span class="operator">=</span> `<span class="number">4</span>C`)) +</span><br><span class="line">  geom_flow(stat = &quot;alluvium&quot;, lode.guidance = &quot;frontback&quot;) +</span><br><span class="line">  scale_x_discrete(limits = c(&quot;MII&quot;, &quot;L1C&quot;, &quot;L2C&quot;,&quot;4C&quot;)) +</span><br><span class="line">  geom_stratum() +</span><br><span class="line">  geom_text(stat = &quot;stratum&quot;, aes(label = after_stat(stratum))) +</span><br><span class="line">  theme_bw()</span><br></pre></td></tr></table></figure>

<p>如图所示：<br><img src="/pics/2023-07-11-sankey3.png" alt="alt 图标"></p>
<h3 id="2-sankeyD3包绘制"><a href="#2-sankeyD3包绘制" class="headerlink" title="2. sankeyD3包绘制"></a>2. sankeyD3包绘制</h3><figure class="highlight r"><table><tr><td class="code"><pre><span class="line">install.packages<span class="punctuation">(</span><span class="string">&quot;devtools&quot;</span><span class="punctuation">)</span></span><br><span class="line">devtools<span class="operator">::</span>install_github<span class="punctuation">(</span><span class="string">&quot;fbreitwieser/sankeyD3&quot;</span><span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>sankeyD3<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">links<span class="operator">&lt;-</span>data.frame<span class="punctuation">(</span>source<span class="operator">=</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;脐橙&quot;</span><span class="punctuation">,</span><span class="string">&quot;苹果&quot;</span><span class="punctuation">,</span><span class="string">&quot;脐橙&quot;</span><span class="punctuation">,</span><span class="string">&quot;梨&quot;</span><span class="punctuation">,</span><span class="string">&quot;香蕉&quot;</span><span class="punctuation">,</span><span class="string">&quot;北京&quot;</span><span class="punctuation">,</span><span class="string">&quot;北京&quot;</span><span class="punctuation">,</span><span class="string">&quot;南京&quot;</span><span class="punctuation">,</span><span class="string">&quot;上海&quot;</span><span class="punctuation">,</span><span class="string">&quot;南京&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">                  target<span class="operator">=</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;北京&quot;</span><span class="punctuation">,</span><span class="string">&quot;北京&quot;</span><span class="punctuation">,</span><span class="string">&quot;南京&quot;</span><span class="punctuation">,</span><span class="string">&quot;上海&quot;</span><span class="punctuation">,</span><span class="string">&quot;南京&quot;</span><span class="punctuation">,</span><span class="string">&quot;AAA&quot;</span><span class="punctuation">,</span><span class="string">&quot;BBB&quot;</span><span class="punctuation">,</span><span class="string">&quot;AAA&quot;</span><span class="punctuation">,</span><span class="string">&quot;BBB&quot;</span><span class="punctuation">,</span><span class="string">&quot;CCC&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">                  weight<span class="operator">=</span><span class="built_in">c</span><span class="punctuation">(</span><span class="number">30</span><span class="punctuation">,</span><span class="number">56</span><span class="punctuation">,</span><span class="number">39</span><span class="punctuation">,</span><span class="number">56</span><span class="punctuation">,</span><span class="number">33</span><span class="punctuation">,</span><span class="number">30</span><span class="punctuation">,</span><span class="number">56</span><span class="punctuation">,</span><span class="number">39</span><span class="punctuation">,</span><span class="number">56</span><span class="punctuation">,</span><span class="number">33</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">nodes <span class="operator">&lt;-</span> data.frame<span class="punctuation">(</span>name<span class="operator">=</span><span class="built_in">c</span><span class="punctuation">(</span><span class="built_in">as.character</span><span class="punctuation">(</span>links<span class="operator">$</span>source<span class="punctuation">)</span><span class="punctuation">,</span> <span class="built_in">as.character</span><span class="punctuation">(</span>links<span class="operator">$</span>target<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span> unique<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">links<span class="operator">$</span>IDsource <span class="operator">&lt;-</span> match<span class="punctuation">(</span>links<span class="operator">$</span>source<span class="punctuation">,</span> nodes<span class="operator">$</span>name<span class="punctuation">)</span><span class="operator">-</span><span class="number">1</span>;</span><br><span class="line">links<span class="operator">$</span>IDtarget <span class="operator">&lt;-</span> match<span class="punctuation">(</span>links<span class="operator">$</span>target<span class="punctuation">,</span> nodes<span class="operator">$</span>name<span class="punctuation">)</span><span class="operator">-</span><span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">nodes<span class="operator">$</span>color<span class="operator">&lt;-</span>sample<span class="punctuation">(</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;red&quot;</span><span class="punctuation">,</span><span class="string">&quot;orange&quot;</span><span class="punctuation">,</span><span class="string">&quot;blue&quot;</span><span class="punctuation">,</span><span class="string">&quot;green&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span>nrow<span class="punctuation">(</span>nodes<span class="punctuation">)</span><span class="punctuation">,</span>replace<span class="operator">=</span><span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">links<span class="operator">$</span>group<span class="operator">&lt;-</span><span class="built_in">rep</span><span class="punctuation">(</span><span class="string">&quot;A&quot;</span><span class="punctuation">,</span>nrow<span class="punctuation">(</span>links<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">links<span class="operator">$</span>group<span class="punctuation">[</span>links<span class="operator">$</span>weigth<span class="operator">&lt;</span><span class="number">50</span> <span class="operator">&amp;</span> links<span class="operator">$</span>weigth<span class="operator">&gt;=</span><span class="number">35</span><span class="punctuation">]</span><span class="operator">&lt;-</span><span class="string">&quot;B&quot;</span></span><br><span class="line">links<span class="operator">$</span>group<span class="punctuation">[</span>links<span class="operator">$</span>weigth<span class="operator">&lt;</span><span class="number">35</span><span class="punctuation">]</span><span class="operator">&lt;-</span><span class="string">&quot;C&quot;</span></span><br><span class="line"></span><br><span class="line">sankeyNetwork<span class="punctuation">(</span>Links <span class="operator">=</span> links<span class="punctuation">,</span> Nodes <span class="operator">=</span> nodes<span class="punctuation">,</span> </span><br><span class="line">              Source <span class="operator">=</span> <span class="string">&quot;IDsource&quot;</span><span class="punctuation">,</span> Target <span class="operator">=</span> <span class="string">&quot;IDtarget&quot;</span><span class="punctuation">,</span></span><br><span class="line">              Value <span class="operator">=</span> <span class="string">&quot;weight&quot;</span><span class="punctuation">,</span> NodeID <span class="operator">=</span> <span class="string">&quot;name&quot;</span><span class="punctuation">,</span></span><br><span class="line">              nodeWidth <span class="operator">=</span><span class="number">10</span><span class="punctuation">,</span>units <span class="operator">=</span> <span class="string">&#x27;TWh&#x27;</span><span class="punctuation">,</span></span><br><span class="line">              numberFormat<span class="operator">=</span><span class="string">&quot;.0f&quot;</span><span class="punctuation">,</span>fontSize <span class="operator">=</span> <span class="number">8</span><span class="punctuation">,</span></span><br><span class="line">              NodeColor<span class="operator">=</span><span class="string">&quot;color&quot;</span><span class="punctuation">,</span>LinkGroup<span class="operator">=</span><span class="string">&quot;group&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<p><img src="/source/pics/2023-07-11-sankey4.png" alt="alt 图标"></p>
]]></content>
      <categories>
        <category>R</category>
      </categories>
      <tags>
        <tag>R</tag>
      </tags>
  </entry>
</search>
